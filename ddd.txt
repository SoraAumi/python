Index: src/main/resources/leaf_static/modules/hn/HN1012/prj_project_virtual_change_modify.lview
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/hn/HN1012/prj_project_virtual_change_modify.lview b/src/main/resources/leaf_static/modules/hn/HN1012/prj_project_virtual_change_modify.lview
--- a/src/main/resources/leaf_static/modules/hn/HN1012/prj_project_virtual_change_modify.lview	(revision d72aa5d715e54962cf9268112f89fce6133db4ac)
+++ b/src/main/resources/leaf_static/modules/hn/HN1012/prj_project_virtual_change_modify.lview	(revision 163a024047781d3c631497db0e248604e903b0e4)
@@ -19,6 +19,8 @@
         <a:link id="hn1012_prj_project_change_req_cancel_link_id" model="hn.HN1012.hn_virtual_project_change_req_info" modelaction="delete"/>
         <!-- <a:link id="hn1012_prj_change_req_back_link" url="${/request/@context_path}/modules/hn/HN1012/prj_project_virtual_change_req_enterance.lview"/> -->
         <a:link id="hn1012_prj_project_change_req_node_approve_history" url="${/request/@context_path}/modules/zjwfl/ZJWFL1060/zj_wfl_monitoring_node_approve_history.lview"/>
+        <a:link id="${/parameter/@layout_code}_prj_project_content_confirm_link_id"
+                url="${/request/@context_path}/modules/prj/PRJ506/prj_project_print_detail.lview"/>
         <a:screen-include screen="modules/cont/CON500/con_contract_get_layout_code.lview"/>
         <script><![CDATA[

@@ -77,11 +79,11 @@
                 remaining_amount=minus(remaining_amount,finance_amount);
                 remaining_amount=plus(remaining_amount,before_change_amount);
                 if(remaining_amount <0 ){
-                    Leaf.showErrorMessage('${l:HLS.PROMPT}', '本合同所属项目过会额度'+prj_finance_amount+'元，已用项目额度'+total_virtual_con_amount+'元，原合同金额'+before_change_amount+'元，当前变更合同金额'+finance_amount+'元，已经超出可用项目额度，请调整合同金额后再次提交！',null,400,130);
+                    Leaf.showErrorMessage('${l:HLS.PROMPT}', '<div style="height: 150px;width: 300px">本合同所属项目过会额度'+prj_finance_amount+'元，已用项目额度'+total_virtual_con_amount+'元，原合同金额'+before_change_amount+'元，当前变更合同金额'+finance_amount+'元，已经超出可用项目额度，请调整合同金额后再次提交！</div>',null,400,300);
                     return;
                 }

-                Leaf.showConfirm('${l:HLS.PROMPT}', '本合同所属项目过会额度' + prj_finance_amount + '元，已用项目额度' + total_virtual_con_amount + '元，原合同金额' + before_change_amount +'元，当前变更合同金额' + finance_amount + '元，提交后剩余可用项目额度' + remaining_amount + '元，确认提交？', function() {
+                Leaf.showConfirm('${l:HLS.PROMPT}', '<div style="height: 150px;width: 300px"> 本合同所属项目过会额度' + prj_finance_amount + '元，已用项目额度' + total_virtual_con_amount + '元，原合同金额' + before_change_amount +'元，当前变更合同金额' + finance_amount + '元，提交后剩余可用项目额度' + remaining_amount + '元，确认提交？</div>', function() {
                     hn1012_virtual_change_req_detail_lock();
                     Leaf.request({
                         url: $('hn1012_prj_project_change_req_info_link_id').getUrl(),
@@ -101,7 +103,7 @@
                             hn1012_virtual_change_req_detail_unlock();
                         }
                     });
-                },null,400,130);
+                },null,400,300);
             }

             function hn1012_modify_prj_change_req_cancel() {
@@ -130,7 +132,7 @@
                 });
             }

-            function hn1012_open_virtual_project_modify_win() {
+            function hn1012_open_virtual_project_modify_win(record) {
                 //先保存
                 var ds = $('hn1012_virtual_project_change_req_info_ds');
                 if (!ds.validate()) {
@@ -138,6 +140,18 @@
                 }
                 hn1012_prj_change_req_save();

+               /* url = $('{/parameter/@layout_code}_prj_project_content_confirm_link_id').getUrl();
+                 new Leaf.Window({
+                    url: url,
+                    title: '合同编辑',
+                    params: {
+                        project_id: '${/parameter/@project_id}',
+                        winid: 'prj_project_create_content_print_win_id'
+                    },
+                    id: 'prj_project_create_content_print_win_id',
+                    fullScreen: true
+                });*/
+
                 var record = ds.getCurrentRecord();
                 var maintain_type = 'UPDATE';
                 var function_usage = 'MODIFY';
@@ -149,10 +163,13 @@
                 param['maintain_type'] = maintain_type;
                 param['url_title'] = '合同明细';
                 param['winid'] = 'hn1012_virtual_project_modify_win_id';
+                param['ch_show_flag'] = '${/parameter/@ch_show_flag}';
+                param['fun_code'] = '${/parameter/@fun_code}';
+                param['unsigned_adjust_flag'] = record.get("unsigned_adjust_flag")
                 //param['layout_debugger_flag']='Y';
                 param['cond_para2'] = record.get('hn_industry_classification');
                 hls_doc_get_layout_code('hn1012_prj_project_get_layout_code_link_id', param, 'hn1012_virtual_project_modify_link', 'hn1012_virtual_project_change_req_info_ds', null, null, null, 'prj1000_tab_refresh');
-            }
+                }

             function tab_refresh(tab_id) {
                 var current_tab = $(tab_id);
@@ -164,9 +181,11 @@
             function prj1000_tab_refresh() {
                 tab_refresh('prj_project_base_info_tab_id');
                 tab_refresh('prj_project_quote_info_tab_id');
-                tab_refresh('prj_project_bp_info_tab_id');
+                // tab_refresh('prj_project_bp_info_tab_id');
                 tab_refresh('prj_project_lease_item_info_tab_id');
                 tab_refresh('prj_project_cdd_item_info_tab_id');
+                tab_refresh('con_contract_content_tab_id');
+
             }

             function hn1012_modify_change_bp() {
@@ -218,6 +237,49 @@
                 });
             }

+            function open_cdd_content_attachment_window(record_id, ds_id,check_id) {
+                let record = $(ds_id).findById(record_id);
+                if (check_id) {
+                    let url_id = $('hn1012_conditions_downloadfile_link_id').getUrl();
+                    let url = url_id + '?table_name=PRJ_CDD_ITEM_CHECK&header_id=' + check_id;
+                    let win = new Leaf.Window({
+                        url: url,
+                        title: '${l:HLS.SUPPORTING_DOCUMENT}',
+                        id: 'content_cdd_loadFile_screen_id',
+                        width: 850,
+                        height: 400
+                    });
+                    win.on('close', function() {
+                        record.ds.query();
+                    });
+                } else {
+                    Leaf.showMessage('${l:HLS.PROMPT}', '请先保存!');
+                }
+            }
+
+
+            function cdd_attachment_renderer(value, record, name){
+                if (name === 'attachment') {
+                    return '<a href="javascript:open_cdd_content_attachment_window(\'' + record.id + '\',\'' + record.ds.id + '\',' + record.get('check_id') + ');">附件</a>';
+                } else if (name === 'attach_file_name') {
+                    if (value != null) {
+
+                        let link = '${/request/@context_path}/atm_download.lsc?attachment_id=';
+                        let str = value.split(';;');
+                        let url = '';
+                        for (let i = 0;i < str.length;i++) {
+                            let temp = str[i].split('--');
+                            if (!Leaf.isEmpty(temp[0])) {
+                                url = url + '<a href=' + link + temp[1] + '>' + temp[0] + '</a>' + ',';
+                            }
+                        }
+                        return url;
+                    }
+                } else if(name === 'order_seq'){
+                    return 'V'+value
+                }
+            }
+
         ]]></script>
         <a:dataSets>
             <a:dataSet id="hn1012_virtual_project_change_req_info_query_ds" autoCreate="true">
@@ -230,6 +292,20 @@
                     <a:field name="description" required="true"/>
                     <a:field name="unsigned_adjust_flag" checkedValue="Y" defaultValue="N" uncheckedValue="N"/>
                 </a:fields>
+            </a:dataSet>
+            <!--审批附件信息 变更前-->
+            <a:dataSet id="hn_content_zip_cdd_old_ds" autoQuery="true" fetchAll="true"
+                       model="layout.server_layout_doc_cdd_item" pageSize="11"
+                       queryUrl="${/request/@context_path}/autocrud/layout.server_layout_doc_cdd_item/query?base_table_pk=${/model/prj_change_req_info/record/@content_project_id}&amp;document_table=PRJ_PROJECT&amp;cdd_list_id=${/model/prj_change_req_info/record/@cdd_list_id}&amp;attachment_tab_group=343&amp;order_seq=${/model/prj_change_req_info/record/@old_version_num}"
+                       selectable="true">
+
+            </a:dataSet>
+
+            <a:dataSet id="hn_content_zip_cdd_new_ds" autoQuery="true" fetchAll="true"
+                       model="layout.server_layout_doc_cdd_item" pageSize="11"
+                       queryUrl="${/request/@context_path}/autocrud/layout.server_layout_doc_cdd_item/query?base_table_pk=${/model/prj_change_req_info/record/@content_project_id}&amp;document_table=PRJ_PROJECT&amp;cdd_list_id=${/model/prj_change_req_info/record/@cdd_list_id}&amp;attachment_tab_group=343&amp;order_seq=${/model/prj_change_req_info/record/@new_version_num}"
+                       selectable="true">
+
             </a:dataSet>
         </a:dataSets>
         <a:screenBody>
@@ -278,7 +354,7 @@
                             </a:tabs>
                         </a:tabPanel>
                     </a:tab>
-                    <a:tab prompt="报价信息" width="170">
+                    <a:tab prompt="合同报价" width="170">
                         <a:tabPanel id="prj_project_quote_info_tab_id" height="450" marginWidth="50">
                             <a:tabs>
                                 <a:tab prompt="变更前" ref="${/request/@context_path}/modules/prj/PRJ1000/prj_project_quote_info.lview?project_id=${/model/prj_change_req_info/record/@old_project_id}&amp;hn_industry_classification=${/model/prj_change_req_info/record/@hn_industry_classification}" width="100"/>
@@ -286,15 +362,23 @@
                             </a:tabs>
                         </a:tabPanel>
                     </a:tab>
-                    <a:tab prompt="商业伙伴信息" width="170">
+                    <a:tab prompt="合同文本" width="170">
+                        <a:tabPanel id="con_contract_content_tab_id" height="450" marginWidth="50">
+                            <a:tabs>
+                                <a:tab prompt="变更前" ref="${/request/@context_path}/modules/prj/PRJ506/prj_con_content_change_query.lview?project_id=${/model/prj_change_req_info/record/@old_project_id}&amp;hn_industry_classification=${/model/prj_change_req_info/record/@hn_industry_classification}&amp;" width="100"/>
+                                <a:tab prompt="变更后" ref="${/request/@context_path}/modules/prj/PRJ506/prj_con_content_change_query.lview?project_id=${/model/prj_change_req_info/record/@change_req_id}&amp;hn_industry_classification=${/model/prj_change_req_info/record/@hn_industry_classification}&amp;" width="100"/>
+                            </a:tabs>
+                        </a:tabPanel>
+                    </a:tab>
+                    <!--<a:tab prompt="商业伙伴信息" width="170">
                         <a:tabPanel id="prj_project_bp_info_tab_id" height="450" marginWidth="50">
                             <a:tabs>
                                 <a:tab prompt="变更前" ref="${/request/@context_path}/modules/hn/HN1012/prj_project_bp_info.lview?project_id=${/model/prj_change_req_info/record/@old_project_id}&amp;hn_industry_classification=${/model/prj_change_req_info/record/@hn_industry_classification}" width="100"/>
                                 <a:tab prompt="变更后" ref="${/request/@context_path}/modules/hn/HN1012/prj_project_bp_info.lview?project_id=${/model/prj_change_req_info/record/@change_req_id}&amp;hn_industry_classification=${/model/prj_change_req_info/record/@hn_industry_classification}" width="100"/>
                             </a:tabs>
                         </a:tabPanel>
-                    </a:tab>
-                    <a:tab prompt="租赁物/抵押物信息" width="170">
+                    </a:tab>-->
+                    <a:tab prompt="资产相关信息" width="170">
                         <a:tabPanel id="prj_project_lease_item_info_tab_id" height="450" marginWidth="50">
                             <a:tabs>
                                 <a:tab prompt="变更前" ref="${/request/@context_path}/modules/prj/PRJ1000/prj_project_lease_item_info.lview?project_id=${/model/prj_change_req_info/record/@old_project_id}&amp;hn_industry_classification=${/model/prj_change_req_info/record/@hn_industry_classification}" width="100"/>
@@ -302,7 +386,7 @@
                             </a:tabs>
                         </a:tabPanel>
                     </a:tab>
-                    <a:tab prompt="合同附件" width="170">
+                    <a:tab prompt="合同附件信息" width="170">
                         <a:tabPanel id="prj_project_cdd_item_info_tab_id" height="450" marginWidth="50">
                             <a:tabs>
                                 <a:tab prompt="变更前" ref="${/request/@context_path}/modules/hn/HN1012/prj_project_virtual_cdd_item_info.lview?project_id=${/model/prj_change_req_info/record/@old_project_id}&amp;hn_industry_classification=${/model/prj_change_req_info/record/@hn_industry_classification}" width="100"/>
@@ -310,11 +394,40 @@
                             </a:tabs>
                         </a:tabPanel>
                     </a:tab>
-                    <a:tab prompt="附件信息" width="170">
+
+                   <!-- <a:tab prompt="附件信息" width="170">
                         <a:tabPanel id="prj_project_chance_cdd_item_info_tab_id" height="450" marginWidth="50">
                             <a:tabs>
                                 <a:tab prompt="变更前" ref="${/request/@context_path}/modules/hn/HN1012/prj_project_chance_cdd_item_info.lview?project_id=${/model/prj_change_req_info/record/@old_project_id}&amp;hn_industry_classification=${/model/prj_change_req_info/record/@hn_industry_classification}" width="100"/>
                                 <a:tab prompt="变更后" ref="${/request/@context_path}/modules/hn/HN1012/prj_project_chance_cdd_item_info.lview?project_id=${/model/prj_change_req_info/record/@change_req_id}&amp;hn_industry_classification=${/model/prj_change_req_info/record/@hn_industry_classification}" width="100"/>
+                            </a:tabs>
+                        </a:tabPanel>
+                    </a:tab>-->
+                    <a:tab prompt="审批附件信息" width="170">
+                        <a:tabPanel id="prj_project_content_cdd_item_info_tab_id" height="450" marginWidth="50">
+                            <a:tabs>
+                                <a:tab prompt="变更前"  width="100">
+                                    <a:grid id = "content_cdd_item_old_grid_id" bindTarget="hn_content_zip_cdd_old_ds" height="350" marginWidth="50">
+                                        <a:columns>
+                                            <a:column name="description" align="center"  width="200" prompt="文件名称"/>
+                                            <a:column name="attachment" align="center"  width="80" prompt="附件" renderer="cdd_attachment_renderer"/>
+                                            <a:column name="attach_file_name" align="center"  width="200" prompt="附件名称" renderer="cdd_attachment_renderer"/>
+                                            <a:column name="order_seq" align="center"  width="80" prompt="版本号" renderer="cdd_attachment_renderer"/>
+                                            <a:column name="note" align="center"  width="500" prompt="备注"/>
+                                        </a:columns>
+                                    </a:grid>
+                                </a:tab>
+                                <a:tab prompt="变更后"  width="100">
+                                    <a:grid id = "content_cdd_item_new_grid_id" bindTarget="hn_content_zip_cdd_new_ds" height="350" marginWidth="50" >
+                                        <a:columns>
+                                            <a:column name="description" align="center"  width="200" prompt="文件名称"/>
+                                            <a:column name="attachment" align="center"  width="80" prompt="附件" renderer="cdd_attachment_renderer"/>
+                                            <a:column name="attach_file_name" align="center"  width="200" prompt="附件名称" renderer="cdd_attachment_renderer"/>
+                                            <a:column name="order_seq" align="center"  width="80" prompt="版本号" renderer="cdd_attachment_renderer"/>
+                                            <a:column name="note" align="center"  width="500" prompt="备注"/>
+                                        </a:columns>
+                                    </a:grid>
+                                </a:tab>
                             </a:tabs>
                         </a:tabPanel>
                     </a:tab>
Index: src/main/resources/leaf_static/WEB-INF/classes/acrch/ARCHIVE002/arch002_project_info.lwm
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/WEB-INF/classes/acrch/ARCHIVE002/arch002_project_info.lwm b/src/main/resources/leaf_static/WEB-INF/classes/acrch/ARCHIVE002/arch002_project_info.lwm
--- a/src/main/resources/leaf_static/WEB-INF/classes/acrch/ARCHIVE002/arch002_project_info.lwm	(revision c1aa07c5d61db47efc2ed4d7e13119192d953710)
+++ b/src/main/resources/leaf_static/WEB-INF/classes/acrch/ARCHIVE002/arch002_project_info.lwm	(revision ac6fbbf9de1bfccb154ab448a59b4e915498aacc)
@@ -148,16 +148,25 @@
         <bm:operation name="update">
             <bm:update-sql><![CDATA[
             begin
-                  update prj_cdd_item_check pci
-                    set pci.confirm_flag = ${@status}
-                  where pci.check_id=${@check_id};
+                  if ${@submit_from} = 'PAYMENT' then
+                    update HN_CON_PAYMENT_CONDITIONS_NEW set confirm_flag = ${@status} where condition_id = ${@condition_id};
+                  else
+                      update prj_cdd_item_check pci
+                        set pci.confirm_flag = ${@status}
+                      where pci.check_id=${@check_id};
+                  end if;
              end;
             ]]></bm:update-sql>
         </bm:operation>
         <bm:operation name="execute">
             <bm:update-sql><![CDATA[
             begin
-                  update prj_cdd_item_check pck set pck.confirm_flag = 'Y' where pck.cdd_item_id in
+                  if ${@submit_from} = 'PAYMENT' then
+                    update hn_con_payment_conditions_new set confirm_flag = 'Y'
+                    where archive_batch_id = ${@archive_batch_id} and confirm_flag <> 'N';
+
+                  else
+                    update prj_cdd_item_check pck set pck.confirm_flag = 'Y' where pck.cdd_item_id in
                     (select pci.cdd_item_id from prj_cdd_item pci, prj_cdd_item_list_grp_tab lgt, prj_cdd_item_tab_group tg
                     where pci.cdd_list_id = ${@cdd_list_id} and pci.enabled_flag ='Y'
                                         and lgt.cdd_list_id = pci.cdd_list_id
@@ -165,19 +174,10 @@
                                         AND lgt.TAB_GROUP_ID =tg.TAB_GROUP_ID
                                         AND nvl(lgt.enabled_flag,'Y') ='Y'
                                         and nvl(tg.enabled_flag,'Y') = 'Y'
-                                        and tg.tab_group = ${@attachment_tab_group})
-                                        and pck.confirm_flag <> 'M';
+                                        and tg.tab_group like decode(${@submit_from}, 'SIGN', '%'||${@attachment_tab_group}||'%', ${@attachment_tab_group}))
+                                        and pck.confirm_flag <> 'N';

-                  update prj_cdd_item_check pck set pck.confirm_flag = 'N' where pck.cdd_item_id in
-                    (select pci.cdd_item_id from prj_cdd_item pci, prj_cdd_item_list_grp_tab lgt, prj_cdd_item_tab_group tg
-                    where pci.cdd_list_id = ${@cdd_list_id} and pci.enabled_flag ='Y'
-                                        and lgt.cdd_list_id = pci.cdd_list_id
-                                        AND pci.cdd_item_id  = lgt.cdd_item_id
-                                        AND lgt.TAB_GROUP_ID =tg.TAB_GROUP_ID
-                                        AND nvl(lgt.enabled_flag,'Y') ='Y'
-                                        and nvl(tg.enabled_flag,'Y') = 'Y'
-                                        and tg.tab_group = ${@attachment_tab_group})
-                                        and pck.confirm_flag = 'M';
+                  end if;
              end;
             ]]></bm:update-sql>
         </bm:operation>
Index: src/main/resources/leaf_static/WEB-INF/classes/cont/CON500/con_contract_content_download.lwm
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/WEB-INF/classes/cont/CON500/con_contract_content_download.lwm b/src/main/resources/leaf_static/WEB-INF/classes/cont/CON500/con_contract_content_download.lwm
--- a/src/main/resources/leaf_static/WEB-INF/classes/cont/CON500/con_contract_content_download.lwm	(revision c1aa07c5d61db47efc2ed4d7e13119192d953710)
+++ b/src/main/resources/leaf_static/WEB-INF/classes/cont/CON500/con_contract_content_download.lwm	(revision 13e3d48f96ae8ed3fe2d316040060c19f7e6461b)
@@ -13,11 +13,8 @@
                     faa.file_name,
                     faa.file_path,
                     doc.content_number,
-                     (select bp.bp_name from prj_project_bp pbp ,hls_bp_master bp
-                    where pbp.prj_bp_id=doc.prj_bp_id
-                    and pbp.bp_id=bp.bp_id
-                   ) pbp_name,
-                    (select t.bp_id_tenant_n from con_contract_lv t where t.contract_id = ${@contract_id}) bp_id_tenant_n,
+                    (select sign_bp_id_n from prj_project_content_v where content_id = doc.content_id) pbp_name,
+                    (select t.bp_id_tenant_n from con_contract_lv t where t.contract_id = ${@contract_id})bp_id_tenant_n,
                     (select t.templet_name from prj_project_content_v t where  t.content_id = doc.content_id) templet_name,
                     (select t.contract_number from con_contract_lv t where t.contract_id = ${@contract_id}) contract_number
                 FROM
@@ -29,7 +26,8 @@
                     doc.content_id         = NVL(${@content_id}, doc.content_id) AND
                     doc.contract_id        = NVL(${@contract_id}, doc.contract_id) AND
                     doc.project_id         = nvl(${@project_id},doc.project_id) and
-                     fam.table_name         = 'CON_CONTRACT_CONTENT' AND
+                    doc.change_version_num = nvl(${@change_version_num}, doc.change_version_num) and
+                     fam.table_name        = 'CON_CONTRACT_CONTENT' AND
                     fam.table_pk_value     = doc.content_id AND
                     fam.attachment_id      = faa.attachment_id
                      and nvl(fam.del_flag,0)=0 and nvl(faa.del_flag,0)=0
Index: src/main/resources/leaf_static/modules/acrch/ARCHIVE002/con_file_archive_info_wfl.lview
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/acrch/ARCHIVE002/con_file_archive_info_wfl.lview b/src/main/resources/leaf_static/modules/acrch/ARCHIVE002/con_file_archive_info_wfl.lview
--- a/src/main/resources/leaf_static/modules/acrch/ARCHIVE002/con_file_archive_info_wfl.lview	(revision c1aa07c5d61db47efc2ed4d7e13119192d953710)
+++ b/src/main/resources/leaf_static/modules/acrch/ARCHIVE002/con_file_archive_info_wfl.lview	(revision bf0176d4101aa2e8dfb71fb4ebaeff6cd5c2d890)
@@ -1,31 +1,99 @@
 <?xml version="1.0" encoding="UTF-8"?>
 <!--
-    $Author: zc
+    $Author: zc/Sora
     $Date: 2018-09-18 10:46:02
-    $Revision: 1.0
-    $Purpose: 档案归档附件
+    $Revision: 1.1
+    $Purpose: 档案归档附件工作流页面
+    $Tips: 多留意控制台
 -->
 <a:screen xmlns:a="http://www.leaf-framework.org/application" customizationEnabled="true" dynamiccreateenabled="true"
           trace="true">
     <a:init-procedure>
-        <a:model-query defaultWhereClause="t1.archive_batch_id=${/parameter/@archive_batch_id}" model="acrch.ARCHIVE002.arch002_project_info" rootPath="project_path"/>
+        <a:model-query defaultWhereClause="t1.archive_batch_id=${/parameter/@archive_batch_id}"
+                       model="acrch.ARCHIVE002.arch002_project_info" rootPath="project_path"/>
     </a:init-procedure>
     <a:view>
         <a:link id="arch002_cdd_uploadFile_id" url="${/request/@context_path}/uploadFile.lview"/>
         <a:link id="arch002_cdd_downloadFile_id" url="${/request/@context_path}/downloadFile.lview"/>
-        <a:link id="con_contract_get_layout_code_link_id" model="cont.CON500.con_contract_get_layout_code" modelaction="update"/>
-        <!--        <a:link id="${/parameter/@project_id}_prj_change_cdd_downloadfile_link_id" url="${/request/@context_path}/downloadFile.lview"/>-->
-        <a:link id="prj_project_query_link" url="${/request/@context_path}/modules/prj/PRJ501N/prj_project_create_tree_n.lview"/>
-        <a:link id="prj506_virtual_contract_query_link_id" url="${/request/@context_path}/modules/prj/PRJ506/virtual_contract_query.lview"/>
+        <a:link id="con_contract_get_layout_code_link_id" model="cont.CON500.con_contract_get_layout_code"
+                modelaction="update"/>
+        <a:link id="prj_project_query_link"
+                url="${/request/@context_path}/modules/prj/PRJ501N/prj_project_create_tree_n.lview"/>
+        <a:link id="prj506_virtual_contract_query_link_id"
+                url="${/request/@context_path}/modules/prj/PRJ506/virtual_contract_query.lview"/>
         <div style="display:flex;">
-            <span style="font-size:20px;margin-left:10px;margin-top:1px;font-weight:bold;float:right;color:red;">提示：请注意确认纸质文件和线上文件是否一致！</span>
-
+            <span style="font-size:20px;margin-left:10px;margin-top:1px;font-weight:bold;float:right;color:red;">提示：默认全部资料均需归档，请勾选无需归档资料！</span>
         </div>
         <script><![CDATA[
-        function open_cdd_attachment_window(record_id, ds_id,check_id) {
+
+        function const_data() {
+            /**
+             * @obj.submit_from 归档来源
+             * @obj.dataset_id 查询dataset的ID集合
+             * @obj.desc 描述
+             * @obj.submit 查询分组
+             */
+            return [
+                {
+                    "submit_from": "PRJ_PLAN",
+                    "dataset_id": ["archive_prj_plan_bp_ds", "archive_compliance_materials_ds"],
+                    "desc": "项目方案",
+                    "tab_group": ["TENANT", "PROJECT"],
+                    "tab_desc": ["客户资信资料", "合规性材料"]
+                },
+                {
+                    "submit_from": "PRJ_PLAN_CHANGE",
+                    "dataset_id": ["archive_prj_change_bp_ds"],
+                    "desc": "项目方案变更",
+                    "tab_group": ["PROJECT"],
+                    "tab_desc": ["项目变更材料"]
+                },
+                {
+                    "submit_from": "PAYMENT",
+                    "dataset_id": ["archive_payment_ds"],
+                    "desc": "付款先决落实",
+                    "tab_group": [],
+                    "tab_desc": ["放款前提材料"]
+                },
+                {
+                    "submit_from": "SIGN",
+                    "dataset_id": ["archive_contract_sign_ds"],
+                    "desc": "合同签约",
+                    "tab_group": ["SIGN"],
+                    "tab_desc": ["签约执行材料"]
+                },
+                {
+                    "submit_from": "PRJ_PLAN_REPORT",
+                    "dataset_id": ["archive_report_ds"],
+                    "desc": "项目报告 - 项目方案",
+                    "tab_group": ["PRJ_CHANGE"],
+                    "tab_desc": ["项目报告"]
+                },
+                {
+                    "submit_from": "PRJ_PLAN_REPORT_CHANGE_A",
+                    "dataset_id": ["archive_report_ds"],
+                    "desc": "项目报告 - 项目变更(租前)",
+                    "tab_group": ["PRJ_CHANGE"],
+                    "tab_desc": ["项目报告"]
+                },
+                {
+                    "submit_from": "PRJ_PLAN_REPORT_CHANGE_B",
+                    "dataset_id": ["archive_report_ds"],
+                    "desc": "项目报告 - 项目变更(租后)",
+                    "tab_group": ["PRJ_CHANGE"],
+                    "tab_desc": ["项目报告"]
+                }
+            ]
+        }
+
+        const view_property = const_data().filter(obj => {
+            return obj.submit_from === '${/parameter/@submit_from}'
+        })[0]
+
+        function open_cdd_attachment_window(record_id, ds_id, check_id) {
             let record = $(ds_id).findById(record_id);
             if (check_id) {
-                let query_flag='${/parameter/@function_usage}';
+                let query_flag = '${/parameter/@function_usage}';
                 let url_id;
                 if (query_flag === 'MODIFY') {
                     url_id = $('arch002_cdd_uploadFile_id').getUrl();
@@ -39,78 +107,8 @@
                     id: 'wfl_cdd_loadFile_screen_id',
                     width: 850,
                     height: 400
-                });
-                win.on('close', function() {
-                    record.ds.query();
-                });
-            } else {
-                Leaf.showMessage('${l:HLS.PROMPT}', '请先保存!');
-            }
-        }
-
-        //商业伙伴附件记录
-        function open_bp_attachment_window(hn_record_id) {
-            if (hn_record_id) {
-                let url = $('arch002_cdd_downloadFile_id').getUrl() + '?table_name=HN_BP_ATTACHMENT_RECORD&header_id=' + hn_record_id;
-                let win = new Leaf.Window({
-                    url: url,
-                    title: '${l:HLS.SUPPORTING_DOCUMENT}',
-                    id: 'hn_project_bp_attachtment_record_id',
-                    width: 850,
-                    height: 400
-                });
-            }
-        };
-
-
-        function winOpen_projectDetailInfo() {
-            let record = $('arch002_project_info_ds').getAt(0);
-            let param = record.data;
-            param['document_id'] = record.get('project_id');
-            param['function_code'] = 'PRJ505';
-            param['function_usage'] = 'QUERY';
-            param['maintain_type'] = 'READONLY';
-            param['cond_para2'] = record.get('hn_industry_classification');
-            param['cond_para3'] = record.get('binary_classification');
-            param['document_type'] = record.get('document_type');
-            param['url_title'] = '项目详细信息';
-            hls_doc_get_layout_code('con_contract_get_layout_code_link_id', param, 'prj_project_query_link', 'arch002_project_info_ds');
-        }
-
-        function winOpen_contractDetailInfo(){
-            let url_link_id;
-            let record=$('arch002_project_info_ds').getCurrentRecord();
-            let param = record.data;
-            param['function_code'] = 'C0N301D_CON';
-            param['function_usage'] = 'QUERY';
-            param['maintain_type'] = 'READONLY';
-            url_link_id='prj506_virtual_contract_query_link_id';
-
-            //param['document_id'] = record.get('project_id');
-            param['cond_para2'] = record.get('hn_industry_classification');
-            param['url_title'] = '合同明细';
-            // param['layout_debugger_flag'] = 'Y';
-            param['winid'] = 'prj506_virtual_contract_modify_detail_link_id';
-            hls_doc_get_layout_code('con_contract_get_layout_code_link_id', param, url_link_id,'arch002_project_info_ds');
-        }
-
-        function upload_file(check_id) {
-            if (check_id) {
-                let url;
-                let query_flag='${/parameter/@function_usage}';
-                if (query_flag === 'MODIFY') {
-                    url = $('arch002_cdd_uploadFile_id').getUrl() + '?table_name=PRJ_CDD_ITEM_CHECK&header_id=' + check_id;
-                } else {
-                    url = $('arch002_cdd_downloadFile_id').getUrl() + '?table_name=PRJ_CDD_ITEM_CHECK&header_id=' + check_id;
-                }
-                let win = new Leaf.Window({
-                    url: url,
-                    title: '${l:HLS.SUPPORTING_DOCUMENT}',
-                    id: 'arch002_cdd_uploadFile_screen_id',
-                    width: 850,
-                    height: 400
                 });
-                win.on('close', function() {
+                win.on('close', function () {
                     record.ds.query();
                 });
             } else {
@@ -118,11 +116,12 @@
             }
         }

+
         function payment_cdd_render_func(value, record, name) {
-            var condition_id=record.get('condition_id');
-            if (name=='attachment_payment2'){
-                return '<a href="javascript:open_payment_attachment_window2(\'' + condition_id+ '\');">附件</a>';
-            }else if(name=='file_name'){
+            var condition_id = record.get('condition_id');
+            if (name === 'attachment_payment2') {
+                return '<a href="javascript:open_payment_attachment_window2(\'' + condition_id + '\');">附件</a>';
+            } else if (name === 'file_name') {
                 if (value != null) {
                     var link = '${/request/@context_path}/atm_download.lsc?attachment_id=';
                     var str = value.split(';;');
@@ -139,7 +138,6 @@
         }

         function open_payment_attachment_window(condition_id) {
-
             var url = $('arch002_cdd_downloadFile_id').getUrl();
             var win = new Leaf.Window({
                 url: url,
@@ -150,20 +148,18 @@
                 },
                 width: 850,
                 height: 400
-            }).on('close',function(){
-                $('archive_payment_cdd_result_ds').query();
+            }).on('close', function () {
+                $('archive_payment_ds').query();
             });
         }

         function open_payment_attachment_window2(condition_id) {
-
-            var query_flag='${/parameter/@function_usage}';
+            var query_flag = '${/parameter/@function_usage}';
             if (query_flag === 'MODIFY') {
                 var url = $('arch002_cdd_uploadFile_id').getUrl();
             } else {
                 var url = $('arch002_cdd_downloadFile_id').getUrl();
             }
-
             var win = new Leaf.Window({
                 url: url,
                 title: '${l:HLS.SUPPORTING_DOCUMENT}',
@@ -173,53 +169,20 @@
                 },
                 width: 850,
                 height: 400
-            }).on('close',function(){
-                $('archive_payment_cdd_result_ds').query();
+            }).on('close', function () {
+                $('archive_payment_ds').query();
             });
         }

         function project_cdd_render_func(value, record, name) {
-            //客户资信 风电 光伏 水电 项目报告
-            const plan_ds_arr = ['hn_bp_cdd_project_result_ds', 'plan_detail_fd_cdd_project_result_ds', 'plan_detail_fbsgf_cdd_project_result_ds', 'plan_detail_sd_cdd_project_result_ds','pro_report_cdd_result_ds']
-            const detail_ds_arr = [ 'archive_fd_cdd_result_ds', 'archive_gf_cdd_result_ds','pro_report_cdd_result_ds']
-            if (name === 'attachment' || name === 'plan_attachment') {
-                if(name === 'plan_attachment'){
-                    let couple_ds = $(plan_ds_arr[detail_ds_arr.indexOf(record.ds.id)])
-                    let couple_filter_records = couple_ds.getAll().filter((couple_record) =>{
-                        return couple_record.get("cdd_item") === record.get("cdd_item")
-                    })
-                    if(couple_filter_records.length === 1){
-                        let couple_record = couple_filter_records[0]
-                        if(couple_record !== undefined && couple_record.get('check_id')){
-                            return '<a href="javascript:open_cdd_attachment_window(\'' + couple_record.id + '\',\'' + couple_ds.id + '\',' + couple_record.get('check_id') + ');">附件</a>';
-                        }
-                    }
-                    else if(couple_filter_records.length > 1){
-                        console.error("出现多个相同的cdd_item 结果集是", couple_filter_records)
-                    }
-
-                }
-                else{
-                    return '<a href="javascript:open_cdd_attachment_window(\'' + record.id + '\',\'' + record.ds.id + '\',' + record.get('check_id') + ');">附件</a>';
-                }
-            } else if (name === 'attach_file_name' || name === 'plan_attach_file_name') {
-                if(name === 'plan_attach_file_name'){
-                    let couple_ds = $(plan_ds_arr[detail_ds_arr.indexOf(record.ds.id)])
-                    let couple_filter_records = couple_ds.getAll().filter((couple_record) =>{
-                        return couple_record.get("cdd_item") === record.get("cdd_item")
-                    })
-                    if(couple_filter_records.length === 1){
-                        let couple_record = couple_filter_records[0]
-                        if(couple_record !== undefined && couple_record.get('attach_file_name')){
-                            value = couple_record.get("attach_file_name")
-                        }
-                    }
-                }
+            if (name === 'attachment') {
+                return '<a href="javascript:open_cdd_attachment_window(\'' + record.id + '\',\'' + record.ds.id + '\',' + record.get('check_id') + ');">附件</a>';
+            } else if (name === 'attach_file_name') {
                 if (value != null) {
                     let link = '${/request/@context_path}/atm_download.lsc?attachment_id=';
                     let str = value.split(';;');
                     let url = '';
-                    for (let i = 0;i < str.length;i++) {
+                    for (let i = 0; i < str.length; i++) {
                         let temp = str[i].split('--');
                         if (!Leaf.isEmpty(temp[0])) {
                             url = url + '<a href=' + link + temp[1] + '>' + temp[0] + '</a>' + ',';
@@ -227,38 +190,12 @@
                     }
                     return url;
                 }
+            } else if (name === 'description') {
+                return sp_format(`<div title={0}>{1}</div>`, value, value)
             }
-            else if(name === 'description') {
-                let confirm_flag = record.get('confirm_flag');
-                if(confirm_flag === 'Y') {
-                    return '<div style="background: #FFB800;-webkit-border-radius: 2px;border:1px;height:3em;line-height:1.5em;">' + value + '</div>';
-                }else{
-                    return value;
-                }
-            }else if (name === 'bp_attachment') {
-                return '<a href="javascript:open_bp_attachment_window(' + record.get('hn_record_id') + ');">附件</a>';
-            }
-            else if(name === 'plan_bp_attachment'){
-                let couple_ds = $(plan_ds_arr[detail_ds_arr.indexOf(record.ds.id)])
-                let couple_filter_records = couple_ds.getAll().filter((couple_record) =>{
-                    return couple_record.get("cdd_item") === record.get("cdd_item")
-                })
-                if(couple_filter_records.length === 1){
-                    let couple_record = couple_filter_records[0]
-                    if(couple_record !== undefined && couple_record.get('hn_record_id')){
-                        return '<a href="javascript:open_bp_attachment_window(' + couple_record.get('hn_record_id') + ');">附件</a>';
-                    }
-                }
-            }else if(name === 'seq_num'){
-                return $(record.ds.id).indexOf(record) + 1
-            }
         }
-        function setTab(tab,display){
-            Ext.fly(tab).setStyle({
-                display:display
-            });
-        }
-        function archive_detail_ds_load(ds){
+
+        function archive_detail_ds_load(ds) {
             let current_seq = '${/model/project_path/record/@current_seq}';
             let records = ds.getAll();

@@ -266,442 +203,347 @@
                 return;
             }

-            //合规性文件 文件类型默认要件类
-            if(ds.id === 'pro_report_cdd_result_ds'){
-                ds.getAll().forEach(record =>{
-                    if(!record.get("cdd_category")){
-                        record.set("cdd_category", "要件类")
-                    }
-                })
-            }
-
-            if("${/session/@user_id}" === "1"){
-                for (var j = 0;j < records.length;j++) {
-                    records[j].getField('important_concerns').setReadOnly(true);
-                    records[j].getField('note').setReadOnly(true);
-                    records[j].getField('feedback').setReadOnly(true);
-                    records[j].getField('arch_par_has_flag').setReadOnly(true);
-                    records[j].getField('arch_par_has_flag_desc').setReadOnly(true);
-
-                }
-            }
-
-            if(current_seq === '10'){
-                for (var j = 0;j < records.length;j++) {
-                    records[j].getField('arch_par_has_flag').setReadOnly(false);
-                    records[j].getField('arch_par_has_flag_desc').setReadOnly(false);
-                    //records[j].getField('sign_num').setReadOnly(true);
-
-                }
-            }
-            else if(current_seq === '20'){
-                for (var j = 0;j < records.length;j++) {
-                    records[j].getField('note').setReadOnly(true);
-                    //records[j].getField('important_concerns').setReadOnly(true);
-                }
-            }
-        }
-
-        function prj_plan_confirm4(){
-            arch002_payment_grid_confirm_func("Y")
-        }
-
-        function prj_plan_cancel4(){
-            arch002_payment_grid_confirm_func("")
-        }
-
-        function arch002_payment_grid_confirm_func(status) {
-            var records=$('archive_payment_cdd_result_ds').getSelected();
-
-            if (records.length==0){
-                Leaf.showMessage('${l:PROMPT}', '请至少勾选一项！');
-                return;
-            }
-            for (var i = 0; i < records.length; i++) {
-                Leaf.request({
-                    url: '${/request/@context_path}/autocrud/csh.CSH900.hn_con_payment_conditions_detail_new/delete',
-                    para: {
-                        condition_id: records[i].get('condition_id'),
-                        status:status
-                    },
-                    success: function (args) {
-                        Leaf.SideBar.show({
-                            msg: '保存成功',
-                            duration: 2000
-                        });
-                        $('archive_payment_cdd_result_ds').query();
-                    },
-                    scope: this
-                });
-            }
-        }
-
-        //
-        //        Leaf.onReady(()=>{
-        //            let current_seq = '${/model/project_path/record/@current_seq}';
-        //
-        //        if(current_seq === '10'){
-        //            for (let i= 1 ; i< 13 ;i++){
-        //                let gird_name = 'archive_file_grid'+ i+'_id';
-        //                let save_btn_name = 'save_btn'+ i;
-        //                let mark_btn_name = 'mark_btn'+ i;
-        //
-        ////                if(document.getElementById(save_btn_name) != null){
-        ////                    document.getElementById(save_btn_name).remove()
-        ////                }
-        //
-        //
-        //            }
-        //        }else if(current_seq === '20') {
-        //            for (let i = 1; i < 13; i++) {
-        //                let gird_name = 'archive_file_grid' + i + '_id';
-        //                let save_btn_name = 'save_btn' + i;
-        //                let confirm_btn_name = 'confirm_btn' + i;
-        //
-        //                let cancel_btn_name = 'cancel_btn' + i;
-        ////                if (document.getElementById(gird_name) != null) {
-        ////                    let grid_id = $(gird_name);
-        ////                    grid_id.hideColumn('arch_par_has_flag_desc');
-        ////                    grid_id.hideColumn('receive_flag_desc');
-        ////                }
-        //                if (document.getElementById(save_btn_name) != null) {
-        //                    document.getElementById(save_btn_name).remove()
-        //                }
-        ////                if (document.getElementById(confirm_btn_name) != null) {
-        ////                    document.getElementById(confirm_btn_name).remove()
-        ////                }
-        //
-        ////                if (document.getElementById(cancel_btn_name) !== null) {
-        ////                    document.getElementById(cancel_btn_name).remove()
-        ////                }
-        //            }
-        //        }
-        //        })
-
-
-        function prj_plan_confirm(status,ds_id){
-            var records=$(ds_id).getSelected();
-            let para_str = $(ds_id).queryurl.split("?")[1].split("&")
-            let attachment_tab_group, cdd_list_id
-            para_str.forEach(para =>{
-                let para_name = para.split("=")[0]
-                let para_value = para.split("=")[1]
-                if(para_name === 'attachment_tab_group'){
-                    attachment_tab_group = para_value
-                } else if(para_name === 'cdd_list_id'){
-                    cdd_list_id = para_value
+
+            ds.getAll().forEach(record => {
+                if ('${/parameter/@function_usage}' === 'QUERY') {
+                    sp_rec_readonly(record)
+                }
+                if (current_seq !== '20') {
+                    record.getField('feedback').setReadOnly(true);
+                } else {
+                    record.getField('note').setReadOnly(true);
                 }
             })
-
-
-            if (records.length==0){
-                Leaf.showMessage('${l:PROMPT}', '请至少勾选一项！');
-                return;
-            }
-
-            //先标记再反选
-            for (var i = 0; i < records.length; i++) {
-                Leaf.request({
-                    url: '${/request/@context_path}/autocrud/acrch.ARCHIVE002.arch002_project_info/update',
-                    para: {
-                        check_id: records[i].get('check_id'),
-                        status
-                    },
-                    success:function(){
-                        $(ds_id).query();
-                    },
-                    scope: this
-                });
-            }
-
-            if(status === 'M'){
-                //反选操作
-                Leaf.request({
-                    url: '${/request/@context_path}/autocrud/acrch.ARCHIVE002.arch002_project_info/execute',
-                    para: {
-                        attachment_tab_group,
-                        cdd_list_id
-                    },
-                    success: function (args) {
-                        Leaf.SideBar.show({
-                            msg: '保存成功',
-                            duration: 2000
-                        });
-                        $(ds_id).query();
-                    },
-                    scope: this
-                });
-            }
-        }
-
-
-        function prj_plan_confirm1(){
-            prj_plan_confirm("M","archive_prj_bp_cdd_result_ds");
-        }
-
-        function prj_plan_cancel1(){
-            prj_plan_confirm("Y","archive_prj_bp_cdd_result_ds");
-        }
-
-        function prj_plan_confirm2(){
-            prj_plan_confirm("M","pro_report_cdd_result_ds");
-        }
-
-        function prj_plan_cancel2(){
-            prj_plan_confirm("Y","pro_report_cdd_result_ds");
-        }
-
-        function prj_plan_confirm3(){
-            prj_plan_confirm("M","prj_report_cdd_result_ds");
-        }
-
-        function prj_plan_cancel3(){
-            prj_plan_confirm("Y","prj_report_cdd_result_ds");
         }

-        //        function prj_plan_confirm4(){
-        //            prj_plan_confirm("Y","archive_prj_bp_cdd_result_ds");
-        //        }
-        //
-        //        function prj_plan_cancel4(){
-        //            prj_plan_confirm("N","archive_prj_bp_cdd_result_ds");
-        //        }

-
-        function prj_plan_confirm5(){
-            prj_plan_confirm("M","archive_sign_cdd_result_ds");
-        }
-
-        function prj_plan_cancel5(){
-            prj_plan_confirm("Y","archive_sign_cdd_result_ds");
-        }
-
-        function prj_plan_confirm6(){
-            prj_plan_confirm("M","archive_change_bp_cdd_result_ds");
+        function archive_submit_handler(ds) {
+            let current_seq = '${/model/project_path/record/@current_seq}';
+            if (current_seq === '20') {
+                ds.getAll().forEach(rec => {
+                    if (rec.get("archive_status") === 'ARCHIVING' || rec.get("archive_status") === "ARCHIVED") {
+                        rec.set("archive_status", 'ARCHIVED')
+                        rec.set("archive_status_n", '已归档')
+                        rec.set("archive_date", new Date())
+                    } else {
+                        rec.set("archive_date", '')
+                    }
+                })
+            }
+            return true
         }

-        function prj_plan_cancel6(){
-            prj_plan_confirm("Y","archive_change_bp_cdd_result_ds");
-        }
-
-        function prj_plan_confirm7(){
-            prj_plan_confirm("M","pro_report_cdd_result_ds");
-        }
-
-        function prj_plan_cancel7(){
-            prj_plan_confirm("Y","pro_report_cdd_result_ds");
-        }
-
-        function prj_plan_confirm8(){
-            prj_plan_confirm("M","prj_report_cdd_result_ds");
-        }
-
-        function prj_plan_cancel8(){
-            prj_plan_confirm("Y","prj_report_cdd_result_ds");
-        }
-
-        function prj_plan_confirm9(){
-            prj_plan_confirm("M","prj_report_cdd_result_ds");
-        }
-
-        function prj_plan_cancel9(){
-            prj_plan_confirm("Y","prj_report_cdd_result_ds");
-        }
-
-        /**
-         * 为项目报告ds添加动态查询参数
-         */
-        function prj_report_query(ds, qpara){
-            if('${/parameter/@submit_from}' === 'PRJ_PLAN_REPORT' && '${/parameter/@document_type}' === 'PRJF') {
-                qpara['attachment_tab_group'] = 'PRJ_CHANGE'
-            }
-            else{
-                qpara['attachment_tab_group'] = 'PRJ_CHANGE'
-            }
-        }
-
-        function archive_detail_query(ds, qpara){
-
-                qpara['attachment_tab_group'] = ''
-        }
-
-        // 合规性材料All
-        function pro_report_query(ds, qpara){
-            if(('${/parameter/@submit_from}' === 'PRJ_PLAN' || '${/parameter/@submit_from}' === 'PRJ_PLAN_CHANGE') && '${/parameter/@document_type}' === 'PRJF') {
-                if('${/parameter/@receive_type}' === 'NOW'){
-                    qpara['attachment_tab_group'] = 'COMPLIANCE_PRJF_NOW'
-                } else{
-                    qpara['attachment_tab_group'] = 'COMPLIANCE_PRJF_FUTURE'
-                }
-            }
+        function archive_update_handler(ds, record, name, value) {
+            if (name === 'archive_status') {
+                if (value === 'NOT_ARCHIVE' || value === 'NOT_NEED_ARCHIVE') {
+                    record.getField("note").setRequired(true)
+                    record.getField("note").setReadOnly(false)
+                } else {
+                    record.getField("note").setRequired(false)
+                    if ('${/model/project_path/record/@current_seq}' === '20') {
+                        record.getField("note").setReadOnly(true)
+                    }
+                }
+            }
+        }
+
+        Leaf.onReady(async function () {
+            view_property.dataset_id.forEach(ds_id => {
+                const ds = $(ds_id)
+                ds.on("submitsuccess", () => {
+                    ds.query()
+                })
+            })
+
+            sp_output_view_info()
+
+
+            let current_seq = '${/model/project_path/record/@current_seq}';
+            if (current_seq !== '20') {
+                for (let i in range(9)) {
+                    console.log(i)
+                    const btn_id = sp_format(`save_btn{0}_s`, i)
+                    if (document.getElementById(btn_id)) {
+                        document.getElementById(btn_id).remove()
+                    }
+                }
+            }
+            if ('${/parameter/@function_usage}' === 'QUERY') {
+                for (let i in range(9)) {
+                    const btn_id = sp_format(`save_btn{0}`, i)
+                    if (document.getElementById(btn_id)) {
+                        document.getElementById(btn_id).remove()
+                    }
+                }
+            }
+        });
+
+
+        //工作流中同意按钮调用效验
+        if (typeof (zjwfl5110_ApproveChecker_add) !== "undefined") {
+            zjwfl5110_ApproveChecker_add('agree', function () {
+                //判断是否有脏数据
+                return view_property["dataset_id"].every(ds_id => {
+                    return sp_ds_dirty_valid($(ds_id))
+                })
+            });
+        }

-            else{
-                qpara['attachment_tab_group'] = 'PROJECT'
+        //工作流同意提示框设定 width 提示框宽度
+
+        function zjwfl5110_setConfirmWin() {
+            return {
+                text: view_property.tab_desc.join("、") + "已确认？"
             }
-            console.log(qpara['attachment_tab_group'])
         }

+        function archive_report_save() {
+            const ds = $("archive_report_ds")
+            archive_submit_handler(ds)
+            ds.submit()
+        }

+        function archive_prj_plan_bp_save() {
+            const ds = $("archive_prj_plan_bp_ds")
+            archive_submit_handler(ds)
+            ds.submit()
+        }
+
+        function archive_compliance_materials_save() {
+            const ds = $("archive_compliance_materials_ds")
+            archive_submit_handler(ds)
+            ds.submit()
+        }
+
+        function archive_payment_save() {
+            const ds = $("archive_payment_ds")
+            archive_submit_handler(ds)
+            ds.submit()
+        }
+
+        function archive_contract_sign_save() {
+            const ds = $("archive_contract_sign_ds")
+            archive_submit_handler(ds)
+            ds.submit()
+        }
+
+        function archive_prj_change_bp_save() {
+            const ds = $("archive_prj_change_bp_ds")
+            archive_submit_handler(ds)
+            ds.submit()
+        }


         ]]></script>
-        <a:screen-include screen="modules/cont/CON500/con_contract_get_layout_code.lview"/>
         <a:dataSets>
             <a:dataSet id="yes_no_ds" lookupCode="YES_NO"/>
             <a:dataSet id="acrch_type_ds" lookupCode="ACRCH_TYPE"/>

+            <a:switch test="/model/project_path/record/@current_seq">
+                <a:case value="20">
+                    <a:dataSet id="archive_status_ds" lookupCode="ARCHIVE_STATUS_ADMIN"/>
+                </a:case>
+                <a:case value="*">
+                    <a:dataSet id="archive_status_ds" lookupCode="ARCHIVE_STATUS"/>
+                </a:case>
+            </a:switch>
+
+
             <a:dataSet id="arch002_project_info_ds">
                 <a:datas dataSource="/model/project_path"/>
             </a:dataSet>

-            <a:dataSet id="archive_prj_bp_cdd_result_ds" autoQuery="true" fetchAll="true"
+            <!--客户资信资料 => 项目方案-->
+            <a:dataSet id="archive_prj_plan_bp_ds" autoQuery="true" fetchAll="true"
                        model="acrch.ARCHIVE002.server_layout_doc_cdd_item" pageSize="11"
-                       queryUrl="${/request/@context_path}/autocrud/acrch.ARCHIVE002.server_layout_doc_cdd_item/query?base_table_pk=${/parameter/@archive_batch_id}&amp;document_table=FILE_ARCHIVE_BATCH&amp;cdd_list_id=${/model/project_path/record/@arch_cdd_list_id}&amp;attachment_tab_group=TENANT&amp;arch_not_required_flag=N"
+                       queryUrl="${/request/@context_path}/autocrud/acrch.ARCHIVE002.server_layout_doc_cdd_item/query?base_table_pk=${/parameter/@archive_batch_id}&amp;document_table=FILE_ARCHIVE_BATCH&amp;cdd_list_id=${/model/project_path/record/@arch_cdd_list_id}&amp;attachment_tab_group=TENANT&amp;fix_category=MANAGER&amp;current_seq=${/model/project_path/record/@current_seq}"
                        selectable="true">
                 <a:fields>
-                    <a:field name="note"/>
-                    <a:field name="cdd_category"/>
-                    <a:field name="description"/>
+                    <a:field name="note" requiredMessage="请给暂不归档和无需归档的文件填写说明"/>
                     <a:field name="arch_required_flag" readOnly="true"/>
-                    <a:field name="arch_required_flag_desc" readOnly="true" displayField="code_value_name" options="yes_no_ds" returnField="arch_required_flag" valueField="code_value"/>
-                    <a:field name="arch_par_has_flag"  defaultValue="Y"/>
-                    <a:field name="arch_par_has_flag_desc"  displayField="code_value_name" options="acrch_type_ds" returnField="arch_par_has_flag" valueField="code_value"/>
+                    <a:field name="arch_required_flag_desc" readOnly="true" displayField="code_value_name"
+                             options="yes_no_ds" returnField="arch_required_flag" valueField="code_value"/>
+                    <a:field name="arch_par_has_flag" defaultValue="Y"/>
+                    <a:field name="arch_par_has_flag_desc" displayField="code_value_name" options="acrch_type_ds"
+                             returnField="arch_par_has_flag" valueField="code_value"/>
+                    <a:field name="archive_status" defaultValue="ARCHIVING"/>
+                    <a:field name="archive_status_desc" displayField="code_value_name" options="archive_status_ds"
+                             returnField="archive_status" valueField="code_value"/>
                     <a:field name="arch_paper_required_flag" readOnly="true"/>
-                    <a:field name="arch_paper_required_flag_desc" readOnly="true" displayField="code_value_name" options="yes_no_ds" returnField="arch_paper_required_flag" valueField="code_value"/>
+                    <a:field name="arch_paper_required_flag_desc" readOnly="true" displayField="code_value_name"
+                             options="yes_no_ds" returnField="arch_paper_required_flag" valueField="code_value"/>
                     <a:field name="receive_flag" defaultValue="Y" readOnly="true"/>
-                    <a:field name="receive_flag_desc" readOnly="true" displayField="code_value_name" options="yes_no_ds" returnField="receive_flag" valueField="code_value"/>
+                    <a:field name="receive_flag_desc" readOnly="true" displayField="code_value_name" options="yes_no_ds"
+                             returnField="receive_flag" valueField="code_value"/>
                 </a:fields>
                 <a:events>
                     <a:event name="load" handler="archive_detail_ds_load"/>
-                    <a:event name="query" handler="archive_detail_query"/>
+                    <a:event name="update" handler="archive_update_handler"/>
                 </a:events>
             </a:dataSet>
-
-            <a:dataSet id="archive_change_bp_cdd_result_ds" autoQuery="true" fetchAll="true"
+            <!--项目方案附件 => 项目方案变更-->
+            <a:dataSet id="archive_prj_change_bp_ds" autoQuery="true" fetchAll="true"
                        model="acrch.ARCHIVE002.server_layout_doc_cdd_item" pageSize="11"
-                       queryUrl="${/request/@context_path}/autocrud/acrch.ARCHIVE002.server_layout_doc_cdd_item/query?base_table_pk=${/parameter/@archive_batch_id}&amp;document_table=FILE_ARCHIVE_BATCH&amp;cdd_list_id=${/model/project_path/record/@arch_cdd_list_id}&amp;attachment_tab_group=TENANT&amp;arch_not_required_flag=N"
+                       queryUrl="${/request/@context_path}/autocrud/acrch.ARCHIVE002.server_layout_doc_cdd_item/query?base_table_pk=${/parameter/@archive_batch_id}&amp;document_table=FILE_ARCHIVE_BATCH&amp;cdd_list_id=${/model/project_path/record/@arch_cdd_list_id}&amp;attachment_tab_group=PROJECT&amp;fix_category=REQUIREMENT&amp;current_seq=${/model/project_path/record/@current_seq}"
                        selectable="true">
                 <a:fields>
-                    <a:field name="note"/>
-                    <a:field name="cdd_category"/>
-                    <a:field name="description"/>
+                    <a:field name="note" requiredMessage="请给暂不归档和无需归档的文件填写说明"/>
                     <a:field name="arch_required_flag" readOnly="true"/>
-                    <a:field name="arch_required_flag_desc" readOnly="true" displayField="code_value_name" options="yes_no_ds" returnField="arch_required_flag" valueField="code_value"/>
-                    <a:field name="arch_par_has_flag"  defaultValue="Y"/>
-                    <a:field name="arch_par_has_flag_desc"  displayField="code_value_name" options="acrch_type_ds" returnField="arch_par_has_flag" valueField="code_value"/>
+                    <a:field name="arch_required_flag_desc" readOnly="true" displayField="code_value_name"
+                             options="yes_no_ds" returnField="arch_required_flag" valueField="code_value"/>
+                    <a:field name="arch_par_has_flag" defaultValue="Y"/>
+                    <a:field name="arch_par_has_flag_desc" displayField="code_value_name" options="acrch_type_ds"
+                             returnField="arch_par_has_flag" valueField="code_value"/>
                     <a:field name="arch_paper_required_flag" readOnly="true"/>
-                    <a:field name="arch_paper_required_flag_desc" readOnly="true" displayField="code_value_name" options="yes_no_ds" returnField="arch_paper_required_flag" valueField="code_value"/>
+                    <a:field name="arch_paper_required_flag_desc" readOnly="true" displayField="code_value_name"
+                             options="yes_no_ds" returnField="arch_paper_required_flag" valueField="code_value"/>
                     <a:field name="receive_flag" defaultValue="Y" readOnly="true"/>
-                    <a:field name="receive_flag_desc" readOnly="true" displayField="code_value_name" options="yes_no_ds" returnField="receive_flag" valueField="code_value"/>
+                    <a:field name="receive_flag_desc" readOnly="true" displayField="code_value_name" options="yes_no_ds"
+                             returnField="receive_flag" valueField="code_value"/>
+                    <a:field name="archive_status" defaultValue="ARCHIVING"/>
+                    <a:field name="archive_status_desc" displayField="code_value_name" options="archive_status_ds"
+                             returnField="archive_status" valueField="code_value"/>
                 </a:fields>
                 <a:events>
                     <a:event name="load" handler="archive_detail_ds_load"/>
-                    <a:event name="query" handler="archive_detail_query"/>
+                    <a:event name="update" handler="archive_update_handler"/>
                 </a:events>
             </a:dataSet>
-
-            <a:dataSet id="archive_payment_cdd_result_ds" autoQuery="true" fetchAll="true"
+            <!--放款前提材料 => 付款先决落实-->
+            <a:dataSet id="archive_payment_ds" autoQuery="true" fetchAll="true"
                        model="csh.CSH900.hn_con_payment_conditions_detail_new" pageSize="11"
-                       queryUrl="${/request/@context_path}/autocrud/csh.CSH900.hn_con_payment_conditions_detail_new/query?archive_batch_id=${/parameter/@archive_batch_id}&amp;arch_not_required_flag=N"
+                       queryUrl="${/request/@context_path}/autocrud/csh.CSH900.hn_con_payment_conditions_detail_new/query?archive_batch_id=${/parameter/@archive_batch_id}&amp;current_seq=${/model/project_path/record/@current_seq}"
                        selectable="true">
                 <a:fields>
-                    <a:field name="note"/>
-                    <a:field name="description"/>
+                    <a:field name="note" requiredMessage="请给暂不归档和无需归档的文件填写说明"/>
                     <a:field name="arch_required_flag" readOnly="true"/>
-                    <a:field name="arch_required_flag_desc" readOnly="true" displayField="code_value_name" options="yes_no_ds" returnField="arch_required_flag" valueField="code_value"/>
+                    <a:field name="arch_required_flag_desc" readOnly="true" displayField="code_value_name"
+                             options="yes_no_ds" returnField="arch_required_flag" valueField="code_value"/>
                     <a:field name="arch_par_has_flag" defaultValue="Y"/>
-                    <a:field name="arch_par_has_flag_desc" displayField="code_value_name" options="acrch_type_ds" returnField="arch_par_has_flag" valueField="code_value"/>
+                    <a:field name="arch_par_has_flag_desc" displayField="code_value_name" options="acrch_type_ds"
+                             returnField="arch_par_has_flag" valueField="code_value"/>
                     <a:field name="arch_paper_required_flag"/>
-                    <a:field name="arch_paper_required_flag_desc" displayField="code_value_name" options="yes_no_ds" returnField="arch_paper_required_flag" valueField="code_value"/>
+                    <a:field name="arch_paper_required_flag_desc" displayField="code_value_name" options="yes_no_ds"
+                             returnField="arch_paper_required_flag" valueField="code_value"/>
                     <a:field name="receive_flag" defaultValue="Y"/>
-                    <a:field name="receive_flag_desc" displayField="code_value_name" options="yes_no_ds" returnField="receive_flag" valueField="code_value"/>
+                    <a:field name="receive_flag_desc" displayField="code_value_name" options="yes_no_ds"
+                             returnField="receive_flag" valueField="code_value"/>
+                    <a:field name="archive_status" defaultValue="ARCHIVING"/>
+                    <a:field name="archive_status_desc" displayField="code_value_name" options="archive_status_ds"
+                             returnField="archive_status" valueField="code_value"/>
                 </a:fields>
                 <a:events>
                     <a:event name="load" handler="archive_detail_ds_load"/>
+                    <a:event name="update" handler="archive_update_handler"/>
                 </a:events>
             </a:dataSet>

-            <a:dataSet id="archive_sign_cdd_result_ds" autoQuery="true" fetchAll="true"
+            <!--签约执行材料 => 合同签约-->
+            <a:dataSet id="archive_contract_sign_ds" autoQuery="true" fetchAll="true"
                        model="acrch.ARCHIVE002.server_layout_doc_cdd_item" pageSize="11"
-                       queryUrl="${/request/@context_path}/autocrud/acrch.ARCHIVE002.server_layout_doc_cdd_item/query?base_table_pk=${/parameter/@archive_batch_id}&amp;document_table=FILE_ARCHIVE_BATCH&amp;cdd_list_id=${/model/project_path/record/@arch_cdd_list_id}&amp;attachment_tab_group=SIGN&amp;arch_not_required_flag=N"
+                       queryUrl="${/request/@context_path}/autocrud/acrch.ARCHIVE002.server_layout_doc_cdd_item/query?base_table_pk=${/parameter/@archive_batch_id}&amp;document_table=FILE_ARCHIVE_BATCH&amp;cdd_list_id=${/model/project_path/record/@arch_cdd_list_id}&amp;attachment_tab_group=SIGN&amp;current_seq=${/model/project_path/record/@current_seq}"
                        selectable="true">
                 <a:fields>
-                    <a:field name="note"/>
-                    <a:field name="description"/>
+                    <a:field name="note" requiredMessage="请给暂不归档和无需归档的文件填写说明"/>
                     <a:field name="arch_required_flag" readOnly="true"/>
-                    <a:field name="arch_required_flag_desc" readOnly="true" displayField="code_value_name" options="yes_no_ds" returnField="arch_required_flag" valueField="code_value"/>
+                    <a:field name="arch_required_flag_desc" readOnly="true" displayField="code_value_name"
+                             options="yes_no_ds" returnField="arch_required_flag" valueField="code_value"/>
                     <a:field name="arch_par_has_flag" defaultValue="Y"/>
-                    <a:field name="arch_par_has_flag_desc" displayField="code_value_name" options="acrch_type_ds" returnField="arch_par_has_flag" valueField="code_value"/>
+                    <a:field name="arch_par_has_flag_desc" displayField="code_value_name" options="acrch_type_ds"
+                             returnField="arch_par_has_flag" valueField="code_value"/>
                     <a:field name="arch_paper_required_flag"/>
-                    <a:field name="arch_paper_required_flag_desc" displayField="code_value_name" options="yes_no_ds" returnField="arch_paper_required_flag" valueField="code_value"/>
+                    <a:field name="arch_paper_required_flag_desc" displayField="code_value_name" options="yes_no_ds"
+                             returnField="arch_paper_required_flag" valueField="code_value"/>
                     <a:field name="receive_flag" defaultValue="Y"/>
-                    <a:field name="receive_flag_desc" displayField="code_value_name" options="yes_no_ds" returnField="receive_flag" valueField="code_value"/>
+                    <a:field name="receive_flag_desc" displayField="code_value_name" options="yes_no_ds"
+                             returnField="receive_flag" valueField="code_value"/>
+                    <a:field name="archive_status" defaultValue="ARCHIVING"/>
+                    <a:field name="archive_status_desc" displayField="code_value_name" options="archive_status_ds"
+                             returnField="archive_status" valueField="code_value"/>
                 </a:fields>
                 <a:events>
                     <a:event name="load" handler="archive_detail_ds_load"/>
+                    <a:event name="update" handler="archive_update_handler"/>
                 </a:events>
             </a:dataSet>

-            <a:dataSet id="pro_report_cdd_result_ds" autoQuery="true" fetchAll="true"
+            <!--合规性材料 => 项目方案&项目方案变更-->
+            <a:dataSet id="archive_compliance_materials_ds" autoQuery="true" fetchAll="true"
                        model="acrch.ARCHIVE002.server_layout_doc_cdd_item" pageSize="11"
-                       queryUrl="${/request/@context_path}/autocrud/acrch.ARCHIVE002.server_layout_doc_cdd_item/query?base_table_pk=${/parameter/@archive_batch_id}&amp;document_table=FILE_ARCHIVE_BATCH&amp;cdd_list_id=${/model/project_path/record/@arch_cdd_list_id}&amp;arch_not_required_flag=N"
+                       queryUrl="${/request/@context_path}/autocrud/acrch.ARCHIVE002.server_layout_doc_cdd_item/query?base_table_pk=${/parameter/@archive_batch_id}&amp;document_table=FILE_ARCHIVE_BATCH&amp;cdd_list_id=${/model/project_path/record/@arch_cdd_list_id}&amp;attachment_tab_group=PROJECT&amp;fix_category=REQUIREMENT&amp;current_seq=${/model/project_path/record/@current_seq}"
                        selectable="true">
                 <a:fields>
-                    <a:field name="note"/>
-                    <a:field name="description"/>
+                    <a:field name="note" requiredMessage="请给暂不归档和无需归档的文件填写说明"/>
                     <a:field name="arch_required_flag" readOnly="true"/>
-                    <a:field name="arch_required_flag_desc" readOnly="true" displayField="code_value_name" options="yes_no_ds" returnField="arch_required_flag" valueField="code_value"/>
+                    <a:field name="arch_required_flag_desc" readOnly="true" displayField="code_value_name"
+                             options="yes_no_ds" returnField="arch_required_flag" valueField="code_value"/>
                     <a:field name="arch_par_has_flag" defaultValue="Y"/>
-                    <a:field name="arch_par_has_flag_desc" displayField="code_value_name" options="acrch_type_ds" returnField="arch_par_has_flag" valueField="code_value"/>
+                    <a:field name="arch_par_has_flag_desc" displayField="code_value_name" options="acrch_type_ds"
+                             returnField="arch_par_has_flag" valueField="code_value"/>
                     <a:field name="arch_paper_required_flag"/>
-                    <a:field name="arch_paper_required_flag_desc" displayField="code_value_name" options="yes_no_ds" returnField="arch_paper_required_flag" valueField="code_value"/>
+                    <a:field name="arch_paper_required_flag_desc" displayField="code_value_name" options="yes_no_ds"
+                             returnField="arch_paper_required_flag" valueField="code_value"/>
                     <a:field name="receive_flag" defaultValue="Y"/>
-                    <a:field name="receive_flag_desc" displayField="code_value_name" options="yes_no_ds" returnField="receive_flag" valueField="code_value"/>
+                    <a:field name="receive_flag_desc" displayField="code_value_name" options="yes_no_ds"
+                             returnField="receive_flag" valueField="code_value"/>
+                    <a:field name="archive_status" defaultValue="ARCHIVING"/>
+                    <a:field name="archive_status_desc" displayField="code_value_name" options="archive_status_ds"
+                             returnField="archive_status" valueField="code_value"/>
                 </a:fields>
                 <a:events>
                     <a:event name="load" handler="archive_detail_ds_load"/>
-                    <a:event name="query" handler="pro_report_query"/>
+                    <a:event name="update" handler="archive_update_handler"/>
                 </a:events>
             </a:dataSet>

-            <a:dataSet id="prj_report_cdd_result_ds" autoQuery="true" fetchAll="true"
+            <!--项目报告 => 项目方案&项目方案变更-->
+            <a:dataSet id="archive_report_ds" autoQuery="true" fetchAll="true"
                        model="acrch.ARCHIVE002.server_layout_doc_cdd_item" pageSize="11"
-                       queryUrl="${/request/@context_path}/autocrud/acrch.ARCHIVE002.server_layout_doc_cdd_item/query?base_table_pk=${/parameter/@archive_batch_id}&amp;document_table=FILE_ARCHIVE_BATCH&amp;cdd_list_id=${/model/project_path/record/@arch_cdd_list_id}&amp;arch_not_required_flag=N"
+                       queryUrl="${/request/@context_path}/autocrud/acrch.ARCHIVE002.server_layout_doc_cdd_item/query?base_table_pk=${/parameter/@archive_batch_id}&amp;document_table=FILE_ARCHIVE_BATCH&amp;cdd_list_id=${/model/project_path/record/@arch_cdd_list_id}&amp;attachment_tab_group=PRJ_CHANGE&amp;fix_category=MANAGER&amp;current_seq=${/model/project_path/record/@current_seq}"
                        selectable="true">
                 <a:fields>
-                    <a:field name="note"/>
-                    <a:field name="description"/>
+                    <a:field name="note" requiredMessage="请给暂不归档和无需归档的文件填写说明"/>
                     <a:field name="arch_required_flag" readOnly="true"/>
-                    <a:field name="arch_required_flag_desc" readOnly="true" displayField="code_value_name" options="yes_no_ds" returnField="arch_required_flag" valueField="code_value"/>
+                    <a:field name="arch_required_flag_desc" readOnly="true" displayField="code_value_name"
+                             options="yes_no_ds" returnField="arch_required_flag" valueField="code_value"/>
                     <a:field name="arch_par_has_flag" defaultValue="Y"/>
-                    <a:field name="arch_par_has_flag_desc" displayField="code_value_name" options="acrch_type_ds" returnField="arch_par_has_flag" valueField="code_value"/>
+                    <a:field name="arch_par_has_flag_desc" displayField="code_value_name" options="acrch_type_ds"
+                             returnField="arch_par_has_flag" valueField="code_value"/>
                     <a:field name="arch_paper_required_flag"/>
-                    <a:field name="arch_paper_required_flag_desc" displayField="code_value_name" options="yes_no_ds" returnField="arch_paper_required_flag" valueField="code_value"/>
+                    <a:field name="arch_paper_required_flag_desc" displayField="code_value_name" options="yes_no_ds"
+                             returnField="arch_paper_required_flag" valueField="code_value"/>
                     <a:field name="receive_flag" defaultValue="Y"/>
-                    <a:field name="receive_flag_desc" displayField="code_value_name" options="yes_no_ds" returnField="receive_flag" valueField="code_value"/>
+                    <a:field name="receive_flag_desc" displayField="code_value_name" options="yes_no_ds"
+                             returnField="receive_flag" valueField="code_value"/>
+                    <a:field name="archive_status" defaultValue="ARCHIVING"/>
+                    <a:field name="archive_status_desc" displayField="code_value_name" options="archive_status_ds"
+                             returnField="archive_status" valueField="code_value"/>
                 </a:fields>
                 <a:events>
                     <a:event name="load" handler="archive_detail_ds_load"/>
-                    <a:event name="query" handler="prj_report_query"/>
+                    <a:event name="update" handler="archive_update_handler"/>
                 </a:events>
             </a:dataSet>
         </a:dataSets>

         <a:screenBody>
             <a:switch test="/parameter/@archive_flag">
-                <a:case value="N">
-
-                </a:case>
+                <a:case value="N"/>
                 <a:case value="*">
                     <a:switch test="/parameter/@submit_from">
                         <a:case value="PRJ_PLAN">
                             <a:form marginWidth="25" title="基本信息">
                                 <a:hBox labelWidth="100">
-                                    <a:textField name="bp_id_tenant_n" bindTarget="arch002_project_info_ds" prompt="承租人名称" width="200" readOnly="true"/>
-                                    <a:textField name="plan_number" bindTarget="arch002_project_info_ds" prompt="项目方案编号" readOnly="true"/>
-                                    <a:textField name="plan_name" bindTarget="arch002_project_info_ds" prompt="项目方案名称" readOnly="true" width="250"/>
-                                    <a:textField name="submit_by" bindTarget="arch002_project_info_ds"  prompt="归档责任人" readOnly="true"/>
-                                    <a:textField name="lease_organization_n" bindTarget="arch002_project_info_ds"  prompt="归档部门" readOnly="true"/>
+                                    <a:textField name="bp_id_tenant_n" bindTarget="arch002_project_info_ds"
+                                                 prompt="承租人名称" width="200" readOnly="true"/>
+                                    <a:textField name="plan_number" bindTarget="arch002_project_info_ds" prompt="项目方案编号"
+                                                 readOnly="true"/>
+                                    <a:textField name="plan_name" bindTarget="arch002_project_info_ds" prompt="项目方案名称"
+                                                 readOnly="true" width="250"/>
+                                    <a:textField name="submit_by" bindTarget="arch002_project_info_ds" prompt="归档责任人"
+                                                 readOnly="true"/>
+                                    <a:textField name="lease_organization_n" bindTarget="arch002_project_info_ds"
+                                                 prompt="归档部门" readOnly="true"/>
                                 </a:hBox>
                             </a:form>
                         </a:case>
@@ -709,11 +551,16 @@
                         <a:case value="PRJ_PLAN_REPORT">
                             <a:form marginWidth="25" title="基本信息">
                                 <a:hBox labelWidth="100">
-                                    <a:textField name="bp_id_tenant_n" bindTarget="arch002_project_info_ds" prompt="承租人名称" width="200" readOnly="true"/>
-                                    <a:textField name="plan_number" bindTarget="arch002_project_info_ds" prompt="项目方案编号" readOnly="true"/>
-                                    <a:textField name="plan_name" bindTarget="arch002_project_info_ds" prompt="项目方案名称" readOnly="true" width="250"/>
-                                    <a:textField name="submit_by" bindTarget="arch002_project_info_ds" prompt="归档责任人"  readOnly="true"/>
-                                    <a:textField name="lease_organization_n" bindTarget="arch002_project_info_ds"  prompt="归档部门" readOnly="true"/>
+                                    <a:textField name="bp_id_tenant_n" bindTarget="arch002_project_info_ds"
+                                                 prompt="承租人名称" width="200" readOnly="true"/>
+                                    <a:textField name="plan_number" bindTarget="arch002_project_info_ds" prompt="项目方案编号"
+                                                 readOnly="true"/>
+                                    <a:textField name="plan_name" bindTarget="arch002_project_info_ds" prompt="项目方案名称"
+                                                 readOnly="true" width="250"/>
+                                    <a:textField name="submit_by" bindTarget="arch002_project_info_ds" prompt="归档责任人"
+                                                 readOnly="true"/>
+                                    <a:textField name="lease_organization_n" bindTarget="arch002_project_info_ds"
+                                                 prompt="归档部门" readOnly="true"/>
                                 </a:hBox>
                             </a:form>
                         </a:case>
@@ -721,11 +568,16 @@
                         <a:case value="PRJ_PLAN_CHANGE">
                             <a:form marginWidth="25" title="基本信息">
                                 <a:hBox labelWidth="100">
-                                    <a:textField name="bp_id_tenant_n" bindTarget="arch002_project_info_ds" prompt="承租人名称" width="200" readOnly="true"/>
-                                    <a:textField name="plan_number" bindTarget="arch002_project_info_ds" prompt="项目方案编号" readOnly="true"/>
-                                    <a:textField name="plan_name" bindTarget="arch002_project_info_ds" prompt="项目方案名称" readOnly="true" width="250"/>
-                                    <a:textField name="submit_by" bindTarget="arch002_project_info_ds" prompt="归档责任人" readOnly="true"/>
-                                    <a:textField name="lease_organization_n" bindTarget="arch002_project_info_ds"  prompt="归档部门" readOnly="true"/>
+                                    <a:textField name="bp_id_tenant_n" bindTarget="arch002_project_info_ds"
+                                                 prompt="承租人名称" width="200" readOnly="true"/>
+                                    <a:textField name="plan_number" bindTarget="arch002_project_info_ds" prompt="项目方案编号"
+                                                 readOnly="true"/>
+                                    <a:textField name="plan_name" bindTarget="arch002_project_info_ds" prompt="项目方案名称"
+                                                 readOnly="true" width="250"/>
+                                    <a:textField name="submit_by" bindTarget="arch002_project_info_ds" prompt="归档责任人"
+                                                 readOnly="true"/>
+                                    <a:textField name="lease_organization_n" bindTarget="arch002_project_info_ds"
+                                                 prompt="归档部门" readOnly="true"/>
                                 </a:hBox>
                             </a:form>
                         </a:case>
@@ -733,11 +585,16 @@
                         <a:case value="PRJ_PLAN_REPORT_CHANGE_A">
                             <a:form marginWidth="25" title="基本信息">
                                 <a:hBox labelWidth="100">
-                                    <a:textField name="bp_id_tenant_n" bindTarget="arch002_project_info_ds" prompt="承租人名称" width="200" readOnly="true"/>
-                                    <a:textField name="plan_number" bindTarget="arch002_project_info_ds" prompt="项目方案编号" readOnly="true"/>
-                                    <a:textField name="plan_name" bindTarget="arch002_project_info_ds" prompt="项目方案名称" readOnly="true" width="250"/>
-                                    <a:textField name="submit_by" bindTarget="arch002_project_info_ds" prompt="归档责任人" readOnly="true"/>
-                                    <a:textField name="lease_organization_n" bindTarget="arch002_project_info_ds"  prompt="归档部门" readOnly="true"/>
+                                    <a:textField name="bp_id_tenant_n" bindTarget="arch002_project_info_ds"
+                                                 prompt="承租人名称" width="200" readOnly="true"/>
+                                    <a:textField name="plan_number" bindTarget="arch002_project_info_ds" prompt="项目方案编号"
+                                                 readOnly="true"/>
+                                    <a:textField name="plan_name" bindTarget="arch002_project_info_ds" prompt="项目方案名称"
+                                                 readOnly="true" width="250"/>
+                                    <a:textField name="submit_by" bindTarget="arch002_project_info_ds" prompt="归档责任人"
+                                                 readOnly="true"/>
+                                    <a:textField name="lease_organization_n" bindTarget="arch002_project_info_ds"
+                                                 prompt="归档部门" readOnly="true"/>
                                 </a:hBox>
                             </a:form>
                         </a:case>
@@ -745,11 +602,16 @@
                         <a:case value="PRJ_PLAN_REPORT_CHANGE_B">
                             <a:form marginWidth="25" title="基本信息">
                                 <a:hBox labelWidth="100">
-                                    <a:textField name="bp_id_tenant_n" bindTarget="arch002_project_info_ds" prompt="承租人名称" width="200" readOnly="true"/>
-                                    <a:textField name="plan_number" bindTarget="arch002_project_info_ds" prompt="项目方案编号" readOnly="true"/>
-                                    <a:textField name="plan_name" bindTarget="arch002_project_info_ds" prompt="项目方案名称" readOnly="true" width="250"/>
-                                    <a:textField name="submit_by" bindTarget="arch002_project_info_ds" prompt="归档责任人" readOnly="true"/>
-                                    <a:textField name="lease_organization_n" bindTarget="arch002_project_info_ds"  prompt="归档部门" readOnly="true"/>
+                                    <a:textField name="bp_id_tenant_n" bindTarget="arch002_project_info_ds"
+                                                 prompt="承租人名称" width="200" readOnly="true"/>
+                                    <a:textField name="plan_number" bindTarget="arch002_project_info_ds" prompt="项目方案编号"
+                                                 readOnly="true"/>
+                                    <a:textField name="plan_name" bindTarget="arch002_project_info_ds" prompt="项目方案名称"
+                                                 readOnly="true" width="250"/>
+                                    <a:textField name="submit_by" bindTarget="arch002_project_info_ds" prompt="归档责任人"
+                                                 readOnly="true"/>
+                                    <a:textField name="lease_organization_n" bindTarget="arch002_project_info_ds"
+                                                 prompt="归档部门" readOnly="true"/>
                                 </a:hBox>
                             </a:form>
                         </a:case>
@@ -757,30 +619,37 @@
                         <a:case value="SIGN">
                             <a:form marginWidth="25" title="基本信息">
                                 <a:hBox labelWidth="100">
-                                    <a:textField name="bp_id_tenant_n" bindTarget="arch002_project_info_ds" prompt="承租人名称" width="200" readOnly="true"/>
-                                    <a:textField name="contract_number" bindTarget="arch002_project_info_ds" prompt="合同编号" readOnly="true"/>
-                                    <a:textField name="virtual_con_name" bindTarget="arch002_project_info_ds" prompt="合同名称" readOnly="true" width="250"/>
-                                    <a:textField name="submit_by" bindTarget="arch002_project_info_ds" prompt="归档责任人" readOnly="true"/>4
-                                    <a:textField name="lease_organization_n" bindTarget="arch002_project_info_ds"  prompt="归档部门" readOnly="true"/>
+                                    <a:textField name="bp_id_tenant_n" bindTarget="arch002_project_info_ds"
+                                                 prompt="承租人名称" width="200" readOnly="true"/>
+                                    <a:textField name="contract_number" bindTarget="arch002_project_info_ds"
+                                                 prompt="合同编号" readOnly="true"/>
+                                    <a:textField name="virtual_con_name" bindTarget="arch002_project_info_ds"
+                                                 prompt="合同名称" readOnly="true" width="250"/>
+                                    <a:textField name="submit_by" bindTarget="arch002_project_info_ds" prompt="归档责任人"
+                                                 readOnly="true"/>
+                                    4
+                                    <a:textField name="lease_organization_n" bindTarget="arch002_project_info_ds"
+                                                 prompt="归档部门" readOnly="true"/>
                                 </a:hBox>
-                                <a:hBox labelWidth="120">
-                                    <a href="javascript:winOpen_contractDetailInfo();" style="margin-left:120px;text-decoration:underline">合同明细</a>
-                                </a:hBox>
+
                             </a:form>
                         </a:case>

                         <a:case value="*">
                             <a:form marginWidth="25" title="基本信息">
                                 <a:hBox labelWidth="100">
-                                    <a:textField name="bp_id_tenant_n" bindTarget="arch002_project_info_ds" prompt="承租人名称" width="200" readOnly="true"/>
-                                    <a:textField name="project_number" bindTarget="arch002_project_info_ds" prompt="项目编号" readOnly="true"/>
-                                    <a:textField name="project_name" bindTarget="arch002_project_info_ds" prompt="项目名称" readOnly="true" width="250"/>
-                                    <a:textField name="submit_by" bindTarget="arch002_project_info_ds" prompt="归档责任人" readOnly="true"/>
-                                    <a:textField name="lease_organization_n" bindTarget="arch002_project_info_ds"  prompt="归档部门" readOnly="true"/>
+                                    <a:textField name="bp_id_tenant_n" bindTarget="arch002_project_info_ds"
+                                                 prompt="承租人名称" width="200" readOnly="true"/>
+                                    <a:textField name="project_number" bindTarget="arch002_project_info_ds"
+                                                 prompt="项目编号" readOnly="true"/>
+                                    <a:textField name="project_name" bindTarget="arch002_project_info_ds" prompt="项目名称"
+                                                 readOnly="true" width="250"/>
+                                    <a:textField name="submit_by" bindTarget="arch002_project_info_ds" prompt="归档责任人"
+                                                 readOnly="true"/>
+                                    <a:textField name="lease_organization_n" bindTarget="arch002_project_info_ds"
+                                                 prompt="归档部门" readOnly="true"/>
                                 </a:hBox>
-                                <a:hBox labelWidth="120">
-                                    <a href="javascript:winOpen_projectDetailInfo();" style="margin-left:120px;text-decoration:underline">项目明细</a>
-                                </a:hBox>
+
                             </a:form>
                         </a:case>
                     </a:switch>
@@ -803,33 +672,47 @@
                                         <a:tabPanel height="400" marginWidth="50">
                                             <a:tabs>
                                                 <a:tab prompt="归档材料清单" width="140">
-                                                    <a:grid id = "archive_file_grid1_id" bindTarget="archive_prj_bp_cdd_result_ds" marginHeight="200" marginWidth="45" navBar="true">
+                                                    <a:grid id="archive_file_grid1_id"
+                                                            bindTarget="archive_prj_plan_bp_ds" marginHeight="200"
+                                                            marginWidth="45" navBar="true">
                                                         <a:toolBar>
-                                                            <a:button id = "plan_id1" click="prj_plan_confirm1" text="确认不归档"/>
-                                                            <a:button id = "plan_cancel_id1" click="prj_plan_cancel1" text="取消不归档"/>
-                                                            <a:button id = "save_btn1" type="save"/>
+                                                            <a:button id="save_btn1" type="save"/>
+                                                            <a:button id="save_btn1_s" text="一键保存"
+                                                                      icon="${/request/@context_path}/leafresource/leaf.ui.std/hap/button/hlsgridsave.png"
+                                                                      btnStyle="background-size: 16px"
+                                                                      click="archive_prj_plan_bp_save"/>
                                                         </a:toolBar>
                                                         <a:columns>
-                                                            <a:column name="cdd_category" prompt="文件类型" width="80" />
-                                                            <a:column name="order_num"  prompt="序号" width="30"/>
-                                                            <a:column name="show_seq"  prompt="重要文件" width="100"/>
-                                                            <a:column name="cdd_class"  prompt="文件分类" width="120"/>
-                                                            <a:column name="bp_name"  prompt="商业伙伴名称" width="180"/>
-                                                            <a:column name="description"  prompt="归档范围（资料名称）" renderer="project_cdd_render_func" width="200"/>
-                                                            <a:column name="attachment"   prompt="附件" renderer="project_cdd_render_func" width="100"/>
-                                                            <a:column name="attach_file_name"  prompt="附件名" renderer="project_cdd_render_func" width="300"/>
-                                                            <!--<a:column name="plan_bp_attachment" prompt="附件(项目方案)" renderer="project_cdd_render_func" width="100"/>-->
-                                                            <!--<a:column name="plan_attach_file_name"  prompt="附件名(项目方案)" renderer="project_cdd_render_func" width="300"/>-->
-                                                            <!--<a:column name="arch_required_flag_desc"  prompt="是否必传" editor="archive_grid1_cb" width="100"/>-->
-                                                            <a:column name="important_concerns"  prompt="文号" editor="archive_grid1_tf" width="100"/>
-                                                            <a:column name="sign_num"  prompt="份数" editor="archive_grid1_nf" width="100"/>
-                                                            <a:column name="arch_par_has_flag_desc"  prompt="归档形式" editor="archive_grid1_cb" width="100"/>
-                                                            <a:column name="investigate_guide_flag_n"  prompt="是否符合审查指引"  width="100"/>
-                                                            <a:column name="reason_alternative"  prompt="不符合原因或替代文件"  width="200"/>
-                                                            <!--<a:column name="arch_paper_required_flag_desc"  prompt="是否为重要资料" editor="archive_grid1_cb" width="120"/>-->
-                                                            <!--<a:column name="receive_flag_desc"  prompt="是否收到纸质资料" editor="archive_grid1_cb" width="110"/>-->
-                                                            <a:column name="creatiodate" prompt="归档日期" width="110" renderer="Leaf.formatDate"/>
-                                                            <a:column name="note" prompt="说明" width="200" editor="archive_grid1_tf"/>
+                                                            <a:column name="archive_status_desc" align="center"
+                                                                      editor="archive_grid1_cb" width="80"
+                                                                      prompt="归档状态"/>
+                                                            <a:column name="cdd_category" prompt="文件类型" width="80"/>
+                                                            <a:column name="order_num" prompt="序号" width="30"/>
+                                                            <a:column name="show_seq" prompt="重要文件" width="100"/>
+                                                            <a:column name="cdd_class" prompt="文件分类" width="120"/>
+                                                            <a:column name="bp_name" prompt="商业伙伴名称" width="180"/>
+                                                            <a:column name="description" prompt="归档范围（资料名称）"
+                                                                      renderer="project_cdd_render_func" width="200"/>
+                                                            <a:column name="attachment" prompt="附件"
+                                                                      renderer="project_cdd_render_func" width="100"/>
+                                                            <a:column name="attach_file_name" prompt="附件名"
+                                                                      renderer="project_cdd_render_func" width="300"/>
+                                                            <a:column name="important_concerns" prompt="文号"
+                                                                      editor="archive_grid1_tf" width="100"/>
+                                                            <a:column name="sign_num" prompt="份数"
+                                                                      editor="archive_grid1_nf" width="100"/>
+                                                            <a:column name="arch_par_has_flag_desc" prompt="归档形式"
+                                                                      editor="archive_grid1_cb" width="100"/>
+                                                            <a:column name="investigate_guide_flag_n" prompt="是否符合审查指引"
+                                                                      width="100"/>
+                                                            <a:column name="reason_alternative" prompt="不符合原因或替代文件"
+                                                                      width="200"/>
+                                                            <a:column name="archive_date" prompt="归档日期" width="110"
+                                                                      renderer="Leaf.formatDateTime"/>
+                                                            <a:column name="note" prompt="说明" width="200"
+                                                                      editor="archive_grid1_tf"/>
+                                                            <a:column name="feedback" prompt="档案反馈" width="200"
+                                                                      editor="archive_grid1_tf"/>
                                                         </a:columns>
                                                         <a:editors>
                                                             <a:comboBox id="archive_grid1_cb"/>
@@ -842,40 +725,51 @@
                                         </a:tabPanel>
                                     </a:tab>

-                                    <!--<a:placeHolder id="hn_binary_record_tab"/>-->
-                                    <!--<a:placeHolder id="hn_document_type_record_tab"/>-->
-                                    <!--<a:placeHolder id="hn_industry_record_tab"/>-->
-
                                     <a:tab prompt="合规性材料" id="pro_report_info_id" width="130">
                                         <a:tabPanel height="400" marginWidth="50">
                                             <a:tabs>
                                                 <a:tab prompt="归档材料清单" width="140">
-                                                    <a:grid id = "archive_file_grid2_id" bindTarget="pro_report_cdd_result_ds" marginHeight="200" marginWidth="45" navBar="true">
+                                                    <a:grid id="archive_file_grid2_id"
+                                                            bindTarget="archive_compliance_materials_ds"
+                                                            marginHeight="200" marginWidth="45" navBar="true">
                                                         <a:toolBar>
-                                                            <a:button id = "plan_id2" click="prj_plan_confirm2" text="确认不归档"/>
-                                                            <a:button id = "plan_cancel_id2" click="prj_plan_cancel2" text="取消不归档"/>
-                                                            <a:button id = "save_btn2" type="save"/>
+                                                            <a:button id="save_btn2" type="save"/>
+                                                            <a:button id="save_btn2_s" text="一键保存"
+                                                                      icon="${/request/@context_path}/leafresource/leaf.ui.std/hap/button/hlsgridsave.png"
+                                                                      btnStyle="background-size: 16px"
+                                                                      click="archive_compliance_materials_save"/>
                                                         </a:toolBar>
                                                         <a:columns>
-                                                            <a:column name="cdd_category" prompt="文件类型" width="80" />
-                                                            <a:column name="order_num"  prompt="序号" width="30"/>
-                                                            <a:column name="show_seq"  prompt="重要文件" width="100"/>
-                                                            <a:column name="cdd_class"  prompt="文件分类" width="120"/>
-                                                            <a:column name="description"  prompt="归档范围（资料名称）" renderer="project_cdd_render_func" width="200"/>
-                                                            <a:column name="attachment"   prompt="附件" renderer="project_cdd_render_func" width="100"/>
-                                                            <a:column name="attach_file_name"  prompt="附件名" renderer="project_cdd_render_func" width="300"/>
-                                                            <!--<a:column name="plan_bp_attachment" prompt="附件(项目方案)" renderer="project_cdd_render_func" width="100"/>-->
-                                                            <!--<a:column name="plan_attach_file_name"  prompt="附件名(项目方案)" renderer="project_cdd_render_func" width="300"/>-->
-                                                            <!--<a:column name="arch_required_flag_desc"  prompt="是否必传" editor="archive_grid1_cb" width="100"/>-->
-                                                            <a:column name="important_concerns"  prompt="文号" editor="archive_grid0_tf" width="100"/>
-                                                            <a:column name="sign_num"  prompt="份数" editor="archive_grid0_nf" width="100"/>
-                                                            <a:column name="arch_par_has_flag_desc"  prompt="归档形式" editor="archive_grid0_cb" width="100"/>
-                                                            <a:column name="investigate_guide_flag_n"  prompt="是否符合审查指引"  width="100"/>
-                                                            <a:column name="reason_alternative"  prompt="不符合原因或替代文件"  width="200"/>
-                                                            <!--<a:column name="arch_paper_required_flag_desc"  prompt="是否为重要资料" editor="archive_grid1_cb" width="120"/>-->
-                                                            <!--<a:column name="receive_flag_desc"  prompt="是否收到纸质资料" editor="archive_grid1_cb" width="110"/>-->
-                                                            <a:column name="creatiodate" prompt="归档日期" width="110" renderer="Leaf.formatDate"/>
-                                                            <a:column name="note" prompt="说明" width="200" editor="archive_grid0_tf"/>
+                                                            <a:column name="archive_status_desc" align="center"
+                                                                      editor="archive_grid0_cb" width="80"
+                                                                      prompt="归档状态"/>
+                                                            <a:column name="cdd_category" prompt="文件类型" width="80"/>
+                                                            <a:column name="order_num" prompt="序号" width="30"/>
+                                                            <a:column name="show_seq" prompt="重要文件" width="100"/>
+                                                            <a:column name="cdd_class" prompt="文件分类" width="120"/>
+                                                            <a:column name="description" prompt="归档范围（资料名称）"
+                                                                      renderer="project_cdd_render_func" width="200"/>
+                                                            <a:column name="attachment" prompt="附件"
+                                                                      renderer="project_cdd_render_func" width="100"/>
+                                                            <a:column name="attach_file_name" prompt="附件名"
+                                                                      renderer="project_cdd_render_func" width="300"/>
+                                                            <a:column name="important_concerns" prompt="文号"
+                                                                      editor="archive_grid0_tf" width="100"/>
+                                                            <a:column name="sign_num" prompt="份数"
+                                                                      editor="archive_grid0_nf" width="100"/>
+                                                            <a:column name="arch_par_has_flag_desc" prompt="归档形式"
+                                                                      editor="archive_grid0_cb" width="100"/>
+                                                            <a:column name="investigate_guide_flag_n" prompt="是否符合审查指引"
+                                                                      width="100"/>
+                                                            <a:column name="reason_alternative" prompt="不符合原因或替代文件"
+                                                                      width="200"/>
+                                                            <a:column name="archive_date" prompt="归档日期" width="110"
+                                                                      renderer="Leaf.formatDate"/>
+                                                            <a:column name="note" prompt="说明" width="200"
+                                                                      editor="archive_grid0_tf"/>
+                                                            <a:column name="feedback" prompt="档案反馈" width="200"
+                                                                      editor="archive_grid0_tf"/>
+
                                                         </a:columns>
                                                         <a:editors>
                                                             <a:comboBox id="archive_grid0_cb"/>
@@ -899,35 +793,47 @@
                                         <a:tabPanel height="400" marginWidth="50">
                                             <a:tabs>
                                                 <a:tab prompt="归档材料清单" width="140">
-                                                    <a:grid id = "archive_file_grid3_id" bindTarget="prj_report_cdd_result_ds" marginHeight="200" marginWidth="45" navBar="true">
+                                                    <a:grid id="archive_file_grid3_id" bindTarget="archive_report_ds"
+                                                            marginHeight="200" marginWidth="45" navBar="true">
                                                         <a:toolBar>
-                                                            <a:button id = "plan_id3" click="prj_plan_confirm3" text="确认不归档"/>
-                                                            <a:button id = "plan_cancel_id3" click="prj_plan_cancel3" text="取消不归档"/>
-                                                            <a:button id = "save_btn3" type="save"/>
+                                                            <a:button id="save_btn3" type="save"/>
+                                                            <a:button id="save_btn3_s" text="一键保存"
+                                                                      icon="${/request/@context_path}/leafresource/leaf.ui.std/hap/button/hlsgridsave.png"
+                                                                      btnStyle="background-size: 16px"
+                                                                      click="archive_report_save"/>
                                                         </a:toolBar>
                                                         <a:columns>
-                                                            <a:column name="cdd_category" prompt="文件类型" width="80" />
-                                                            <a:column name="order_num"  prompt="序号" width="30"/>
-                                                            <a:column name="show_seq"  prompt="重要文件" width="100"/>
-                                                            <a:column name="cdd_class"  prompt="文件分类" width="120"/>
-                                                            <a:column name="description"  prompt="归档范围（资料名称）" renderer="project_cdd_render_func" width="200"/>
-                                                            <a:column name="attachment"   prompt="附件" renderer="project_cdd_render_func" width="100"/>
-                                                            <a:column name="attach_file_name"  prompt="附件名" renderer="project_cdd_render_func" width="300"/>
-                                                            <!--<a:column name="plan_bp_attachment" prompt="附件(项目方案)" renderer="project_cdd_render_func" width="100"/>-->
-                                                            <!--<a:column name="plan_attach_file_name"  prompt="附件名(项目方案)" renderer="project_cdd_render_func" width="300"/>-->
-                                                            <!--<a:column name="arch_required_flag_desc"  prompt="是否必传" editor="archive_grid1_cb" width="100"/>-->
-                                                            <a:column name="important_concerns"  prompt="文号" editor="archive_grid12_tf" width="100"/>
-                                                            <a:column name="sign_num"  prompt="份数" editor="archive_grid12_nf" width="100"/>
-                                                            <a:column name="arch_par_has_flag_desc"  prompt="归档形式" editor="archive_grid12_cb" width="100"/>
-                                                            <!--<a:column name="arch_paper_required_flag_desc"  prompt="是否为重要资料" editor="archive_grid1_cb" width="120"/>-->
-                                                            <!--<a:column name="receive_flag_desc"  prompt="是否收到纸质资料" editor="archive_grid1_cb" width="110"/>-->
-                                                            <a:column name="creatiodate" prompt="归档日期" width="110" renderer="Leaf.formatDate"/>
-                                                            <a:column name="note" prompt="说明" width="200" editor="archive_grid12_tf"/>
+                                                            <a:column name="archive_status_desc" align="center"
+                                                                      editor="archive_grid12_cb" width="80"
+                                                                      prompt="归档状态"/>
+                                                            <a:column name="cdd_category" prompt="文件类型" width="80"/>
+                                                            <a:column name="order_num" prompt="序号" width="30"/>
+                                                            <a:column name="show_seq" prompt="重要文件" width="100"/>
+                                                            <a:column name="cdd_class" prompt="文件分类" width="120"/>
+                                                            <a:column name="description" prompt="归档范围（资料名称）"
+                                                                      renderer="project_cdd_render_func" width="200"/>
+                                                            <a:column name="attachment" prompt="附件"
+                                                                      renderer="project_cdd_render_func" width="100"/>
+                                                            <a:column name="attach_file_name" prompt="附件名"
+                                                                      renderer="project_cdd_render_func" width="300"/>
+                                                            <a:column name="important_concerns" prompt="文号"
+                                                                      editor="archive_grid12_tf" width="100"/>
+                                                            <a:column name="sign_num" prompt="份数"
+                                                                      editor="archive_grid12_nf" width="100"/>
+                                                            <a:column name="arch_par_has_flag_desc" prompt="归档形式"
+                                                                      editor="archive_grid12_cb" width="100"/>
+                                                            <a:column name="archive_date" prompt="归档日期" width="110"
+                                                                      renderer="Leaf.formatDate"/>
+                                                            <a:column name="note" prompt="说明" width="200"
+                                                                      editor="archive_grid12_tf"/>
+                                                            <a:column name="feedback" prompt="档案反馈" width="200"
+                                                                      editor="archive_grid12_tf"/>
                                                         </a:columns>
                                                         <a:editors>
                                                             <a:comboBox id="archive_grid12_cb"/>
                                                             <a:textField id="archive_grid12_tf"/>
-                                                            <a:numberField id="archive_grid12_nf" allowDecimals="false"/>
+                                                            <a:numberField id="archive_grid12_nf"
+                                                                           allowDecimals="false"/>
                                                         </a:editors>
                                                     </a:grid>
                                                 </a:tab>
@@ -946,31 +852,41 @@
                                         <a:tabPanel height="400" marginWidth="50">
                                             <a:tabs>
                                                 <a:tab prompt="归档材料清单" width="140">
-                                                    <a:grid id = "archive_file_grid4_id" bindTarget="archive_payment_cdd_result_ds" marginHeight="200" marginWidth="45" navBar="true">
+                                                    <a:grid id="archive_file_grid4_id" bindTarget="archive_payment_ds"
+                                                            marginHeight="200" marginWidth="45" navBar="true">
                                                         <a:toolBar>
-                                                            <a:button id = "plan_id4" click="prj_plan_confirm4" text="确认不归档"/>
-                                                            <a:button id = "plan_cancel_id4" click="prj_plan_cancel4" text="取消不归档"/>
                                                             <a:button id="save_btn4" type="save"/>
+                                                            <a:button id="save_btn4_s" text="一键保存"
+                                                                      icon="${/request/@context_path}/leafresource/leaf.ui.std/hap/button/hlsgridsave.png"
+                                                                      btnStyle="background-size: 16px"
+                                                                      click="archive_payment_save"/>
                                                         </a:toolBar>
                                                         <a:columns>
-                                                            <a:column name="cdd_category" prompt="文件类型" width="80" />
-                                                            <a:column name="order_num"  prompt="序号" width="30"/>
-                                                            <a:column name="show_seq"  prompt="重要文件" width="100"/>
-                                                            <a:column name="cdd_class"  prompt="文件分类" width="120"/>
-                                                            <a:column name="description"  prompt="归档范围（资料名称）" renderer="project_cdd_render_func" width="200"/>
-                                                            <a:column name="attachment_payment2"   prompt="附件" renderer="payment_cdd_render_func" width="100"/>
-                                                            <a:column name="file_name"  prompt="附件名" renderer="payment_cdd_render_func" width="300"/>
-                                                            <!--<a:column name="plan_bp_attachment" prompt="附件(项目方案)" renderer="project_cdd_render_func" width="100"/>-->
-                                                            <!--<a:column name="plan_attach_file_name"  prompt="附件名(项目方案)" renderer="project_cdd_render_func" width="300"/>-->
-                                                            <!--<a:column name="arch_required_flag_desc"  prompt="是否必传" editor="archive_grid1_cb" width="100"/>-->
-                                                            <a:column name="important_concerns"  prompt="文号" editor="archive_grid8_tf" width="100"/>
-                                                            <a:column name="sign_num"  prompt="份数" editor="archive_grid8_nf" width="100"/>
-                                                            <a:column name="arch_par_has_flag_desc"  prompt="归档形式" editor="archive_grid8_cb" width="100"/>
-                                                            <!--<a:column name="arch_paper_required_flag_desc"  prompt="是否为重要资料" editor="archive_grid1_cb" width="120"/>-->
-                                                            <!--<a:column name="receive_flag_desc"  prompt="是否收到纸质资料" editor="archive_grid1_cb" width="110"/>-->
-                                                            <a:column name="creation_date_s" prompt="归档日期" width="110"/>
-                                                            <a:column name="note" prompt="说明" width="200" editor="archive_grid8_tf"/>
-
+                                                            <a:column name="archive_status_desc" align="center"
+                                                                      editor="archive_grid8_cb" width="80"
+                                                                      prompt="归档状态"/>
+                                                            <a:column name="cdd_category" prompt="文件类型" width="80"/>
+                                                            <a:column name="order_num" prompt="序号" width="30"/>
+                                                            <a:column name="show_seq" prompt="重要文件" width="100"/>
+                                                            <a:column name="cdd_class" prompt="文件分类" width="120"/>
+                                                            <a:column name="description" prompt="归档范围（资料名称）"
+                                                                      renderer="project_cdd_render_func" width="200"/>
+                                                            <a:column name="attachment_payment2" prompt="附件"
+                                                                      renderer="payment_cdd_render_func" width="100"/>
+                                                            <a:column name="file_name" prompt="附件名"
+                                                                      renderer="payment_cdd_render_func" width="300"/>
+                                                            <a:column name="important_concerns" prompt="文号"
+                                                                      editor="archive_grid8_tf" width="100"/>
+                                                            <a:column name="sign_num" prompt="份数"
+                                                                      editor="archive_grid8_nf" width="100"/>
+                                                            <a:column name="arch_par_has_flag_desc" prompt="归档形式"
+                                                                      editor="archive_grid8_cb" width="100"/>
+                                                            <a:column name="archive_date" prompt="归档日期" width="110"
+                                                                      renderer="Leaf.formatDate"/>
+                                                            <a:column name="note" prompt="说明" width="200"
+                                                                      editor="archive_grid8_tf"/>
+                                                            <a:column name="feedback" prompt="档案反馈" width="200"
+                                                                      editor="archive_grid8_tf"/>
                                                         </a:columns>
                                                         <a:editors>
                                                             <a:comboBox id="archive_grid8_cb"/>
@@ -994,30 +910,42 @@
                                         <a:tabPanel height="400" marginWidth="50">
                                             <a:tabs>
                                                 <a:tab prompt="归档材料清单" width="140">
-                                                    <a:grid id = "archive_file_grid5_id" bindTarget="archive_sign_cdd_result_ds" marginHeight="200" marginWidth="45" navBar="true">
+                                                    <a:grid id="archive_file_grid5_id"
+                                                            bindTarget="archive_contract_sign_ds" marginHeight="200"
+                                                            marginWidth="45" navBar="true">
                                                         <a:toolBar>
-                                                            <a:button id = "plan_id5" click="prj_plan_confirm5" text="确认不归档"/>
-                                                            <a:button id = "plan_cancel_id5" click="prj_plan_cancel5" text="取消不归档"/>
                                                             <a:button id="save_btn5" type="save"/>
+                                                            <a:button id="save_btn5_s" text="一键保存"
+                                                                      icon="${/request/@context_path}/leafresource/leaf.ui.std/hap/button/hlsgridsave.png"
+                                                                      btnStyle="background-size: 16px"
+                                                                      click="archive_contract_sign_save"/>
                                                         </a:toolBar>
                                                         <a:columns>
-                                                            <a:column name="cdd_category" prompt="文件类型" width="80" />
-                                                            <a:column name="order_num"  prompt="序号" width="30"/>
-                                                            <a:column name="show_seq"  prompt="重要文件" width="100"/>
-                                                            <a:column name="cdd_class"  prompt="文件分类" width="120"/>
-                                                            <a:column name="description"  prompt="归档范围（资料名称）" renderer="project_cdd_render_func" width="200"/>
-                                                            <a:column name="attachment"   prompt="附件" renderer="project_cdd_render_func" width="100"/>
-                                                            <a:column name="attach_file_name"  prompt="附件名" renderer="project_cdd_render_func" width="300"/>
-                                                            <!--<a:column name="plan_bp_attachment" prompt="附件(项目方案)" renderer="project_cdd_render_func" width="100"/>-->
-                                                            <!--<a:column name="plan_attach_file_name"  prompt="附件名(项目方案)" renderer="project_cdd_render_func" width="300"/>-->
-                                                            <!--<a:column name="arch_required_flag_desc"  prompt="是否必传" editor="archive_grid1_cb" width="100"/>-->
-                                                            <a:column name="important_concerns"  prompt="文号" editor="archive_grid9_tf" width="100"/>
-                                                            <a:column name="sign_num"  prompt="份数" editor="archive_grid9_nf" width="100"/>
-                                                            <a:column name="arch_par_has_flag_desc"  prompt="归档形式" editor="archive_grid9_cb" width="100"/>
-                                                            <!--<a:column name="arch_paper_required_flag_desc"  prompt="是否为重要资料" editor="archive_grid1_cb" width="120"/>-->
-                                                            <!--<a:column name="receive_flag_desc"  prompt="是否收到纸质资料" editor="archive_grid1_cb" width="110"/>-->
-                                                            <a:column name="creatiodate" prompt="归档日期" width="110" renderer="Leaf.formatDate"/>
-                                                            <a:column name="note" prompt="说明" width="200" editor="archive_grid9_tf"/>
+                                                            <a:column name="archive_status_desc" align="center"
+                                                                      editor="archive_grid9_cb" width="80"
+                                                                      prompt="归档状态"/>
+                                                            <a:column name="cdd_category" prompt="文件类型" width="80"/>
+                                                            <a:column name="order_num" prompt="序号" width="30"/>
+                                                            <a:column name="show_seq" prompt="重要文件" width="100"/>
+                                                            <a:column name="cdd_class" prompt="文件分类" width="120"/>
+                                                            <a:column name="description" prompt="归档范围（资料名称）"
+                                                                      renderer="project_cdd_render_func" width="200"/>
+                                                            <a:column name="attachment" prompt="附件"
+                                                                      renderer="project_cdd_render_func" width="100"/>
+                                                            <a:column name="attach_file_name" prompt="附件名"
+                                                                      renderer="project_cdd_render_func" width="300"/>
+                                                            <a:column name="important_concerns" prompt="文号"
+                                                                      editor="archive_grid9_tf" width="100"/>
+                                                            <a:column name="sign_num" prompt="份数"
+                                                                      editor="archive_grid9_nf" width="100"/>
+                                                            <a:column name="arch_par_has_flag_desc" prompt="归档形式"
+                                                                      editor="archive_grid9_cb" width="100"/>
+                                                            <a:column name="archive_date" prompt="归档日期" width="110"
+                                                                      renderer="Leaf.formatDate"/>
+                                                            <a:column name="note" prompt="说明" width="200"
+                                                                      editor="archive_grid9_tf"/>
+                                                            <a:column name="feedback" prompt="档案反馈" width="200"
+                                                                      editor="archive_grid9_tf"/>
                                                         </a:columns>
                                                         <a:editors>
                                                             <a:comboBox id="archive_grid9_cb"/>
@@ -1037,34 +965,46 @@
                         <a:case value="PRJ_PLAN_CHANGE">
                             <a:tabPanel marginHeight="40" marginWidth="25" id="prj_change_tabs">
                                 <a:tabs>
-                                    <a:tab prompt="客户资信资料" id="bp_credit_info_id" width="130">
+                                    <a:tab prompt="项目方案变更附件" id="bp_credit_info_id" width="130">
                                         <a:tabPanel height="400" marginWidth="50">
                                             <a:tabs>
                                                 <a:tab prompt="归档材料清单" width="140">
-                                                    <a:grid id = "archive_file_grid6_id" bindTarget="archive_change_bp_cdd_result_ds" marginHeight="200" marginWidth="45" navBar="true">
+                                                    <a:grid id="archive_file_grid6_id"
+                                                            bindTarget="archive_prj_change_bp_ds" marginHeight="200"
+                                                            marginWidth="45" navBar="true">
                                                         <a:toolBar>
-                                                            <a:button id = "plan_id6" click="prj_plan_confirm6" text="确认不归档"/>
-                                                            <a:button id = "plan_cancel_id6" click="prj_plan_cancel6" text="取消不归档"/>
-                                                            <a:button id = "save_btn6" type="save"/>
+                                                            <a:button id="save_btn6" type="save"/>
+                                                            <a:button id="save_btn6_s"
+                                                                      click="archive_prj_change_bp_save" text="一键保存"
+                                                                      icon="${/request/@context_path}/leafresource/leaf.ui.std/hap/button/hlsgridsave.png"
+                                                                      btnStyle="background-size: 16px"/>
                                                         </a:toolBar>
                                                         <a:columns>
-                                                            <a:column name="cdd_category" prompt="文件类型" width="80" />
-                                                            <a:column name="order_num"  prompt="序号" width="30"/>
-                                                            <a:column name="show_seq"  prompt="重要文件" width="100"/>
-                                                            <a:column name="cdd_class"  prompt="文件分类" width="120"/>
-                                                            <a:column name="description"  prompt="归档范围（资料名称）" renderer="project_cdd_render_func" width="200"/>
-                                                            <a:column name="attachment"   prompt="附件" renderer="project_cdd_render_func" width="100"/>
-                                                            <a:column name="attach_file_name"  prompt="附件名" renderer="project_cdd_render_func" width="300"/>
-                                                            <!--<a:column name="plan_bp_attachment" prompt="附件(项目方案)" renderer="project_cdd_render_func" width="100"/>-->
-                                                            <!--<a:column name="plan_attach_file_name"  prompt="附件名(项目方案)" renderer="project_cdd_render_func" width="300"/>-->
-                                                            <!--<a:column name="arch_required_flag_desc"  prompt="是否必传" editor="archive_grid1_cb" width="100"/>-->
-                                                            <a:column name="important_concerns"  prompt="文号" editor="archive_grid1_tf" width="100"/>
-                                                            <a:column name="sign_num"  prompt="份数" editor="archive_grid1_nf" width="100"/>
-                                                            <a:column name="arch_par_has_flag_desc"  prompt="归档形式" editor="archive_grid1_cb" width="100"/>
-                                                            <!--<a:column name="arch_paper_required_flag_desc"  prompt="是否为重要资料" editor="archive_grid1_cb" width="120"/>-->
-                                                            <!--<a:column name="receive_flag_desc"  prompt="是否收到纸质资料" editor="archive_grid1_cb" width="110"/>-->
-                                                            <a:column name="creatiodate" prompt="归档日期" width="110" renderer="Leaf.formatDate"/>
-                                                            <a:column name="note" prompt="说明" width="200" editor="archive_grid1_tf"/>
+                                                            <a:column name="archive_status_desc" align="center"
+                                                                      editor="archive_grid1_cb" width="80"
+                                                                      prompt="归档状态"/>
+                                                            <a:column name="cdd_category" prompt="文件类型" width="80"/>
+                                                            <a:column name="order_num" prompt="序号" width="30"/>
+                                                            <a:column name="show_seq" prompt="重要文件" width="100"/>
+                                                            <a:column name="cdd_class" prompt="文件分类" width="120"/>
+                                                            <a:column name="description" prompt="归档范围（资料名称）"
+                                                                      renderer="project_cdd_render_func" width="200"/>
+                                                            <a:column name="attachment" prompt="附件"
+                                                                      renderer="project_cdd_render_func" width="100"/>
+                                                            <a:column name="attach_file_name" prompt="附件名"
+                                                                      renderer="project_cdd_render_func" width="300"/>
+                                                            <a:column name="important_concerns" prompt="文号"
+                                                                      editor="archive_grid1_tf" width="100"/>
+                                                            <a:column name="sign_num" prompt="份数"
+                                                                      editor="archive_grid1_nf" width="100"/>
+                                                            <a:column name="arch_par_has_flag_desc" prompt="归档形式"
+                                                                      editor="archive_grid1_cb" width="100"/>
+                                                            <a:column name="archive_date" prompt="归档日期" width="110"
+                                                                      renderer="Leaf.formatDate"/>
+                                                            <a:column name="note" prompt="说明" width="200"
+                                                                      editor="archive_grid1_tf"/>
+                                                            <a:column name="feedback" prompt="档案反馈" width="200"
+                                                                      editor="archive_grid1_tf"/>

                                                         </a:columns>
                                                         <a:editors>
@@ -1078,46 +1018,7 @@
                                         </a:tabPanel>
                                     </a:tab>

-                                    <a:tab prompt="合规性材料" id="change_report_info_id" width="130">
-                                        <a:tabPanel height="400" marginWidth="50">
-                                            <a:tabs>
-                                                <a:tab prompt="归档材料清单" width="140">
-                                                    <a:grid id = "archive_file_grid7_id" bindTarget="pro_report_cdd_result_ds" marginHeight="200" marginWidth="45" navBar="true">
-                                                        <a:toolBar>
-                                                            <a:button id = "plan_id7" click="prj_plan_confirm7" text="确认不归档"/>
-                                                            <a:button id = "plan_cancel_id7" click="prj_plan_cancel7" text="取消不归档"/>
-                                                            <a:button id = "save_btn7" type="save"/>
-                                                        </a:toolBar>
-                                                        <a:columns>
-                                                            <a:column name="cdd_category" prompt="文件类型" width="80" />
-                                                            <a:column name="order_num"  prompt="序号" width="30"/>
-                                                            <a:column name="show_seq"  prompt="重要文件" width="100"/>
-                                                            <a:column name="cdd_class"  prompt="文件分类" width="120"/>
-                                                            <a:column name="description"  prompt="归档范围（资料名称）" renderer="project_cdd_render_func" width="200"/>
-                                                            <a:column name="attachment"   prompt="附件" renderer="project_cdd_render_func" width="100"/>
-                                                            <a:column name="attach_file_name"  prompt="附件名" renderer="project_cdd_render_func" width="300"/>
-                                                            <!--<a:column name="plan_bp_attachment" prompt="附件(项目方案)" renderer="project_cdd_render_func" width="100"/>-->
-                                                            <!--<a:column name="plan_attach_file_name"  prompt="附件名(项目方案)" renderer="project_cdd_render_func" width="300"/>-->
-                                                            <!--<a:column name="arch_required_flag_desc"  prompt="是否必传" editor="archive_grid1_cb" width="100"/>-->
-                                                            <a:column name="important_concerns"  prompt="文号" editor="archive_grid12_tf" width="100"/>
-                                                            <a:column name="sign_num"  prompt="份数" editor="archive_grid12_nf" width="100"/>
-                                                            <a:column name="arch_par_has_flag_desc"  prompt="归档形式" editor="archive_grid12_cb" width="100"/>
-                                                            <!--<a:column name="arch_paper_required_flag_desc"  prompt="是否为重要资料" editor="archive_grid1_cb" width="120"/>-->
-                                                            <!--<a:column name="receive_flag_desc"  prompt="是否收到纸质资料" editor="archive_grid1_cb" width="110"/>-->
-                                                            <a:column name="creatiodate" prompt="归档日期" width="110" renderer="Leaf.formatDate"/>
-                                                            <a:column name="note" prompt="说明" width="200" editor="archive_grid12_tf"/>
-                                                        </a:columns>
-                                                        <a:editors>
-                                                            <a:comboBox id="archive_grid12_cb"/>
-                                                            <a:textField id="archive_grid12_tf"/>
-
-                                                            <a:numberField id="archive_grid12_nf" allowDecimals="false"/>
-                                                        </a:editors>
-                                                    </a:grid>
-                                                </a:tab>
-                                            </a:tabs>
-                                        </a:tabPanel>
-                                    </a:tab>
+
                                 </a:tabs>
                             </a:tabPanel>
                         </a:case>
@@ -1130,35 +1031,47 @@
                                         <a:tabPanel height="400" marginWidth="50">
                                             <a:tabs>
                                                 <a:tab prompt="归档材料清单" width="140">
-                                                    <a:grid id = "archive_file_grid8_id" bindTarget="prj_report_cdd_result_ds" marginHeight="200" marginWidth="45" navBar="true">
+                                                    <a:grid id="archive_file_grid8_id" bindTarget="archive_report_ds"
+                                                            marginHeight="200" marginWidth="45" navBar="true">
                                                         <a:toolBar>
-                                                            <a:button id = "plan_id8" click="prj_plan_confirm8" text="确认不归档"/>
-                                                            <a:button id = "plan_cancel_id8" click="prj_plan_cancel8" text="取消不归档"/>
-                                                            <a:button id = "save_btn8" type="save"/>
+                                                            <a:button id="save_btn8" type="save"/>
+                                                            <a:button id="save_btn8_s" click="archive_report_save"
+                                                                      text="一键保存"
+                                                                      icon="${/request/@context_path}/leafresource/leaf.ui.std/hap/button/hlsgridsave.png"
+                                                                      btnStyle="background-size: 16px"/>
                                                         </a:toolBar>
                                                         <a:columns>
-                                                            <a:column name="cdd_category" prompt="文件类型" width="80" />
-                                                            <a:column name="order_num"  prompt="序号" width="30"/>
-                                                            <a:column name="show_seq"  prompt="重要文件" width="100"/>
-                                                            <a:column name="cdd_class"  prompt="文件分类" width="120"/>
-                                                            <a:column name="description"  prompt="归档范围（资料名称）" renderer="project_cdd_render_func" width="200"/>
-                                                            <a:column name="attachment"   prompt="附件" renderer="project_cdd_render_func" width="100"/>
-                                                            <a:column name="attach_file_name"  prompt="附件名" renderer="project_cdd_render_func" width="300"/>
-                                                            <!--<a:column name="plan_bp_attachment" prompt="附件(项目方案)" renderer="project_cdd_render_func" width="100"/>-->
-                                                            <!--<a:column name="plan_attach_file_name"  prompt="附件名(项目方案)" renderer="project_cdd_render_func" width="300"/>-->
-                                                            <!--<a:column name="arch_required_flag_desc"  prompt="是否必传" editor="archive_grid1_cb" width="100"/>-->
-                                                            <a:column name="important_concerns"  prompt="文号" editor="archive_grid14_tf" width="100"/>
-                                                            <a:column name="sign_num"  prompt="份数" editor="archive_grid14_nf" width="100"/>
-                                                            <a:column name="arch_par_has_flag_desc"  prompt="归档形式" editor="archive_grid14_cb" width="100"/>
-                                                            <!--<a:column name="arch_paper_required_flag_desc"  prompt="是否为重要资料" editor="archive_grid1_cb" width="120"/>-->
-                                                            <!--<a:column name="receive_flag_desc"  prompt="是否收到纸质资料" editor="archive_grid1_cb" width="110"/>-->
-                                                            <a:column name="creatiodate" prompt="归档日期" width="110" renderer="Leaf.formatDate"/>
-                                                            <a:column name="note" prompt="说明" width="200" editor="archive_grid14_tf"/>
+                                                            <a:column name="archive_status_desc" align="center"
+                                                                      editor="archive_grid14_cb" width="80"
+                                                                      prompt="归档状态"/>
+                                                            <a:column name="cdd_category" prompt="文件类型" width="80"/>
+                                                            <a:column name="order_num" prompt="序号" width="30"/>
+                                                            <a:column name="show_seq" prompt="重要文件" width="100"/>
+                                                            <a:column name="cdd_class" prompt="文件分类" width="120"/>
+                                                            <a:column name="description" prompt="归档范围（资料名称）"
+                                                                      renderer="project_cdd_render_func" width="200"/>
+                                                            <a:column name="attachment" prompt="附件"
+                                                                      renderer="project_cdd_render_func" width="100"/>
+                                                            <a:column name="attach_file_name" prompt="附件名"
+                                                                      renderer="project_cdd_render_func" width="300"/>
+                                                            <a:column name="important_concerns" prompt="文号"
+                                                                      editor="archive_grid14_tf" width="100"/>
+                                                            <a:column name="sign_num" prompt="份数"
+                                                                      editor="archive_grid14_nf" width="100"/>
+                                                            <a:column name="arch_par_has_flag_desc" prompt="归档形式"
+                                                                      editor="archive_grid14_cb" width="100"/>
+                                                            <a:column name="archive_date" prompt="归档日期" width="110"
+                                                                      renderer="Leaf.formatDate"/>
+                                                            <a:column name="note" prompt="说明" width="200"
+                                                                      editor="archive_grid14_tf"/>
+                                                            <a:column name="feedback" prompt="档案反馈" width="200"
+                                                                      editor="archive_grid14_tf"/>
                                                         </a:columns>
                                                         <a:editors>
                                                             <a:comboBox id="archive_grid14_cb"/>
                                                             <a:textField id="archive_grid14_tf"/>
-                                                            <a:numberField id="archive_grid14_nf" allowDecimals="false"/>
+                                                            <a:numberField id="archive_grid14_nf"
+                                                                           allowDecimals="false"/>
                                                         </a:editors>
                                                     </a:grid>
                                                 </a:tab>
@@ -1176,35 +1089,48 @@
                                         <a:tabPanel height="400" marginWidth="50">
                                             <a:tabs>
                                                 <a:tab prompt="归档材料清单" width="140">
-                                                    <a:grid id = "archive_file_grid9_id" bindTarget="prj_report_cdd_result_ds" marginHeight="200" marginWidth="45" navBar="true">
+                                                    <a:grid id="archive_file_grid9_id" bindTarget="archive_report_ds"
+                                                            marginHeight="200" marginWidth="45" navBar="true">
                                                         <a:toolBar>
-                                                            <a:button id = "plan_id9" click="prj_plan_confirm9" text="确认不归档"/>
-                                                            <a:button id = "plan_cancel_id9" click="prj_plan_cancel9" text="取消不归档"/>
-                                                            <a:button id = "save_btn9" type="save"/>
+                                                            <a:button id="save_btn9" type="save"/>
+                                                            <a:button id="save_btn9_s" click="archive_report_save"
+                                                                      text="一键保存"
+                                                                      icon="${/request/@context_path}/leafresource/leaf.ui.std/hap/button/hlsgridsave.png"
+                                                                      btnStyle="background-size: 16px"/>
                                                         </a:toolBar>
                                                         <a:columns>
-                                                            <a:column name="cdd_category" prompt="文件类型" width="80" />
-                                                            <a:column name="order_num"  prompt="序号" width="30"/>
-                                                            <a:column name="show_seq"  prompt="重要文件" width="100"/>
-                                                            <a:column name="cdd_class"  prompt="文件分类" width="120"/>
-                                                            <a:column name="description"  prompt="归档范围（资料名称）" renderer="project_cdd_render_func" width="200"/>
-                                                            <a:column name="attachment"   prompt="附件" renderer="project_cdd_render_func" width="100"/>
-                                                            <a:column name="attach_file_name"  prompt="附件名" renderer="project_cdd_render_func" width="300"/>
-                                                            <!--<a:column name="plan_bp_attachment" prompt="附件(项目方案)" renderer="project_cdd_render_func" width="100"/>-->
-                                                            <!--<a:column name="plan_attach_file_name"  prompt="附件名(项目方案)" renderer="project_cdd_render_func" width="300"/>-->
-                                                            <!--<a:column name="arch_required_flag_desc"  prompt="是否必传" editor="archive_grid1_cb" width="100"/>-->
-                                                            <a:column name="important_concerns"  prompt="文号" editor="archive_grid14_tf" width="100"/>
-                                                            <a:column name="sign_num"  prompt="份数" editor="archive_grid14_nf" width="100"/>
-                                                            <a:column name="arch_par_has_flag_desc"  prompt="归档形式" editor="archive_grid14_cb" width="100"/>
-                                                            <!--<a:column name="arch_paper_required_flag_desc"  prompt="是否为重要资料" editor="archive_grid1_cb" width="120"/>-->
-                                                            <!--<a:column name="receive_flag_desc"  prompt="是否收到纸质资料" editor="archive_grid1_cb" width="110"/>-->
-                                                            <a:column name="creatiodate" prompt="归档日期" width="110" renderer="Leaf.formatDate"/>
-                                                            <a:column name="note" prompt="说明" width="200" editor="archive_grid14_tf"/>
+                                                            <a:column name="archive_status_desc" align="center"
+                                                                      editor="archive_grid14_cb" width="80"
+                                                                      prompt="归档状态"/>
+                                                            <a:column name="cdd_category" prompt="文件类型" width="80"/>
+                                                            <a:column name="order_num" prompt="序号" width="30"/>
+                                                            <a:column name="show_seq" prompt="重要文件" width="100"/>
+                                                            <a:column name="cdd_class" prompt="文件分类" width="120"/>
+                                                            <a:column name="description" prompt="归档范围（资料名称）"
+                                                                      renderer="project_cdd_render_func" width="200"/>
+                                                            <a:column name="attachment" prompt="附件"
+                                                                      renderer="project_cdd_render_func" width="100"/>
+                                                            <a:column name="attach_file_name" prompt="附件名"
+                                                                      renderer="project_cdd_render_func" width="300"/>
+                                                            <a:column name="important_concerns" prompt="文号"
+                                                                      editor="archive_grid14_tf" width="100"/>
+                                                            <a:column name="sign_num" prompt="份数"
+                                                                      editor="archive_grid14_nf" width="100"/>
+                                                            <a:column name="arch_par_has_flag_desc" prompt="归档形式"
+                                                                      editor="archive_grid14_cb" width="100"/>
+                                                            <a:column name="archive_date" prompt="归档日期" width="110"
+                                                                      renderer="Leaf.formatDate"/>
+                                                            <a:column name="note" prompt="说明" width="200"
+                                                                      editor="archive_grid14_tf"/>
+                                                            <a:column name="feedback" prompt="档案反馈" width="200"
+                                                                      editor="archive_grid14_tf"/>
+
                                                         </a:columns>
                                                         <a:editors>
                                                             <a:comboBox id="archive_grid14_cb"/>
                                                             <a:textField id="archive_grid14_tf"/>
-                                                            <a:numberField id="archive_grid14_nf" allowDecimals="false"/>
+                                                            <a:numberField id="archive_grid14_nf"
+                                                                           allowDecimals="false"/>
                                                         </a:editors>
                                                     </a:grid>
                                                 </a:tab>
@@ -1218,81 +1144,6 @@
                 </a:case>
             </a:switch>
         </a:screenBody>
-        <script><![CDATA[
-        Leaf.onReady(function() {
-            /*if ('${/parameter/@attachment_flag}' == 'Y') {
-                document.getElementById("hn_atm_complement_atm_tab").style.display = "";
-            } else {
-                document.getElementById("hn_atm_complement_atm_tab").style.display = "none";
-            }*/
-
-
-            if ('${/parameter/@show_button}' == 'N' && '${/parameter/@archive_flag}'!='N') {
-                if('${/parameter/@submit_from}'=='PRJ_PLAN'){
-                    $('plan_id1').hide();
-                    $('plan_cancel_id1').hide();
-                    $('plan_id2').hide();
-                    $('plan_cancel_id2').hide();
-                }else if('${/parameter/@submit_from}'=='PRJ_PLAN_REPORT'){
-                    $('plan_id3').hide();
-                    $('plan_cancel_id3').hide();
-                }else if('${/parameter/@submit_from}'=='PAYMENT'){
-                    $('plan_id4').hide();
-                    $('plan_cancel_id4').hide();
-                }else if('${/parameter/@submit_from}'=='SIGN'){
-                    $('plan_id5').hide();
-                    $('plan_cancel_id5').hide();
-                }else if('${/parameter/@submit_from}'=='PRJ_PLAN_CHANGE'){
-                    $('plan_id6').hide();
-                    $('plan_cancel_id6').hide();
-                    $('plan_id7').hide();
-                    $('plan_cancel_id7').hide();
-                }else if('${/parameter/@submit_from}'=='PRJ_PLAN_REPORT_CHANGE_A'){
-                    $('plan_id8').hide();
-                    $('plan_cancel_id8').hide();
-                }else if('${/parameter/@submit_from}'=='PRJ_PLAN_REPORT_CHANGE_B'){
-                    $('plan_id9').hide();
-                    $('plan_cancel_id9').hide();
-                }
-            }else if ('${/parameter/@show_button}' == 'ALL' && '${/parameter/@archive_flag}'!='N') {
-                if('${/parameter/@submit_from}'=='PRJ_PLAN'){
-                    $('save_btn1').hide();
-                    $('plan_id1').hide();
-                    $('plan_cancel_id1').hide();
-                    $('save_btn2').hide();
-                    $('plan_id2').hide();
-                    $('plan_cancel_id2').hide();
-                }else if('${/parameter/@submit_from}'=='PRJ_PLAN_REPORT'){
-                    $('save_btn3').hide();
-                    $('plan_id3').hide();
-                    $('plan_cancel_id3').hide();
-                }else if('${/parameter/@submit_from}'=='PAYMENT'){
-                    $('save_btn4').hide();
-                    $('plan_id4').hide();
-                    $('plan_cancel_id4').hide();
-                }else if('${/parameter/@submit_from}'=='SIGN'){
-                    $('save_btn5').hide();
-                    $('plan_id5').hide();
-                    $('plan_cancel_id5').hide();
-                }else if('${/parameter/@submit_from}'=='PRJ_PLAN_CHANGE'){
-                    $('save_btn6').hide();
-                    $('plan_id6').hide();
-                    $('plan_cancel_id6').hide();
-                    $('save_btn7').hide();
-                    $('plan_id7').hide();
-                    $('plan_cancel_id7').hide();
-                }else if('${/parameter/@submit_from}'=='PRJ_PLAN_REPORT_CHANGE_A'){
-                    $('save_btn8').hide();
-                    $('plan_id8').hide();
-                    $('plan_cancel_id8').hide();
-                }else if('${/parameter/@submit_from}'=='PRJ_PLAN_REPORT_CHANGE_B'){
-                    $('save_btn9').hide();
-                    $('plan_id9').hide();
-                    $('plan_cancel_id9').hide();
-                }
-            }
-            console.log('${/parameter/@document_type}' + ' ' + '${/parameter/@submit_from}', ' ' + '${/parameter/@archive_batch_id}')
-        });
-        ]]></script>
+        <a:screen-include screen="modules/simple/simple_util.lview?para=${/parameter/}"/>
     </a:view>
 </a:screen>
Index: src/main/resources/leaf_static/modules/acrch/ARCHIVE003/archive_auto_file_detail.lview
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/acrch/ARCHIVE003/archive_auto_file_detail.lview b/src/main/resources/leaf_static/modules/acrch/ARCHIVE003/archive_auto_file_detail.lview
--- a/src/main/resources/leaf_static/modules/acrch/ARCHIVE003/archive_auto_file_detail.lview	(revision c1aa07c5d61db47efc2ed4d7e13119192d953710)
+++ b/src/main/resources/leaf_static/modules/acrch/ARCHIVE003/archive_auto_file_detail.lview	(revision 17e4557689da69547005d51c7a8fed724a94dd6e)
@@ -287,7 +287,7 @@
             </a:dataSet>
             <a:dataSet id="archive_bp_cdd_result_ds" autoQuery="true" fetchAll="true"
                        model="acrch.ARCHIVE002.server_layout_doc_cdd_item" pageSize="11"
-                       queryUrl="${/request/@context_path}/autocrud/acrch.ARCHIVE002.server_layout_doc_cdd_item/query?base_table_pk=${/parameter/@archive_batch_id}&amp;document_table=FILE_ARCHIVE_BATCH&amp;cdd_list_id=${/model/project_path/record/@arch_cdd_list_id}&amp;attachment_tab_group=TENANT&amp;arch_not_required_flag=N"
+                       queryUrl="${/request/@context_path}/autocrud/acrch.ARCHIVE002.server_layout_doc_cdd_item/query?base_table_pk=${/parameter/@archive_batch_id}&amp;document_table=FILE_ARCHIVE_BATCH&amp;cdd_list_id=${/model/project_path/record/@arch_cdd_list_id}&amp;attachment_tab_group=TENANT&amp;arch_not_required_flag=N&amp;confirm_flag=Y"
                        selectable="true">
                 <a:fields>
                     <a:field name="note"/>
@@ -304,7 +304,7 @@
             </a:dataSet>
             <a:dataSet id="archive_sd_cdd_result_ds" autoQuery="true" fetchAll="true"
                        model="layout.server_layout_doc_cdd_item" pageSize="11"
-                       queryUrl="${/request/@context_path}/autocrud/layout.server_layout_doc_cdd_item/query?base_table_pk=${/parameter/@archive_batch_id}&amp;document_table=FILE_ARCHIVE_BATCH&amp;cdd_list_id=${/model/project_path/record/@arch_cdd_list_id}&amp;attachment_tab_group=${/model/cdd_sd_group_info/record/@tab_group_id}"
+                       queryUrl="${/request/@context_path}/autocrud/layout.server_layout_doc_cdd_item/query?base_table_pk=${/parameter/@archive_batch_id}&amp;document_table=FILE_ARCHIVE_BATCH&amp;cdd_list_id=${/model/project_path/record/@arch_cdd_list_id}&amp;attachment_tab_group=${/model/cdd_sd_group_info/record/@tab_group_id}&amp;confirm_flag=Y"
                        selectable="true">
                 <a:fields>
                     <a:field name="note"/>
@@ -321,7 +321,7 @@
             </a:dataSet>
             <a:dataSet id="archive_fd_cdd_result_ds" autoQuery="true" fetchAll="true"
                        model="acrch.ARCHIVE002.server_layout_doc_cdd_item" pageSize="11"
-                       queryUrl="${/request/@context_path}/autocrud/acrch.ARCHIVE002.server_layout_doc_cdd_item/query?base_table_pk=${/parameter/@archive_batch_id}&amp;document_table=FILE_ARCHIVE_BATCH&amp;cdd_list_id=${/model/project_path/record/@arch_cdd_list_id}&amp;attachment_tab_group=COMPLIANCE_PRJF&amp;arch_not_required_flag=N"
+                       queryUrl="${/request/@context_path}/autocrud/acrch.ARCHIVE002.server_layout_doc_cdd_item/query?base_table_pk=${/parameter/@archive_batch_id}&amp;document_table=FILE_ARCHIVE_BATCH&amp;cdd_list_id=${/model/project_path/record/@arch_cdd_list_id}&amp;attachment_tab_group=COMPLIANCE_PRJF&amp;arch_not_required_flag=N&amp;confirm_flag=Y"
                        selectable="true">
                 <a:fields>
                     <a:field name="note"/>
@@ -341,7 +341,7 @@
             </a:dataSet>
             <a:dataSet id="archive_gf_cdd_result_ds" autoQuery="true" fetchAll="true"
                        model="acrch.ARCHIVE002.server_layout_doc_cdd_item" pageSize="11"
-                       queryUrl="${/request/@context_path}/autocrud/acrch.ARCHIVE002.server_layout_doc_cdd_item/query?base_table_pk=${/parameter/@archive_batch_id}&amp;document_table=FILE_ARCHIVE_BATCH&amp;cdd_list_id=${/model/project_path/record/@arch_cdd_list_id}&amp;attachment_tab_group=COMPLIANCE_PRJF&amp;arch_not_required_flag=N"
+                       queryUrl="${/request/@context_path}/autocrud/acrch.ARCHIVE002.server_layout_doc_cdd_item/query?base_table_pk=${/parameter/@archive_batch_id}&amp;document_table=FILE_ARCHIVE_BATCH&amp;cdd_list_id=${/model/project_path/record/@arch_cdd_list_id}&amp;attachment_tab_group=COMPLIANCE_PRJF&amp;arch_not_required_flag=N&amp;confirm_flag=Y"
                        selectable="true">
                 <a:fields>
                     <a:field name="note"/>
@@ -359,7 +359,7 @@
 <!--            通用合规性材料-->
             <a:dataSet id="archive_all_cdd_result_ds" autoQuery="true" fetchAll="true"
                        model="acrch.ARCHIVE002.server_layout_doc_cdd_item" pageSize="11"
-                       queryUrl="${/request/@context_path}/autocrud/acrch.ARCHIVE002.server_layout_doc_cdd_item/query?base_table_pk=${/parameter/@archive_batch_id}&amp;document_table=FILE_ARCHIVE_BATCH&amp;cdd_list_id=${/model/project_path/record/@arch_cdd_list_id}&amp;attachment_tab_group=COMPLIANCE_PRJF&amp;arch_not_required_flag=N"
+                       queryUrl="${/request/@context_path}/autocrud/acrch.ARCHIVE002.server_layout_doc_cdd_item/query?base_table_pk=${/parameter/@archive_batch_id}&amp;document_table=FILE_ARCHIVE_BATCH&amp;cdd_list_id=${/model/project_path/record/@arch_cdd_list_id}&amp;attachment_tab_group=COMPLIANCE_PRJF&amp;arch_not_required_flag=N&amp;confirm_flag=Y"
                        selectable="true">
                 <a:fields>
                     <a:field name="note"/>
@@ -379,7 +379,7 @@
             </a:dataSet>
             <a:dataSet id="archive_within_cdd_result_ds" autoQuery="true" fetchAll="true"
                        model="layout.server_layout_doc_cdd_item" pageSize="11"
-                       queryUrl="${/request/@context_path}/autocrud/layout.server_layout_doc_cdd_item/query?base_table_pk=${/parameter/@archive_batch_id}&amp;document_table=FILE_ARCHIVE_BATCH&amp;cdd_list_id=${/model/project_path/record/@arch_cdd_list_id}&amp;attachment_tab_group=${/model/cdd_within_group_info/record/@tab_group_id}"
+                       queryUrl="${/request/@context_path}/autocrud/layout.server_layout_doc_cdd_item/query?base_table_pk=${/parameter/@archive_batch_id}&amp;document_table=FILE_ARCHIVE_BATCH&amp;cdd_list_id=${/model/project_path/record/@arch_cdd_list_id}&amp;attachment_tab_group=${/model/cdd_within_group_info/record/@tab_group_id}&amp;confirm_flag=Y"
                        selectable="true">
                 <a:fields>
                     <a:field name="note"/>
@@ -396,7 +396,7 @@
             </a:dataSet>
             <a:dataSet id="archive_prjf_cdd_result_ds" autoQuery="true" fetchAll="true"
                        model="layout.server_layout_doc_cdd_item" pageSize="11"
-                       queryUrl="${/request/@context_path}/autocrud/layout.server_layout_doc_cdd_item/query?base_table_pk=${/parameter/@archive_batch_id}&amp;document_table=FILE_ARCHIVE_BATCH&amp;cdd_list_id=${/model/project_path/record/@arch_cdd_list_id}&amp;attachment_tab_group=${/model/cdd_prjf_group_info/record/@tab_group_id}"
+                       queryUrl="${/request/@context_path}/autocrud/layout.server_layout_doc_cdd_item/query?base_table_pk=${/parameter/@archive_batch_id}&amp;document_table=FILE_ARCHIVE_BATCH&amp;cdd_list_id=${/model/project_path/record/@arch_cdd_list_id}&amp;attachment_tab_group=${/model/cdd_prjf_group_info/record/@tab_group_id}&amp;confirm_flag=Y"
                        selectable="true">
                 <a:fields>
                     <a:field name="note"/>
@@ -413,7 +413,7 @@
             </a:dataSet>
             <a:dataSet id="archive_payment_cdd_result_ds" autoQuery="true" fetchAll="true"
                        model="csh.CSH900.hn_con_payment_conditions_detail_new" pageSize="11"
-                       queryUrl="${/request/@context_path}/autocrud/csh.CSH900.hn_con_payment_conditions_detail_new/query?archive_batch_id=${/parameter/@archive_batch_id}"
+                       queryUrl="${/request/@context_path}/autocrud/csh.CSH900.hn_con_payment_conditions_detail_new/query?archive_batch_id=${/parameter/@archive_batch_id}&amp;confirm_flag=Y"
                        selectable="true">
                 <a:fields>
                     <a:field name="note"/>
@@ -430,7 +430,7 @@
             </a:dataSet>
             <a:dataSet id="archive_sign_cdd_result_ds" autoQuery="true" fetchAll="true"
                        model="acrch.ARCHIVE002.server_layout_doc_cdd_item" pageSize="11"
-                       queryUrl="${/request/@context_path}/autocrud/acrch.ARCHIVE002.server_layout_doc_cdd_item/query?base_table_pk=${/parameter/@archive_batch_id}&amp;document_table=FILE_ARCHIVE_BATCH&amp;cdd_list_id=${/model/project_path/record/@arch_cdd_list_id}&amp;attachment_tab_group=SIGN&amp;arch_not_required_flag=N"
+                       queryUrl="${/request/@context_path}/autocrud/acrch.ARCHIVE002.server_layout_doc_cdd_item/query?base_table_pk=${/parameter/@archive_batch_id}&amp;document_table=FILE_ARCHIVE_BATCH&amp;cdd_list_id=${/model/project_path/record/@arch_cdd_list_id}&amp;attachment_tab_group=SIGN&amp;arch_not_required_flag=N&amp;confirm_flag=Y"
                        selectable="true">
                 <a:fields>
                     <a:field name="note"/>
@@ -448,7 +448,7 @@

             <a:dataSet id="pro_report_cdd_result_ds" autoQuery="true" fetchAll="true"
                        model="acrch.ARCHIVE002.server_layout_doc_cdd_item" pageSize="11"
-                       queryUrl="${/request/@context_path}/autocrud/acrch.ARCHIVE002.server_layout_doc_cdd_item/query?base_table_pk=${/parameter/@archive_batch_id}&amp;document_table=FILE_ARCHIVE_BATCH&amp;cdd_list_id=${/model/project_path/record/@arch_cdd_list_id}&amp;arch_not_required_flag=N"
+                       queryUrl="${/request/@context_path}/autocrud/acrch.ARCHIVE002.server_layout_doc_cdd_item/query?base_table_pk=${/parameter/@archive_batch_id}&amp;document_table=FILE_ARCHIVE_BATCH&amp;cdd_list_id=${/model/project_path/record/@arch_cdd_list_id}&amp;arch_not_required_flag=N&amp;confirm_flag=Y"
                        selectable="true">
                 <a:fields>
                     <a:field name="note"/>
@@ -469,7 +469,7 @@
             </a:dataSet>
             <a:dataSet id="prj_report_cdd_result_ds" autoQuery="true" fetchAll="true"
                        model="acrch.ARCHIVE002.server_layout_doc_cdd_item" pageSize="11"
-                       queryUrl="${/request/@context_path}/autocrud/acrch.ARCHIVE002.server_layout_doc_cdd_item/query?base_table_pk=${/parameter/@archive_batch_id}&amp;document_table=FILE_ARCHIVE_BATCH&amp;cdd_list_id=${/model/project_path/record/@arch_cdd_list_id}&amp;arch_not_required_flag=N&amp;attachment_tab_group=PRJ_CHANGE"
+                       queryUrl="${/request/@context_path}/autocrud/acrch.ARCHIVE002.server_layout_doc_cdd_item/query?base_table_pk=${/parameter/@archive_batch_id}&amp;document_table=FILE_ARCHIVE_BATCH&amp;cdd_list_id=${/model/project_path/record/@arch_cdd_list_id}&amp;arch_not_required_flag=N&amp;attachment_tab_group=PRJ_CHANGE&amp;confirm_flag=Y"
                        selectable="true">
                 <a:fields>
                     <a:field name="note"/>
Index: src/main/resources/leaf_static/modules/prj/PRJ501Z/hn_prj_project_plan_modify.lview
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/prj/PRJ501Z/hn_prj_project_plan_modify.lview b/src/main/resources/leaf_static/modules/prj/PRJ501Z/hn_prj_project_plan_modify.lview
--- a/src/main/resources/leaf_static/modules/prj/PRJ501Z/hn_prj_project_plan_modify.lview	(revision c1aa07c5d61db47efc2ed4d7e13119192d953710)
+++ b/src/main/resources/leaf_static/modules/prj/PRJ501Z/hn_prj_project_plan_modify.lview	(revision 4ee22eadac8d4cf6e0b3ffb7ad334e8becc16e05)
@@ -313,10 +313,10 @@

         //支撑性文件
         function prj_project_plan_attachment() {
-            if(typeof(check_result_ds())!='undefined'&&!Ext.isEmpty(check_result_ds())){
-                Leaf.showMessage('提示',check_result_ds());
-                return;
-            }
+            // if(typeof(check_result_ds())!='undefined'&&!Ext.isEmpty(check_result_ds())){
+            //     Leaf.showMessage('提示',check_result_ds());
+            //     return;
+            // }
             var ds = $('prj_project_plan_detail_result_ds');
             var ds_id = ds.id;
             var plan_id = '${/parameter/@plan_id}';
Index: src/main/resources/leaf_static/modules/prj/PRJ506/prj_project_print_detail.lview
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/prj/PRJ506/prj_project_print_detail.lview b/src/main/resources/leaf_static/modules/prj/PRJ506/prj_project_print_detail.lview
--- a/src/main/resources/leaf_static/modules/prj/PRJ506/prj_project_print_detail.lview	(revision c1aa07c5d61db47efc2ed4d7e13119192d953710)
+++ b/src/main/resources/leaf_static/modules/prj/PRJ506/prj_project_print_detail.lview	(revision 98ac3cdacf1066d1ee14fd7a7fbc584b3cd5bb30)
@@ -12,9 +12,10 @@
                        rootPath="contract_file_path"/>
     </a:init-procedure>
     <a:view>
-        <a:link id="${/parameter/@project_id}prj506_con_change_review_link" url="${/request/@context_path}/sys/office/review"/>
-        <a:link id="${/parameter/@project_id}prj506_con_change_view_link" url="${/request/@context_path}/sys/office/view"/>
-        <a:link id="${/parameter/@project_id}prj506_con_change_edit_link" url="${/request/@context_path}/sys/office/edit"/>
+        <a:screen-include screen="modules/simple/simple_util.lview?para=${/parameter/}"/>
+        <a:link id="${/parameter/@project_id}_prj506_con_change_review_link" url="${/request/@context_path}/sys/office/review"/>
+        <a:link id="${/parameter/@project_id}_prj506_con_change_view_link" url="${/request/@context_path}/sys/office/view"/>
+        <a:link id="${/parameter/@project_id}_prj506_con_change_edit_link" url="${/request/@context_path}/sys/office/edit"/>
         <a:link id="con_contract_delete" model="prj.PRJ506.con_contract_content"
                 modelaction="delete"/>
         <a:link id="con_contract_order" model="prj.PRJ506.con_contract_content"
@@ -23,6 +24,8 @@
                 url="${/request/@context_path}/modules/prj/PRJ506/con_content_change_create.lview"/>
         <a:link id="prj_project_link"
                 url="${/request/@context_path}/modules/prj/PRJ506/prj_project_print_detail_create.lview"/>
+        <a:link id="prj_project_link_bl"
+                url="${/request/@context_path}/modules/prj/PRJ506/prj_project_bl_print_detail_create.lview"/>
         <a:link id="con_contract_get_layout_code_link_id" model="cont.CON500.con_contract_get_layout_code"
                 modelaction="update"/>
         <a:link id="con_contract_content_asset_detail_link_id"
@@ -182,53 +185,55 @@
         }

         //合同文本生成
-        function con_print_detail_print_new() {
-            lock_current_window();
-
+        async function con_print_detail_print_new() {
             var result_ds = $('con_contract_update_print_detail_line_ds');
-            var records = result_ds.getAll();
-
             var file_path = $('contract_file_path_ds').getAt(0).get('contract_file_path');
-            for (let i = 0; i <records.length ; i++) {
-            var num = i + 1
-             if(records[i].get('templet_type') != '其他类型'){
-            if( Ext.isEmpty(records[i].get('sign_bp_id_n'))){
-                Leaf.showMessage('提示', '请添加第'+ num +'个合同的签约方');
+
+            if (!sp_ds_dirty_valid(result_ds)){
+                Leaf.showMessage('提示', '请先保存');
                 unlock_current_window();
-
                 return false;
+            }

+            let res = await sp_bm_request('/autocrud/cont.CON505.con_contract_content_check/query',
+                {project_id: '${/parameter/@project_id}'})

-            }
-                unlock_current_window();
-            }
-            }
-            Leaf.request({
-                url: $('con_doc_batch_create_link_id').getUrl(),
-                para: {
-                    project_id: '${/parameter/@project_id}',
-                    file_path: file_path,  // kyy暂时测试
-                    batch_flag: 'Y'
-                },
-                success: function (res) {
-                    Leaf.SideBar.enable = true;
-                    Leaf.SideBar.show({
-                        msg: '生成完毕',
-                        duration: 2000
-                    });
-                    result_ds.query(result_ds.currentPage);
-                    unlock_current_window();
-                },
-                error: function () {
-                    unlock_current_window();
-                },
-                failure: function () {
-                    unlock_current_window();
-                },
-                scope: this
-            });
-        }
+            if(res['count_not_link'] > 0){
+                Leaf.showMessage("提示", "存在未填写关联合同编号的补充协议，请检查")
+            } else if(res['count_sign_bp'] > 0){
+                Leaf.showMessage("提示", "存在未填写签约方的合同，请检查")
+            } else{
+                Leaf.request({
+                    url: $('con_doc_batch_create_link_id').getUrl(),
+                    para: {
+                        project_id: '${/parameter/@project_id}',
+                        file_path: file_path,
+                        batch_flag: 'Y'
+                    },
+                    success: function (res) {
+                        Leaf.SideBar.enable = true;
+                        Leaf.SideBar.show({
+                            msg: '生成完毕',
+                            duration: 2000
+                        });
+                        result_ds.query(result_ds.currentPage);
+                        unlock_current_window();
+                    },
+                    error: function () {
+                        unlock_current_window();
+                    },
+                    failure: function () {
+                        unlock_current_window();
+                    },
+                    scope: this
+                });
+            }

+
+
+
+        }
+
         function lock_current_window() {
             Leaf.Masker.mask($('${/parameter/@winid}').wrap, '${l:HLS.EXECUTING}');
         }
@@ -238,39 +243,28 @@
         }
         //合同类型
         function con_print_detail_create() {
-             debugger
-            /*lock_current_window();
-            Leaf.request({
-                url: $('prj_project_create_content_link_id').getUrl(),
-                para: {
-                    project_id: '${/parameter/@project_id}'
-                },
-                success: function(res) {
-                    var result_ds = $('con_contract_update_print_detail_line_ds');
-                    result_ds.query(result_ds.currentPage);
-                    unlock_current_window();
-                },
-                error: function() {
-                    unlock_current_window();
-                },
-                failure: function() {
-                    unlock_current_window();
-                },
-                scope: this
-            });*/
-
+            let record = $("con_contract_update_print_detail_headers_ds").getAt(0)
             var param = {};
             var url_link_id = '';
-            var fun_code = '${/parameter/@function_code}';
+            var fun_code = '${/parameter/@fun_code}';
             //部分时候会出现获取不到或者fun_code =='PRJ506T'的情况：(fun_code =='PRJ506T')||(fun_code == "")
             // if((fun_code == 'HN1012D')||(fun_code =='PRJ506T')||(fun_code == "")){
-            if(fun_code == 'HN1012D'){
+            if(fun_code == 'Y'){
                 param['function_code'] = 'PRJ506B';
                 url_link_id = 'con_content_change_link';
-            }else {
+            }
+            else {
                 param['function_code'] = 'PRJ506T';
                 url_link_id = 'prj_project_link';
             }
+
+            if(record.get("business_type") === 'FACTORING_BUSINESS'){
+                param['function_code'] = 'PRJ506_BL';
+                url_link_id = 'prj_project_link_bl';
+                if(bl_main_choose_flag()){
+                    param['bl_choose_main_flag'] = 'Y'
+                }
+            }
             param['project_id'] = '${/parameter/@project_id}';
             param['function_usage'] = 'query';
             param['url_title'] = '合同类型';
@@ -281,27 +275,23 @@
             hls_doc_get_layout_code('con_contract_get_layout_code_link_id', param, url_link_id, 'con_contract_update_print_detail_line_ds');
         }

-        function on_result_load(ds,record) {
-             var records = ds.getAll();
-            for (var i = 0; i < records.length; i++) {
-
-            //签约方必填
-            // if(records[i].get('templet_code') != 'HNTC_OTHER_CON'){
-            //
-            //     records[i].getField('sign_bp_id_n').setRequired(true);
-            // }
+        function bl_main_choose_flag(){
+             return  $("con_contract_update_print_detail_line_ds").getAll().filter(rec =>{
+                 return rec.get("templet_code") === 'HNTC_BL_CONTRACT_NO_KEEP_WATCH' || rec.get("templet_code") === 'HNTC_BL_CONTRACT_KEEP_WATCH'
+             }).length > 0
         }
-         }
+

         //下载
         function update_attachment_renderer(value, record, name) {
-
+            debugger;
             var content_id = record.get('content_id');
             var record_id = record.id;
             return '<a href="javascript:downloadfile_link(' + content_id + ',\'' + record_id + '\')">下载</a>';
         }

         function downloadfile_link(content_id, record_id) {
+            debugger;
             var res = $('con_contract_update_print_detail_line_ds').findById(record_id);
             var content_print_flag = res.get('content_print_flag');
             if (content_print_flag == 'Y') {
@@ -315,73 +305,33 @@

         //打包下载
           function con_download_zip() {
-            debugger
-              // var url = $('con543_con_batch_dl_link_id').getUrl() + '?contract_id=' + '${/parameter/@contract_id}';
-              var url = $('con543_con_batch_dl_link_id').getUrl() + '?project_id=' + '${/parameter/@project_id}';
-              window.open(url, '_self');
+             if($("con_contract_update_print_detail_line_ds").getAll().length > 0){
+                 let virtual_con_number = $("con_contract_update_print_detail_line_ds").getAt(0).get("virtual_con_number")
+                 var url = $('con543_con_batch_dl_link_id').getUrl()
+                     +'?project_id=' + '${/parameter/@project_id}'
+                     + '&virtual_con_number=' +  virtual_con_number
+                     + '&change_version_num=' + '${/parameter/@change_version_num}';
+
+                 window.open(url, '_self');
+             } else{
+                 Leaf.showMessage("提示", "当前暂无可打包下载的文件")
+             }
+
           }
         //edit by jcp 删除
-        function con500_delete_print() {
-
-            // $('con_contract_update_print_detail_grid_2').remove();
-            /*$('con_contract_update_print_detail_line_ds').query();*/
-            var record = $('con_contract_update_print_detail_line_ds').getSelected();
+        async function con500_delete_print() {
+            let ds = $('con_contract_update_print_detail_line_ds')
+            var record = ds.getSelected();
             var len = record.length;
             if (len == 0) {
                 Leaf.showMessage('${l:PROMPT}','请选择一条记录！');
                 return;
             }
-
-            var param = [];
-            for (var i=0;i<record.length;i++) {
-                var project_id = record[i].get('project_id');
-                var content_id = record[i].get('content_id');
-                param.push({
-                    'content_id': content_id
-                });
-            }
-            Leaf.request({
-                url:$('con_contract_delete').getUrl(),/*'prj.PRJ506.con_contract_content/delete',*/
-                para: {
-                    content_id: content_id /*'${/parameter/@content_id}'*/
-                },
-                success:function (res) {
-
-                    // Leaf.showMessage('提示','删除成功!');
-                    Leaf.request({
-                        url:$('con_contract_order').getUrl(),/*'prj.PRJ506.con_contract_content/execute',*/
-                        para: {
-                            project_id: project_id /*'${/parameter/@content_id}'*/
-                        },
-                        success:function (res) {
-
-                            // Leaf.showMessage('提示','排序成功!');
-                            $('con_contract_update_print_detail_line_ds').query();
-                            return;
-                        },
-                        failure: function () {
-                            // Leaf.showMessage('提示','排序失败!');
-                            return;
-                        },
-                        error: function () {

-                        },
-                        scope: this,
-                        sync: true
-                    });
-                    $('con_contract_update_print_detail_line_ds').query();
-                    return;
-                },
-                failure: function () {
-                    Leaf.showMessage('提示','删除失败!');
-                    return;
-                },
-                error: function () {
+            const params = sp_list_filter_obj(sp_trans_rec_list(record), ["content_id"])
+            await sp_batch_execute($('con_contract_delete').getUrl(), params, "删除合同文本")

-                },
-                scope: this,
-                sync: true
-            });
+            ds.query()
         }

         //附件上传
@@ -455,7 +405,7 @@
         };
          //在线查看 add jcp
          function con_change_link(record_id) {
-
+             debugger;
              var ch_show_flag = '${/parameter/@ch_show_flag}';
              var current_record = $('con_contract_update_print_detail_line_ds').findById(record_id);
              var templet_id = current_record.get('templet_id');
@@ -466,62 +416,67 @@
                  return;
              }
              var url ='';
-             if (ch_show_flag == 'Y'){
-                 url = $('${/parameter/@project_id}prj506_con_change_edit_link').getUrl() + '?sourceTypeCode=fnd_atm_attachment_multi&sourcePkValue=' + con_atm_source_pk_value;
-             }
-             else if (ch_show_flag == 'X'){
-                 url = $('${/parameter/@project_id}prj506_con_change_review_link').getUrl() + '?sourceTypeCode=fnd_atm_attachment_multi&sourcePkValue=' + con_atm_source_pk_value;
-             }
-             else{
-                 url = $('${/parameter/@project_id}prj506_con_change_view_link').getUrl() + '?sourceTypeCode=fnd_atm_attachment_multi&sourcePkValue=' + con_atm_source_pk_value;
-             }
+             // if (ch_show_flag == 'Y'){
+             //     url = $('${/parameter/@project_id}_prj506_con_change_edit_link').getUrl() + '?sourceTypeCode=fnd_atm_attachment_multi&sourcePkValue=' + con_atm_source_pk_value;
+             // }
+             // else if (ch_show_flag == 'X'){
+             //     url = $('${/parameter/@project_id}_prj506_con_change_review_link').getUrl() + '?sourceTypeCode=fnd_atm_attachment_multi&sourcePkValue=' + con_atm_source_pk_value;
+             // }
+             // else{
+                 url = $('${/parameter/@project_id}_prj506_con_change_view_link').getUrl() + '?sourceTypeCode=fnd_atm_attachment_multi&sourcePkValue=' + con_atm_source_pk_value;
+             // }
              window.open(url, '_blank');
          }
-
+        //在线编辑超链接
         function edit_office_attachment_renderer(value, record, name) {
-
-            var contract_approval_flag= '${/parameter/@contract_approval_flag}';
+            var ch_show_flag= '${/parameter/@ch_show_flag}';
             var change_flag = record.get('change_flag');
             var templet_id = record.get('templet_id');
-            var file_name = record.get('file_name');
             var attachment_number = record.get('attachment_number');
             var clause_usage = record.get('clause_usage');
-            if (contract_approval_flag=='Y'){
+            if ((ch_show_flag === 'W') || (ch_show_flag === 'Q') || (ch_show_flag === 'QW')){
+                //查查编编(合同变更 法务 补充)
                 if (!record.isNew) {
-                    if ((!templet_id) || (attachment_number == 0) || (!clause_usage)) {
+                    if ((!templet_id) || (attachment_number === 0) || (!clause_usage) || (change_flag !== 'Y')) {
                         return '';
                     }
                     return '<a href="javascript:open_office_link(' + record.id + ')">在线编辑</a>';
                 }
-                return '';
-            }else {
+            }else if ((ch_show_flag === 'Y') || (ch_show_flag === 'Z') || (ch_show_flag === 'ZY')){
+                //编编编编(合同审批 法务 补充)
                 if (!record.isNew) {
-                    if ((!templet_id) || (attachment_number == 0) || (!clause_usage) || (change_flag != 'Y')) {
+                    if ((!templet_id) || (attachment_number === 0) || (!clause_usage)) {
                         return '';
                     }
                     return '<a href="javascript:open_office_link(' + record.id + ')">在线编辑</a>';
                 }
-                return '';
             }
-
+            return ''
         }
-
+         //在线查看超链接
          function check_office_attachment_renderer(value, record, name) {
-
-             var contract_approval_flag= '${/parameter/@contract_approval_flag}';
+             debugger;
+             // var contract_approval_flag= '${/parameter/@contract_approval_flag}';
+             var ch_show_flag= '${/parameter/@ch_show_flag}';
              var change_flag = record.get('change_flag');
              var templet_id = record.get('templet_id');
              var attachment_number = record.get('attachment_number');
              var clause_usage = record.get('clause_usage');
-             if (contract_approval_flag=='Y') {
+             // if (contract_approval_flag=='Y') {
+             //合同审批维护以及工作流补充节点不显示在线查看
+             if (ch_show_flag=='Y') {
+
+                 return '';
+             }else if (ch_show_flag=='X') {
                  if (!record.isNew) {
                      if ((!templet_id) || (attachment_number == 0) || (!clause_usage)) {
                          return '';
                      }
-                     // return '<a href="javascript:con_change_link(' + record.id + ')">在线查看</a>';
+                     return '<a href="javascript:con_change_link(' + record.id + ')">在线查看</a>';
                  }
                  return '';
-             }else {
+             }
+             else if (ch_show_flag === 'W' || ch_show_flag === 'Z' || ch_show_flag === 'Q' || ch_show_flag === 'ZY' || (ch_show_flag === 'QW')) {
                  if (!record.isNew) {
                      if ((!templet_id) || (attachment_number == 0) || (!clause_usage) || (change_flag == 'Y')) {
                          return '';
@@ -552,6 +507,10 @@
             if (!record.isNew) {
                 var content_id = record.get('content_id');

+                if(record.get('templet_type') === '其他类型'){
+                    return ''
+                }
+
                 var bp_name = record.get('sign_bp_id_n');
                 if(record.get('content_print_flag_name')=='未生成' && bp_name == undefined){
                     return '<a href="javascript:winOpen_type_para(' + content_id + ')">签约方</a>';
@@ -560,15 +519,14 @@
                 }else if(record.get('content_print_flag_name')=='已生成' && bp_name != ''){
                     return  bp_name;
                 }
-
             }
             return '';
         }

-        function print_update() {
-
-        }
+        //在线编辑方法
         function open_office_link(record_id) {
+            debugger;
+            var ch_show_flag= '${/parameter/@ch_show_flag}';
             var current_record = $('con_contract_update_print_detail_line_ds').findById(record_id);
             var templet_id = current_record.get('templet_id');
             var attachment_number = current_record.get('attachment_number');
@@ -578,7 +536,12 @@
                 return;
             }
             //doc_plugin_template_copy(record_id);
-            var url = $('${/parameter/@project_id}prj506_con_change_edit_link').getUrl() + '?sourceTypeCode=fnd_atm_attachment_multi&sourcePkValue=' + con_atm_source_pk_value;
+            var url;
+            if (['Y', 'W', 'ZY', 'QW'].indexOf(ch_show_flag) > -1){
+                url = $('${/parameter/@project_id}_prj506_con_change_review_link').getUrl() + '?sourceTypeCode=fnd_atm_attachment_multi&sourcePkValue=' + con_atm_source_pk_value;
+            }else if (['Z', 'Q'].indexOf(ch_show_flag) > -1){
+                url = $('${/parameter/@project_id}_prj506_con_change_edit_link').getUrl() + '?sourceTypeCode=fnd_atm_attachment_multi&sourcePkValue=' + con_atm_source_pk_value;
+            }
             window.open(url, '_blank');
         }

@@ -591,12 +554,65 @@
              window.open(href = url_l, target = "_self");
          }*/
         function file_online_renderer(ds, record) {
-            var records = $('con_contract_update_print_detail_line_ds').getAll();
-            if (record.get('templet_code') == 'HNTC_OTHER_CON') {
+            if (record.get('templet_code') == 'HNTC_OTHER_CON' || record.get("business_type") === 'FACTORING_BUSINESS') {
                 return '<a href=javascript:detail_upload_window(' + record.get('content_id') + ')>附件上传</a>';
             }
         }

+        async function con500_save_print(){
+
+
+            $('con_contract_update_print_detail_line_ds').submit();
+        }
+
+        function textEditFunc(){
+            if('${/parameter/@ch_show_flag}' !== 'X'){
+                return 'textField'
+            } else{
+                return ''
+            }
+        }
+
+        function print_ds_query(ds, qpara){
+            if('${/parameter/@change_version_num}'){
+               qpara['change_version_num'] = '${/parameter/@change_version_num}'
+            }
+        }
+
+        function print_ds_before_submit(ds){
+            // const linked_contents = ds.getAll().filter((obj)=>{
+            //     return obj.get('linked_content_id') !== undefined
+            // })
+            //
+            // linked_contents.forEach((rec)=>{
+            //     const same_linked_contents = linked_contents.filter((obj)=>{return obj.get('linked_content_id') === rec.get('linked_content_id')})
+            //     const linked_current_seq = same_linked_contents.indexOf(rec) + 1
+            //     if(same_linked_contents.length === 1){
+            //         rec.set("content_number", rec.get('linked_content_number') + "-BCN")
+            //     } else if(same_linked_contents.length === 2){
+            //         same_linked_contents[0].set("content_number", rec.get('linked_content_number') + "-BCN001")
+            //         rec.set("content_number", rec.get('linked_content_number') + "-BCN002")
+            //     } else{
+            //         rec.set("content_number", rec.get('linked_content_number') + "-BCN" + sp_lpad(linked_current_seq, 3))
+            //     }
+            // })
+
+
+            return true
+        }
+
+
+        function refresh_print_ds_supplementary_number(){
+            $("con_contract_update_print_detail_line_ds").getAll().forEach(rec =>{
+                const rec_data = rec.data
+                if(rec_data['content_number'] && rec_data['content_number'].indexOf("BCN") > -1){
+                    rec.getField("linked_content_number").setReadOnly(false)
+                    rec.getField('linked_content_number').setRequired(true)
+                }
+            })
+        }
+
+
         ]]></script>
         <a:dataSets>
             <a:dataSet id="basic_clause_tmplet_usage_ds" lookupCode="CON_TMPLET_USAGE"/>
@@ -641,6 +657,15 @@
                             <a:map from="bp_class_desc" to="bp_class_desc"/>
                         </a:mapping>
                     </a:field>
+                    <a:field name="linked_content_number" lovGridHeight="350" lovHeight="500" lovLabelWidth="100"
+                             lovService="cont.CON505.con_contract_content_link_for_lov?project_id=${/parameter/@project_id}&amp;change_version_num=${/parameter/@change_version_num}"
+                             lovWidth="550" required="false" readonly="true" title="关联合同选择">
+                        <a:mapping>
+                            <a:map from="content_id" to="linked_content_id"/>
+                            <a:map from="content_number" to="linked_content_number"/>
+                        </a:mapping>
+                    </a:field>
+                    <a:field name="linked_content_id"/>
                     <a:field name="clause_usage_name" displayField="code_value_name"
                              options="basic_clause_tmplet_usage_ds" required="true" returnField="clause_usage"
                              valueField="code_value"/>
@@ -654,18 +679,23 @@
                         </a:mapping>
                     </a:field>
                     <a:field name="content_number"/>
+                    <a:field name="content_number_bcn"/>
                     <a:field name="available_flag" checkedValue="Y" defaultValue="Y" uncheckedValue="N"/>
                     <a:field name="print_date" datatype="java.util.DATE"/>
                     <a:field name="sign_bp_id"/>
                 </a:fields>
                 <a:events>
-                    <a:event name="load" handler="on_result_load"/>
-
+                    <a:event name="query" handler="print_ds_query"/>
+                    <a:event name="beforesubmit" handler="print_ds_before_submit"/>
+                    <a:event name="load" handler="refresh_print_ds_supplementary_number"/>
+                    <a:event name="update" handler="refresh_print_ds_supplementary_number"/>
                 </a:events>
             </a:dataSet>
+
         </a:dataSets>
         <a:screenBody>
             <a:screenTopToolbar style="width:848px">
+                <a:gridButton id="save_print_id" click="con500_save_print" text="HLS.SAVE"/>
                 <a:gridButton id="con_download_id" click="con_download_zip" text="打包下载"/>
                 <a:gridButton id="create_print_id" click="con_print_detail_create" text="新增合同文本"/>
                 <!-- <a:gridButton id="con500_print_btn" click="con_print_detail_print" text="PRJ702.GENERATE_THE_FILE"/> -->
@@ -685,12 +715,14 @@
                     <h2>提示: 主合同及交易合同请按照【供应商（如有）-主承租人-次承租人】的顺序勾选签约方</h2>
                 </div>
             </a:form>
-            <a:grid id="con_contract_update_print_detail_grid_2" bindTarget="con_contract_update_print_detail_line_ds" height="290" navBar="true" width="1200">
+            <a:grid id="con_contract_update_print_detail_grid_2" bindTarget="con_contract_update_print_detail_line_ds" marginHeight="300" navBar="true" marginWidth="50">
                 <a:columns>
                     <!-- <a:column name="description" prompt="模板类型" width="150"/>-->
                     <a:column name="templet_type" prompt="模板类别" width="130"/>
-                    <a:column name="templet_name" editor="print_detail_grid_lov_id" width="250" prompt="合同名称"/>
-                    <a:column name="content_number" prompt="合同编号" width="150"/>
+                    <a:column name="templet_name"  width="250" prompt="合同名称"/>
+                    <a:column name="content_number_bcn" prompt="合同编号" width="200"/>
+<!--                    <a:column name="content_number" prompt="合同编号" width="200"/>-->
+                    <a:column name="linked_content_number" editor="print_detail_grid_lov_id" prompt="关联合同编号" width="150"/>
                     <!-- <a:column name="clause_usage_name" prompt="HLS.CONTRACT_USAGE"/> -->
                     <!--  <a:column name="ref_n05" align="right" prompt="PRJ702.NUMBER_OF_COPIES" width="70"/> -->
                     <a:column name="print_date" prompt="PRJ702.FILE_GENERATED_DATE" renderer="Leaf.formatDate" width="80"/>
@@ -701,40 +733,56 @@
                     <a:column name="sign_bp_id_n" prompt="签约方" align="center" renderer="defineTypeParameter" width="150"/>
                     <a:column name="content_print_flag_name" prompt="CON505.CON_CONTENT_STATUS" width="100"/>
                     <a:column name="create_online" prompt="在线编辑" width="100" renderer="edit_office_attachment_renderer"/>
-                    <a:column name="content_detail" prompt="在线查看"  renderer="check_office_attachment_renderer" width="100"/>
+<!--                    <a:column name="content_detail" prompt="在线查看"  renderer="check_office_attachment_renderer" width="100"/>-->
                     <a:column name="file" prompt="附件" width="80" renderer="file_online_renderer"/>
-                    <a:column name="print_num" prompt="签约份数" renderer="print_update" width="100" align="center"/>
+                    <a:column name="print_num" prompt="签约份数" width="100" align="center" editorFunction="textEditFunc"/>
                     <a:column name="attachment" align="center" prompt="下载" renderer="update_attachment_renderer" width="100"/>
                     <!-- <a:column align="center" prompt="附件上传" renderer="attachment_upload" width="80"/>
                     <a:column name="file_name" align="left" prompt="附件名" renderer="con500_link_render" width="220"/> -->
                 </a:columns>
+                <a:editors>
+                    <a:textField id="textField"/>
+                    <a:lov id="print_detail_grid_lov_id"/>
+                </a:editors>
             </a:grid>
         </a:screenBody>
         <script><![CDATA[
+        function hide_btn(btn_id){
+            if(document.getElementById(btn_id)){
+                document.getElementById(btn_id).remove()
+            }
+        }
+
+
         Leaf.onReady(function() {
-
-            if ('${/parameter/@ch_show_flag}' == 'X') {
-                $('create_print_id').show();
-                $('con_print_detail_print_id').show();
-                $('delete_print_id').show();
-                $('con_download_id').hide();
+
+            if(['X', 'Y', 'Z'].indexOf('${/parameter/@ch_show_flag}') > -1){
+                $("con_contract_update_print_detail_grid_2").hideColumn("linked_content_number")
             }
-            else if ('${/parameter/@ch_show_flag}' == 'Y') {
-                $('con_download_id').show();
-                $('create_print_id').hide();
-                $('con_print_detail_print_id').hide();
-                $('delete_print_id').hide();
+
+
+            $("con_contract_update_print_detail_line_ds").on("submitsuccess", async ()=>{
+                const ds = $("con_contract_update_print_detail_line_ds")
+                if(ds.getAll().length){
+                    await sp_bm_request("${/request/@context_path}/autocrud/cont.CON505.con_contract_content_link_for_lov/update",
+                        {project_id: ds.getAt(0).get("project_id")}
+                    )
+                }
+                ds.query()
+            })
+
+            if('${/parameter/@ch_show_flag}' === 'X'){
+                hide_btn("save_print_id")
             }
-            else {
-                $('create_print_id').show();
-                $('con_print_detail_print_id').show();
-                $('delete_print_id').show();
-                $('con_download_id').show();
+            if (['Q', 'Z', 'ZY', 'QW'].indexOf('${/parameter/@ch_show_flag}') > -1) {
+                hide_btn('create_print_id')
+                hide_btn('con_print_detail_print_id')
+                hide_btn('delete_print_id')
             }
-            // if ('${/parameter/@ch_show_flag}' == 'X') {
-            //     $('hn_wfl_add_win').show();
-            // }
+
+
         });
         ]]></script>
+
     </a:view>
 </a:screen>
Index: src/main/resources/leaf_static/modules/prj/PRJ506/virtual_contract_query.lview
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/prj/PRJ506/virtual_contract_query.lview b/src/main/resources/leaf_static/modules/prj/PRJ506/virtual_contract_query.lview
--- a/src/main/resources/leaf_static/modules/prj/PRJ506/virtual_contract_query.lview	(revision c1aa07c5d61db47efc2ed4d7e13119192d953710)
+++ b/src/main/resources/leaf_static/modules/prj/PRJ506/virtual_contract_query.lview	(revision 975e309bbb5f73c28d127b2ace8419899825c782)
@@ -5,9 +5,10 @@
     $Revision: 1.0
     $Purpose: 虚拟合同维护
 -->
-<a:screen xmlns:a="http://www.leaf-framework.org/application" customizationEnabled="true" dynamiccreateenabled="true"
-          trace="true">
+<a:screen xmlns:a="http://www.leaf-framework.org/application" customizationEnabled="true" dynamiccreateenabled="true" trace="true">
     <a:view>
+        <a:screen-include screen="modules/simple/simple_util.lview?para=${/parameter/}"/>
+
         <a:link id="${/parameter/@layout_code}_prj500Z_cdd_downloadFile_id"
                 url="${/request/@context_path}/downloadFile.lview"/>
 <!--        <a:link id="prj506_cdd_uploadFile_id" url="${/request/@context_path}/uploadFile.lview"/>-->
@@ -26,6 +27,7 @@
                 modelaction="update"/>
         <a:link id="prj_project_sign_save_link_id" model="prj.PRJ506.con_contract_sign_save_check"
                 modelaction="execute"/>
+        <a:link id="prj_project_cdd_save" model="prj.PRJ506.prj_project_cdd_save" modelaction="update"/>
         <a:link id="prj_project_modify_link"
                 url="${/request/@context_path}/modules/prj/PRJ501Z/prj_project_modify_info.lview"/>
         <a:link id="prj_project_get_layout_code_link_id" model="cont.CON500.con_contract_get_layout_code"
@@ -47,28 +49,23 @@
         <a:link id="${/parameter/@layout_code}_pageLink_node_approve_history"
                 url="${/request/@context_path}/modules/zjwfl/ZJWFL1060/zj_wfl_monitoring_node_approve_history.lview"/>

+
         <script><![CDATA[
-        //隐藏按钮
-        Leaf.onReady(function() {

-                if(Leaf.isEmpty(con_button) || con_button == undefined){
-                    if('${/parameter/@layout_code}' == 'VIRTUAL_CONTRACT_QUERY' ) {
-                     $('VIRTUAL_CONTRACT_QUERY_user_button1').hide();
-                    }else if('${/parameter/@layout_code}' == 'VIRTUAL_CONTRACT_QUERY_SEC'){
-                        $('VIRTUAL_CONTRACT_QUERY_SEC_user_button1').hide();
-                    }/*else if('${/parameter/@layout_code}' == 'VIRTUAL_CONTRACT_QUERY_SEC_SIG'){
-                        $('VIRTUAL_CONTRACT_QUERY_SEC_SIG_user_button1').hide();
-                    }else if('${/parameter/@layout_code}' == 'VIRTUAL_CONTRACT_QUERY_B'){
-                        $('VIRTUAL_CONTRACT_QUERY_B_SEC_user_button1').hide();
-                    }else if('${/parameter/@layout_code}' == 'VIRTUAL_CONTRACT_QUERY_A'){
-                        $('VIRTUAL_CONTRACT_QUERY_A_user_button1').hide();
-                    }else if('${/parameter/@layout_code}' == 'VIRTUAL_CONTRACT_QUERY_THD'){
-                        $('VIRTUAL_CONTRACT_QUERY_THD_user_button1').hide();
-                    }*/
-                }
+        //页面加载隐藏页首按钮
+        Leaf.onReady(()=>{
+            let button_arr = ['_save', '_user_button1', '_user_button2', '_user_button3', '_user_button4']
+

+            '${/parameter/@button_flag}'.split('/').forEach((flag, idx) =>{
+                if(flag === 'N' && idx < button_arr.length){
+                    if(document.getElementById('${/parameter/@layout_code}' + button_arr[idx])){
+                        document.getElementById('${/parameter/@layout_code}' + button_arr[idx]).remove()
+                    }
+                }
+            })
+        })

-        });
         function upload_file(id, name, query_only) {
             var record = window['${/parameter/@layout_code}_hls_link_render_record'][id + '---' + name];
             var dsCurrentPage = record.ds.currentPage;
@@ -128,20 +125,19 @@
         }
         //查看附件信息
         function open_office_see_link(record_id) {
-                debugger;
-
             var ds_file_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'con_contract_content');
-            if(ds_file_id=='VIRTUAL_CONTRACT_QUERY_SEC_G_CONTENT_con_contract_content_ds'){
-            var current_record = $(ds_file_id).findById(record_id);
-        var templet_id = current_record.get('templet_id');
-        var attachment_number = current_record.get('attachment_number');
-        var con_atm_source_pk_value = current_record.get('con_atm_source_pk_value');
-        if ((!templet_id) && (!attachment_number)) {
-        Leaf.showMessage('${l:PROMPT}', '未找到合同文本!');
-        return;
-        }
-        var url = $('onlineoffice_review_link').getUrl() + '?sourceTypeCode=fnd_atm_attachment_multi&sourcePkValue=' + con_atm_source_pk_value;
-        window.open(url, '_blank');
+            if(ds_file_id==='${/parameter/@layout_code}'  + '_G_CONTENT_con_contract_content_ds' ||
+                ds_file_id==='${/parameter/@layout_code}'  + '_G_SEAL_con_contract_content_ds'){
+                var current_record = $(ds_file_id).findById(record_id);
+                var templet_id = current_record.get('templet_id');
+                var attachment_number = current_record.get('attachment_number');
+                var con_atm_source_pk_value = current_record.get('con_atm_source_pk_value');
+                if ((!templet_id) && (!attachment_number)) {
+                    Leaf.showMessage('${l:PROMPT}', '未找到合同文本!');
+                    return;
+                }
+                var url = $('onlineoffice_review_link').getUrl() + '?sourceTypeCode=fnd_atm_attachment_multi&sourcePkValue=' + con_atm_source_pk_value;
+                window.open(url, '_blank');
             }


@@ -469,6 +465,8 @@
                     return '<a href="javascript:open_plan_update_detail(\'' + record.ds.id + '\',\'' + record.id + '\');">' + '项目方案审批详情' + '</a>';
                 }
                 return "";
+            } else if(name === 'order_seq'){
+                return "V"+value
             }
         };
         //add by liliu 2021年11月13日 from项目方案变更：客户想在合同签约处查看项目方案变更的审批记录
@@ -536,9 +534,9 @@

         //加载时调用(grid,table,gridBox)
         var count_flag = 0;
+
         //项目类匹配上bp_seq
-        window['${/parameter/@layout_code}_on_layout_dynamic_grid_load'] = function (ds, record) {
-debugger
+        window['${/parameter/@layout_code}_on_layout_dynamic_grid_load'] = function (ds, record, config_records) {
             var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_project_bp');
             $(ds_id).setQueryParameter('bp_seq', 1);
             if (ds.id == ds_id && count_flag < 1) {
@@ -555,38 +553,21 @@
                 }
             }

-        var ds_id2 = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'con_contract_content');
-            if(typeof(ds_id2) != 'undefined' && !Ext.isEmpty(ds_id2) && ds_id2==ds.id){
-                var records = $(ds_id2).getAll();
-                if(records.length>0&&'${/parameter/@edit_type}' != 'edit'){
-                    for (var i = 0; i < records.length; i++) {
-                        records[i].getField('print_num').setReadOnly(true);
-                    }
-                }
-            }
+            var ds_id2 = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'con_contract_content');
+                if(typeof(ds_id2) != 'undefined' && !Ext.isEmpty(ds_id2) && ds_id2==ds.id){
+                    var records = $(ds_id2).getAll();
+                    if(records.length>0&&'${/parameter/@edit_type}' != 'edit'){
+                        for (var i = 0; i < records.length; i++) {
+                            records[i].getField('print_num').setReadOnly(true);
+                        }
+                    }
+                }

             if (('${/parameter/@function_code}' != 'PRJ506F_WFL') && '${/parameter/@edit_type}' != 'edit' && '${/parameter/@layout_code}' == 'VIRTUAL_CONTRACT_QUERY_SEC') {
                 $('${/parameter/@layout_code}_C_ATTCH_REVIEW_ADD_layout_dynamic_button_id').hide();
                 $('${/parameter/@layout_code}_C_ATTCH_REVIEW_DELETE_layout_dynamic_button_id').hide();
                 $('${/parameter/@layout_code}_C_ATTCH_REVIEW_SAVE_layout_dynamic_button_id').hide();
             }
-       /* var records = $(ds_id2).getAll();
-        if(ds_id2==ds.id)
-
-        if(records.length>0&&'${/parameter/@edit_type}' != 'edit'){
-        for (var i = 0; i < records.length; i++) {
-        records[i].getField('print_num').setReadOnly(true);
-        }
-        }*/
-
-
-
-
-        };
-
-        //查询时调用(grid,table,gridBox)
-        window['${/parameter/@layout_code}_on_layout_dynamic_grid_query'] = function(ds, qpara, bp_seq) {
-

         };

@@ -608,6 +589,7 @@
                         records[i].getField('sign_num').setRequired(false);
                         records[i].getField('sign_num').setReadOnly(true);
                     }
+                    records[i].dirty = false;

                 }
             }
@@ -674,26 +656,51 @@

         window['${/parameter/@layout_code}_user_button3_layout_dynamic_click'] = function () {

-        var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'con_contract_content');
-        var records = $(ds_id).getAll();
-        if(records.length){
+            var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'con_contract_content');
+            var records = $(ds_id).getAll();
+            if(records.length){

-        var project_id = records[0].get('project_id');
+            var project_id = records[0].get('project_id');

-        var doc_code = '合同文本附件';
-        var url_l = $('workflow_con_batch_dl_link_id').getUrl() + '?project_id=' + project_id + '&doc_code=' + encodeURI(doc_code) + '&type=ZIP';
-        window.open(href = url_l, target = "_self");
+            var doc_code = '合同文本附件';
+            var url_l = $('workflow_con_batch_dl_link_id').getUrl() + '?project_id=' + project_id + '&doc_code=' + encodeURI(doc_code) + '&type=ZIP';
+            window.open(href = url_l, target = "_self");

-        }
+            }

         }

+        window['${/parameter/@layout_code}_user_button4_layout_dynamic_click'] = function () {
+            let base_info_ds = $(get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_project'))
+            let project_id = base_info_ds.getCurrentRecord().get("project_id")
+            let change_version_num = base_info_ds.getCurrentRecord().get("change_version_num")
+            let ref_ds = $(get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_cdd_item_doc_ref', 'C_ATTCH_REVIEW'))
+
+            Leaf.showConfirm('${l:HLS.PROMPT}', '确认清稿吗', function() {
+                Leaf.request({
+                    url: "${/request/@context_path}/modules/prj/PRJ506/prj_atm_batch_save.lsc",
+                    para:{
+                        project_id,
+                        change_version_num
+                    },
+                    success: ()=>{
+                        Leaf.SideBar.show({ msg: '${l:HLS.SUBMIT_SUCCESS}',duration: 2000});
+                        ref_ds.query()
+                    }
+                })
+
+
+            })
+
+        }
+

-        //新增和加载时调用(form)
+            //新增和加载时调用(form)
         window['${/parameter/@bp_seq}${/parameter/@layout_code}_on_layout_dynamic_form_add_and_load'] = function (ds, record, config_records, bp_seq) {

             var prj_ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_project');
             if (ds.id == prj_ds_id) {
+
                 //签约节点控制必输
                 if ('${/parameter/@sign_flag}' != 'Y') {
                     var head_record = $(prj_ds_id).getAt(0);
@@ -767,40 +774,56 @@
         };

         // var ds_con_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'con_contract_content');
-        var con_button = '${/parameter/@CON_BUTTON}';
+

-            window['${/parameter/@layout_code}_user_button1_layout_dynamic_click'] = function () {
-
-
-                // var record = $(ds_con_id).getAt(0);
-                var url = '';
-
-                if(con_button == 'modifyedit'){
-                    url = $('prj_project_update_print_query_link_id').getUrl();
-                }else if(con_button == 'addedit'){
-                    url = $('prj_project_select_content_link_id').getUrl();
-                }
-                var win = new Leaf.Window({
-                    url: url,
-                    title: '合同编辑',
-                    params: {
-                        edit_type :'${/parameter/@edit_type}',
-                        project_id: '${/parameter/@project_id}',
-                        winid: 'prj_project_create_content_print_win_id',
-                        ch_show_flag: 'X'
-                    },
-                    id: 'prj_project_create_content_print_win_id',
-                    fullScreen: true
-                });
-         win.on('close',function(){
-        var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'con_contract_content');
-         if(ds_id) {
-        $(ds_id).query();
-        }
-
-       /* window['${/parameter/@bp_seq}${/parameter/@layout_code}_SAVE_LAYOUT_DYNAMIC_CLICK']();*/
-
-        });
+        window['${/parameter/@layout_code}_user_button1_layout_dynamic_click'] = function () {
+            let con_button = '${/parameter/@CON_BUTTON}';
+            // var record = $(ds_con_id).getAt(0);
+            let content_ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'con_contract_content');
+            let ch_show_flag
+            let current_seq = $(content_ds_id).getAt(0).get("current_seq")
+            //Tips: X:只查看 Y:review模式只编辑 Z:edit模式只编辑 ZY:review模式而且只有打包下载
+            if(current_seq === 25){
+                ch_show_flag = 'Y'
+            } else if(current_seq === 27){
+                ch_show_flag = 'ZY'
+            } else if(current_seq === 30){
+                ch_show_flag = 'Z'
+            } else{
+                if('${/parameter/@edit_type}' === 'review'){
+                    ch_show_flag = 'Y'
+                } else if('${/parameter/@edit_type}' === 'edit') {
+                    ch_show_flag = 'Z'
+                }else{
+                    ch_show_flag = 'X'
+                }
+            }
+
+            var url = '';
+            if(con_button == 'modifyedit'){
+                url = $('prj_project_update_print_query_link_id').getUrl();
+            }else if(con_button == 'addedit'){
+                url = $('prj_project_select_content_link_id').getUrl();
+            }
+            var win = new Leaf.Window({
+                url: url,
+                title: '合同编辑',
+                params: {
+                    edit_type :'${/parameter/@edit_type}',
+                    project_id: '${/parameter/@project_id}',
+                    winid: 'prj_project_create_content_print_win_id',
+                    ch_show_flag,
+                    current_seq: $(content_ds_id).getAt(0).get("current_seq")
+                },
+                id: 'prj_project_create_content_print_win_id',
+                fullScreen: true
+            });
+             win.on('close',function(){
+                var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'con_contract_content');
+                if(ds_id) {
+                    $(ds_id).query();
+                }
+            });


         }
@@ -866,9 +889,10 @@
                 });

                 function save_before_agree() {
-                    var execute_bool = false;
+                    var execute_bool = true;
                     var file_ds_id = '${/parameter/@layout_code}_C_ATTCH_prj_cdd_item_doc_ref_ds';
                     var records = $(file_ds_id).getAll();
+
                     if($(file_ds_id).validate()){
                         execute_bool = true;

Index: src/main/resources/leaf_static/WEB-INF/classes/csh/CSH900/hn_con_payment_conditions_detail_new.lwm
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/WEB-INF/classes/csh/CSH900/hn_con_payment_conditions_detail_new.lwm b/src/main/resources/leaf_static/WEB-INF/classes/csh/CSH900/hn_con_payment_conditions_detail_new.lwm
--- a/src/main/resources/leaf_static/WEB-INF/classes/csh/CSH900/hn_con_payment_conditions_detail_new.lwm	(revision 4ee22eadac8d4cf6e0b3ffb7ad334e8becc16e05)
+++ b/src/main/resources/leaf_static/WEB-INF/classes/csh/CSH900/hn_con_payment_conditions_detail_new.lwm	(revision 17e4557689da69547005d51c7a8fed724a94dd6e)
@@ -1,7 +1,7 @@
 <?xml version="1.0" encoding="UTF-8"?>
 <bm:model xmlns:o="leaf.database.local.oracle" xmlns:bm="http://www.leaf-framework.org/schema/bm"
           xmlns:f="leaf.database.features" alias="t1" baseTable="HN_CON_PAYMENT_CONDITIONS_NEW"
-          defaultOrderBy="confirm_flag,condition_id,condition_code">
+          defaultOrderBy="confirm_flag desc,condition_id,condition_code">
     <bm:fields>
         <bm:field name="condition_id" databaseType="NUMBER" datatype="java.lang.Long" physicalName="CONDITION_ID"
                   prompt="HN_CON_PAYMENT_CONDITIONS_NEW.CONDITION_ID"/>
@@ -131,7 +131,7 @@
                            t1.sign_num,
                            rownum AS order_num
                       FROM HN_CON_PAYMENT_CONDITIONS_NEW t1
-                     ORDER BY confirm_flag, condition_id, condition_code) t1#WHERE_CLAUSE#
+                     ORDER BY confirm_flag desc, condition_id, condition_code) t1#WHERE_CLAUSE#
             ]]></bm:query-sql>
         </bm:operation>

Index: src/main/resources/leaf_static/modules/hn/HN1400/hn_business_contract_deal_approval_edit.lview
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/hn/HN1400/hn_business_contract_deal_approval_edit.lview b/src/main/resources/leaf_static/modules/hn/HN1400/hn_business_contract_deal_approval_edit.lview
--- a/src/main/resources/leaf_static/modules/hn/HN1400/hn_business_contract_deal_approval_edit.lview	(revision 19dbd4c494d0ae3be902c2c51d64041967106d8c)
+++ b/src/main/resources/leaf_static/modules/hn/HN1400/hn_business_contract_deal_approval_edit.lview	(revision 0e93e7bc67e28282773fe32adb9442a6cdef881e)
@@ -21,10 +21,14 @@
                 url="${/request/@context_path}/modules/prj/PRJ506/prj_atm_batch_dl.lsc"/>
         <script><![CDATA[
         Leaf.onReady(function() {
-
+            if('${/parameter/@save_button_flag}' === 'N' || '${/parameter/@save_button_flag}' === ''){
+                document.getElementById('${/parameter/@layout_code}' + '_save').remove()
+            }
             if ('${/parameter/@function_code}' == 'HN_BU_EDIT_B' && '${/parameter/@material_count_flag}' != 'BUTTON') {
                 $('VIRTUAL_CONTRACT_QUERY_B_user_button1').hide();
             }
+
+
         });

         // 支撑性文件
@@ -310,20 +314,13 @@
         window['${/parameter/@bp_seq}${/parameter/@layout_code}_on_layout_dynamic_grid_query'] = function(ds, qpara, bp_seq) {
             var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_project_bp');
             $(ds_id).setQueryParameter('bp_seq', 1);
+
+
         };

         //加载时调用(grid,table,gridBox)
         var count_flag = 0;
-        //项目类匹配上bp_seq
-        window['${/parameter/@layout_code}_on_layout_dynamic_grid_load'] = function(ds, record) {

-            var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_project_bp');
-            $(ds_id).setQueryParameter('bp_seq', 1);
-            if (ds.id == ds_id && count_flag < 1) {
-                count_flag = count_flag + 1;
-                $(ds_id).query();
-            }
-        };

         //更新事件
         window['${/parameter/@bp_seq}${/parameter/@layout_code}_on_layout_dynamic_update'] = function(ds, record, name, value, old_value, bp_seq) {
@@ -359,14 +356,16 @@

         //加载时调用 grid
         window['${/parameter/@bp_seq}${/parameter/@layout_code}_on_layout_dynamic_grid_load'] = function(ds, record, config_records, bp_seq) {
-
             var prj_ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_project');
             var detail_ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'hn_business_deal_detail');
             var details_records = $(detail_ds_id).getAll();
-            var prj_record = $(prj_ds_id).getCurrentRecord();
+            var prj_record = $(prj_ds_id).getAt(0);
             var function_usage = '${/parameter/@function_usage}'||'QUERY';
             var function_code = '${/parameter/@function_code}';
             var sign_num_flag = '${/parameter/@sign_num_flag}';
+
+
+
             if(detail_ds_id == ds.id) {

                 for (var i = 0;i < details_records.length;i++) {
@@ -385,53 +384,54 @@

             }

-            var file_ds_id = 'VIRTUAL_CONTRACT_QUERY_B_G_SEAL_con_contract_content_ds';
-            if(ds.id == file_ds_id){

-                var records = $(file_ds_id).getAll();
-                for (var i = 0; i < records.length; i++){
-
-                    if(sign_num_flag == 'X' ){
-
-                        records[i].getField('bp_sign_num').setRequired(true);
-                        records[i].getField('bp_sign_num').setReadOnly(false);
-                        records[i].getField('material_count').setReadOnly(true);
-                        records[i].getField('note').setReadOnly(true);
-
-                    }else if('${/parameter/@material_count_flag}'=='Y'){
-                        records[i].getField('material_count').setReadOnly(false);
-                        records[i].getField('note').setReadOnly(false);
+            var file_ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'con_contract_content')
+            if(ds.id == file_ds_id && record){
+                if(sign_num_flag == 'X' ){
+                    record.getField('bp_sign_num').setRequired(true);
+                    record.getField('bp_sign_num').setReadOnly(false);
+                    record.getField('material_count').setReadOnly(true);
+                    record.getField('note').setReadOnly(true);
+                }else if('${/parameter/@material_count_flag}'=='Y'){
+                    record.getField('material_count').setReadOnly(false);
+                    record.getField('note').setReadOnly(false);

-                        records[i].getField('bp_sign_num').setRequired(false);
-                        records[i].getField('bp_sign_num').setReadOnly(true);
+                    record.getField('bp_sign_num').setRequired(false);
+                    record.getField('bp_sign_num').setReadOnly(true);

-                    }else {
-                        records[i].getField('bp_sign_num').setRequired(false);
-                        records[i].getField('bp_sign_num').setReadOnly(true);
-                        records[i].getField('material_count').setReadOnly(true);
-                        records[i].getField('note').setReadOnly(true);
+                }else {
+                    record.getField('bp_sign_num').setRequired(false);
+                    record.getField('bp_sign_num').setReadOnly(true);
+                    record.getField('material_count').setReadOnly(true);
+                    record.getField('note').setReadOnly(true);

-                    }
-
-
-                }
+                }
+            }
+        };

-            }
-        };
+        //打包下载
         window['${/parameter/@layout_code}_user_button1_layout_dynamic_click'] = function () {
             var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'con_contract_content');
+            let base_info_rec = $(get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_project')).getAt(0);
             var records = $(ds_id).getAll();
             if (records.length) {
-
                 var project_id = records[0].get('project_id');
-
+                if('${/parameter/@change_req_id}' !== ''){
+                    project_id = '${/parameter/@change_req_id}'
+                }
                 var doc_code = '合同文本附件';
-                var url_l = $('workflow_con_batch_dl_link_id').getUrl() + '?project_id=' + project_id + '&doc_code=' + encodeURI(doc_code) + '&type=ZIP';
+                var url_l = $('workflow_con_batch_dl_link_id').getUrl() +
+                    '?project_id=' + project_id +
+                    '&doc_code=' + encodeURI(doc_code) +
+                    '&type=ZIP' +
+                    sp_format(`&virtual_con_number={0}&change_version_num={1}`,
+                        base_info_rec.get("virtual_con_number"), base_info_rec.get("change_version_num"));
                 window.open(href = url_l, target = "_self");

             }
+        }

-        }
+

         window['${/parameter/@layout_code}_G_SEAL_USER_BUTTON1_layout_dynamic_tab_click'] = function () {
             var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_project_con_seal');
@@ -477,6 +477,9 @@
             var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_project');
             if (ds.id == ds_id) {

+
+
+
                var sign_type=record.get('sign_type');
                    if('${/parameter/@function_code}' != 'HN_BU_EDIT_A'||sign_type=='租后变更'){
                        record.getField('contract_date').setRequired(false);
@@ -486,6 +489,18 @@

                }

+                if('${/parameter/@readonly_flag_base_info}'){
+                    record.getField('contract_date').setRequired(true);
+                    record.getField('contract_date').setReadOnly(false);
+                    record.getField('contract_term').setRequired(true);
+                    record.getField('contract_term').setReadOnly(false);
+                } else{
+                    record.getField('contract_date').setRequired(false);
+                    record.getField('contract_date').setReadOnly(true);
+                    record.getField('contract_term').setRequired(false);
+                    record.getField('contract_term').setReadOnly(true);
+                }
+
             }
         };

@@ -598,5 +613,6 @@
             </a:case>
         </a:switch>
         <a:screen-include screen="modules/cont/CON500/con_contract_get_layout_code.lview"/>
+        <a:screen-include screen="modules/simple/simple_util.lview"/>
     </a:view>
 </a:screen>
Index: src/main/resources/leaf_static/modules/prj/PRJ506/prj_project_print_detail_query.lview
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/prj/PRJ506/prj_project_print_detail_query.lview b/src/main/resources/leaf_static/modules/prj/PRJ506/prj_project_print_detail_query.lview
--- a/src/main/resources/leaf_static/modules/prj/PRJ506/prj_project_print_detail_query.lview	(revision 19dbd4c494d0ae3be902c2c51d64041967106d8c)
+++ b/src/main/resources/leaf_static/modules/prj/PRJ506/prj_project_print_detail_query.lview	(revision f85497fecb54e752fee72fbc515a4d3bfbc283f3)
@@ -13,10 +13,12 @@
         <a:link id="con_contract_uploadfile" url="${/request/@context_path}/downloadFile.lview"/>
         <a:link id="con543_con_batch_dl_link_id" url="${/request/@context_path}/modules/prj/PRJ506/prj_atm_batch_dl.lsc"/>
         <a:link id="con_contract_dowload_uploadfile_id" url="${/request/@context_path}/modules/cont/CON500/con_atm_batch_dl.lsc"/>
-        <a:link id="onlyoffice_view_link" url="${/request/@context_path}/sys/office/edit"/>
-        <a:link id="onlyoffice_review_link" url="${/request/@context_path}/sys/office/view"/>
+        <a:link id="onlyoffice_edit_link" url="${/request/@context_path}/sys/office/edit"/>
+        <a:link id="onlyoffice_review_link" url="${/request/@context_path}/sys/office/review"/>
+        <a:link id="onlyoffice_view_link" url="${/request/@context_path}/sys/office/view"/>
         <script><![CDATA[

+
             function lock_current_window() {
                 Leaf.Masker.mask($('${/parameter/@winid}').wrap, '${l:HLS.EXECUTING}');
             }
@@ -136,7 +138,13 @@
                 Leaf.showMessage('${l:PROMPT}', '未找到合同文本!');
                 return;
             }
-            var url = $('onlyoffice_view_link').getUrl() + '?sourceTypeCode=fnd_atm_attachment_multi&sourcePkValue=' + con_atm_source_pk_value;
+            let url
+            if("${/parameter/@project_id}" === "30") {
+                url = $('onlyoffice_edit_link').getUrl() + '?sourceTypeCode=fnd_atm_attachment_multi&sourcePkValue=' + con_atm_source_pk_value;
+            }
+            else{
+                url = $('onlyoffice_review_link').getUrl() + '?sourceTypeCode=fnd_atm_attachment_multi&sourcePkValue=' + con_atm_source_pk_value;
+            }
             window.open(url, '_blank');
         }
         function open506_office_see_link(record_id) {
@@ -148,15 +156,16 @@
                 Leaf.showMessage('${l:PROMPT}', '未找到合同文本!');
                 return;
             }
-            var url = $('onlyoffice_review_link').getUrl() + '?sourceTypeCode=fnd_atm_attachment_multi&sourcePkValue=' + con_atm_source_pk_value;
+
+            var url = $('onlyoffice_view_link').getUrl() + '?sourceTypeCode=fnd_atm_attachment_multi&sourcePkValue=' + con_atm_source_pk_value;
             window.open(url, '_blank');
         }
         //附件
         function file_online_renderer(ds,record) {

-        if(record.get('content_number') != '其他文件'){
-            record.set('file','');
-        }
+            if(record.get('content_number') != '其他文件'){
+                record.set('file','');
+            }
         }

         ]]></script>
Index: src/main/resources/leaf_static/WEB-INF/classes/cont/CON500/con_doc_file_templet_get_atm.lwm
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/WEB-INF/classes/cont/CON500/con_doc_file_templet_get_atm.lwm b/src/main/resources/leaf_static/WEB-INF/classes/cont/CON500/con_doc_file_templet_get_atm.lwm
--- a/src/main/resources/leaf_static/WEB-INF/classes/cont/CON500/con_doc_file_templet_get_atm.lwm	(revision ff64be97012222c59a0d66a34cd25a3c423bcc36)
+++ b/src/main/resources/leaf_static/WEB-INF/classes/cont/CON500/con_doc_file_templet_get_atm.lwm	(revision a41ef63bff39fb154a86dc822f2c62dab945d6e0)
@@ -20,6 +20,7 @@
                     WHERE
                         m1.table_name     = 'CON_CONTRACT_CONTENT' AND
                         m1.table_pk_value = cc.content_id
+                        and rownum = 1
                     ) file_exists_flag,
                     cc.content_number
                     ||'-'
@@ -48,10 +49,10 @@
                     m.table_name      = 'HLS_DOC_FILE_TEMPLET' AND
                     m.table_pk_value  = lt.templet_id AND
                     lt.templet_id     = ct.doc_templet_id AND
-                    ct.doc_plugin_flag = 'Y' AND
+                    ct.doc_plugin_flag = 'Y'
                     and nvl(faa.del_flag,0)=0
                     and nvl(m.del_flag,0)=0
-                    ct.templet_id      = cc.templet_id AND
+                    AND ct.templet_id      = cc.templet_id AND
                     (
                         cc.content_id =${/parameter/@content_id} OR
                         (
Index: src/main/resources/leaf_static/WEB-INF/classes/prj/PRJ506/prj_project_content_v.lwm
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/WEB-INF/classes/prj/PRJ506/prj_project_content_v.lwm b/src/main/resources/leaf_static/WEB-INF/classes/prj/PRJ506/prj_project_content_v.lwm
--- a/src/main/resources/leaf_static/WEB-INF/classes/prj/PRJ506/prj_project_content_v.lwm	(revision c7a334c4741e40ec28e7b6dff6af23268a63cb59)
+++ b/src/main/resources/leaf_static/WEB-INF/classes/prj/PRJ506/prj_project_content_v.lwm	(revision 98ac3cdacf1066d1ee14fd7a7fbc584b3cd5bb30)
@@ -1,17 +1,20 @@
 <?xml version="1.0" encoding="UTF-8"?>
 <!--
-    $Author: gaoyang
-    $Date: 2013-9-10 下午02:50:18
-    $Revision: 1.0
-    $Purpose:
--->
-<bm:model xmlns:bm="http://www.leaf-framework.org/schema/bm" xmlns:f="leaf.database.features" alias="t1" baseTable="prj_project_content_v" defaultOrderBy="decode(t1.bp_category,&apos;TENANT&apos;,0,&apos;GUARANTOR&apos;,1,&apos;VENDER&apos;,2,&apos;&apos;)">
+        $Author: gaoyang
+        $Date: 2013-9-10 下午02:50:18
+        $Revision: 1.0
+        $Purpose:
+        decode(t1.bp_category,&apos;TENANT&apos;,0,&apos;GUARANTOR&apos;,1,&apos;VENDER&apos;,2,&apos;&apos;)
+        -->
+<bm:model xmlns:bm="http://www.leaf-framework.org/schema/bm" xmlns:f="leaf.database.features" alias="t1" baseTable="prj_project_content_v" defaultOrderBy="t1.content_print_flag_name,t1.content_number_type,decode(instr(t1.content_number, 'BCN'), 0, 0, t1.linked_content_id), t1.content_number_seq,t1.content_number,t1.order_seq,decode(t1.bp_category,&apos;TENANT&apos;,0,&apos;GUARANTOR&apos;,1,&apos;VENDER&apos;,2,&apos;&apos;)">
     <bm:fields>
+        <bm:field name="attachment_number" databaseType="NUMBER" datatype="java.lang.Long" physicalName="ATTACHMENT_NUMBER" prompt="CON_CONTRACT_CONTENT_V.ATTACHMENT_NUMBER"/>
         <bm:field name="content_id" databaseType="NUMBER" datatype="java.lang.Long" physicalName="CONTENT_ID" prompt="CON_CONTRACT_CONTENT_V.CONTENT_ID"/>
         <!-- <bm:field name="contract_id" databaseType="NUMBER" datatype="java.lang.Long" physicalName="CONTRACT_ID" prompt="CON_CONTRACT_CONTENT_V.CONTRACT_ID"/> -->
         <bm:field name="con_contract_bp_id" databaseType="NUMBER" datatype="java.lang.Long" physicalName="CON_CONTRACT_BP_ID" prompt="CON_CONTRACT_CONTENT_V.CON_CONTRACT_BP_ID"/>
         <bm:field name="mortgage_id" databaseType="NUMBER" datatype="java.lang.Long" physicalName="MORTGAGE_ID" prompt="CON_CONTRACT_CONTENT_V.MORTGAGE_ID"/>
         <bm:field name="content_number" databaseType="VARCHAR2" datatype="java.lang.String" forDisplay="true" forQuery="true" physicalName="CONTENT_NUMBER" prompt="文本编号"/>
+        <bm:field name="content_number_bcn" databaseType="VARCHAR2" datatype="java.lang.String" forDisplay="true" forQuery="true" physicalName="CONTENT_NUMBER_BCN" prompt="文本编号"/>
         <bm:field name="content_print_flag" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="CONTENT_PRINT_FLAG" prompt="CON_CONTRACT_CONTENT_V.CONTENT_PRINT_FLAG"/>
         <bm:field name="content_print_flag_name" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="CONTENT_PRINT_FLAG_NAME" prompt="CON_CONTRACT_CONTENT_V.CONTENT_PRINT_FLAG_NAME"/>
         <bm:field name="bp_category" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="BP_CATEGORY" prompt="CON_CONTRACT_CONTENT_V.BP_CATEGORY"/>
@@ -32,6 +35,7 @@
         <bm:field name="templet_usage" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="TEMPLET_USAGE" prompt="CON_CONTRACT_CONTENT_V.TEMPLET_USAGE"/>
         <bm:field name="clause_usage" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="CLAUSE_USAGE" prompt="CON_CONTRACT_CONTENT_V.CLAUSE_USAGE"/>
         <bm:field name="clause_usage_name" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="CLAUSE_USAGE_NAME" prompt="CON_CONTRACT_CONTENT_V.CLAUSE_USAGE_NAME"/>
+        <bm:field name="business_type" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="BUSINESS_TYPE" prompt="PRJ_PROJECT_V.BUSINESS_TYPE"/>
         <bm:field name="ref_v01" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="REF_V01" prompt="CON_CONTRACT_CONTENT.REF_V01"/>
         <bm:field name="ref_v02" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="REF_V02" prompt="CON_CONTRACT_CONTENT.REF_V02"/>
         <bm:field name="ref_v03" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="REF_V03" prompt="CON_CONTRACT_CONTENT.REF_V03"/>
@@ -47,15 +51,35 @@
         <bm:field name="ref_d03" databaseType="DATE" datatype="java.util.Date" physicalName="REF_D03" prompt="CON_CONTRACT_CONTENT.REF_D03"/>
         <bm:field name="ref_d04" databaseType="DATE" datatype="java.util.Date" physicalName="REF_D04" prompt="CON_CONTRACT_CONTENT.REF_D04"/>
         <bm:field name="ref_d05" databaseType="DATE" datatype="java.util.Date" physicalName="REF_D05" prompt="CON_CONTRACT_CONTENT.REF_D05"/>
+        <bm:field name="sign_bp_id" databaseType="NUMBER" datatype="java.lang.Long" physicalName="SIGN_BP_ID" prompt="CON_CONTRACT_CONTENT.SIGN_BP_ID"/>
+        <bm:field name="sign_bp_id_n" forInsert="false" forUpdate="false"
+                  expression="( select decode(h1.bp_name, '', '', h1.bp_name ) ||
+                                       decode(h2.bp_name, '', '', ',' || h2.bp_name  ) || decode(h3.bp_name, '', '', ',' || h3.bp_name  )  bp_name
+                                  from hls_bp_master        h1,
+                                       hls_bp_master        h2,
+                                       hls_bp_master        h3,
+                                       con_contract_content ccc
+                                 where h1.bp_id(+) = ccc.sign_bp_id_1
+                                   and h2.bp_id(+) = ccc.sign_bp_id_2
+                                   and h3.bp_id(+) = ccc.sign_bp_id_3
+                                   and ccc.content_id=t1.content_id)"/>
         <bm:field name="couple_guarantee_flag" databaseType="VARCHAR2" datatype="java.lang.String"/>
-        <bm:field name="attach_count" expression="(select count(1) from fnd_atm_attachment_multi m  where m.table_name = &apos;CON_CONTRACT_CONTENT_WORKFLOW&apos;  and m.table_pk_value = to_char(t1.content_id)  and nvl(m.del_flag,0)=0" forInsert="false" forUpdate="false"/>
+        <bm:field name="attach_count" expression="(select count(1) from fnd_atm_attachment_multi m  where m.table_name = &apos;CON_CONTRACT_CONTENT_WORKFLOW&apos;  and m.table_pk_value = to_char(t1.content_id))" forInsert="false" forUpdate="false"/>
         <bm:field name="print_date" databaseType="DATE" datatype="java.util.Date"/>
         <bm:field name="content_type"/>
         <!-- <bm:field name="search_term_1"/> -->
         <bm:field name="project_id"/>
         <bm:field name="prj_bp_id"/>
+        <bm:field name="con_atm_source_pk_value" expression="(SELECT a.source_pk_value FROM fnd_atm_attachment a ,fnd_atm_attachment_multi m WHERE a.attachment_id = m.attachment_id       AND m.table_name = &apos;CON_CONTRACT_CONTENT&apos;   AND m.table_pk_value = t1.content_id and rownum=1) " forInsert="false" forUpdate="false"/>
         <bm:field name="file_name" expression="(hls_sys_upload_pkg.get_atm_file_href(p_table_pk_value =&gt; t1.content_id,p_source_type =&gt; &apos;CON_CONTRACT_CONTENT_V&apos;,p_user_id =&gt; 1))"/>
         <bm:field name="templet_type" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="TEMPLET_TYPE" prompt="CON_CONTRACT_CONTENT_V.TEMPLET_TYPE"/>
+        <bm:field name="print_num" databaseType="NUMBER" datatype="java.lang.Long" physicalName="PRINT_NUM" prompt="CON_CONTRACT_CONTENT_V.PRINT_NUM"/>
+        <bm:field name="change_flag" databaseType="VARCHAR2" datatype="java.lang.String"/>
+        <bm:field name="virtual_con_number" databaseType="VARCHAR2" datatype="java.lang.String"/>
+        <bm:field name="version_num" databaseType="VARCHAR2" datatype="java.lang.String"/>
+        <bm:field name="change_version_num" databaseType="VARCHAR2" datatype="java.lang.String"/>
+        <bm:field name="linked_content_id" databaseType="NUMBER" datatype="java.lang.Long"/>
+        <bm:field name="linked_content_number" databaseType="VARCHAR2" datatype="java.lang.String" expression="(select content_number from con_contract_content where content_id = t1.linked_content_id)"/>
     </bm:fields>
     <bm:features>
         <f:standard-who/>
@@ -63,8 +87,25 @@
     <bm:query-fields>
         <bm:query-field field="content_number" queryOperator="like"/>
         <bm:query-field field="content_type" queryOperator="="/>
+        <bm:query-field field="version_num" queryOperator="="/>
+        <bm:query-field field="change_version_num" queryOperator="="/>
     </bm:query-fields>
     <bm:data-filters>
         <bm:data-filter enforceOperations="query" expression="t1.project_id=${@project_id}"/>
     </bm:data-filters>
+    <bm:operations>
+        <bm:operation name="execute">
+            <bm:update-sql><![CDATA[
+                begin
+                    sdic_con_contract_content_pkg.check_content_uploadfile_type(p_table_name        =>${@table_name},
+                                                                                p_table_pk_value    =>${@header_id},
+                                                                                p_user_id           =>${/session/@user_id},
+                                                                                p_return_msg        =>${@return_msg});
+                end;
+         ]]></bm:update-sql>
+            <bm:parameters>
+                <bm:parameter name="return_msg" datatype="java.lang.String" output="true" outputPath="@return_msg"/>
+            </bm:parameters>
+        </bm:operation>
+    </bm:operations>
 </bm:model>
Index: src/main/resources/leaf_static/modules/prj/PRJ506/con_doc_batch_create.lsc
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/prj/PRJ506/con_doc_batch_create.lsc b/src/main/resources/leaf_static/modules/prj/PRJ506/con_doc_batch_create.lsc
--- a/src/main/resources/leaf_static/modules/prj/PRJ506/con_doc_batch_create.lsc	(revision 302afbbf6d2d765f5b525e0e33584b9da97521cb)
+++ b/src/main/resources/leaf_static/modules/prj/PRJ506/con_doc_batch_create.lsc	(revision 82b0f7956ace61babe9813d97b2d2d5fc946aca9)
@@ -30,24 +30,28 @@
                     var guid_file_name_path = $bm('cont.CON500.con_contract_get_guid_file_name').queryAsMap();
                     var guid_file_name_tables = guid_file_name_path.getChildren();
                     to_file_path = to_file_path + guid_file_name_tables[0].guid_file_name + 'con' + record_data.content_id;
-        println(from_file_path+"AAAAA");
-        println(to_file_path+"BBBB");
+                    println(from_file_path+"AAAAA");
+                    println(to_file_path+"BBBB");
                     copyFile(from_file_path, to_file_path);
             	    // source_type=VITUAL_CON 虚拟合同    add by wujun for huaneng 2018/10/22
+
+
+                    try {
+                        var brwt = new BookmarksReplaceWithText($instance('leaf.database.service.IDatabaseServiceFactory'), $instance('uncertain.ocm.IObjectRegistry'), $ctx.getData());
+                        var file_map = brwt.replaceBookmarkFromContent(to_file_path.toString(), record_data.content_id);
+                        var content_file = java.io.File(to_file_path.toString());
+                        var content_file_size = content_file.length();
+                    } catch (e) {
+                        raise_app_error(e);
+                    }
                     $bm('cont.CON500.con_file_content_copy_update').update({
                         table_name: 'CON_CONTRACT_CONTENT',
                         content_id: record_data.content_id,
       	                source_type: 'VITUAL_CON',
                         file_name: to_file_name.toString(),
-                        file_path: to_file_path.toString()
+                        file_path: to_file_path.toString(),
+                        file_size: content_file_size
                     });
-
-                    try {
-                        var brwt = new BookmarksReplaceWithText($instance('leaf.database.service.IDatabaseServiceFactory'), $instance('uncertain.ocm.IObjectRegistry'), $ctx.getData());
-                        brwt.replaceBookmarkFromContent(to_file_path.toString(), record_data.content_id);
-                    } catch (e) {
-                        raise_app_error(e);
-                    }
                 }
             }
         ]]></s:server-script>
Index: src/main/resources/leaf_static/WEB-INF/classes/hn/HN1012/hn_virtual_project_change_req_info.lwm
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/WEB-INF/classes/hn/HN1012/hn_virtual_project_change_req_info.lwm b/src/main/resources/leaf_static/WEB-INF/classes/hn/HN1012/hn_virtual_project_change_req_info.lwm
--- a/src/main/resources/leaf_static/WEB-INF/classes/hn/HN1012/hn_virtual_project_change_req_info.lwm	(revision a8aa09e3fc924190a3b4200fad90f7bf6e8cb5c8)
+++ b/src/main/resources/leaf_static/WEB-INF/classes/hn/HN1012/hn_virtual_project_change_req_info.lwm	(revision 8fb9e29163b48a9af754ab7d2b316bc6cefb9faf)
@@ -13,9 +13,30 @@
                    (SELECT t.change_req_id,
 					       t.change_req_number,
 					       t.company_id,
-					       t.project_id old_project_id,
+					       decode(t.status, 'APPROVED', (
+					            select pp.project_id
+                                from prj_project pp
+                                where pp.project_number= pp2.project_number
+                                and pp.virtual_con_number= pp2.virtual_con_number
+                                and pp.data_class = 'HISTORY'
+                                and version = (select version from prj_project where project_id = t.change_req_id) - 1
+                                and rownum = 1
+					       ), t.project_id) old_project_id,
+					       t.project_id as content_project_id,
 					       t.status,
 					       to_date(to_char(t.req_date,'yyyy/mm/dd'),'yyyy/mm/dd') req_date,
+					       (select max(replace(version_num, 'V')) from con_contract_content where project_id = t.change_req_id) new_version_num,
+					       (select max(replace(version_num, 'V')) from con_contract_content where project_id =
+					       decode(t.status, 'APPROVED', (
+					            select pp.project_id
+                                from prj_project pp
+                                where pp.project_number= pp2.project_number
+                                and pp.virtual_con_number= pp2.virtual_con_number
+                                and pp.data_class = 'HISTORY'
+                                and version = (select version from prj_project where project_id = t.change_req_id) - 1
+                                and rownum = 1
+					       ), t.project_id)) old_version_num,
+
 					       t.description,
 					       t.wfl_instance_id,
 					       t.owner_user_id,
@@ -52,13 +73,16 @@
 					           and pp.ref_project_id = pp1.ref_project_id) total_virtual_con_amount,
 					       pp2.finance_amount before_change_amount,
 					       pp1.project_id,
+					       pp2.cdd_list_id,
 					       pp1.hn_industry_classification,
 					       t.unsigned_adjust_flag,
 					       pp1.content_wfl_status,
 					       (select r.wfl_instance_id
                               from prj_plan_change_req r
                              where r.change_req_id = t.source_id
-                               and t.source_type = 'HN_PRJ_PLAN') plan_instance_id
+                               and t.source_type = 'HN_PRJ_PLAN') plan_instance_id,
+                           pp1.version_num
+
 					  FROM hn_virtual_con_change_req t, prj_project_v pp1, prj_project_v pp2
 					 WHERE t.project_id = pp2.project_id
 					   AND t.change_req_id = pp1.project_id
@@ -110,6 +134,7 @@
         <bm:field name="project_number"/>
         <bm:field name="project_name"/>
         <bm:field name="virtual_con_number"/>
+        <bm:field name="cdd_list_id"/>
         <bm:field name="virtual_con_name"/>
         <bm:field name="lease_organization_desc"/>
         <bm:field name="employee_name"/>
@@ -123,6 +148,11 @@
         <bm:field name="unsigned_adjust_flag"/>
         <bm:field name="content_wfl_status"/>
         <bm:field name="plan_instance_id"/>
+        <!-- 这里有三个version_num 第一个指的是change_version_num 真版本号 后两个分别查的是变更前后的伪版本号-->
+        <bm:field name="version_num"/>
+        <bm:field name="old_version_num"/>
+        <bm:field name="new_version_num"/>
+        <bm:field name="content_project_id"/>
     </bm:fields>
     <bm:data-filters>
         <bm:data-filter name="change_req_id" expression="t1.change_req_id=${@change_req_id}"/>
Index: src/main/resources/leaf_static/WEB-INF/classes/prj/PRJ506/get_last_change_req_id.lwm
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/WEB-INF/classes/prj/PRJ506/get_last_change_req_id.lwm b/src/main/resources/leaf_static/WEB-INF/classes/prj/PRJ506/get_last_change_req_id.lwm
new file mode 100644
--- /dev/null	(revision 9540280c8903c3f8467b264884b6e820b8f91d18)
+++ b/src/main/resources/leaf_static/WEB-INF/classes/prj/PRJ506/get_last_change_req_id.lwm	(revision 9540280c8903c3f8467b264884b6e820b8f91d18)
@@ -0,0 +1,21 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!--
+    $Author: hand
+    $Date: 2017-9-11 下午4:38:25
+    $Revision: 1.0
+    $Purpose:
+-->
+<bm:model xmlns:bm="http://www.leaf-framework.org/schema/bm">
+    <bm:operations>
+        <bm:operation name="query">
+            <bm:query-sql><![CDATA[
+              select t1.project_id from (select pp.project_id
+                  from prj_project pp
+                  where pp.project_number= (select project_number from prj_project where project_id = ${@project_id})
+                  and pp.virtual_con_number= (select virtual_con_number from prj_project where project_id = ${@project_id})
+                  and pp.data_class = 'CHANGE_REQ'
+                  order by pp.project_id desc) t1 where rownum = 1
+          ]]></bm:query-sql>
+        </bm:operation>
+    </bm:operations>
+</bm:model>
Index: src/main/resources/leaf_static/modules/prj/PRJ506/virtual_contract_modify.lview
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/prj/PRJ506/virtual_contract_modify.lview b/src/main/resources/leaf_static/modules/prj/PRJ506/virtual_contract_modify.lview
--- a/src/main/resources/leaf_static/modules/prj/PRJ506/virtual_contract_modify.lview	(revision a8aa09e3fc924190a3b4200fad90f7bf6e8cb5c8)
+++ b/src/main/resources/leaf_static/modules/prj/PRJ506/virtual_contract_modify.lview	(revision cb56d95b1c4f5a62314b8fe4acff55e485704034)
@@ -48,20 +48,22 @@
         <a:link id="hn1400_manager_downloadF_link_id" url="${/request/@context_path}/downloadFile.lview"/>
         <a:link id="${/parameter/@layout_code}_pageLink_node_approve_history"
                 url="${/request/@context_path}/modules/zjwfl/ZJWFL1060/zj_wfl_monitoring_node_approve_history.lview"/>
-        <a:link id="prj_project_select_content_edit_link_id"
-                url="${/request/@context_path}/modules/prj/PRJ506/prj_project_print_detail.lview"/>
         <a:link id="con_content_select_content_edit_link_id"
                 url="${/request/@context_path}/modules/prj/PRJ506/prj_project_print_detail.lview"/>
+        <a:link id="prj_project_virtual_con_cancel_link_id" model="prj.PRJ506.hn_create_consultancy_service_init_link" modelaction="update"/>
         <script><![CDATA[
         //忽略保存校验方法
         //诡异bug,某个字段必输，换种方法
         window['${/parameter/@layout_code}_ignore_required_before_save'] = function () {
             window['${/parameter/@layout_code}_not_ignore_required_flag'] = false;
         };
+
         //保存前调用
         window['${/parameter/@bp_seq}${/parameter/@layout_code}_on_layout_dynamic_before_submit'] = function (ds, record) {
             window['${/parameter/@layout_code}_lock_layout_dynamic_window']();
+
             var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_project');
+
             var records = $(ds_id).getAt(0);
             if (!records.get('virtual_con_name')) {
                 Leaf.showMessage('${l:HLS.PROMPT}', '合同名称不能为空！');
@@ -97,7 +99,6 @@
                 });
             } else {
                 Leaf.showMessage('${l:HLS.PROMPT}', '请先保存!');
-
             }
         }

@@ -124,23 +125,31 @@
          }; */
         //创建合同文本
         window['${/parameter/@layout_code}_user_button1_layout_dynamic_click'] = function () {
-
+            debugger;
             var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_project');
             var record = $(ds_id).getCurrentRecord();
+            var ch_show_flag = '${/parameter/@ch_show_flag}';
+            var change_version_num = '${/parameter/@unsigned_adjust_flag}' === 'N'? $(ds_id).getAt(0).get("change_version_num") : '';
+
+            let asset_flag = asset_info_valid()
+
+            if(!asset_flag){
+                return;
+            }
+
             //update panhong  对以前的合同设置不能打印
             var date = new Date().format('2019-01-21');
-            if (record.get('business_type') == 'FACTORING_BUSINESS' || record.get('create_date') <= date) {
+            if (record.get('create_date') <= date) {
                 Leaf.request({
                     url: '${/request/@context_path}/autocrud/prj.PRJ506.check_prj_saled_type/update',
                     para: {
-                        project_id: record.get('project_id')
+                        project_id: record.get('project_id'),
+                        fun_code: '${/parameter/@fun_code}'
                     },
                     scope: this,
                     success: function () {
                         var str = '';
-                        if (record.get('business_type') == 'FACTORING_BUSINESS') {
-                            str = '此项目为保理项目，系统暂不支持合同文本生成';
-                        } else if (record.get('create_date') <= date) {
+                        if (record.get('create_date') <= date) {
                             str = '该合同为存续合同，系统暂不支持合同模板打印，如有问题请联系信息化建设工作小组';
                         }
                         Leaf.showErrorMessage('${l:HLS.PROMPT}', str, null, 400, 130);
@@ -163,7 +172,9 @@
                         document_table: 'PRJ_PROJECT',
                         winid: '${/parameter/@layout_code}_prj_project_content_confirm_win_id',
                         ch_show_flag: '${/parameter/@ch_show_flag}',
-                        contract_approval_flag: '${/parameter/@contract_approval_flag}'
+                        contract_approval_flag: '${/parameter/@contract_approval_flag}',
+                        fun_code: '${/parameter/@fun_code}',
+                        change_version_num
                     },
                     url: $('${/parameter/@layout_code}_prj_project_content_confirm_link_id').getUrl(),
                     title: '合同文本生成',
@@ -182,48 +193,65 @@
                 });
             }
             else{
-                Leaf.showConfirm('提示', '您是否确定融资金额为'+record.get('finance_amount')+'?', function() {
-                    Leaf.request({
-                        url: '${/request/@context_path}/autocrud/prj.PRJ506.prj_project_update_content_copy/update',
-                        para: {
-                            project_id: '${/parameter/@project_id}'
-                        },
-                        success: function (res) {
-                            debugger;
-                            var win = new Leaf.Window({
-                                id: '${/parameter/@layout_code}_prj_project_content_confirm_win_id',
-                                params: {
-                                    project_id: record.get('project_id'),
-                                    document_table: 'PRJ_PROJECT',
-                                    winid: '${/parameter/@layout_code}_prj_project_content_confirm_win_id',
-                                    ch_show_flag: '${/parameter/@ch_show_flag}',
-                                    contract_approval_flag: '${/parameter/@contract_approval_flag}'
-                                },
-                                url: $('${/parameter/@layout_code}_prj_project_content_confirm_link_id').getUrl(),
-                                title: '合同文本生成',
-                                fullScreen: true
-                            });
-                            //在关闭页面之后,刷新一下ds
-                            win.on('close', function () {
-                                var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'con_contract_content');
-                                if (ds_id) {
-                                    $(ds_id).query();
-                                }
-                                var ds = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_project');
-                                if (ds){
-                                    $(ds).query();
-                                }
-                            });
-                        },
-                        failure: function () {
-                            // window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
-                        },
-                        error: function () {
-                            // window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
-                        },
-                        scope: this
-                    });
-                });
+                // if (ch_show_flag=='Y'){
+                //     var win = new Leaf.Window({
+                //         id: '${/parameter/@layout_code}_prj_project_content_confirm_win_id',
+                //         params: {
+                //             project_id: record.get('project_id'),
+                //             document_table: 'PRJ_PROJECT',
+                //             winid: '${/parameter/@layout_code}_prj_project_content_confirm_win_id',
+                //             ch_show_flag: '${/parameter/@ch_show_flag}'
+                //         },
+                //         url: $('${/parameter/@layout_code}_prj_project_content_confirm_link_id').getUrl(),
+                //         title: '合同文本生成',
+                //         fullScreen: true
+                //     });
+                // }else {
+                    Leaf.showConfirm('提示', sp_format(`当前合同金额为{0}元，您确认吗？`, record.get('finance_amount')), function () {
+                        Leaf.request({
+                            url: '${/request/@context_path}/autocrud/prj.PRJ506.prj_project_update_content_copy/update',
+                            para: {
+                                project_id: '${/parameter/@project_id}'
+                            },
+                            success: function (res) {
+                                debugger;
+                                var win = new Leaf.Window({
+                                    id: '${/parameter/@layout_code}_prj_project_content_confirm_win_id',
+                                    params: {
+                                        project_id: record.get('project_id'),
+                                        document_table: 'PRJ_PROJECT',
+                                        winid: '${/parameter/@layout_code}_prj_project_content_confirm_win_id',
+                                        ch_show_flag: '${/parameter/@ch_show_flag}',
+                                        contract_approval_flag: '${/parameter/@contract_approval_flag}',
+                                        fun_code: '${/parameter/@fun_code}',
+                                        change_version_num
+                                    },
+                                    url: $('${/parameter/@layout_code}_prj_project_content_confirm_link_id').getUrl(),
+                                    title: '合同文本生成',
+                                    fullScreen: true
+                                });
+                                //在关闭页面之后,刷新一下ds
+                                win.on('close', function () {
+                                    var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'con_contract_content');
+                                    if (ds_id) {
+                                        $(ds_id).query();
+                                    }
+                                    var ds = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_project');
+                                    if (ds) {
+                                        $(ds).query();
+                                    }
+                                });
+                            },
+                            failure: function () {
+                                // window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
+                            },
+                            error: function () {
+                                // window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
+                            },
+                            scope: this
+                        });
+                    });
+                // }
             }

         }
@@ -277,6 +305,9 @@
                     a = a + 1;
                 }
             }
+
+
+
             if (a > 0) {
                 Leaf.showMessage('${l:HLS.PROMPT}', '商业伙伴资料下,预留印鉴信息到期日要大于当天,请修改!');
                 window['${/parameter/@bp_seq}${/parameter/@layout_code}_unlock_layout_dynamic_window']();
@@ -284,8 +315,42 @@
             } else {
                 window['${/parameter/@layout_code}_SAVE_LAYOUT_DYNAMIC_CLICK'](virtual_con_submit_approval);
             }
-            return;
+
         };
+        //提交审批资产信息效验
+        function asset_info_valid(){
+            let asset_ds_arr = [
+                $(get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_project_lease_item', 'G_CON_LEASE_ITEM')),
+                $(get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_project_lease_item', 'G_CON_LEASE_ITEM_02')),
+                $(get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'hn_virtual_offer_contract', 'F_CONTRACT_LIST')),
+                $(get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_project_mortgage', 'G_CON_MORTGAGE'))
+            ]
+            let dirty_flag = false
+            let all_rec_length = asset_ds_arr.reduce((all_count, cur_ds)=>{
+                let all_records = cur_ds.getAll()
+                if(cur_ds.validate()){
+                    for (let i = 0; i < all_records.length; i++) {
+                        if(all_records[i].dirty === true){
+                            Leaf.showMessage('${l:HLS.PROMPT}', '请先保存!');
+                            dirty_flag = true
+                            break
+                        }
+                    }
+                } else{
+                    dirty_flag = true
+                }
+                return all_count + all_records.length
+            }, 0)
+
+            if(dirty_flag){
+                return false
+            }
+            if(all_rec_length === 0){
+                Leaf.showMessage('${l:HLS.PROMPT}', '请维护资产相关信息!');
+                return false
+            }
+            return true
+        }

         /*预留印鉴表信息超链接  合同审批新建*/
         window['${/parameter/@layout_code}_hls213n_hls_bp_rese_table_uploadd'] = function (id, name, query_only) {
@@ -746,6 +811,7 @@
         window['${/parameter/@bp_seq}${/parameter/@layout_code}_on_layout_dynamic_grid_query'] = function (ds, qpara, bp_seq) {
             var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_project_bp');
             $(ds_id).setQueryParameter('bp_seq', 1);
+
         };

         //加载时调用(grid,table,gridBox)
@@ -941,11 +1007,18 @@
         //adjust by jcp
         window['${/parameter/@layout_code}_user_button4_layout_dynamic_click'] = function () {
             var ds = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_project');
-            var record = $(ds).getCurrentRecord();
+            var record = $(ds).getAt(0);
+            var change_version_num = '${/parameter/@unsigned_adjust_flag}' === 'N'? record.get("change_version_num") : '';
+            let asset_flag = asset_info_valid()
+
+            if(!asset_flag){
+                return;
+            }
+
             if(record.get('sure_flag')=='Y'){
-                var url = 'con_content_select_content_edit_link_id';
-                var fun_code = '${/parameter/@function_code}';
-                if(fun_code == 'HN1012D'){
+                var url;
+                var fun_code = '${/parameter/@fun_code}';
+                if(fun_code == 'Y'){
                     url = $('con_content_select_content_edit_link_id').getUrl();
                 }
                 var win = new Leaf.Window({
@@ -955,7 +1028,8 @@
                         project_id: '${/parameter/@project_id}',
                         winid: 'prj_project_create_content_print_win_id',
                         ch_show_flag: '${/parameter/@ch_show_flag}',
-                        fun_code:'${/parameter/@fun_code}'
+                        fun_code:'${/parameter/@fun_code}',
+                        change_version_num
                     },
                     id: 'prj_project_create_content_print_win_id',
                     fullScreen: true
@@ -971,15 +1045,15 @@
                 });
             }
             else{
-                    Leaf.showConfirm('提示', '您是否确定融资金额为'+record.get('finance_amount')+'?', function() {
+                    Leaf.showConfirm('提示', sp_format(`当前合同金额为{0}元，您确认吗？`, record.get('finance_amount')), function() {
                         Leaf.request({
                             url: '${/request/@context_path}/autocrud/prj.PRJ506.prj_project_update_content_copy/execute',
                             para: {
-                                project_id: '${/parameter/@project_id}',
+                                project_id: '${/parameter/@project_id}'
                             },
                             success: function (res) {
                                 // var record = $(ds_con_id).getAt(0);
-                                var url = 'con_content_select_content_edit_link_id';
+                                var url;
                                 var fun_code = '${/parameter/@fun_code}';
                                 if(fun_code == 'Y'){
                                     url = $('con_content_select_content_edit_link_id').getUrl();
@@ -991,7 +1065,8 @@
                                         project_id: '${/parameter/@project_id}',
                                         winid: 'prj_project_create_content_print_win_id',
                                         ch_show_flag: '${/parameter/@ch_show_flag}',
-                                        fun_code:'${/parameter/@fun_code}'
+                                        fun_code:'${/parameter/@fun_code}',
+                                        change_version_num
                                     },
                                     id: 'prj_project_create_content_print_win_id',
                                     fullScreen: true
@@ -1105,6 +1180,39 @@
             }
         };

+
+        //合同审批取消按钮
+        window['${/parameter/@layout_code}_user_button5_layout_dynamic_click'] = function () {
+            var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_project');
+            var current_record = $(ds_id).getCurrentRecord();
+
+            Leaf.showConfirm('${l:HLS.PROMPT}', '确定合同撤销吗？', function () {
+                window['${/parameter/@layout_code}_lock_layout_dynamic_window']();
+                Leaf.request({
+                    url: $('prj_project_virtual_con_cancel_link_id').getUrl(),
+                    para: {
+                        project_id: current_record.get('project_id')
+                    },
+                    scope: this,
+                    success: function () {
+                        window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
+                        $('${/parameter/@winid}').close();
+                        $('projectQueryScreen_mainDs').query();
+                    },
+                    failure: function () {
+                        window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
+                    },
+                    error: function () {
+                        window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
+                    }
+                });
+            }, null, 400, 130);
+
+
+
+        };
         ]]></script>
+        <a:screen-include screen="modules/simple/simple_util.lview?para=${/parameter/}"/>
+
     </a:view>
 </a:screen>
Index: src/main/resources/leaf_static/modules/prj/PRJ507/prj_project_sign_entrace.lview
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/prj/PRJ507/prj_project_sign_entrace.lview b/src/main/resources/leaf_static/modules/prj/PRJ507/prj_project_sign_entrace.lview
--- a/src/main/resources/leaf_static/modules/prj/PRJ507/prj_project_sign_entrace.lview	(revision a8aa09e3fc924190a3b4200fad90f7bf6e8cb5c8)
+++ b/src/main/resources/leaf_static/modules/prj/PRJ507/prj_project_sign_entrace.lview	(revision 9540280c8903c3f8467b264884b6e820b8f91d18)
@@ -15,6 +15,8 @@
         <a:link id="prj_project_detail_link"
                 url="${/request/@context_path}/modules/prj/PRJ501Z/prj_project_modify_info.lview"/>
         <a:link id="prj_project_virtual_sign_submit_link_id" model="prj.PRJ507.prj_project_sign_entrance" modelaction="execute"/>
+        <a:link id="get_last_change_req_id" model="prj.PRJ506.get_last_change_req_id" modelaction="query"/>
+
         <script><![CDATA[
         function render_formatDate(value, record, name) {
             if (!Ext.isEmpty(value)) {
@@ -102,9 +104,20 @@
             param['url_title'] = '合同明细';
             // param['layout_debugger_flag'] = 'Y';
             param['winid'] = 'prj506_virtual_contract_modify_detail_link_id';
+
+            Leaf.request({
+                url: $('get_last_change_req_id').getUrl(),
+                para: {project_id},
+                success: function(res) {
+                    console.log(res.data[0])
+                },
+                scope: this
+            });
             hls_doc_get_layout_code('prj_project_get_layout_code_link_id_1', param, url_link_id, 'projectQueryScreen_mainDs');
         }

+
+
         function prj501_project_number_render(value, record, name) {
             if(record.get('prj_plan_flag')=='Y'){
                 return '<a href="javascript:open_prj_project_scheme_detail_query_win(\'' + record.id + '\',\'' + record.ds.id + '\')">' + value + '</a>';
Index: src/main/resources/leaf_static/WEB-INF/classes/prj/PRJ506/prj_project_content_save.lwm
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/WEB-INF/classes/prj/PRJ506/prj_project_content_save.lwm b/src/main/resources/leaf_static/WEB-INF/classes/prj/PRJ506/prj_project_content_save.lwm
--- a/src/main/resources/leaf_static/WEB-INF/classes/prj/PRJ506/prj_project_content_save.lwm	(revision 3f1713e87935eeabff3b7d08496727b686183804)
+++ b/src/main/resources/leaf_static/WEB-INF/classes/prj/PRJ506/prj_project_content_save.lwm	(revision c7f0b99c9b98199635c218c76649269c36017740)
@@ -41,8 +41,13 @@
 			              p_mortgage_id=>${@mortgage_id},
 			              p_content_print_flag=>${@content_print_flag},
 			              p_available_flag=>${@available_flag},
-			              p_user_id=>${/session/@user_id}
-		              );
+			              p_user_id=>${/session/@user_id},
+			              p_print_num => ${@print_num}
+		            );
+
+		            update con_contract_content
+		                set linked_content_id = ${@linked_content_id}
+		            where content_id = ${@content_id};
             	end;
             ]]></bm:update-sql>
         </bm:operation>
Index: src/main/resources/leaf_static/modules/ga/ga100/hn_prj_ga_enterance.lview
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/ga/ga100/hn_prj_ga_enterance.lview b/src/main/resources/leaf_static/modules/ga/ga100/hn_prj_ga_enterance.lview
--- a/src/main/resources/leaf_static/modules/ga/ga100/hn_prj_ga_enterance.lview	(revision 51005de06f2b4ce85538d067581f75414c4f5353)
+++ b/src/main/resources/leaf_static/modules/ga/ga100/hn_prj_ga_enterance.lview	(revision 1fed35ea3c479c0a340f90fc05070f53e3cd9984)
@@ -88,11 +88,11 @@
             Leaf.request({
                 url: '${/request/@context_path}/autocrud/prj.PRJ502N.hn_group_org_business_user/update',
                 success: function(res) {
-                    role_code = res.result.role_code;
+                    let role_code = res.result.role_code;
                     if (role_code === "AFTER_RENT_BUSINESS_W") {
                         Leaf.showErrorMessage('提示', '您没有权限新增!');
                     } else {
-                        new Leaf.Window({
+                        let win = Leaf.Window({
                             id: 'hn1012_prj_project_change_create_entrance_win',
                             url: $('hn1012_virtual_change_create_entrance_link').getUrl(),
                             params: {
@@ -127,16 +127,16 @@
                 var instance_id = record.get('wfl_instance_id');
             }
             if (instance_id) {
-                            new Leaf.Window({
-                                id: 'node_approve_history_win',
-                                url: $('prj502n_pageLink_node_approve_history').getUrl(),
-                                params: {
-                                    instance_id: instance_id,
-                                    show_hide: 'Y'
-                                },
-                                title: '单据明细',
-                                fullScreen: true
-                            });
+                new Leaf.Window({
+                    id: 'node_approve_history_win',
+                    url: $('prj502n_pageLink_node_approve_history').getUrl(),
+                    params: {
+                        instance_id: instance_id,
+                        show_hide: 'Y'
+                    },
+                    title: '单据明细',
+                    fullScreen: true
+                });
             } else {
                 Leaf.showErrorMessage('提示', '该项目尚未发起上会审批！');
             }
Index: src/main/resources/leaf_static/modules/hn/HN1012/prj_project_virtual_change_req_enterance.lview
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/hn/HN1012/prj_project_virtual_change_req_enterance.lview b/src/main/resources/leaf_static/modules/hn/HN1012/prj_project_virtual_change_req_enterance.lview
--- a/src/main/resources/leaf_static/modules/hn/HN1012/prj_project_virtual_change_req_enterance.lview	(revision 51005de06f2b4ce85538d067581f75414c4f5353)
+++ b/src/main/resources/leaf_static/modules/hn/HN1012/prj_project_virtual_change_req_enterance.lview	(revision 1fed35ea3c479c0a340f90fc05070f53e3cd9984)
@@ -91,11 +91,11 @@
             Leaf.request({
                 url: '${/request/@context_path}/autocrud/prj.PRJ502N.hn_group_org_business_user/update',
                 success: function(res) {
-                    role_code = res.result.role_code;
+                    let role_code = res.result.role_code;
                     if (role_code === "AFTER_RENT_BUSINESS_W") {
                         Leaf.showErrorMessage('提示', '您没有权限新增!');
                     } else {
-                        new Leaf.Window({
+                        let win = Leaf.Window({
                             id: 'hn1012_prj_project_change_create_entrance_win',
                             url: $('hn1012_virtual_change_create_entrance_link').getUrl(),
                             params: {
Index: src/main/resources/leaf_static/modules/prj/PRJ506/prj_atm_batch_dl.lsc
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/prj/PRJ506/prj_atm_batch_dl.lsc b/src/main/resources/leaf_static/modules/prj/PRJ506/prj_atm_batch_dl.lsc
--- a/src/main/resources/leaf_static/modules/prj/PRJ506/prj_atm_batch_dl.lsc	(revision 31d7f61a53743ee1e97b0794beec3b4372083d44)
+++ b/src/main/resources/leaf_static/modules/prj/PRJ506/prj_atm_batch_dl.lsc	(revision d849e2595021c000cd6b36dde95c8971bd48b83e)
@@ -38,7 +38,7 @@
             var doc_code = '合同文本'
             //println(decodeURI($ctx.parameter.doc_code));
             var path = $ctx.parameter.path;
-            var filename = doc_code + '-' + date_str + ".zip"
+            var filename = doc_code + '-' + $ctx.parameter.virtual_con_number +  '-' + date_str + ".zip"
             resp.setDateHeader("Expires", 0);
             resp.setContentType("application/x-msdownload");
             var content_id = $ctx.parameter.content_id;
@@ -49,11 +49,11 @@
                         content_id: $ctx.parameter.content_id,
                         contract_id: $ctx.parameter.contract_id,
                         project_id:$ctx.parameter.project_id,
-                        content_type: $ctx.parameter.content_type
+                        content_type: $ctx.parameter.content_type,
+                        change_version_num: $ctx.parameter.change_version_num
                     });
                     var arr = result.getChildren();
                     if (arr.length >= 1) {
-
                         var doc_name=arr[0].content_number+'-'+arr[0].templet_name+'-'+arr[0].pbp_name+'.doc';

                         resp.setHeader("Content-disposition", "attachment; filename="+encodeURI(doc_name,'utf-8'));
@@ -70,7 +70,8 @@
                 var result = attachment_batch_dl.queryAsMap({
                     contract_id: $ctx.parameter.contract_id,
                     templet_name: $ctx.parameter.templet_name,
-                    project_id: $ctx.parameter.project_id
+                    project_id: $ctx.parameter.project_id,
+                    change_version_num: $ctx.parameter.change_version_num
                 });
                 var arr = result.getChildren();
                 println(arr);
@@ -80,7 +81,17 @@
                 //zos.setEncoding("GBK"); //如果是org.apache.tools.zip需要追加字符集
                 for (var i = 0;i < arr.length;i++) {
                     var f = arr[i];
-                    var doc_name=arr[i].content_number+'-'+arr[i].templet_name+'-'+arr[i].pbp_name+'.doc';
+                    if(arr[i].content_number == null || arr[i].content_number == undefined){
+                        arr[i].content_number = '';
+                    } else{
+                        arr[i].content_number = arr[i].content_number + '-';
+                    }
+                    if(arr[i].pbp_name == null || arr[i].pbp_name == undefined){
+                        arr[i].pbp_name = '';
+                    } else{
+                        arr[i].pbp_name = '-' + arr[i].pbp_name;
+                    }
+                    var doc_name=arr[i].content_number+arr[i].templet_name+arr[i].pbp_name+'.doc';

                     if (f.file_path ) {
                         writeFile(zos, doc_name, f.file_path);
Index: src/main/resources/leaf_static/modules/prj/PRJ506/con_content_change_create.lview
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/prj/PRJ506/con_content_change_create.lview b/src/main/resources/leaf_static/modules/prj/PRJ506/con_content_change_create.lview
--- a/src/main/resources/leaf_static/modules/prj/PRJ506/con_content_change_create.lview	(revision adac3e56701af2c083ea1757ebf6e2f3aaf5ba3e)
+++ b/src/main/resources/leaf_static/modules/prj/PRJ506/con_content_change_create.lview	(revision 31cdcad66b8414a50545ed534b076c0de1db1f26)
@@ -16,37 +16,31 @@
         window['${/parameter/@layout_code}_user_button1_layout_dynamic_click'] = function () {

             lock_current_window();
-            var ds_id = 'PRJ506B_GRID_Z_con_clause_templet_ds';//get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'con_clause_templet');
+            let Z_DS = 'PRJ506B_GRID_Z_con_clause_templet_ds';
+            let T_DS = 'PRJ506B_GRID_T_con_clause_templet_ds';
+
+            let JY_DS = 'PRJ506B_GRID_JY_con_clause_templet_ds';
+            let ZX_DS = 'PRJ506B_GRID_ZX_con_clause_templet_ds';
+            let J_DS = 'PRJ506B_GRID_J_con_clause_templet_ds';
+            let CN_DS = 'PRJ506B_GRID_CN_con_clause_templet_ds';
+            let param = {};
+            let saveData = [];

-            var qt_ds = 'PRJ506B_GRID_T_con_clause_templet_ds';
+            let ds_id_arr = [Z_DS, T_DS, JY_DS, ZX_DS, J_DS, CN_DS]
+            ds_id_arr.forEach(ds_id =>{
+                $(ds_id).getSelected().forEach(record =>{
+                    record.set('project_id', '${/parameter/@project_id}');
+                    saveData.push(record.data)
+                })
+
+            })


             function con_content_tmp_choose_close() {
                 $('${/parameter/@winid}').close();
             }
-            var qt_record = $(qt_ds).getSelected();
-            var records = $(ds_id).getSelected();

-            var param = {};
-            var saveData = [];
-            for (var i = 0; i < records.length; i++) {

-                var record;
-                record = records[i];
-                var temp_id = record.get('templet_id');
-                record.set('templet_id', temp_id);
-                record.set('project_id', '${/parameter/@project_id}');
-                saveData.push(record.data);
-            }
-
-            for (var i = 0; i < qt_record.length; i++) {
-                var qt;
-                qt = qt_record[i];
-                var temp_id = qt.get('templet_id');
-                qt.set('templet_id', temp_id);
-                qt.set('project_id', '${/parameter/@project_id}');
-                saveData.push(qt.data);
-            }

             param['details'] = saveData;
             param['project_id'] = '${/parameter/@project_id}';
Index: src/main/resources/leaf_static/WEB-INF/classes/prj/PRJ506/prj_project_cdd_save.lwm
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/WEB-INF/classes/prj/PRJ506/prj_project_cdd_save.lwm b/src/main/resources/leaf_static/WEB-INF/classes/prj/PRJ506/prj_project_cdd_save.lwm
new file mode 100644
--- /dev/null	(revision bf0176d4101aa2e8dfb71fb4ebaeff6cd5c2d890)
+++ b/src/main/resources/leaf_static/WEB-INF/classes/prj/PRJ506/prj_project_cdd_save.lwm	(revision bf0176d4101aa2e8dfb71fb4ebaeff6cd5c2d890)
@@ -0,0 +1,24 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!-- 请稿前保存 -->
+<bm:model xmlns:bm="http://www.leaf-framework.org/schema/bm">
+    <bm:operations>
+        <bm:operation name="update">
+            <bm:parameters>
+                <bm:parameter name="zip_path"/>
+                <bm:parameter name="zip_size"/>
+                <bm:parameter name="version_number"/>
+                <bm:parameter name="project_id"/>
+                <bm:parameter name="change_project_id"/>
+            </bm:parameters>
+            <bm:update-sql><![CDATA[
+              begin
+                sdic_con_contract_content_pkg.content_cdd_save(p_zip_path => ${@zip_path},
+                                                               p_zip_size => ${@zip_size},
+                                                               p_version_number => ${@version_number},
+                                                               p_project_id => ${@project_id},
+                                                               p_change_project_id => ${@change_project_id});
+              end;
+          ]]></bm:update-sql>
+        </bm:operation>
+    </bm:operations>
+</bm:model>
Index: src/main/resources/leaf_static/modules/hn/HN1012/prj_project_virtual_change_query.lview
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/hn/HN1012/prj_project_virtual_change_query.lview b/src/main/resources/leaf_static/modules/hn/HN1012/prj_project_virtual_change_query.lview
--- a/src/main/resources/leaf_static/modules/hn/HN1012/prj_project_virtual_change_query.lview	(revision 64004bba7c231846d953c24fe44dea1a92107b0f)
+++ b/src/main/resources/leaf_static/modules/hn/HN1012/prj_project_virtual_change_query.lview	(revision 0ee27db1f4dde3aa13e968bac11839edd10d947d)
@@ -155,10 +155,8 @@
         // }
         function hn1012_open_virtual_modify_win() {
             // var record = $(ds_con_id).getAt(0);
-            var url;
-
-                url = $('con_content_select_content_edit_link_id').getUrl();
-
+            var url = $('con_content_select_content_edit_link_id').getUrl();
+            let change_version_num = $("hn1012_virtual_project_change_req_info_ds").getAt(0).get("version_num")
             var win = new Leaf.Window({
                 url: url,
                 title: '合同编辑',
@@ -166,7 +164,8 @@
                     project_id: '${/parameter/@change_req_id}',
                     winid: 'prj_project_create_content_print_win_id',
                     ch_show_flag: '${/parameter/@ch_show_flag}',
-                    fun_code: 'Y'
+                    fun_code: 'Y',
+                    change_version_num
                 },
                 id: 'prj_project_create_content_print_win_id',
                 fullScreen: true
@@ -218,13 +217,6 @@

         }

-
-        //        Leaf.onReady(function () {
-        //            if (Ext.isEmpty('${/parameter/@seal_edit_flag}') || '${/parameter/@seal_edit_flag}' != 'Y') {
-        //                $('hn1012_seal_mat_save_btn').hide();
-        //            }
-        //        });
-
         function hn1012_virtual_project_change_req_submitSuccess() {
             $('hn_prj_project_con_seal_mat_ds').query();
             $('hn_prj_project_con_seal_ds').query();
@@ -330,6 +322,73 @@
                 $(ds_id).query();
             });
         }
+
+        function open_cdd_attachment_window(record_id, ds_id,check_id) {
+            let record = $(ds_id).findById(record_id);
+            if (check_id) {
+                let url_id = $('hn1012_conditions_downloadfile_link_id').getUrl();
+                let url = url_id + '?table_name=PRJ_CDD_ITEM_CHECK&header_id=' + check_id;
+                let win = new Leaf.Window({
+                    url: url,
+                    title: '${l:HLS.SUPPORTING_DOCUMENT}',
+                    id: 'content_cdd_loadFile_screen_id',
+                    width: 850,
+                    height: 400
+                });
+                win.on('close', function() {
+                    record.ds.query();
+                });
+            } else {
+                Leaf.showMessage('${l:HLS.PROMPT}', '请先保存!');
+            }
+        }
+
+        function cdd_attachment_renderer(value, record, name){
+            if (name === 'attachment') {
+                return '<a href="javascript:open_cdd_attachment_window(\'' + record.id + '\',\'' + record.ds.id + '\',' + record.get('check_id') + ');">附件</a>';
+            } else if (name === 'attach_file_name') {
+                if (value != null) {
+                    let link = '${/request/@context_path}/atm_download.lsc?attachment_id=';
+                    let str = value.split(';;');
+                    let url = '';
+                    for (let i = 0;i < str.length;i++) {
+                        let temp = str[i].split('--');
+                        if (!Leaf.isEmpty(temp[0])) {
+                            url = url + '<a href=' + link + temp[1] + '>' + temp[0] + '</a>' + ',';
+                        }
+                    }
+                    return url;
+                }
+            } else if(name === 'order_seq'){
+                return 'V'+value
+            }
+        }
+
+        function cdd_item_save(){
+            const ref_ds = $("hn_content_zip_cdd_new_ds")
+
+            Leaf.showConfirm('${l:HLS.PROMPT}', '确认清稿吗', function() {
+                Leaf.request({
+                    url: "${/request/@context_path}/modules/prj/PRJ506/prj_atm_batch_save.lsc",
+                    para:{
+                        project_id: '${/model/prj_change_req_info/record/@content_project_id}',
+                        change_project_id: '${/model/prj_change_req_info/record/@change_req_id}',
+                        change_version_num: '${/model/prj_change_req_info/record/@version_num}'
+                    },
+                    success: (res)=>{
+                        if(res.success){
+                            Leaf.SideBar.show({ msg: '清稿保存成功',duration: 2000});
+                            ref_ds.query()
+                        } else{
+                            Leaf.SideBar.show({ msg: '暂时没有可保存的合同',type: "warning", duration: 2000});
+                        }
+
+                    }
+                })
+
+
+            })
+        }
         ]]></script>
         <a:dataSets>
             <a:dataSet id="hn1012_virtual_project_change_req_info_query_ds" autoCreate="true">
@@ -371,6 +430,22 @@
                     <a:field name="instance_id" defaultValue="${/parameter/@instance_id}"/>
                 </a:fields>
             </a:dataSet>
+
+            <!--审批附件信息 变更前-->
+            <a:dataSet id="hn_content_zip_cdd_old_ds" autoQuery="true" fetchAll="true"
+                       model="layout.server_layout_doc_cdd_item" pageSize="11"
+                       queryUrl="${/request/@context_path}/autocrud/layout.server_layout_doc_cdd_item/query?base_table_pk=${/model/prj_change_req_info/record/@content_project_id}&amp;document_table=PRJ_PROJECT&amp;cdd_list_id=${/model/prj_change_req_info/record/@cdd_list_id}&amp;attachment_tab_group=343&amp;order_seq=${/model/prj_change_req_info/record/@old_version_num}"
+                       selectable="true">
+
+            </a:dataSet>
+
+            <a:dataSet id="hn_content_zip_cdd_new_ds" autoQuery="true" fetchAll="true"
+                       model="layout.server_layout_doc_cdd_item" pageSize="11"
+                       queryUrl="${/request/@context_path}/autocrud/layout.server_layout_doc_cdd_item/query?base_table_pk=${/model/prj_change_req_info/record/@content_project_id}&amp;document_table=PRJ_PROJECT&amp;cdd_list_id=${/model/prj_change_req_info/record/@cdd_list_id}&amp;attachment_tab_group=343&amp;order_seq=${/model/prj_change_req_info/record/@new_version_num}"
+                       selectable="true">
+
+            </a:dataSet>
+
         </a:dataSets>
         <a:screenBody>
             <a:screenTopToolbar>
@@ -378,6 +453,7 @@
             <!--&lt;!&ndash; <a:gridButton click="hn1012_prj_change_req_save" text="保存"/> &ndash;&gt;-->
             <!--<a:gridButton id="hn_wfl_modify_win" click="hn1012_open_virtual_project_modify_win" text="维护合同变更信息"/>-->
                 <a:gridButton id="hn_wfl_modify_win" click="hn1012_open_virtual_modify_win" text="维护合同文本"/>
+                <a:gridButton id="cdd_item_save" click="cdd_item_save" text="清稿前保存"/>
             <!--<a:gridButton id="hn_wfl_add_win" click="hn1012_open_virtual_modify_win" text="维护合同文本"/>-->
             <!--&lt;!&ndash; <a:gridButton click="hn1012_modify_change_bp" text="商业伙伴参数修改"/> &ndash;&gt;-->
             <!--&lt;!&ndash; <a:gridButton click="hn1012_modify_prj_change_req_submit" text="提交审批"/> &ndash;&gt;-->
@@ -622,6 +698,34 @@
                              </a:tabs>
                          </a:tabPanel>
                      </a:tab>-->
+                    <a:tab prompt="审批附件信息" width="170">
+                        <a:tabPanel id="prj_project_cdd_item_info_tab_id" height="450" marginWidth="50">
+                            <a:tabs>
+                                <a:tab prompt="变更前"  width="100">
+                                    <a:grid id = "content_cdd_item_old_grid_id" bindTarget="hn_content_zip_cdd_old_ds" height="350" marginWidth="50">
+                                        <a:columns>
+                                            <a:column name="description" align="center"  width="200" prompt="文件名称"/>
+                                            <a:column name="attachment" align="center"  width="80" prompt="附件" renderer="cdd_attachment_renderer"/>
+                                            <a:column name="attach_file_name" align="center"  width="200" prompt="附件名称" renderer="cdd_attachment_renderer"/>
+                                            <a:column name="order_seq" align="center"  width="80" prompt="版本号" renderer="cdd_attachment_renderer"/>
+                                            <a:column name="note" align="center"  width="500" prompt="备注"/>
+                                        </a:columns>
+                                    </a:grid>
+                                </a:tab>
+                                <a:tab prompt="变更后"  width="100">
+                                    <a:grid id = "content_cdd_item_new_grid_id" bindTarget="hn_content_zip_cdd_new_ds" height="350" marginWidth="50" >
+                                        <a:columns>
+                                            <a:column name="description" align="center"  width="200" prompt="文件名称"/>
+                                            <a:column name="attachment" align="center"  width="80" prompt="附件" renderer="cdd_attachment_renderer"/>
+                                            <a:column name="attach_file_name" align="center"  width="200" prompt="附件名称" renderer="cdd_attachment_renderer"/>
+                                            <a:column name="order_seq" align="center"  width="80" prompt="版本号" renderer="cdd_attachment_renderer"/>
+                                            <a:column name="note" align="center"  width="500" prompt="备注"/>
+                                        </a:columns>
+                                    </a:grid>
+                                </a:tab>
+                            </a:tabs>
+                        </a:tabPanel>
+                    </a:tab>
                 </a:tabs>
             </a:tabPanel>
         </a:screenBody>
@@ -644,16 +748,20 @@
         // });

         Leaf.onReady(function() {
-            // debugger;
-            if (('${/parameter/@ch_show_flag}' == 'Q') || ('${/parameter/@ch_show_flag}' == 'W')){
+            if (['Q', 'W', 'QW'].indexOf('${/parameter/@ch_show_flag}') > -1){
                 $('hn_wfl_modify_win').show();
             }else {
                 $('hn_wfl_modify_win').hide();
             }
-            // if ('${/parameter/@ch_show_flag}' == 'X') {
-            //     $('hn_wfl_add_win').show();
-            // }
+
+            if ('${/parameter/@ch_show_flag}' !== 'Q') {
+                $('cdd_item_save').hide();
+            }
+
+            const t = 1/0
+
         });
         ]]></script>
+        <a:screen-include screen="modules/simple/simple_util.lview?para=${/parameter/}"/>
     </a:view>
 </a:screen>
\ No newline at end of file
Index: src/main/resources/leaf_static/modules/prj/PRJ501Z/prj_project_modify_info.lview
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/prj/PRJ501Z/prj_project_modify_info.lview b/src/main/resources/leaf_static/modules/prj/PRJ501Z/prj_project_modify_info.lview
--- a/src/main/resources/leaf_static/modules/prj/PRJ501Z/prj_project_modify_info.lview	(revision 64004bba7c231846d953c24fe44dea1a92107b0f)
+++ b/src/main/resources/leaf_static/modules/prj/PRJ501Z/prj_project_modify_info.lview	(revision a89a1f292f0fd25f52f474ea6f41aeee7a83f184)
@@ -209,7 +209,7 @@
                     }
                 }
             }
-            record.set('version', 'v' + parseInt(plus(version_num, 1)).toFixed(1));
+            record.set('version', 'v' + parseInt(plus(fix_category 1)).toFixed(1));

         };
         //更新时调用
Index: src/main/resources/leaf_static/WEB-INF/classes/cont/CON500/con_file_content_copy_update.lwm
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/WEB-INF/classes/cont/CON500/con_file_content_copy_update.lwm b/src/main/resources/leaf_static/WEB-INF/classes/cont/CON500/con_file_content_copy_update.lwm
--- a/src/main/resources/leaf_static/WEB-INF/classes/cont/CON500/con_file_content_copy_update.lwm	(revision d849e2595021c000cd6b36dde95c8971bd48b83e)
+++ b/src/main/resources/leaf_static/WEB-INF/classes/cont/CON500/con_file_content_copy_update.lwm	(revision 2b0fa9656307f04778376c655dbd0fd1c2de175f)
@@ -10,6 +10,7 @@
                         p_table_pk_value =>${@content_id},
                         p_file_name      =>${@file_name},
                         p_file_path      =>${@file_path},
+                        p_file_size      =>${@file_size},
                         p_source_type    =>${@source_type},
                         p_user_id        =>${/session/@user_id}
                     );
Index: src/main/resources/leaf_static/modules/simple/simple_util.lview
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/simple/simple_util.lview b/src/main/resources/leaf_static/modules/simple/simple_util.lview
--- a/src/main/resources/leaf_static/modules/simple/simple_util.lview	(revision e0e06c69b9b05eee052f0eb1c675b39111e7d8f7)
+++ b/src/main/resources/leaf_static/modules/simple/simple_util.lview	(revision 98ac3cdacf1066d1ee14fd7a7fbc584b3cd5bb30)
@@ -8,62 +8,248 @@

 <a:screen xmlns:a="http://www.leaf-framework.org/application" customizationEnabled="true" trace="true">
     <a:view>
+        <script src="/modules/simple/js/simple_util_request.js"></script>
+        <script src="/modules/simple/js/simple_util_mess.js"></script>
+        <script src="/modules/simple/js/simple_util_workflow.js"></script>
+        <script src="/modules/simple/js/simple_util_layout.js"></script>
+        <script src="/modules/simple/js/simple_util_env.js"></script>
+        <script src="/modules/simple/js/simple_util_log.js"></script>
+        <script src="/modules/simple/js/simple_util_setting.js"></script>
         <script><![CDATA[

-            //获取属性信息
-            function get_property_info(url, layout_code, current_seq){
-                Ext.Ajax.request({
-                    url,
-                    method: "GET",
-                    success: function(response){
-                        window['simple_wfl_property'] = Ext.decode(response.responseText)
-                        set_property(layout_code, current_seq)
-                    },
-                    scope: this
+        const parameter_obj = sp_get_parameter_obj('${/parameter/@para}')
+        const request_obj = sp_get_parameter_obj('${/request/}')
+        const env_obj = sp_get_env_info_obj()
+
+        const wfl_view = ['/modules/zjwfl/ZJWFL1060/zj_wfl_monitoring_node_approve_history.lview',
+            '/modules/zjwfl/ZJWFL5110/zj_wfl_approve.lview']
+
+        const sp_init_flag = wfl_view.indexOf(request_obj['url']) < 0 && env_obj['env'] !== 'PROD'
+
+        if(sp_init_flag){
+            void (function simple_view_init(){
+                const [banner, hot_key] = [sp_settings.banner, sp_settings.project_env.hot_key]
+                const current_win = $L.WindowManager.getCurrentCache()
+
+                const ds_Obj = sp_get_view_cmp($L.DataSet, current_win)
+                if (banner.banner_enabled) {
+                    console.clear()
+                    sp_log_banner(banner.banner_context, sp_settings.version)
+                }
+                let func_q, func_s
+                if(parameter_obj['layout_code']){
+                    [func_q, func_s] = [window['${/parameter/layout_code}_QUERY_LAYOUT_DYNAMIC_CLICK'],
+                        window['${/parameter/layout_code}_SAVE_LAYOUT_DYNAMIC_CLICK']]
+                } else{
+                    func_q = ()=>{
+                        for (const ds_id in ds_Obj) {
+                            const ds = ds_Obj[ds_id]
+                            if(ds.queryurl){
+                                ds.query()
+                            }
+                        }
+                    }
+
+                    func_s = ()=>{
+                        for (const ds_id in ds_Obj) {
+                            const ds = ds_Obj[ds_id]
+                            if(ds.submiturl){
+                                ds.submit()
+                            }
+                        }
+                    }
+                }
+
+                if(hot_key.enter_query){
+                    sp_key_press_action(13, func_q)
+                }
+                if(hot_key.ctrl_s_save){
+                    sp_ctrl_action(83, func_s)
+                }
+
+                current_win.on('close', function() {
+                    dom.removeEventListener('keydown', func_q)
+                    dom.removeEventListener('keydown', func_s)
                 })
+
+            })()
+        }
+
+
+
+
+
+        //对象转列表 估计很少用
+        function sp_obj_to_list(obj) {
+            let arr = []
+            for (let key in obj) {
+                if (obj.hasOwnProperty(key)) {
+                    arr.push({key, value: obj[key]})
+                }
             }
+            return arr
+        }

-            //设置属性参数
-            function set_property(layout_code, current_seq){
-                let filter_info = window['simple_wfl_property'].filter(seq =>{
-                    return seq["current_seq"] = current_seq
-                })
+
+
+        //多records 变为列表 说实话这个我也不知道应该用到哪里 先写着
+        function sp_trans_rec_list(records) {
+            let arr = []
+            records.forEach(rec => {
+                arr.push(rec.getObject())
+            })
+            return arr
+        }
+
+        /**
+         * 将单个record全转化为只读/必填
+         * @param rec record
+         * @param sp_switch 只读必填开关 只读=>true 必填=>false
+         * @returns {undefined}
+         */
+        function sp_rec_readonly(rec, sp_switch = true) {
+            for (let field in rec.data) {
+                if (rec.data.hasOwnProperty(field)) {
+                    rec.getField(field).setReadOnly(sp_switch)
+                    rec.getField(field).setRequired(!sp_switch)
+                }
+            }

-                // try {
-                    filter_info[0]["revise_data"].forEach(revise_obj =>{
-                        let revise_ds = $(get_dsid_by_basetable(window[layout_code+'_layoutDataSetList'], revise_obj["ds_name"], revise_obj["tab_group"]))
-                        revise_obj["columns"].forEach(column =>{
-                            revise_ds.getAll().forEach(rec =>{
-                                if(column["column_value"]){
-                                    rec.set(column["column_name"], column["column_value"])
-                                }
-                                if(column["property"]["readonly"]){
-                                    rec.getField(column["column_name"]).setReadOnly(column["property"]["readonly"])
-                                }
-                                if(column["property"]["required"]){
-                                    rec.getField(column["column_name"]).setRequired(column["property"]["required"])
-                                }
-                            })
-                        })
+        }
+
+        //执行SQL语句
+        async function sp_execute_sql(execute_sql) {
+            return await sp_bm_request("${/request/@context_path}/autocrud/execute_sql/execute", {execute_sql})
+        }
+
+        //查询SQL语句 有点麻烦
+        async function sp_query_sql(query_sql){
+            const res =  await sp_bm_request("${/request/@context_path}/autocrud/execute_sql/query", {query_sql})
+            console.log(res)
+            return res
+        }
+
+
+        /**
+         * ds验证是否有脏数据 有就提示 返回false验证不通过 没有就返回true验证通过
+         * @param ds
+         * @returns {boolean}
+         */
+        function sp_ds_dirty_valid(ds) {
+            return ds.getAll().every(rec => {
+                if (rec.dirty === true) {
+                    Leaf.showMessage("提示", "请先保存")
+                    return false
+                }
+                return true
+            })
+        }
+
+        /**
+         * 批量处理
+         * @param url 处理请求地址
+         * @param params 请求参数集
+         * @param mask_format 遮罩文本
+         */
+        async function sp_batch_execute(url, params, mask_format){
+            Leaf.Masker.mask(Ext.getBody(), "开始" + mask_format)
+            for (let i = 0; i < params.length; i++) {
+                await sp_bm_request(url, params[i])
+                sp_set_masker_letter("正在" + mask_format + (i + 1) + "/" + params.length)
+            }
+            Leaf.Masker.unmask(Ext.getBody())
+            Leaf.SideBar.show({
+                msg: mask_format + '完毕',
+                duration: 2000
+            });
+        }
+
+        /**
+         * 将类似${/parameter} 或者是 ${/model/dataset/record/}转化为object类型
+         * @param parameter_str
+         * @returns {{}}
+         */
+        function sp_get_parameter_obj(parameter_str) {
+            let parameter_obj = {}
+            parameter_str.replace("{", "").replace("}", "").split(",").forEach(para_str => {
+                const [key, value] = para_str.replace(/\ +/g, "").split("=")
+                parameter_obj[key] = value
+            })
+            return parameter_obj
+        }
+
+
+        /**
+         * 工作流页面数据输出
+         * @param param_obj 页面参数 一般为${/parameter/}
+         * @param instance_id 流程ID 默认从页面参数里面取
+         */
+        async function sp_get_workflow_info(instance_id = parameter_obj['instance_id'], param_obj = parameter_obj) {
+            const output_work_para_info = (workflow_info, group_name)=>{
+                const plant_emoji = sp_choice(sp_const_plant_emoji)
+                group_name = plant_emoji + " " + group_name + " " + plant_emoji
+                console.groupCollapsed(group_name)
+                sp_obj_list_log(workflow_info['workflow_para_info'])
+                console.groupEnd()
+            }

-                    })
-                // } catch (e){
-                //     console.error(e)
-                // }
+            if (instance_id) {
+                const workflow_info = await get_instance_info(instance_id)
+
+                let para_desc_obj = {}
+                workflow_info.view_para_info.forEach(para => {
+                    para_desc_obj[para['parameter_desc']] = param_obj[para['parameter_code']]
+                })
+                //console.clear()
+                console.groupCollapsed('🌅 工作流信息')
+                sp_obj_colorful_log(workflow_info['instance_node_info'], '工作流节点信息')
+                output_work_para_info(workflow_info, '工作流参数')
+                sp_obj_colorful_log(para_desc_obj, "工作流页面参数")
+                console.groupEnd()
+                return workflow_info
+            }
+        }

-            }
+        function sp_output_para_info(){
+            console.log(request_obj)
+            console.log(parameter_obj)
+        }

-            //字符串插入 参考python 中 str.format()
-            function format(val) {
-                let args = Array.prototype.slice.call(arguments, 1)
-                return val.replace(/{(\d+)}/g, function(match, number) {
-                    return typeof args[number] !== 'undefined' ? args[number] : match
-                })
-            }
+
+
+
+        /**
+         * 输出obj集
+         * @param para_obj 页面参数 一般为parameter对象集合
+         * @param group_name obj集名
+         * @returns {{}}
+         */
+        function sp_output_view_parameter(para_obj = parameter_obj, group_name = '页面参数') {
+            sp_obj_colorful_log(para_obj, group_name)
+            return para_obj
+        }

+        /**
+         * 输出页面属性参数
+         */
+        function sp_output_view_info() {
+            console.clear()
+            const plant_emoji = sp_choice(sp_const_plant_emoji)
+            console.log('当前环境:' +current_env_info.env)
+            console.groupCollapsed(plant_emoji + ' 页面属性 ' + plant_emoji)
+            sp_log_view_info(parameter_obj, request_obj)
+            console.groupEnd()
+        }

+        async function sp_output_layout_ds_id(layout_code = parameter_obj['layout_code']) {
+            const layout_info = await sp_get_layout_ds_id(layout_code)
+            const plant_emoji = sp_choice(sp_const_plant_emoji)
+            console.groupCollapsed(plant_emoji + ' 动态页面datasetID集合 ' + plant_emoji)
+            sp_obj_list_log(layout_info)
+            console.groupEnd()
+            return layout_info
+        }

         ]]></script>
-        <a:screen-include screen="modules/cont/CON500/con_contract_get_layout_code.lview"/>
     </a:view>
 </a:screen>
Index: src/main/resources/leaf_static/modules/prj/PRJ506/update_cdd_content_file_size.lsc
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/prj/PRJ506/update_cdd_content_file_size.lsc b/src/main/resources/leaf_static/modules/prj/PRJ506/update_cdd_content_file_size.lsc
--- a/src/main/resources/leaf_static/modules/prj/PRJ506/update_cdd_content_file_size.lsc	(revision 355aa731f82046cde7ca3ce218d794f0a884b7b1)
+++ b/src/main/resources/leaf_static/modules/prj/PRJ506/update_cdd_content_file_size.lsc	(revision 03b8223852cdc819ea4baba4d5c5bb315b1fc49a)
@@ -4,21 +4,35 @@
         <s:server-script><![CDATA[
             importPackage(java.util.zip);
             importPackage(java.io);
-            var dl = $bm('prj.PRJ506.con_contract_content');
-            var result = dl.queryAsMap({
-                project_id: $ctx.parameter.project_id,
-            });
-            var arr = result.getChildren();
-            if (arr.length >= 1) {
-                for (var i = 0;i < arr.length;i++) {
-                    var fs = java.io.File(arr[i].file_path).length();
-                    $bm('prj.PRJ506.con_contract_content_new').execute({
-                        file_size: fs,
-                        file_path: arr[i].file_path
-                    })
+            try{
+                var dl = $bm('prj.PRJ506.con_contract_content_new');
+                var result = dl.queryAsMap({
+                    project_id: $ctx.parameter.project_id,
+                });
+                var arr = result.getChildren();
+                if (arr.length >= 1) {
+                    for (var i = 0;i < arr.length;i++) {
+                        var fs = java.io.File(arr[i].file_path).length();
+                        $bm('prj.PRJ506.con_contract_content_new').execute({
+                            file_size: fs,
+                            file_path: arr[i].file_path
+                        })
+                    }
                 }
+            } catch(e){
+                $ctx.success = "true";
+                $ctx.parameter.return_status = 'E';
+                $ctx.parameter.return_message = String(e);
             }

+            result = {
+                        result: $ctx.parameter.return_status,
+                        message: $ctx.parameter.return_message,
+                        success: $ctx.success
+                    }
+
+            $ctx.parameter.json = JSON.stringify(result);
         ]]></s:server-script>
     </a:init-procedure>
+    <a:service-output output="/parameter/@json"/>
 </a:service>
Index: src/main/resources/leaf_static/WEB-INF/classes/prj/PRJ506/con_contract_content.lwm
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/WEB-INF/classes/prj/PRJ506/con_contract_content.lwm b/src/main/resources/leaf_static/WEB-INF/classes/prj/PRJ506/con_contract_content.lwm
--- a/src/main/resources/leaf_static/WEB-INF/classes/prj/PRJ506/con_contract_content.lwm	(revision baac762cd1fd38c592edc6bf160166f9cfd17e26)
+++ b/src/main/resources/leaf_static/WEB-INF/classes/prj/PRJ506/con_contract_content.lwm	(revision 6f09d8654efa1cc00cbe85108e2e54420dffc620)
@@ -94,7 +94,4 @@
             </bm:operation>

         </bm:operations>
-    <bm:fields>
-        <bm:field name="file_path" databaseType="VARCHAR2" datatype="java.lang.String"/>
-    </bm:fields>
 </bm:model>
Index: src/main/resources/leaf_static/WEB-INF/classes/prj/PRJ506/con_contract_content_new.lwm
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/WEB-INF/classes/prj/PRJ506/con_contract_content_new.lwm b/src/main/resources/leaf_static/WEB-INF/classes/prj/PRJ506/con_contract_content_new.lwm
--- a/src/main/resources/leaf_static/WEB-INF/classes/prj/PRJ506/con_contract_content_new.lwm	(revision baac762cd1fd38c592edc6bf160166f9cfd17e26)
+++ b/src/main/resources/leaf_static/WEB-INF/classes/prj/PRJ506/con_contract_content_new.lwm	(revision 03b8223852cdc819ea4baba4d5c5bb315b1fc49a)
@@ -8,6 +8,12 @@
 -->
 <bm:model xmlns:bm="http://www.leaf-framework.org/schema/bm">
     <bm:operations>
+        <bm:operation name="query">
+            <bm:query-sql><![CDATA[
+                select file_path  from prj_project_content_v v
+                 where v.project_id = ${@project_id}
+            ]]></bm:query-sql>
+        </bm:operation>
         <bm:operation name="execute">
             <bm:update-sql><![CDATA[
                BEGIN
@@ -17,4 +23,7 @@
            ]]></bm:update-sql>
         </bm:operation>
     </bm:operations>
+    <bm:fields>
+        <bm:field name="file_path" databaseType="VARCHAR2" datatype="java.lang.String"/>
+    </bm:fields>
 </bm:model>
Index: src/main/resources/leaf_static/WEB-INF/classes/layout/server_layout_doc_cdd_item.lwm
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/WEB-INF/classes/layout/server_layout_doc_cdd_item.lwm b/src/main/resources/leaf_static/WEB-INF/classes/layout/server_layout_doc_cdd_item.lwm
--- a/src/main/resources/leaf_static/WEB-INF/classes/layout/server_layout_doc_cdd_item.lwm	(revision 947be302a6ca83933bd717cb0c6c79690f7c3cb3)
+++ b/src/main/resources/leaf_static/WEB-INF/classes/layout/server_layout_doc_cdd_item.lwm	(revision 70d932a4ddbb6bf1d4a2ddc60e3954b15f05df5c)
@@ -224,7 +224,9 @@
                     and nvl(pci.arch_required_flag, 'Y') not in nvl(${@arch_not_required_flag},' ')
                     and ((nvl(${@confirm_flag},'N')='Y' AND pp.confirm_flag='Y') or nvl(${@confirm_flag},'N')='N')

-                    )v   ORDER BY v.file_count,v.order_seq,v.confirm_flag,v.creation_date ASC) t1 #WHERE_CLAUSE#
+                    )v   ORDER BY (case when v.document_table = 'HN_PRJ_PLAN' and v.tab_group_id = 25 then decode(v.cdd_class, '融资租赁项目方案',996, '项目方案补充资料', 9997,
+         '项目方案上会表决资料', 99998, '项目方案上会表决资料', 999999, '融资租赁项目方案变更', 10000000 , 0) + v.order_seq else 1 end),
+                    v.file_count,v.order_seq,v.confirm_flag,v.creation_date ASC) t1 #WHERE_CLAUSE#


             ]]></bm:query-sql>
@@ -492,5 +494,6 @@
         <bm:query-field name="attach_only_query_flag" queryExpression="(nvl(${@attach_only_query_flag},'N') = t1.attach_only_query_flag )"/>
         <!--用于项目变更仅查询本次新增的变更附件资料-->
         <bm:query-field name="prj_change_query_flag" queryExpression="(${@prj_change_query_flag} is not null and t1.version_display is null)"/>
+        <bm:query-field name="order_seq" queryExpression="(t1.order_seq &lt;= ${@order_seq})"/>
     </bm:query-fields>
 </bm:model>
Index: src/main/resources/leaf_static/modules/prj/PRJ506/prj_atm_batch_save.lsc
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/prj/PRJ506/prj_atm_batch_save.lsc b/src/main/resources/leaf_static/modules/prj/PRJ506/prj_atm_batch_save.lsc
new file mode 100644
--- /dev/null	(revision bf0176d4101aa2e8dfb71fb4ebaeff6cd5c2d890)
+++ b/src/main/resources/leaf_static/modules/prj/PRJ506/prj_atm_batch_save.lsc	(revision bf0176d4101aa2e8dfb71fb4ebaeff6cd5c2d890)
@@ -0,0 +1,107 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<a:service xmlns:s="leaf.plugin.script" xmlns:a="http://www.leaf-framework.org/application" trace="true">
+    <a:init-procedure>
+        <s:server-script><![CDATA[
+            importPackage(java.util.zip);
+            importPackage(java.io);
+            //importPackage(org.apache.tools.zip); /*可以传入参数*/
+
+            function writeFile(zos, fn, fp) {
+                var ze = new ZipEntry(fn);
+                zos.putNextEntry(ze);
+                transfer(fp, zos);
+            }
+
+            function transfer(file, os) {
+                var fis = new FileInputStream(file);
+                var b = new java.lang.reflect.Array.newInstance(java.lang.Byte.TYPE, 1024 * 64);
+                var len = -1;
+                while ((len = fis.read(b)) != -1) {
+                    os.write(b, 0, len);
+                }
+                fis.close();
+            }
+            function getdate() {
+                var now = new Date()
+                y = now.getFullYear()
+                m = now.getMonth() + 1
+                d = now.getDate()
+                m = m < 10 ? "0" + m : m
+                d = d < 10 ? "0" + d : d
+                return y + "" + m + "" + d
+            }
+
+            var success;
+            var date_str = getdate();
+            var path = $ctx.parameter.path;
+            var zip_path = '/u01/hls_attachment/' + java.util.UUID.randomUUID().toString().replace('-', '').toUpperCase();
+
+            var attachment_batch_dl = $bm('cont.CON500.con_contract_content_download');
+            var result;
+            if($ctx.parameter.change_project_id){
+                result = attachment_batch_dl.queryAsMap({
+                    contract_id: $ctx.parameter.contract_id,
+                    templet_name: $ctx.parameter.templet_name,
+                    project_id: $ctx.parameter.change_project_id,
+                    change_version_num: $ctx.parameter.change_version_num
+                });
+            } else{
+                result = attachment_batch_dl.queryAsMap({
+                    contract_id: $ctx.parameter.contract_id,
+                    templet_name: $ctx.parameter.templet_name,
+                    project_id: $ctx.parameter.project_id,
+                    change_version_num: $ctx.parameter.change_version_num
+                });
+            }
+
+
+            var arr = result.getChildren();
+
+            //打包下载
+            var zos = new ZipOutputStream(new FileOutputStream(zip_path));
+            //zos.setEncoding("GBK"); //如果是org.apache.tools.zip需要追加字符集
+            if(arr.length > 0){
+                for (var i = 0;i < arr.length;i++) {
+                    var f = arr[i];
+                    if(arr[i].content_number == null || arr[i].content_number == undefined){
+                        arr[i].content_number = '';
+                    } else{
+                        arr[i].content_number = arr[i].content_number + '-';
+                    }
+                    if(arr[i].pbp_name == null || arr[i].pbp_name == undefined){
+                        arr[i].pbp_name = '';
+                    } else{
+                        arr[i].pbp_name = '-' + arr[i].pbp_name;
+                    }
+                    var doc_name=arr[i].content_number+arr[i].templet_name+arr[i].pbp_name+'.doc';
+
+                    if (f.file_path ) {
+                        writeFile(zos, doc_name, f.file_path);
+                    }
+                }
+                zos.close();
+
+                var zip_file = java.io.File(zip_path);
+                var zip_file_size = zip_file.length();
+
+                $bm('prj.PRJ506.prj_project_cdd_save').update({
+                    zip_path: zip_path,
+                    version_number: $ctx.parameter.change_version_num,
+                    zip_size: zip_file_size,
+                    project_id : $ctx.parameter.project_id,
+                    change_project_id: $ctx.parameter.change_project_id
+                });
+
+                success = 'true'
+            } else{
+                success = "false";
+            }
+
+            result = {success: success}
+
+            $ctx.parameter.json = JSON.stringify(result);
+
+        ]]></s:server-script>
+    </a:init-procedure>
+    <a:service-output output="/parameter/@json"/>
+</a:service>
Index: src/main/resources/leaf_static/WEB-INF/classes/cont/CON505/con_contract_content_link_for_lov.lwm
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/WEB-INF/classes/cont/CON505/con_contract_content_link_for_lov.lwm b/src/main/resources/leaf_static/WEB-INF/classes/cont/CON505/con_contract_content_link_for_lov.lwm
new file mode 100644
--- /dev/null	(revision cb56d95b1c4f5a62314b8fe4acff55e485704034)
+++ b/src/main/resources/leaf_static/WEB-INF/classes/cont/CON505/con_contract_content_link_for_lov.lwm	(revision cb56d95b1c4f5a62314b8fe4acff55e485704034)
@@ -0,0 +1,41 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!--
+    $Author: ylf
+    $Date: 2022-4-19 下午01:13:41
+    $Revision: 1.0
+    $Purpose:
+-->
+<bm:model xmlns:bm="http://www.leaf-framework.org/schema/bm">
+    <bm:operations>
+        <bm:operation name="query">
+            <bm:query-sql><![CDATA[
+            select
+            content_id, templet_name, content_number, project_id
+            from prj_project_content_v
+
+			  #WHERE_CLAUSE#
+
+]]></bm:query-sql>
+        </bm:operation>
+        <bm:operation name="update">
+            <bm:update-sql><![CDATA[
+            begin
+                sdic_con_contract_content_pkg.update_bcn_content_number(p_project_id => ${@project_id});
+            end;
+]]></bm:update-sql>
+        </bm:operation>
+    </bm:operations>
+    <bm:fields>
+        <bm:field name="content_id" databaseType="NUMBER" datatype="java.lang.Long"  physicalName="CONTENT_ID"/>
+        <bm:field name="project_id" databaseType="NUMBER" datatype="java.lang.Long"  physicalName="PROJECT_ID"/>
+        <bm:field name="templet_name" databaseType="VARCHAR2" datatype="java.lang.String" forDisplay="true" forQuery="true" physicalName="TEMPLET_NAME" prompt="合同名称" displayWidth="300"/>
+        <bm:field name="content_number" databaseType="VARCHAR2" datatype="java.lang.String" forDisplay="true" forQuery="true" physicalName="CONTENT_NUMBER" prompt="合同编号" displayWidth="200"/>
+    </bm:fields>
+    <bm:query-fields>
+        <bm:query-field field="project_id" queryOperator="="/>
+    </bm:query-fields>
+    <bm:data-filters>
+        <bm:data-filter enforceOperations="query" expression="instr(content_number, 'BCN') = 0"/>
+        <bm:data-filter enforceOperations="query" expression="to_number(replace(change_version_num, 'V')) &lt; to_number(replace(nvl(${@change_version_num}, 'V999'), 'V'))"/>
+    </bm:data-filters>
+</bm:model>
Index: src/main/resources/leaf_static/modules/simple/js/simple_util_mess.js
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/simple/js/simple_util_mess.js b/src/main/resources/leaf_static/modules/simple/js/simple_util_mess.js
--- a/src/main/resources/leaf_static/modules/simple/js/simple_util_mess.js	(revision 95b7f8a21f5ac3bfefd9461e96250bb441aa5fee)
+++ b/src/main/resources/leaf_static/modules/simple/js/simple_util_mess.js	(revision 98ac3cdacf1066d1ee14fd7a7fbc584b3cd5bb30)
@@ -1,6 +1,6 @@
 //list-obj比较(英文)
 function compare_english(property_name) {
-    return function(a,b){
+    return function (a, b) {
         let x1 = a[property_name].toUpperCase();
         let x2 = b[property_name].toUpperCase();
         if (x1 < x2) {
@@ -15,8 +15,8 @@
 }

 //list-obj比较(数字)
-function compare_number(property_name){
-    return function(a,b){
+function compare_number(property_name) {
+    return function (a, b) {
         const value1 = a[property_name];
         const value2 = b[property_name];
         return value1 - value2;
@@ -24,13 +24,13 @@
 }

 //list-obj比较(中文首字母)
-function compare_chinese_head(property_name){
-    return function(a,b){
+function compare_chinese_head(property_name) {
+    return function (a, b) {
         const value1 = a[property_name][0];
         const value2 = b[property_name][0];
-        if(value1 > value2){
+        if (value1 > value2) {
             return 1
-        } else if(value1 < value2){
+        } else if (value1 < value2) {
             return -1
         }
     }
@@ -43,7 +43,7 @@
  */
 function sp_format(val) {
     let args = Array.prototype.slice.call(arguments, 1)
-    return val.replace(/{(\d+)}/g, function(match, number) {
+    return val.replace(/{(\d+)}/g, function (match, number) {
         return typeof args[number] !== 'undefined' ? args[number] : match
     })
 }
@@ -54,29 +54,180 @@
  * @param list 列表
  * @returns {*} 数据
  */
-function sp_choice(list){
+function sp_choice(list) {
     return list[Math.floor((Math.random() * list.length))];
 }

-function sp_range(start, end){
-    return Array(end-start).fill(start).map((el,i)=>start+i)
+function sp_range(start, end) {
+    return Array(end - start).fill(start).map((el, i) => start + i)
 }

+/**
+ * 判断是否包含
+ * @param obj 对象
+ * @param list 列表
+ * @returns {boolean} 是否包含
+ */
+function sp_contain(obj, list){
+    return list.indexOf(obj) > -1
+}
+
 /**
  * 获取一个长度为num 数据为从1到num的列表
  * @param num
  * @returns {number[]}
  */
-function range(num){
+function range(num) {
     return [...Array(num).keys()]
 }

-function sp_confirm_win(title, context){
-    return new Promise((resolve, reject)=>{
-        Leaf.showConfirm(title, context, ()=>{
-            resolve(true)
-        }, ()=>{
-            resolve(false)
+
+
+
+/**
+ * 字符串插入
+ * @param source 原字符串
+ * @param start 插入位置
+ * @param newStr 新字符串
+ * @returns {*}
+ */
+function sp_insert_str(source, start, newStr) {
+    return source.slice(0, start) + newStr + source.slice(start);
+}
+
+/**
+ * 自动补位
+ * @param num 数字
+ * @param n 补位
+ * @param sign 记号
+ * @returns {string}
+ */
+function sp_lpad(num, n, sign=0){
+    //num代表传入的数字，n代表要保留的字符的长度
+    return (Array(n).join(sign)+num).slice(-n);
+}
+
+/**
+ * 列表过滤键值对
+ * @param list 列表
+ * @param filter_keys 过滤键值
+ * @returns {*[]}
+ */
+function sp_list_filter_obj(list, filter_keys){
+    let filter_list = []
+    list.forEach((obj)=>{
+        let filter_obj = {}
+        filter_keys.forEach((key)=>{
+            filter_obj[key] = obj[key]
         })
+        filter_list.push(filter_obj)
     })
+    return filter_list
+}
+
+/**
+ * 设置全体遮罩层描述
+ * @param letter 描述内容
+ */
+function sp_set_masker_letter(letter){
+    const mask_container = Leaf.Masker.container
+    for(let container in mask_container){
+        if (mask_container.hasOwnProperty(container)){
+            mask_container[container]['dom'].getElementsByTagName("span")[0].innerHTML = letter
+        }
+    }
+}
+
+/**
+ * 按类型获取组件
+ * @param cmp_type 组件类型
+ * @param win 窗口ID实例 用于范围搜索
+ * @returns {{}} 组件集obj
+ */
+function sp_get_view_cmp(cmp_type, win){
+    let cache
+
+    if(win){
+        cache = win.cmps
+    }else{
+        cache = $L.CmpManager.cache
+    }
+
+    let filter_obj = {}
+
+    Object.keys(cache).forEach(ds_id =>{
+        if(cache[ds_id] instanceof cmp_type && ds_id.indexOf('ext-gen') < 0){
+            filter_obj[ds_id] = cache[ds_id]
+        }
+    })
+
+    return filter_obj
+}
+
+/**
+ * 单键触发函数
+ * @param keyCode 键值
+ * @param func 触发函数
+ */
+function sp_key_press_action(keyCode, func){
+    return document.addEventListener('keydown', function(e){
+        if (e.keyCode === keyCode){
+            e.preventDefault();
+            if(func){
+                func()
+            }
+        }
+    });
+}
+
+/**
+ * ctrl+单键触发函数
+ * @param keyCode 键值
+ * @param func 触发函数
+ */
+function sp_ctrl_action(keyCode, func){
+    return document.addEventListener('keydown', function(e){
+        if (e.keyCode === keyCode && (navigator.platform.match("Mac") ? e.metaKey : e.ctrlKey)){
+            e.preventDefault();
+            if(func){
+                func()
+            }
+        }
+    });
+}
+
+
+// 设置cookie
+function setCookie(key, value, expiredHours) {
+    let exDate = new Date();
+    exDate.setTime(exDate.getTime() + expiredHours * 60 * 60 * 1000);
+    document.cookie =
+        key +
+        "=" +
+        escape(value) +
+        (expiredHours == null ? "" : ";expires=" + exDate.toUTCString());
+}
+
+// 读取cookie
+function getCookie(key) {
+    if (document.cookie.length > 0) {
+        let c_start = document.cookie.indexOf(key + "=");
+        if (c_start !== -1) {
+            c_start = c_start + key.length + 1;
+            let c_end = document.cookie.indexOf(";", c_start);
+            if (c_end === -1) c_end = document.cookie.length;
+            return unescape(document.cookie.substring(c_start, c_end));
+        }
+    }
+    return "";
+}
+
+// 删除cookie
+function delCookie(key) {
+    let exp = new Date();
+    exp.setTime(exp.getTime() - 1);
+    let cval = this.getCookie(key);
+    if (cval != null) {
+        document.cookie = key + "=" + cval + ";expires=" + exp.toUTCString();
+    }
 }
\ No newline at end of file
Index: src/main/resources/leaf_static/modules/simple/js/simple_util_log.js
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/simple/js/simple_util_log.js b/src/main/resources/leaf_static/modules/simple/js/simple_util_log.js
--- a/src/main/resources/leaf_static/modules/simple/js/simple_util_log.js	(revision c7f0b99c9b98199635c218c76649269c36017740)
+++ b/src/main/resources/leaf_static/modules/simple/js/simple_util_log.js	(revision 98ac3cdacf1066d1ee14fd7a7fbc584b3cd5bb30)
@@ -1,5 +1,5 @@
-const sp_const_colorful = ['LightBlue', 'LightCoral', 'LightGreen',  'LightSalmon',
-    'LightSeaGreen',  'LightSlateGray',  'MediumPurple', 'MediumSlateBlue', 'MediumVioletRed', 'Orange', 'Plum']
+const sp_const_colorful = ['LightBlue', 'LightCoral', 'LightGreen', 'LightSalmon',
+    'LightSeaGreen', 'LightSlateGray', 'MediumPurple', 'MediumSlateBlue', 'MediumVioletRed', 'Orange', 'Plum']

 const sp_const_fruit_emoji = ['🍇', '🍈', '🍉', '🍊', '🍋', '🍌', '🍍', '🥭', '🍎', '🍏', '🍐', '🍑',
     '🍒', '🍓', '🫐', '🥝', '🍅', '🫒', '🥥', '🥑', '🍆', '🥔', '🥕', '🌽', '🌶️']
@@ -7,11 +7,10 @@
 const sp_const_plant_emoji = ['💐', '🌸', '💮', '🏵️', '🌹', '🥀', '🌺', '🌻', '🌼', '🌷', '🌱', '🪴', '🌲', '🌳',
     '🌴', '🌵', '🌾', '🌿', '☘️', '🍀', '🍁', '🍂', '🍃', '🍄']

-const sp_log_version = 'Simple Log V0.1'
+const sp_const_instrument_emoji = ['🎷', '🎸', '🎹', '🎺', '🎻', '🪕', '🥁']

-let sp_log_banner_flag = true
+const sp_util_version = 'Simple Util V0.13'

-console.clear()

 /**
  * 华丽的输出object类型数据
@@ -20,66 +19,126 @@
  * @param compare_func 比较方法(默认英文比较)
  * @param fold 是否折叠 默认是(不折叠就输出的就太多啦 自行斟酌)
  */
-function sp_obj_colorful_log(obj, group_name, compare_func=compare_english, fold=true){
+function sp_obj_colorful_log(obj, group_name, compare_func = compare_english, fold = true) {
     const plant_emoji = sp_choice(sp_const_plant_emoji)
     group_name = plant_emoji + " " + group_name + " " + plant_emoji
-    if(fold){
+    if (fold) {
         console.groupCollapsed(group_name)
-    } else{
+    } else {
         console.group(group_name)
     }
-    let arr = sp_obj_to_list(obj)
-    arr.sort(compare_func("key"))
-    arr.forEach(para =>{
-        let emoji = sp_choice(sp_const_fruit_emoji)
-        console.log(sp_format(`%c{0} {1}:{2} {3}`, emoji, para["key"], para["value"], emoji),
-            sp_format(`color: {0}; font-weight: bold;`, sp_choice(sp_const_colorful)))
-    })
-    console.groupEnd()
+    if(obj instanceof Object){
+        obj = sp_obj_to_list(obj)
+    }
+    sp_obj_list_log(obj, compare_func)
+    console.groupEnd()
+}
+
+/**
+ * 华丽的输出list类型数据(无分组)
+ * @param arr list
+ * @param compare_func 比较方法(默认英文比较)
+ */
+function sp_obj_list_log(arr, compare_func) {
+    if (compare_func instanceof Function) {
+        arr.sort(compare_func("key"))
+        arr.forEach(para => {
+            let emoji = sp_choice(sp_const_fruit_emoji)
+            console.log(sp_format(`%c{0} {1}:{2} {3}`, emoji, para["key"], para["value"], emoji),
+                sp_format(`color: {0}; font-weight: bold;`, sp_choice(sp_const_colorful)))
+        })
+    } else {
+        arr.forEach(para => {
+            let emoji = sp_choice(sp_const_fruit_emoji)
+            console.log(sp_format(`%c{0} {1}:{2} {3}`, emoji, para["key"], para["value"], emoji),
+                sp_format(`color: {0}; font-weight: bold;`, sp_choice(sp_const_colorful)))
+        })
+    }
 }

 /**
  * 特别的输出 随机颜色 随机水果符号
  * @param log_str 要输出的字符串
- * @param colorful_flag 是否要颜色 (不要就是默认黑)
- * @param emoji_flag 是否要符号
+ * @param colorful_const 颜色选择集合
+ * @param emoji_const 符号选择集合
  */
-function sp_log(log_str, colorful_flag=true, emoji_flag=true){
+function sp_log(log_str, emoji_const = sp_const_fruit_emoji, colorful_const = sp_const_colorful) {
     let emoji, color
-    if(emoji_flag){
-        emoji = sp_choice(sp_const_fruit_emoji)
+    if (emoji_const) {
+        emoji = sp_choice(emoji_const)
     }
-    if(colorful_flag){
-        color = sp_choice(sp_const_colorful)
-    } else{
+    if (colorful_const) {
+        color = sp_choice(colorful_const)
+    } else {
         color = "black"
     }
-    console.log(sp_format(`%c{0} {1}`, emoji, log_str),
-        sp_format(`color: {0}; font-weight: bold; font-size: 18px;`, color))
+    console.log(sp_format(` %c{0} {1}`, emoji, log_str),
+        sp_format(`color: {0}; font-weight: bolder;`, color))
 }

 /**
  * 控制台输出页面信息
  * @param banner_data example:{author: 'Sora', view_name: 'test view'}
  */
-function sp_banner(banner_data){
+function sp_banner(banner_data) {
     const author_str = sp_format(`view-author: {0} `, banner_data['author'])
     const detail_str = sp_format(`view-function: {0} `, banner_data['view_name'])
-    console.log("\n %c "+ author_str +" %c "+ detail_str + " %c " + sp_log_version
-        +" \n","color: #fadfa3; background: #030307; padding:5px 0;font-weight: bold;",
+    console.log("\n %c " + author_str + " %c " + detail_str + " %c " + sp_util_version
+        + " \n", "color: #fadfa3; background: #030307; padding:5px 0;font-weight: bold;",
         "background: #fadfa3; padding:5px 0;font-weight: bold;",
         "color: #fadfa3; background: #030307; padding:5px 0;font-weight: bold;")
 }

-function sp_log_banner(){
-    console.log("\n %c "+ 'Thanks for using Simple Log!' + " %c " + sp_log_version,
+
+
+function sp_log_banner(banner_context, version) {
+    console.log("\n %c " + banner_context + " %c " + `Simple Util ${version}`,
         "background: #fadfa3; padding:5px;font-weight: bold;",
         "color: #fadfa3; background: #030307; padding:5px;font-weight: bold;")
 }

-if(sp_log_banner_flag){
-    sp_log_banner()
+function sp_log_view_info(parameter_obj, request_obj) {
+    const log = (str)=>{
+        sp_log(str, sp_const_instrument_emoji)
+    }
+
+    const wfl_view = ['/modules/zjwfl/ZJWFL1060/zj_wfl_monitoring_node_approve_history.lview',
+        '/modules/zjwfl/ZJWFL5110/zj_wfl_approve.lview']
+    if (parameter_obj['layout_code']) {
+        log(` 这个页面是动态页面！页面布局代码为 ${parameter_obj['layout_code']}`)
+        log(` 可以通过执行 sp_output_layout_ds_id() => (不包括lov、combobox的DS_ID)  或 sp_get_view_cmp($L.DataSet) => (所有DS_ID) 方法在控制台输出动态页面DS数据 `)
+    } else {
+        log(' 这个页面是静态页面！')
+        log(` 可以通过执行 sp_get_view_cmp($L.DataSet) 方法在控制台输出动态页面DS数据 `)
+    }
+
+    if (sp_contain(request_obj['url'], wfl_view)) {
+        log(' 这个页面是工作流页面！')
+        log(` 页面功能为: ${parameter_obj['function_code']}`)
+        log(` 可以通过执行 sp_get_workflow_info() 方法在控制台输出工作流信息 `)
+        log(` Tips: 这个方法需要一个参数当前实例ID 如果没有就在页面参数里面取 若没有写参数请确保工作流中有instance_id参数`)
+    } else {
+        log(` 页面地址为: ${request_obj['url']}`)
+        log(` 页面功能为: ${parameter_obj['function_code']}`)
+    }
+
+    if(typeof sp_view_ex_data !==  'undefined'){
+        log(`这个页面留下了一个特别的数据 可能会对你有所帮助`)
+        const obj = sp_view_ex_data()
+        if(obj instanceof Object){
+            sp_obj_colorful_log(obj, '额外数据')
+        } else{
+            console.log(obj)
+        }
+    }
+
+    sp_obj_colorful_log(parameter_obj, '页面参数')
+
 }
+
+
+
+



Index: src/main/resources/leaf_static/WEB-INF/classes/simple/SIM_LAYOUT/simple_layout_info.lwm
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/WEB-INF/classes/simple/SIM_LAYOUT/simple_layout_info.lwm b/src/main/resources/leaf_static/WEB-INF/classes/simple/SIM_LAYOUT/simple_layout_info.lwm
new file mode 100644
--- /dev/null	(revision 24d7a0a3e787570acd95844eee05b95eb76336be)
+++ b/src/main/resources/leaf_static/WEB-INF/classes/simple/SIM_LAYOUT/simple_layout_info.lwm	(revision 24d7a0a3e787570acd95844eee05b95eb76336be)
@@ -0,0 +1,33 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!--
+    $Author: Sora
+    $Date: 2022-4-20
+    $Revision: 1.0
+    $Purpose:
+-->
+<bm:model xmlns:bm="http://www.leaf-framework.org/schema/bm">
+    <bm:operations>
+        <bm:operation name="query">
+            <bm:query-sql>
+                <![CDATA[
+                    select * from (
+                        SELECT  l.layout_code||'_'||l.tab_code||'_'||l.base_table||'_DS' as value,
+                        nvl(l.tab_desc, (select h.tab_desc FROM hls_doc_layout_tab h
+                                              where  h.layout_code = 'VIRTUAL_CONTRACT_QUERY_SEC'
+                                              and h.enabled_flag = 'Y' and h.tab_code = l.parent_tab_code)) as key
+                                           FROM hls_doc_layout_tab l
+                                              where  l.layout_code = 'VIRTUAL_CONTRACT_QUERY_SEC'
+                                              and l.enabled_flag = 'Y'
+                                              and l.base_table is not null
+                                              order by l.tab_seq
+                        ) t
+                           #WHERE_CLAUSE#
+            ]]></bm:query-sql>
+        </bm:operation>
+    </bm:operations>
+    <bm:fields>
+        <bm:field name="key" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="KEY"/>
+        <bm:field name="value" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="VALUE"/>
+
+    </bm:fields>
+</bm:model>
Index: src/main/resources/leaf_static/modules/simple/js/simple_util_layout.js
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/simple/js/simple_util_layout.js b/src/main/resources/leaf_static/modules/simple/js/simple_util_layout.js
new file mode 100644
--- /dev/null	(revision 98ac3cdacf1066d1ee14fd7a7fbc584b3cd5bb30)
+++ b/src/main/resources/leaf_static/modules/simple/js/simple_util_layout.js	(revision 98ac3cdacf1066d1ee14fd7a7fbc584b3cd5bb30)
@@ -0,0 +1,57 @@
+async function sp_get_layout_ds_id(layout_code) {
+    const url = `/autocrud/simple.SIM_LAYOUT.simple_layout_info/query`
+    return await sp_bm_request(url, {layout_code})
+}
+
+async function sp_get_layout_code(function_code){
+    const url = `/autocrud/cont.CON500.con_contract_get_layout_code/update`
+    const [role_id, user_id] = [1,1]
+    const res = await sp_request(url, {function_code, role_id, user_id})
+    return res['result']
+}
+
+async function sp_active_win_para_valid(params){
+    const need_para = ['url_title', 'function_code']
+    const need_para_desc = ['页面标题', '功能编号']
+
+    for (let i = 0; i < need_para.length;i++) {
+        if(!params[need_para[i]]){
+            Leaf.showMessage("提示", `参数${need_para_desc[i]}没有获取到`)
+            return false
+        }
+    }
+
+    const res = await sp_get_layout_code(params['function_code'])
+    params['function_code'] = res['function_code']
+    params['calc_type'] = res['cond_para1']
+
+    if(!params['layout_code']){
+        Leaf.showMessage("提示", "没有获取到页面布局代码")
+        return false
+    }
+
+    return params
+}
+
+/**
+ * 打开动态页面参数
+ * @param win_url 要打开的页面路径
+ * @param params  页面参数 需要带 'url_title', 'function_code' 参数 可选参数 'winId', 'screen_width', 'screen_height'
+ * @returns {Promise<*>} 窗口实例
+ */
+async function sp_open_active_win(win_url, params){
+    params = await sp_active_win_para_valid(params)
+
+    if(params){
+        return new Leaf.Window({
+            id: params['winId']?params['winId']:`layout_win_${params['function_code']}_${params['layout_code']}`,
+            params: params,
+            url: win_url,
+            title: `${params['url_title']}(功能-${params['function_code']} 布局代码-${params['layout_code']})`,
+            width: params['screen_width'],
+            height: params['screen_height'],
+            fullScreen: !(params['screen_width'] || params['screen_height']),
+            draggable: params['draggable'] || false
+        });
+    }
+}
\ No newline at end of file
Index: src/main/resources/leaf_static/modules/acrch/ARCHIVE003/archive_file_history_entrance.lview
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/acrch/ARCHIVE003/archive_file_history_entrance.lview b/src/main/resources/leaf_static/modules/acrch/ARCHIVE003/archive_file_history_entrance.lview
--- a/src/main/resources/leaf_static/modules/acrch/ARCHIVE003/archive_file_history_entrance.lview	(revision 0fdbcecd83d85885c16ba98a31f1a2871a25bf2e)
+++ b/src/main/resources/leaf_static/modules/acrch/ARCHIVE003/archive_file_history_entrance.lview	(revision 24d7a0a3e787570acd95844eee05b95eb76336be)
@@ -133,6 +133,6 @@

         ]]></script>
         <a:screen-include screen="modules/cont/CON500/con_contract_get_layout_code.lview"/>
-        <a:screen-include screen="modules/simple/simple_util.lview"/>
+        <a:screen-include screen="modules/simple/simple_util.lview?para=${/parameter/}"/>
     </a:view>
 </a:screen>
Index: src/main/resources/leaf_static/modules/simple/js/simple_util_workflow.js
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/simple/js/simple_util_workflow.js b/src/main/resources/leaf_static/modules/simple/js/simple_util_workflow.js
--- a/src/main/resources/leaf_static/modules/simple/js/simple_util_workflow.js	(revision 0fdbcecd83d85885c16ba98a31f1a2871a25bf2e)
+++ b/src/main/resources/leaf_static/modules/simple/js/simple_util_workflow.js	(revision 163a024047781d3c631497db0e248604e903b0e4)
@@ -1,49 +1,53 @@
-
-
 //设置属性参数
-function set_property(layout_code, current_seq){
-    let filter_info = window['simple_wfl_property'].filter(seq =>{
+function set_property(layout_code, current_seq) {
+    let filter_info = window['simple_wfl_property'].filter(seq => {
         return seq["current_seq"] = current_seq
     })

     try {
-        filter_info[0]["revise_data"].forEach(revise_obj =>{
-            let revise_ds = $(get_dsid_by_basetable(window[layout_code+'_layoutDataSetList'], revise_obj["ds_name"], revise_obj["tab_group"]))
-            revise_obj["columns"].forEach(column =>{
-                revise_ds.getAll().forEach(rec =>{
-                    if(column["column_value"]){
+        filter_info[0]["revise_data"].forEach(revise_obj => {
+            let revise_ds = $(get_dsid_by_basetable(window[layout_code + '_layoutDataSetList'], revise_obj["ds_name"], revise_obj["tab_group"]))
+            revise_obj["columns"].forEach(column => {
+                revise_ds.getAll().forEach(rec => {
+                    if (column["column_value"]) {
                         rec.set(column["column_name"], column["column_value"])
                     }
-                    if(column["property"]["readonly"]){
+                    if (column["property"]["readonly"]) {
                         rec.getField(column["column_name"]).setReadOnly(column["property"]["readonly"])
                     }
-                    if(column["property"]["required"]){
+                    if (column["property"]["required"]) {
                         rec.getField(column["column_name"]).setRequired(column["property"]["required"])
                     }
                 })
             })

         })
-    } catch (e){
+    } catch (e) {
         console.error(e)
     }
 }

-async function get_instance_info(local_url, instance_id){
-    const sp_workflow_info = {
-        instance_info:{},
-        workflow_para_info: []
-    }
+async function get_instance_info(instance_id) {
+    const sp_workflow_info = {}

-    const url = `${local_url}/autocrud/simple.SIM_WFL.simple_instance_info/query`
-    const res = await sp_request(url, {instance_id})
-    sp_workflow_info.instance_info = res
-    sp_workflow_info.workflow_para_info = await get_view_para_info(local_url, res['node_display_service_name'])
+    sp_workflow_info.instance_node_info = await get_instance_node_info(instance_id)
+    sp_workflow_info.workflow_para_info = await get_workflow_para_info(instance_id)
+    sp_workflow_info.view_para_info = await get_view_para_info(sp_workflow_info.instance_node_info['node_display_service_name'])
     return sp_workflow_info
 }

-async function get_view_para_info(local_url, service_name){
-    const url = `${local_url}/autocrud/simple.SIM_WFL.simple_workflow_view_para/query`
-    return await sp_request(url, {service_name})
+async function get_instance_node_info(instance_id){
+    const url = `/autocrud/simple.SIM_WFL.simple_instance_info/query`
+    return await sp_bm_request(url, {instance_id})
+}
+
+async function get_workflow_para_info(instance_id){
+    const url = `/autocrud/simple.SIM_WFL.simple_workflow_para/query`
+    return await sp_bm_request(url, {instance_id})
+}
+
+async function get_view_para_info(service_name) {
+    const url = `/autocrud/simple.SIM_WFL.simple_workflow_view_para/query`
+    return await sp_bm_request(url, {service_name})
 }

Index: src/main/resources/leaf_static/WEB-INF/classes/simple/SIM_WFL/simple_workflow_para.lwm
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/WEB-INF/classes/simple/SIM_WFL/simple_workflow_para.lwm b/src/main/resources/leaf_static/WEB-INF/classes/simple/SIM_WFL/simple_workflow_para.lwm
new file mode 100644
--- /dev/null	(revision bf0176d4101aa2e8dfb71fb4ebaeff6cd5c2d890)
+++ b/src/main/resources/leaf_static/WEB-INF/classes/simple/SIM_WFL/simple_workflow_para.lwm	(revision bf0176d4101aa2e8dfb71fb4ebaeff6cd5c2d890)
@@ -0,0 +1,27 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!--
+    $Author: Sora
+    $Date: 2022-4-2
+    $Revision: 1.0
+    $Purpose:
+-->
+<bm:model xmlns:bm="http://www.leaf-framework.org/schema/bm">
+    <bm:operations>
+        <bm:operation name="query">
+            <bm:query-sql>
+                <![CDATA[
+                    select * from (
+                        select parameter_code as key, parameter_desc as key_desc, parameter_value as value
+                              from zj_wfl_instance_para_all_v v
+                             where v.instance_id =  ${@instance_id}
+                        ) t
+                           #WHERE_CLAUSE#
+            ]]></bm:query-sql>
+        </bm:operation>
+    </bm:operations>
+    <bm:fields>
+        <bm:field name="key" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="KEY"/>
+        <bm:field name="key_desc" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="KEY_DESC"/>
+        <bm:field name="value" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="VALUE"/>
+    </bm:fields>
+</bm:model>
Index: src/main/resources/leaf_static/modules/simple/active_view_model.lview
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/simple/active_view_model.lview b/src/main/resources/leaf_static/modules/simple/active_view_model.lview
--- a/src/main/resources/leaf_static/modules/simple/active_view_model.lview	(revision 065a85e56f1b58349482335cd5f6f87e4a461be7)
+++ b/src/main/resources/leaf_static/modules/simple/active_view_model.lview	(revision bf0176d4101aa2e8dfb71fb4ebaeff6cd5c2d890)
@@ -14,6 +14,6 @@
         ]]></script>

         <a:screen-include screen="modules/cont/CON500/con_contract_get_layout_code.lview"/>
-        <a:screen-include screen="modules/simple/simple_util.lview"/>
+        <a:screen-include screen="modules/simple/simple_util.lview?para=${/parameter/}"/>
     </a:view>
 </a:screen>
Index: src/main/resources/leaf_static/modules/simple/js/simple_util_env.js
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/simple/js/simple_util_env.js b/src/main/resources/leaf_static/modules/simple/js/simple_util_env.js
--- a/src/main/resources/leaf_static/modules/simple/js/simple_util_env.js	(revision 065a85e56f1b58349482335cd5f6f87e4a461be7)
+++ b/src/main/resources/leaf_static/modules/simple/js/simple_util_env.js	(revision cb56d95b1c4f5a62314b8fe4acff55e485704034)
@@ -1,32 +1,32 @@
 const env_info = [
     {
         env: 'DEV',
-        url: 'http://10.213.234.43:9081'
+        url: '10.213.234.43:9081'
     },
     {
         env: 'LOCAL',
-        url: 'http://localhost:9081'
+        url: 'localhost:9081'
     },
     {
         env: 'UAT',
-        url: 'https://business.huanengleasing.com'
+        url: 'business.huanengleasing.com'
     },
     {
         env: 'PROD',
-        url: 'https://business.huanengleasing.cn'
+        url: 'business.huanengleasing.cn'
     },
     {
         env: 'PRE',
-        url: 'http://10.213.234.41:9090'
+        url: '10.213.234.41:9090'
     }
 ]

 let current_env_info = {}


-function sp_get_env_info_obj(request_obj){
-    current_env_info = env_info.filter(obj =>{
-        return obj.url === request_obj['origin']
+function sp_get_env_info_obj() {
+    current_env_info = env_info.filter(obj => {
+        return obj.url === window.location.host
     })[0]

     return current_env_info
Index: src/main/resources/leaf_static/modules/simple/js/simple_util_request.js
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/simple/js/simple_util_request.js b/src/main/resources/leaf_static/modules/simple/js/simple_util_request.js
--- a/src/main/resources/leaf_static/modules/simple/js/simple_util_request.js	(revision 065a85e56f1b58349482335cd5f6f87e4a461be7)
+++ b/src/main/resources/leaf_static/modules/simple/js/simple_util_request.js	(revision cb56d95b1c4f5a62314b8fe4acff55e485704034)
@@ -1,15 +1,26 @@
-async function sp_request(url, param, method='POST'){
+async function sp_bm_request(url, param, method = 'POST') {
+    const json = await sp_request(url, param, method)
+
+    if(json['result'] === undefined){
+        console.error('请求出错，请求结果为' + JSON.stringify(json))
+        return json
+    } else{
+        return json['result']['record']
+    }
+}
+
+async function sp_request(url, param, method ="POST"){
     url += '?'

-    for(let i in param){
-        if(param.hasOwnProperty(i)){
+    for (let i in param) {
+        if (param.hasOwnProperty(i)) {
             url += `${i}=${param[i]}&`
         }
     }

     const res = await fetch(url, {method})
-    const json = await  res.json()
+    return await res.json()
+}

-    return json['result']['record']
-}
+

Index: src/main/resources/leaf_static/modules/prj/PRJ501Z/prj_basic_risk_measures_detail.lview
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/prj/PRJ501Z/prj_basic_risk_measures_detail.lview b/src/main/resources/leaf_static/modules/prj/PRJ501Z/prj_basic_risk_measures_detail.lview
--- a/src/main/resources/leaf_static/modules/prj/PRJ501Z/prj_basic_risk_measures_detail.lview	(revision 2d66f458e3a23441ab2740743638482e689cc546)
+++ b/src/main/resources/leaf_static/modules/prj/PRJ501Z/prj_basic_risk_measures_detail.lview	(revision fc9e4df94fbab15e85036cc66f2041b1d04682a4)
@@ -532,7 +532,7 @@
                 <a:datas>
                     <a:record code_value_name="决议+合同+登记" code_value="REGIST"/>
                     <a:record code_value_name="决议+合同" code_value="NOREGIST"/>
-<!--                    <a:record code_value_name="登记" code_value="DENGJI"/>-->
+                    <a:record code_value_name="登记" code_value="DENGJI"/>
                 </a:datas>
                 <a:fields>
                     <a:field name="code_value_name"/>
Index: src/main/java/com/hand/hls/acr/service/impl/AcrInvoiceInterfaceServiceImpl.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/java/com/hand/hls/acr/service/impl/AcrInvoiceInterfaceServiceImpl.java b/src/main/java/com/hand/hls/acr/service/impl/AcrInvoiceInterfaceServiceImpl.java
--- a/src/main/java/com/hand/hls/acr/service/impl/AcrInvoiceInterfaceServiceImpl.java	(revision fd32897cea65ba0889e429bbc9b29c39bc6e38b6)
+++ b/src/main/java/com/hand/hls/acr/service/impl/AcrInvoiceInterfaceServiceImpl.java	(revision 975e309bbb5f73c28d127b2ace8419899825c782)
@@ -92,6 +92,8 @@
     private static String LEASE = "LEASE";
     //直租
     private static String LEASEBACK = "LEASEBACK";
+    //保理
+    private static String FACTORING_BUSINESS = "FACTORING_BUSINESS";
     //不动产
     private static String DIVISION_01 = "01";
     //动产
@@ -723,6 +725,7 @@
     private AcrInvoiceInterfaceRequest setBusinessEntity(AcrInvoiceInterfaceRequest acrInvoiceInterfaceRequest) {
         String businessType = acrInvoiceInterfaceRequest.getConBusinessType();
         String division = acrInvoiceInterfaceRequest.getDivision();
+        String billDesc = acrInvoiceInterfaceRequest.getBillDesc();


         if (LEASE.equalsIgnoreCase(businessType) && DIVISION_01.equalsIgnoreCase(division)) {
@@ -742,6 +745,14 @@
             acrInvoiceInterfaceRequest.setBillCode("104");
             acrInvoiceInterfaceRequest.setBillName("有形动产融资性售后回租");
         }
+        if (FACTORING_BUSINESS.equalsIgnoreCase(businessType)){
+            acrInvoiceInterfaceRequest.setBillCode("108");
+            acrInvoiceInterfaceRequest.setBillName("保理业务");
+        }
+        if ("咨询服务费".equalsIgnoreCase(billDesc)){
+            acrInvoiceInterfaceRequest.setBillCode("109");
+            acrInvoiceInterfaceRequest.setBillName("咨询服务");
+        }
         return acrInvoiceInterfaceRequest;
     }
 }
Index: src/main/resources/leaf_static/WEB-INF/classes/sdic/SDIC001/sdic_acr_invoice.lwm
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/WEB-INF/classes/sdic/SDIC001/sdic_acr_invoice.lwm b/src/main/resources/leaf_static/WEB-INF/classes/sdic/SDIC001/sdic_acr_invoice.lwm
--- a/src/main/resources/leaf_static/WEB-INF/classes/sdic/SDIC001/sdic_acr_invoice.lwm	(revision e6d5a74fa95e635e1ae79895bb667a446cfa38a6)
+++ b/src/main/resources/leaf_static/WEB-INF/classes/sdic/SDIC001/sdic_acr_invoice.lwm	(revision 13a1e44d7450b34e2f9a5d9587ad15da9c657ded)
@@ -167,7 +167,5 @@
         <bm:query-field name="due_date_from" queryExpression="t1.due_date&gt;=trunc(to_date(${@due_date_from},&apos;yyyy-mm-dd&apos;))"/>
         <bm:query-field name="due_date_to" queryExpression="trunc(t1.due_date)&lt;=to_date(${@due_date_to},&apos;yyyy-mm-dd&apos;)"/>
     </bm:query-fields>
-    <bm:data-filters>
-        <bm:data-filter enforceOperations="query" expression="t1.cf_item_n = '提前留购补偿金'"/>
-    </bm:data-filters>
+
 </bm:model>
Index: src/main/resources/leaf_static/WEB-INF/classes/prj/PRJ501Z/hn_project_scheme_clause.lwm
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/WEB-INF/classes/prj/PRJ501Z/hn_project_scheme_clause.lwm b/src/main/resources/leaf_static/WEB-INF/classes/prj/PRJ501Z/hn_project_scheme_clause.lwm
--- a/src/main/resources/leaf_static/WEB-INF/classes/prj/PRJ501Z/hn_project_scheme_clause.lwm	(revision d915ef10c333e36ad28e45190ba93ee1d10383df)
+++ b/src/main/resources/leaf_static/WEB-INF/classes/prj/PRJ501Z/hn_project_scheme_clause.lwm	(revision 163a024047781d3c631497db0e248604e903b0e4)
@@ -63,6 +63,7 @@
     </bm:primary-key>
     <bm:data-filters>
         <bm:data-filter name="query" expression="t1.plan_id = ${@plan_id} and t1.scheme_type=${@scheme_type}"/>
+        <bm:data-filter name="query" expression="t1.update_flag = 'Y'"/>
     </bm:data-filters>
     <bm:operations>
         <bm:operation name="update">
Index: src/main/resources/leaf_static/modules/cont/CON500/con_contract_get_layout_code.lview
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/cont/CON500/con_contract_get_layout_code.lview b/src/main/resources/leaf_static/modules/cont/CON500/con_contract_get_layout_code.lview
--- a/src/main/resources/leaf_static/modules/cont/CON500/con_contract_get_layout_code.lview	(revision d915ef10c333e36ad28e45190ba93ee1d10383df)
+++ b/src/main/resources/leaf_static/modules/cont/CON500/con_contract_get_layout_code.lview	(revision 163a024047781d3c631497db0e248604e903b0e4)
@@ -8,6 +8,17 @@
 <a:screen xmlns:a="http://www.leaf-framework.org/application" customizationEnabled="true" trace="true">
     <a:view>
         <script><![CDATA[
+        /**
+         * 打开动态页面窗口
+         * @param bm_url_link 获取动态页面布局的BM对应的linkId
+         * @param param 窗口参数
+         * @param win_url_link 打开的动态页面窗口对应的页面文件路径的linkId
+         * @param list_ds 关闭页面 之后 要查询的ds_id
+         * @param pre_layout_code 当前页面的 动态页面布局代码 当param没有winid参数的时候 将自动生成一个winid (没什么用)
+         * @param pre_winid 当前页面的窗口ID 在执行查找layout_code的时候 这个函数会给当前页面上一个遮罩层 由于查询时间一般很短 所以不传也没关系
+         * @param pre_win_close_flag 一个标识 效果是如果生成的窗口关闭 那么当前的窗口也会关闭
+         * @param function_name 页面关闭的时候 要额外执行的函数 但必须是以window[function_name]的 形式声明函数 (为啥不直接传个函数进来)
+         */
             function hls_doc_get_layout_code(bm_url_link, param, win_url_link, list_ds, pre_layout_code, pre_winid, pre_win_close_flag,function_name) {
                 if (pre_winid) {
                     Leaf.Masker.mask($(pre_winid).wrap, '${l:HLS.EXECUTING}');
Index: src/main/resources/leaf_static/modules/layout/flexible_UI.lview
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/layout/flexible_UI.lview b/src/main/resources/leaf_static/modules/layout/flexible_UI.lview
new file mode 100644
--- /dev/null	(revision 163a024047781d3c631497db0e248604e903b0e4)
+++ b/src/main/resources/leaf_static/modules/layout/flexible_UI.lview	(revision 163a024047781d3c631497db0e248604e903b0e4)
@@ -0,0 +1,204 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!--
+    $Author: gaoyang
+    $Date: 2014-5-19 下午01:09:48
+    $Revision: 1.0
+    $Purpose:
+-->
+<a:screen xmlns:a="http://www.leaf-framework.org/application" trace="true">
+    <a:view>
+        <script type="text/javascript"><![CDATA[
+            //锁屏
+            window['${/parameter/@bp_seq}${/parameter/@layout_code}_lock_layout_dynamic_window'] = function() {
+                var detail_mask;
+                if ('${/parameter/@winid}') {
+                    if (parent.$L.CmpManager.get('${/parameter/@winid}')) {
+                        detail_mask = parent.$('${/parameter/@winid}').wrap;
+                        parent.Leaf.Masker.mask(detail_mask, '${l:HLS.EXECUTING}');
+                    } else {
+                        detail_mask = $('${/parameter/@winid}').wrap;
+                        Leaf.Masker.mask(detail_mask, '${l:HLS.EXECUTING}');
+                    }
+                } else {
+                    detail_mask = Ext.getBody();
+                    Leaf.Masker.mask(detail_mask, '${l:HLS.EXECUTING}');
+                }
+            };
+            window['${/parameter/@bp_seq}${/parameter/@layout_code}_on_cp_object_focus'] = function() {};
+            //解屏
+            window['${/parameter/@bp_seq}${/parameter/@layout_code}_unlock_layout_dynamic_window'] = function() {
+                var detail_mask;
+                if ('${/parameter/@winid}') {
+                    if (parent.$L.CmpManager.get('${/parameter/@winid}')) {
+                        detail_mask = parent.$('${/parameter/@winid}').wrap;
+                        parent.Leaf.Masker.unmask(detail_mask);
+                    } else {
+                        detail_mask = $('${/parameter/@winid}').wrap;
+                        Leaf.Masker.unmask(detail_mask);
+                    }
+                } else {
+                    detail_mask = Ext.getBody();
+                    Leaf.Masker.unmask(detail_mask);
+                }
+                if (Ext.get(document.documentElement)) {
+                    $L.Masker.unmask(Ext.get(document.documentElement));
+                }
+            };
+            //图片渲染
+            window['${/parameter/@bp_seq}${/parameter/@layout_code}_dynamic_pic_renderer'] = function(record, name, bp_seq) {
+                var result = name.match(/(.*)_pic$/);
+                if (result) {
+                    var pic_value = record.get(result[1]);
+                    if (pic_value == 'OUTFLOW') {
+                        return '<img src="${/request/@context_path}/images/outflow.png" style="margin-top:4px"/>';
+                    } else if (pic_value == 'INFLOW') {
+                        return '<img src="${/request/@context_path}/images/inflow.png" style="margin-top:4px"/>';
+                    } else if (pic_value == 'NONCASH') {
+                        return '<img src="${/request/@context_path}/images/noncash.png" style="margin-top:4px"/>';
+                    } else if (pic_value == 'CASH') {
+                        return '<img src="${/request/@context_path}/images/cash.png" style="margin-top:4px"/>';
+                    }
+                }
+            };
+
+
+            window['${/parameter/@bp_seq}${/parameter/@layout_code}_hls_link_render_record'] = {};
+            //超链接渲染
+            window['${/parameter/@bp_seq}${/parameter/@layout_code}_dynamic_link_renderer'] = function(value, record, name, config_record, bp_seq) {
+                var link_function = '';
+                window['${/parameter/@bp_seq}${/parameter/@layout_code}_hls_link_render_record'][record.id + '---' + name] = record;
+                if (name == 'quote') {
+                    return '<a href="javascript:window[\'' + link_function + '\'](\'' + record.id + '\',\'' + name + '\');">' + config_record.get('prompt') + '</a>';
+                }
+            };
+            //按钮渲染
+            window['${/parameter/@bp_seq}${/parameter/@layout_code}_dynamic_button_renderer'] = function(value, record, name, config_record, bp_seq) {
+                var link_function = '';
+                if (name == 'quote') {
+                    link_function = '';
+                }
+                if (Ext.isIE || Ext.isIE9 || Ext.isIE10) {
+                    return '<button style="font-size:11px;height:22px;width:70%;text-align:center;padding:0 4px 4px 0" onclick="window[\'' + link_function + '\'](\'' + record.id + '\',\'' + name + '\');"><div style="height: 18px; line-height: 16px; text-decoration: none;">' + config_record.get('prompt') + '</div></button>';
+                } else {
+                    return '<button style="font-size:11px;height:22px;width:70%;text-align:center;" onclick="window[\'' + link_function + '\'](\'' + record.id + '\',\'' + name + '\');">' + config_record.get('prompt') + '</button>';
+                }
+            };
+            //新增和加载时调用(form)
+            window['${/parameter/@bp_seq}${/parameter/@layout_code}_on_layout_dynamic_form_add_and_load'] = function(ds, record, config_records, bp_seq) {
+
+               };
+
+            //保存前调用
+            window['${/parameter/@bp_seq}${/parameter/@layout_code}_on_layout_dynamic_before_submit'] = function(ds, record) {
+                window['${/parameter/@layout_code}_lock_layout_dynamic_window']();
+                var check_flag = true;
+                return check_flag;
+            };
+
+            //保存submitsuccess调用
+            window['${/parameter/@layout_code}_on_layout_dynamic_submitsuccess'] = function(ds, record, res, bp_seq) {
+                window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
+            };
+            //保存失败调用
+            window['${/parameter/@bp_seq}${/parameter/@layout_code}_on_layout_dynamic_submitfailed'] = function(ds) {
+                window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
+            };
+
+            //新增时调用(grid,table,gridBox)
+            window['${/parameter/@bp_seq}${/parameter/@layout_code}_on_layout_dynamic_grid_add'] = function(ds, record, config_records, bp_seq) {
+
+               };
+            //加载时调用(grid,table,gridBox)
+            window['${/parameter/@bp_seq}${/parameter/@layout_code}_on_layout_dynamic_grid_load'] = function(ds, record, config_records, bp_seq) {
+
+               };
+            //查询时调用(grid,table,gridBox)
+            window['${/parameter/@bp_seq}${/parameter/@layout_code}_on_layout_dynamic_grid_query'] = function(ds, qpara, bp_seq) {
+
+               };
+            //查询时调用(form,fieldboxcolumn)
+            window['${/parameter/@bp_seq}${/parameter/@layout_code}_on_layout_dynamic_form_query'] = function(ds, qpara, bp_seq) {
+
+               };
+            //新增时调用(attach)
+            window['${/parameter/@bp_seq}${/parameter/@layout_code}_on_layout_dynamic_attach_add'] = function(ds, record, config_records, bp_seq) {
+
+               };
+            //加载时调用(attach)
+            window['${/parameter/@bp_seq}${/parameter/@layout_code}_on_layout_dynamic_attach_load'] = function(ds, record, config_records, bp_seq) {
+
+               };
+            //更新时调用
+            window['${/parameter/@bp_seq}${/parameter/@layout_code}_on_layout_dynamic_update'] = function(ds, record, name, value, old_value, bp_seq) {
+
+               };
+
+            //选择事件(grid,attach,gridbox,table)
+            window['${/parameter/@bp_seq}${/parameter/@layout_code}_on_layout_dynamic_grid_select'] = function(ds, record, bp_seq) {
+
+               };
+            //indexchange事件(grid,attach,gridbox,table)
+            window['${/parameter/@layout_code}_on_layout_dynamic_grid_indexchange'] = function(ds, record, bp_seq) {
+
+               };
+
+            //取消选择事件(grid,attach,gridbox,table)
+            window['${/parameter/@bp_seq}${/parameter/@layout_code}_on_layout_dynamic_grid_unselect'] = function(ds, record, bp_seq) {
+
+               };
+
+            //移除事件(grid,attach,gridbox,table)
+            window['${/parameter/@bp_seq}${/parameter/@layout_code}_on_layout_dynamic_grid_remove'] = function(ds, record, bp_seq) {
+
+            };
+
+            //移除前事件(grid,attach,gridbox,table)
+            window['${/parameter/@bp_seq}${/parameter/@layout_code}_on_layout_dynamic_grid_brfore_remove'] = function(ds, record, bp_seq) {
+                return true;
+            };
+
+            //grid cellclick
+            window['${/parameter/@bp_seq}${/parameter/@layout_code}_on_layout_dynamic_grid_cell_click'] = function(ds, record, bp_seq) {
+
+            };
+
+
+
+            function sumFunction(datas, name) {
+                var sum = 0;
+                for (var i = 0;i < datas.length;i++) {
+                    var r = datas[i];
+                    var d = r.get(name);
+                    var n = parseFloat(d);
+                    if (!isNaN(n)) {
+                        sum = plus(sum, n);
+                    }
+                }
+                var total = (typeof(sum) == 'undefined' ? '' : parseFloat(sum));
+                return '<font>' + Leaf.formatNumber(total) + '</font>';
+            }
+
+            //false为忽略校验，true为不忽略校验
+            window['${/parameter/@layout_code}_not_ignore_required_flag'] = true;
+            //忽略保存校验方法
+            window['${/parameter/@layout_code}_ignore_required_before_save'] = function() {
+                window['${/parameter/@layout_code}_not_ignore_required_flag'] = true;
+            };
+
+            //requiredfunction
+            window['${/parameter/@layout_code}_not_ignore_required'] = function() {
+                return window['${/parameter/@layout_code}_not_ignore_required_flag'];
+            };
+
+            Leaf.onReady(function() {
+                var input = document.createElement('input');
+                document.body.appendChild(input);
+                Ext.fly(input).moveTo(-10000, -10000);
+                input.focus();
+                setTimeout(function() {
+                    Ext.fly(input).remove();
+                }, 1000);
+            });
+        ]]></script>
+    </a:view>
+</a:screen>
Index: src/main/resources/leaf_static/modules/prj/PRJ506/prj_project_bl_print_detail_create.lview
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/prj/PRJ506/prj_project_bl_print_detail_create.lview b/src/main/resources/leaf_static/modules/prj/PRJ506/prj_project_bl_print_detail_create.lview
new file mode 100644
--- /dev/null	(revision 84f2a566ee08657fcc7803006532e3bb6da95a4a)
+++ b/src/main/resources/leaf_static/modules/prj/PRJ506/prj_project_bl_print_detail_create.lview	(revision 84f2a566ee08657fcc7803006532e3bb6da95a4a)
@@ -0,0 +1,80 @@
+<?xml version="1.0" encoding="UTF-8"?>
+
+<a:screen xmlns:a="http://www.leaf-framework.org/application" customizationEnabled="true" dynamiccreateenabled="true"
+          trace="true">
+    <a:view>
+        <a:link id="con_content_tmp_choose_confirm_link"
+                url="${/request/@context_path}/modules/prj/PRJ506/con_content_tmp_choose_confirm.lsc"/>
+
+        <script><![CDATA[
+
+        //按钮渲染
+        window['${/parameter/@layout_code}_user_button1_layout_dynamic_click'] = function () {
+
+            lock_current_window();
+            var ds_id = 'PRJ506T_BL_GRID_T_con_clause_templet_ds';
+            var jyht_ds = 'PRJ506T_BL_GRID_JY_con_clause_templet_ds';
+
+            function con_content_tmp_choose_close() {
+                $('${/parameter/@winid}').close();
+            }
+
+
+
+            var records = $(ds_id).getSelected();
+            var jyht_record = $(jyht_ds).getSelected();
+            var param = {};
+            var saveData = [];
+
+            if(jyht_record.filter(rec =>{return rec.get("con_type") === 'BL_MAIN'}).length > 1){
+                Leaf.showMessage("提示", "保理主合同只能选择一个")
+                unlock_current_window()
+                return
+            }
+            for (var i = 0; i < records.length; i++) {
+
+                var record;
+                record = records[i];
+                var temp_id = record.get('templet_id');
+                record.set('templet_id', temp_id);
+                record.set('project_id', '${/parameter/@project_id}');
+                saveData.push(record.data);
+            }
+            for (var i = 0; i < jyht_record.length; i++) {
+                if('${/parameter/@bl_choose_main_flag}' === 'Y' && jyht_record[i].get("con_type") === 'BL_MAIN'){
+                    Leaf.showMessage("提示", "保理主合同只能存在一个")
+                    unlock_current_window();
+                    return
+                }
+                var jyht;
+                jyht = jyht_record[i];
+                var temp_id = jyht.get('templet_id');
+                jyht.set('templet_id', temp_id);
+                jyht.set('project_id', '${/parameter/@project_id}');
+                saveData.push(jyht.data);
+            }
+            param['details'] = saveData;
+            param['project_id'] = '${/parameter/@project_id}';
+            Leaf.request({
+                url: $('con_content_tmp_choose_confirm_link').getUrl(),
+                para: param,
+                success: function () {
+                    // Leaf.showMessage('${l:HLS.PROMPT}', '添加成功!');
+                    $('con_contract_update_print_detail_line_ds').query()
+                    con_content_tmp_choose_close();
+                    unlock_current_window();
+                },
+                error: function () {
+                    unlock_current_window();
+                },
+                failure: function () {
+                    unlock_current_window();
+                },
+                scope: this
+            });
+
+        }
+        ]]></script>
+        <a:screen-include screen="modules/cont/CON500/con_contract_get_layout_code.lview"/>
+    </a:view>
+</a:screen>
Index: src/main/resources/leaf_static/WEB-INF/classes/execute_sql.lwm
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/WEB-INF/classes/execute_sql.lwm b/src/main/resources/leaf_static/WEB-INF/classes/execute_sql.lwm
--- a/src/main/resources/leaf_static/WEB-INF/classes/execute_sql.lwm	(revision 9d6f4ba28e89d8b30c1522106db9bc47e003b4d9)
+++ b/src/main/resources/leaf_static/WEB-INF/classes/execute_sql.lwm	(revision 98ac3cdacf1066d1ee14fd7a7fbc584b3cd5bb30)
@@ -9,10 +9,14 @@
             ]]></bm:update-sql>
         </bm:operation>
         <bm:operation name="query">
-            <bm:update-sql><![CDATA[
-            ${@query_sql};
-            ]]></bm:update-sql>
+            <bm:parameters>
+                <bm:parameter name="query_sql" dataType="java.lang.Long"/>
+            </bm:parameters>
+            <bm:query-sql><![CDATA[
+            ${@query_sql}
+            ]]></bm:query-sql>
         </bm:operation>
+
     </bm:operations>

 </bm:model>
Index: src/main/resources/com/hand/hls/acr/mapper/AcrInvoiceInterfaceMapper.xml
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/com/hand/hls/acr/mapper/AcrInvoiceInterfaceMapper.xml b/src/main/resources/com/hand/hls/acr/mapper/AcrInvoiceInterfaceMapper.xml
--- a/src/main/resources/com/hand/hls/acr/mapper/AcrInvoiceInterfaceMapper.xml	(revision 31c5e5535882002a05f0a7278d3c30ecab1d85f2)
+++ b/src/main/resources/com/hand/hls/acr/mapper/AcrInvoiceInterfaceMapper.xml	(revision c80967a86f4045e13cc04cec59a2f8d4c93a6419)
@@ -78,7 +78,7 @@
                hi.invoice_phone_number as cust_phone, --购方电话
                hi.invoice_bank as bank_name, --购方开户银行
                hi.invoice_bp_bank_account as bank_acct, --购方开户银行账号
-               bp.email as email, --购方邮箱
+               'swyyzx@huanengleasing.com' as email, --购方邮箱
                bp.invoice_phone_number as phone_num, --购方手机号
                (select a.business_type
                 from hls_business_type a
Index: src/main/resources/leaf_static/modules/hls/HLS213N/hls_bp_master_create.lview
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/hls/HLS213N/hls_bp_master_create.lview b/src/main/resources/leaf_static/modules/hls/HLS213N/hls_bp_master_create.lview
--- a/src/main/resources/leaf_static/modules/hls/HLS213N/hls_bp_master_create.lview	(revision 31c5e5535882002a05f0a7278d3c30ecab1d85f2)
+++ b/src/main/resources/leaf_static/modules/hls/HLS213N/hls_bp_master_create.lview	(revision c80967a86f4045e13cc04cec59a2f8d4c93a6419)
@@ -511,6 +511,62 @@

             };

+            window['${/parameter/@layout_code}_SAVE_LAYOUT_DYNAMIC_CLICK'] = function(nextStep) {
+                var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'hls_bp_master');
+
+                const record = $(ds_id).getCurrentRecord()
+                Leaf.showConfirm("提示", `<p align="center">是否确认`+record.get('bp_name')+"客户为"+record.get("hn_industry_classification_n")+"客户，为您加载对应材料清单？</p>", function(){
+                    var root_ds = $('${/parameter/@layout_code}_virtual_ds');
+                    if (root_ds.validate()) {
+                        var winid = '${/parameter/@winid}';
+                        var root_record = root_ds.getCurrentRecord();
+                        root_ds.setSubmitParameter('layout_code', '${/parameter/@layout_code}');
+
+                        function on_layout_dynamic_before_save() {
+                            root_ds.un('beforesubmit', on_layout_dynamic_before_save);
+                            var flag = false;
+                            for (var name in root_record.data) {
+                                if (root_record.data[name].data[0].ds instanceof $L.DataSet) {
+                                    var current_record = root_record.data[name].data[0].ds.getCurrentRecord();
+                                    flag = window['${/parameter/@layout_code}_on_layout_dynamic_before_submit'](root_record.data[name].data[0].ds, current_record);
+                                }
+                            }
+                            return flag;
+                        }
+                        root_ds.on('beforesubmit', on_layout_dynamic_before_save);
+                        window['${/parameter/@layout_code}_LAYOUT_DYNAMIC_ROOT_DS_EXECUTE_FINALLY'](root_ds, root_record, nextStep, winid);
+                    }
+                })
+
+            };
+
+            window['${/parameter/@layout_code}_LAYOUT_DYNAMIC_ROOT_DS_EXECUTE_FINALLY'] = function(ds, record, nextStep, winid) {
+                function ON_LAYOUT_DYNAMIC_INNER_SUBMITSUCCESS(ds, res) {
+                    ds.un('submitsuccess', ON_LAYOUT_DYNAMIC_INNER_SUBMITSUCCESS);
+                    window['${/parameter/@layout_code}_on_layout_dynamic_submitsuccess'](ds, record, res);
+                    if (typeof(nextStep) == 'function') {
+                        nextStep(ds);
+                    }
+                }
+
+                function ON_LAYOUT_DYNAMIC_INNER_SUBMITFAILED() {
+                    ds.un('submitfailed', ON_LAYOUT_DYNAMIC_INNER_SUBMITFAILED);
+                    window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
+
+                }
+
+                function ON_LAYOUT_DYNAMIC_INNER_SUBMITERROR() {
+                    ds.un('submiterror', ON_LAYOUT_DYNAMIC_INNER_SUBMITERROR);
+                    window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
+
+                }
+                ds.on('submitsuccess', ON_LAYOUT_DYNAMIC_INNER_SUBMITSUCCESS);
+                ds.on('submitfailed', ON_LAYOUT_DYNAMIC_INNER_SUBMITFAILED);
+                ds.on('submiterror', ON_LAYOUT_DYNAMIC_INNER_SUBMITERROR);
+
+                ds.submit();
+            };
+
             //选择事件(grid,attach,gridbox,table)
             window['${/parameter/@bp_seq}${/parameter/@layout_code}_on_layout_dynamic_grid_select'] = function(ds, record, bp_seq) {
                 var doc_ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'hls_bp_master_role');
Index: src/main/resources/leaf_static/WEB-INF/classes/cont/CON505/con_contract_content_check.lwm
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/WEB-INF/classes/cont/CON505/con_contract_content_check.lwm b/src/main/resources/leaf_static/WEB-INF/classes/cont/CON505/con_contract_content_check.lwm
--- a/src/main/resources/leaf_static/WEB-INF/classes/cont/CON505/con_contract_content_check.lwm	(revision 6afe6203eb0099f1cc7cc0ac2768e9e5ddf17663)
+++ b/src/main/resources/leaf_static/WEB-INF/classes/cont/CON505/con_contract_content_check.lwm	(revision 98ac3cdacf1066d1ee14fd7a7fbc584b3cd5bb30)
@@ -7,6 +7,16 @@
 -->
 <bm:model xmlns:bm="http://www.leaf-framework.org/schema/bm">
     <bm:operations>
+        <bm:operation name="query">
+            <bm:query-sql><![CDATA[
+                select count(case when c.linked_content_id is null and instr(c.content_number, 'BCN') > 0 then 1 end) count_not_link,
+                       count(case when sign_bp_id_n is null then 1 end) count_sign_bp
+                     from prj_project_content_v c
+                    where c.project_id = ${@project_id}
+
+            ]]></bm:query-sql>
+        </bm:operation>
+
         <bm:operation name="update">
             <bm:update-sql><![CDATA[
             	begin
Index: src/main/resources/leaf_static/modules/hls/HLS030N/hls_doc_layout_n.lview
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/hls/HLS030N/hls_doc_layout_n.lview b/src/main/resources/leaf_static/modules/hls/HLS030N/hls_doc_layout_n.lview
--- a/src/main/resources/leaf_static/modules/hls/HLS030N/hls_doc_layout_n.lview	(revision 6afe6203eb0099f1cc7cc0ac2768e9e5ddf17663)
+++ b/src/main/resources/leaf_static/modules/hls/HLS030N/hls_doc_layout_n.lview	(revision 98ac3cdacf1066d1ee14fd7a7fbc584b3cd5bb30)
@@ -335,5 +335,6 @@
                 </a:editors>
             </a:grid>
         </a:screenBody>
+        <a:screen-include screen="modules/simple/simple_util.lview?para=${/parameter/}"/>
     </a:view>
 </a:screen>
Index: src/main/resources/leaf_static/modules/hls/HLS811/hls_doc_file_templet_para.lview
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/hls/HLS811/hls_doc_file_templet_para.lview b/src/main/resources/leaf_static/modules/hls/HLS811/hls_doc_file_templet_para.lview
--- a/src/main/resources/leaf_static/modules/hls/HLS811/hls_doc_file_templet_para.lview	(revision 6afe6203eb0099f1cc7cc0ac2768e9e5ddf17663)
+++ b/src/main/resources/leaf_static/modules/hls/HLS811/hls_doc_file_templet_para.lview	(revision 98ac3cdacf1066d1ee14fd7a7fbc584b3cd5bb30)
@@ -152,5 +152,6 @@
                 </a:editors>
             </a:grid>
         </a:screenBody>
+        <a:screen-include screen="modules/simple/simple_util.lview?para=${/parameter/}"/>
     </a:view>
 </a:screen>
Index: src/main/resources/leaf_static/modules/prj/PRJ506/prj_project_create_content.lview
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/prj/PRJ506/prj_project_create_content.lview b/src/main/resources/leaf_static/modules/prj/PRJ506/prj_project_create_content.lview
--- a/src/main/resources/leaf_static/modules/prj/PRJ506/prj_project_create_content.lview	(revision 6afe6203eb0099f1cc7cc0ac2768e9e5ddf17663)
+++ b/src/main/resources/leaf_static/modules/prj/PRJ506/prj_project_create_content.lview	(revision 98ac3cdacf1066d1ee14fd7a7fbc584b3cd5bb30)
@@ -268,5 +268,6 @@
                 </a:columns>
             </a:grid>
         </a:screenBody>
+        <a:screen-include screen="modules/simple/simple_util.lview?para=${/parameter/}"/>
     </a:view>
 </a:screen>
Index: src/main/resources/leaf_static/modules/simple/js/simple_util_setting.js
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/simple/js/simple_util_setting.js b/src/main/resources/leaf_static/modules/simple/js/simple_util_setting.js
new file mode 100644
--- /dev/null	(revision 98ac3cdacf1066d1ee14fd7a7fbc584b3cd5bb30)
+++ b/src/main/resources/leaf_static/modules/simple/js/simple_util_setting.js	(revision 98ac3cdacf1066d1ee14fd7a7fbc584b3cd5bb30)
@@ -0,0 +1,15 @@
+const sp_settings = {
+  "version": "V0.13",
+  "author": "Sora",
+  "banner": {
+    "banner_context": "Thanks For Using Simple Util!",
+    "banner_enabled": true
+  },
+  "project_env": {
+    "hot_key": {
+      "enter_query": true,
+      "ctrl_s_save": true
+    }
+  }
+}
+
diff --git a/src/main/resources/leaf_static/modules/simple/simple_util_dev_log.md b/src/main/resources/leaf_static/modules/simple/simple_util_dev_log.md
new file mode 100644
