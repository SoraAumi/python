Index: src/main/resources/leaf_static/WEB-INF/classes/layout/server_layout_doc_cdd_item.lwm
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/WEB-INF/classes/layout/server_layout_doc_cdd_item.lwm b/src/main/resources/leaf_static/WEB-INF/classes/layout/server_layout_doc_cdd_item.lwm
--- a/src/main/resources/leaf_static/WEB-INF/classes/layout/server_layout_doc_cdd_item.lwm	(revision 3ec71beb9eade34ba61d6c828d11f3a093cb67e0)
+++ b/src/main/resources/leaf_static/WEB-INF/classes/layout/server_layout_doc_cdd_item.lwm	(revision 15803945221269648973ca84cd1cf84c0db7413e)
@@ -9,23 +9,26 @@
     <bm:operations>
         <bm:operation name="query">
             <bm:query-sql><![CDATA[
-            select * from(
+             select  rownum as order_num,t1.*
+           from (select
+            v.* from(
                 SELECT
-                   decode(pci.cdd_item,'HN_PRJ_VIRTUAL_021',to_date('1999-01-01','yyyy-MM-dd'),pp.creation_date)creation_date,
+                    decode(pci.cdd_item,'HN_PRJ_VIRTUAL_021',to_date('1999-01-01','yyyy-MM-dd'),pp.creation_date) creation_date,
                    to_char(pp.creation_date,'yyyy-mm-dd hh24:mi:ss') creatiodate,
                     -- 文档分类 add by wujun for huaneng 2018-6-12
                     pci.cdd_class,
                     pci.cdd_class_code,
+                    (select cdd_class from prj_cdd_item_templet pct where pct.cdd_item = pci.cdd_item AND ROWNUM=1) cdd_category,
                     nvl((select 'Y' from dual where
-				       exists (select 1 from hn_virtual_con_change_req tt1,prj_cdd_item_doc_ref tt2,prj_cdd_item_check tt3,prj_cdd_item tt4
-				                where tt1.change_req_id = pp.document_id
-				                  and tt1.project_id = tt2.document_id
-				                  and tt2.document_table = 'PRJ_PROJECT'
-				                  and tt2.check_id = tt3.check_id
-				                  and tt3.cdd_item_id = tt4.cdd_item_id
-				                  and tt4.cdd_item = pci.cdd_item)),'N') delete_sign_flag,
-				    pp.prj_version version_display,
-				    nvl((select 'Y'
+               exists (select 1 from hn_virtual_con_change_req tt1,prj_cdd_item_doc_ref tt2,prj_cdd_item_check tt3,prj_cdd_item tt4
+                        where tt1.change_req_id = pp.document_id
+                          and tt1.project_id = tt2.document_id
+                          and tt2.document_table = 'PRJ_PROJECT'
+                          and tt2.check_id = tt3.check_id
+                          and tt3.cdd_item_id = tt4.cdd_item_id
+                          and tt4.cdd_item = pci.cdd_item)),'N') delete_sign_flag,
+            pp.prj_version version_display,
+            nvl((select 'Y'
                      from dual
                     where exists (select 1
                              from prj_cdd_item_check pcic
@@ -43,17 +46,26 @@
                     pp.not_applicable,
                     pp.check_id,
                     pp.audit_status,
-	                pp.audit_status_n,
-	                    pp.note1,
-	                    pp.note2,
-	                    pp.note3,
-	                    pp.express_number,
-	                    pp.send_date,
-	                    pp.receive_date,
-	                    pp.print_status,
-	                    pp.print_status_n,
-	                    pp.dd_check_flag,
-					    pp.dd_photo_flag,
+                  pp.audit_status_n,
+                      pp.note1,
+                      pp.note2,
+                      pp.note3,
+                      pp.express_number,
+                      pp.send_date,
+                      pp.receive_date,
+                      pp.print_status,
+                      pp.print_status_n,
+                      pp.dd_check_flag,
+              pp.dd_photo_flag,
+              pp.receive_flag,
+              pp.mark_flag,
+              pp.confirm_flag,
+              --add by zc 资料清单优化
+              pp.important_concerns,
+              NVL(pp.investigate_guide_flag,'Y') as investigate_guide_flag,
+              (select v.code_value_name from sys_code_values_v v where v.code = 'PRJ_PLAN_ATTACHMENT_INVESTIGATE_GUIDE_FLAG' and v.code_value=NVL(pp.investigate_guide_flag,'Y')) investigate_guide_flag_n,
+              pp.reason_alternative,
+              --end
                     (select ct.content_print_flag from con_contract_content ct where ct.check_id = pp.check_id) content_print_flag,
                     (select ct.content_id from con_contract_content ct where ct.check_id = pp.check_id) content_id,
                     (SELECT
@@ -98,6 +110,10 @@
                     pci.sign_tab_group,
                     pci.incept_tab_group,
                     pci.lender_tab_group,
+                    nvl(pci.arch_required_flag, 'Y') arch_required_flag,/*add zc 归档必传标识*/
+                    nvl(pci.arch_par_has_flag,'Y') arch_par_has_flag,
+                    (select v.code_value_name from sys_code_values_v v where v.code = 'ACRCH_TYPE' and v.code_value= nvl(pci.arch_par_has_flag,'Y')) arch_par_has_flag_desc,
+                    pci.arch_paper_required_flag,
                     tg.tab_group_id,
                     tg.tab_group attachment_tab_group,
                     lgt.important_flag,
@@ -144,7 +160,7 @@
                     ) check_confirm_note,
                     tg.tab_group,
                     hls_sys_upload_pkg.get_atm_file_href(p_table_pk_value => pp.check_id,p_source_type => 'PRJ_CDD_ITEM_CHECK',p_user_id => ${/session/@user_id}) AS attach_file_name,
-                    nvl(pp.sign_num,0) as sign_num
+                    nvl(pci.sign_num,0) as sign_num
                 FROM
                     (SELECT
                         pcf.check_id,
@@ -156,22 +172,28 @@
                         pck.attachment_required,
                         pck.not_applicable,
                         pck.audit_status,
-	                    (select  v.code_value_name from sys_code_values_v v where v.code = 'CON_543D_AUDIT_STATUS' and v.code_value=pck.audit_status) audit_status_n,
-	                    pck.note1,
-	                    pck.note2,
-	                    pck.note3,
-	                    pck.express_number,
-	                    pck.send_date,
-	                    pck.receive_date,
-	                    pck.print_status,
-	                     (select  v.code_value_name from sys_code_values_v v where v.code = 'OTHER_BSNT_MATRS_CODE' and v.code_value=pck.print_status) print_status_n,
-	                    pck.dd_check_flag,
-					    pck.dd_photo_flag,
-					    pck.prj_version_id,
-					    pck.prj_version,
+                      (select  v.code_value_name from sys_code_values_v v where v.code = 'CON_543D_AUDIT_STATUS' and v.code_value=pck.audit_status) audit_status_n,
+                      pck.note1,
+                      pck.note2,
+                      pck.note3,
+                      pck.express_number,
+                      pck.send_date,
+                      pck.receive_date,
+                      pck.print_status,
+                      (select  v.code_value_name from sys_code_values_v v where v.code = 'OTHER_BSNT_MATRS_CODE' and v.code_value=pck.print_status) print_status_n,
+                      pck.dd_check_flag,
+              pck.dd_photo_flag,
+              pck.prj_version_id,
+              pck.prj_version,
                         pck.instance_id,
-					    pck.creation_date,
-					    pck.sign_num
+              pck.creation_date,
+              nvl(pck.receive_flag,'Y') receive_flag,
+              pck.mark_flag,
+              pck.confirm_flag,
+              pck.important_concerns,
+              pck.investigate_guide_flag,
+              (select  v.code_value_name from sys_code_values_v v where v.code = 'PRJ_PLAN_ATTACHMENT_INVESTIGATE_GUIDE_FLAG' and v.code_value=pck.investigate_guide_flag) investigate_guide_flag_n,
+              pck.reason_alternative
                     FROM
                         prj_cdd_item_doc_ref pcf,
                         prj_cdd_item_check pck
@@ -186,6 +208,7 @@
                 WHERE
                     pci.cdd_item_id  = lgt.cdd_item_id AND
                     lgt.TAB_GROUP_ID =tg.TAB_GROUP_ID(+) AND
+
                     nvl(lgt.enabled_flag,'Y') ='Y' AND
                     nvl(tg.enabled_flag,'Y') = 'Y' AND
                     nvl(tg.tab_group_id,-1)  = nvl(${@attachment_tab_group},-1) AND
@@ -198,10 +221,12 @@
                     pci.cdd_list_id  = nvl(${/parameter/@cdd_list_id},${@cdd_list_id}) AND
                     pci.enabled_flag ='Y'
                     and lgt.cdd_list_id = pci.cdd_list_id
+                    and nvl(pci.arch_required_flag, 'Y') not in nvl(${@arch_not_required_flag},' ')
+                    and ((nvl(${@confirm_flag},'N')='Y' AND pp.confirm_flag='Y') or nvl(${@confirm_flag},'N')='N')
+
+                    )v   ORDER BY v.file_count,v.order_seq,v.confirm_flag,v.creation_date ASC) t1 #WHERE_CLAUSE#

-                    )t1 #WHERE_CLAUSE#
-                ORDER BY
-                    t1.file_count,t1.creation_date,t1.seq_num ASC
+
             ]]></bm:query-sql>
         </bm:operation>
         <bm:operation name="update">
@@ -247,7 +272,12 @@
                                       p_cdd_item_id           =>${@cdd_item_id},
                                       p_check_id              =>v_check_id,
                                       p_user_id  =>${/session/@user_id},
-                                      p_false_required_flag =>${@false_required_flag});
+                                      p_false_required_flag =>${@false_required_flag},
+                                      p_arch_required_flag =>${@arch_required_flag},
+                                      p_arch_par_has_flag =>${@arch_par_has_flag},
+                                      p_arch_paper_required_flag =>${@arch_paper_required_flag},
+                                      p_sign_num =>${@sign_num}
+                                      );

                                update  prj_cdd_item_check pci
 									  set pci.note1 = ${@note1},
@@ -260,10 +290,14 @@
 									      pci.receive_date = to_date(${@receive_date},'YYYY-MM-DD'),
 									      pci.dd_check_flag = ${@dd_check_flag},
 									      pci.dd_photo_flag = ${@dd_photo_flag},
-									      pci.sign_num= nvl(${@sign_num},0)
+                                          pci.receive_flag  = ${@receive_flag},
+                                          pci.mark_flag     = ${@mark_flag},
+                                          pci.confirm_flag  = ${@confirm_flag},
+                                          pci.important_concerns = ${@important_concerns},
+                                          pci.investigate_guide_flag = ${@investigate_guide_flag},
+                                          pci.reason_alternative = ${@reason_alternative}
 								  where pci.check_id=v_check_id;
 								  select v_check_id into ${@check_id} from dual;
-
             	END;
         	]]></bm:update-sql>
             <bm:parameters>
@@ -317,20 +351,31 @@
                                       p_cdd_item_id           =>${@cdd_item_id},
                                       p_check_id              =>v_check_id,
                                       p_user_id  =>${/session/@user_id},
-                                      p_false_required_flag =>${@false_required_flag});
+                                      p_false_required_flag =>${@false_required_flag},
+                                      p_arch_required_flag =>${@arch_required_flag},
+                                      p_arch_par_has_flag =>${@arch_par_has_flag},
+                                      p_arch_paper_required_flag =>${@arch_paper_required_flag},
+                                      p_sign_num =>${@sign_num}
+                                      );
+
 		                          update  prj_cdd_item_check pci
-									  set pci.note1 = ${@note1},
-									      pci.audit_status = ${@audit_status},
-									      pci.note2	=${@note2},
-									      pci.note3 = ${@note3},
-									      pci.print_status = ${@print_status},
-									      pci.express_number = ${@express_number},
-									      pci.send_date = to_date(${@send_date},'YYYY-MM-DD'),
-									      pci.receive_date = to_date(${@receive_date},'YYYY-MM-DD'),
-									      pci.dd_check_flag = ${@dd_check_flag},
-									      pci.dd_photo_flag = ${@dd_photo_flag},
-									      pci.sign_num= nvl(${@sign_num},0)
-								  where pci.check_id=v_check_id;
+                                    set pci.note1 = ${@note1},
+                                        pci.audit_status = ${@audit_status},
+                                        pci.note2 =${@note2},
+                                        pci.note3 = ${@note3},
+                                        pci.print_status = ${@print_status},
+                                        pci.express_number = ${@express_number},
+                                        pci.send_date = to_date(${@send_date},'YYYY-MM-DD'),
+                                        pci.receive_date = to_date(${@receive_date},'YYYY-MM-DD'),
+                                        pci.dd_check_flag = ${@dd_check_flag},
+                                        pci.dd_photo_flag = ${@dd_photo_flag},
+                                        pci.receive_flag  = ${@receive_flag},
+                                        pci.mark_flag     = ${@mark_flag},
+                                        pci.confirm_flag  = ${@confirm_flag},
+                                        pci.important_concerns = ${@important_concerns},
+                                        pci.investigate_guide_flag = ${@investigate_guide_flag},
+                                        pci.reason_alternative = ${@reason_alternative}
+                                  where pci.check_id=v_check_id;
 								select v_check_id into ${@check_id} from dual;
             	END;
         	]]></bm:update-sql>
@@ -358,6 +403,8 @@
     </bm:operations>
     <bm:fields>
         <bm:field name="cdd_item" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="CDD_ITEM"/>
+        <bm:field name="cdd_class" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="CDD_CLASS"/>
+        <bm:field name="cdd_category" databaseType="VARCHAR2" datatype="java.lang.String"/>
         <bm:field name="description" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="DESCRIPTION"/>
         <bm:field name="order_seq" databaseType="NUMBER" datatype="java.lang.Long" physicalName="ORDER_SEQ"/>
         <bm:field name="show_seq" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="SHOW_SEQ"/>
@@ -412,15 +459,29 @@
         <bm:field name="audit_status_n"/>
         <bm:field name="dd_check_flag"/>
         <bm:field name="dd_photo_flag"/>
-        <bm:field name="cdd_class"/>
         <bm:field name="cdd_class_code"/>
         <bm:field name="delete_sign_flag"/>
         <bm:field name="creation_date" databaseType="DATE" datatype="java.util.Date"/>
         <bm:field name="version_display"/>
+        <bm:field name="creatiodate"/>
         <bm:field name="attach_only_query_flag"/>
         <bm:field name="false_required_flag"/>
         <bm:field name="sign_num"/>
-        <bm:field name="creatiodate"/>
+        <bm:field name="arch_required_flag"/>
+        <bm:field name="arch_par_has_flag"/>
+        <bm:field name="arch_par_has_flag_desc"/>
+        <bm:field name="arch_paper_required_flag"/>
+        <bm:field name="receive_flag"/>
+        <bm:field name="mark_flag"/>
+        <bm:field name="confirm_flag"/>
+
+        <bm:field name="seq_num"/>
+        <bm:field name="important_concerns"/>
+        <bm:field name="investigate_guide_flag"/>
+        <bm:field name="investigate_guide_flag_n"/>
+        <bm:field name="reason_alternative"/>
+        <bm:field name="order_num"/>
+
     </bm:fields>
     <bm:query-fields>
         <!--提前留购发起隐藏同意提前留购确认书-->
Index: src/main/resources/leaf_static/modules/acrch/ACRCH001/acrch_contract_entrance.lview
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/acrch/ACRCH001/acrch_contract_entrance.lview b/src/main/resources/leaf_static/modules/acrch/ACRCH001/acrch_contract_entrance.lview
new file mode 100644
--- /dev/null	(revision 586e0a3342bdf9c1f74a1427bf4719efccef1318)
+++ b/src/main/resources/leaf_static/modules/acrch/ACRCH001/acrch_contract_entrance.lview	(revision 586e0a3342bdf9c1f74a1427bf4719efccef1318)
@@ -0,0 +1,96 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!--
+    $Author: wangchao
+    $Date: 2021-03-30 下午01:58:31
+    $Revision: 1.0
+    $Purpose: 档案归档入口界面
+-->
+<a:screen xmlns:a="http://www.leaf-framework.org/application" customizationEnabled="true" dynamiccreateenabled="true" trace="true">
+    <a:init-procedure>
+        <a:model-query defaultWhereClause="t1.function_code = &apos;HLS214N&apos;" model="fnd.FND6000.bgfl_common_template_query" rootPath="template_path"/>
+    </a:init-procedure>
+    <a:view>
+        <a:link id="con_contract_get_layout_code_link_id" model="cont.CON500.con_contract_get_layout_code" modelaction="update"/>
+        <a:link id="prj506_virtual_contract_query_link_id" url="${/request/@context_path}/modules/prj/PRJ506/virtual_contract_query.lview"/>
+        <a:link id="prj_project_modify_link2" url="${/request/@context_path}/modules/prj/PRJ501N/prj_project_create_tree_n.lview"/>
+        <script><![CDATA[
+        function open_project_modify_win(ds_id,record_id) {
+            var record = $(ds_id).findById(record_id);
+            var maintain_type = 'READONLY';
+            var function_usage = 'QUERY';
+            var function_code = 'PRJ505';
+            var param = record.data;
+
+            param['document_id'] = record.get('ref_project_id');
+            param['function_code'] = function_code;
+            param['function_usage'] = function_usage;
+            param['maintain_type'] = maintain_type;
+            param['url_title'] = '${l:HLS.PROJECT_MAITAIN}';
+            //param['layout_debugger_flag']='Y';
+            param['cond_para2'] = record.get('hn_industry_classification');
+            param['cond_para3'] = record.get('binary_classification');
+            param['document_type'] = record.get('document_type');
+            param['wf_function_code'] = '${/parameter/@function_code}';
+            param['winid'] = 'prj501n_main_prj_link_winid';
+            hls_doc_get_layout_code('con_contract_get_layout_code_link_id', param, 'prj_project_modify_link2', ds_id);
+        }
+
+
+        function prj506_grid_virtual_con(ds_id,reocrd_id) {
+            var url_link_id;
+            var record = $(ds_id).findById(reocrd_id);
+            var param = record.data;
+
+            param['function_code'] = 'C0N301D_CON';
+            param['function_usage'] = 'QUERY';
+            param['maintain_type'] = 'READONLY';
+            url_link_id='prj506_virtual_contract_query_link_id';
+
+            //param['document_id'] = record.get('project_id');
+            param['cond_para2'] = record.get('hn_industry_classification');
+            param['url_title'] = '合同明细';
+            // param['layout_debugger_flag'] = 'Y';
+            param['winid'] = 'prj506_virtual_contract_modify_detail_link_id';
+            hls_doc_get_layout_code('con_contract_get_layout_code_link_id', param, url_link_id, ds_id);
+        }
+
+            window['${/parameter/@layout_code}_dynamic_link_renderer'] = function(value, record, name, config_record) {
+                if (name == 'project_number') {
+                    return '<a href="javascript:open_project_modify_win(\'' + record.ds.id + '\',\'' + record.id + '\')">' + value + '</a>';
+                }
+
+                else if (name == 'contract_number') {
+                    return '<a href="javascript:prj506_grid_virtual_con(\'' + record.ds.id + '\',\'' + record.id + '\')">' + value + '</a>';
+                }
+                return value;
+            };
+
+            //电子档归档按钮
+            window['${/parameter/@layout_code}_user_button1_layout_dynamic_click'] = function() {
+                var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_project');
+                var records = $(ds_id).getSelected();
+                var record=records[0].getCurrentRecord();
+                var win = new Leaf.Window({
+                    params: {
+                      project_id:record.get('project_id')
+                    },
+                    id: 'acrch001_detail_window',
+                    url: $('item_insurance_modify_link_id').getUrl(),
+                    title:'',
+                    fullScreen: true
+                });
+
+            };
+
+
+            window['${/parameter/@layout_code}_on_layout_dynamic_grid_query'] = function(ds, qpara, bp_seq) {
+                var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'hls_bp_master');
+                if (ds == $(ds_id)) {
+                    aut_authority_list_validate_query(ds, qpara);
+                }
+            };
+        ]]></script>
+        <a:screen-include screen="modules/cont/CON500/con_contract_authority_list_validate.lview?document_category=BP&amp;function_code=HLS214"/>
+        <a:screen-include screen="modules/cont/CON500/con_contract_get_layout_code.lview"/>
+    </a:view>
+</a:screen>
Index: src/main/resources/leaf_static/modules/acrch/ACRCH001/con_contract_content.lview
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/acrch/ACRCH001/con_contract_content.lview b/src/main/resources/leaf_static/modules/acrch/ACRCH001/con_contract_content.lview
new file mode 100644
--- /dev/null	(revision 586e0a3342bdf9c1f74a1427bf4719efccef1318)
+++ b/src/main/resources/leaf_static/modules/acrch/ACRCH001/con_contract_content.lview	(revision 586e0a3342bdf9c1f74a1427bf4719efccef1318)
@@ -0,0 +1,234 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!--
+    $Author: Feng
+    $Date: 2014-1-3 上午10:24:25
+    $Revision: 1.0
+    $Purpose:
+-->
+<a:screen xmlns:a="http://www.leaf-framework.org/application" trace="true">
+    <a:init-procedure>
+        <!-- <a:model-execute model="db.prj_cdd_item_pkg.prj_cdd_item_extra_save"/> -->
+        <a:model-query model="cont.CON555.con555_get_info" rootPath="con555_get_info"/>
+    </a:init-procedure>
+    <a:view>
+        <a:link id="con555_cdd_uploadFile_id" url="${/request/@context_path}/uploadFile.lview"/>
+        <a:link id="con555_cdd_download_id" url="${/request/@context_path}/atm_download.lsc"/>
+        <a:link id="con555_cdd_query_link" url="${/request/@context_path}/autocrud/cont.CON555.con_content_query_detail/query"/>
+        <a:link id="con_contract_file_link_id" model="db.con_contract_pkg.update_contract_file_date" modelaction="execute"/>
+        <link href="${/request/@context_path}/css/lightbox.css" rel="stylesheet" type="text/css"/>
+        <script src="${/request/@context_path}/javascripts/lightbox.js"/>
+        <script><![CDATA[
+         Ext.ux.Lightbox.register('a[ref=img]', true);
+
+            window['con555_cdd_editorFunction'] = function(record, name) {
+                if (record.get('sys_flag') == 'N') {
+                    return 'con555_cdd_tf_id';
+                }
+                return '';
+            };
+
+            function con555_cdd_selectFunc(record) {
+                if (record.get('sys_flag') == 'Y') {
+                    return false;
+                }
+                return true;
+            }
+            window['con555_cdd_attachment_render'] = function(value, record, name) {
+                //debugger;
+                var check_id = record.get('check_id');
+                var file_name = record.get('file_name');
+                var record_id = record.id;
+                if (!record.isNew && check_id) {
+                    return '<a href="javascript:window[\'con555_cdd_attachtment_upload\'](\'' + record.get('check_id') + '\',\'' + file_name + '\',\'' + record_id + '\')">${l:HLS.ATTACHMENT}</a>';
+                }
+            };
+
+            window['con555_link_render'] = function(value, record, name) {
+                // var file_name = record.get('file_name');
+                // var url = $('con555_cdd_download_id').getUrl() + '?attachment_id=' + record.get('attachment_id');
+                // if (file_name) {
+                // return '<a href='+url+ '>' + value + '</a>';
+                // }
+                //debugger;
+                if (value != null) {
+                    var link = '${/request/@context_path}/atm_download.lsc?attachment_id=';
+                    var str = value.split(';;');
+                    var url = '';
+                    for (var i = 0;i < str.length;i++) {
+                        var temp = str[i].split('--');
+                        if (!Leaf.isEmpty(temp[0])) {
+                            url = url + '<a href=' + link + temp[1] + ' ref="img">' + temp[0] + '</a>' + ',';
+                        }
+                    }
+                    return url;
+
+                }
+            };
+
+            window['con555_cdd_attachtment_upload'] = function(check_id, file_name, record_id) {
+                //debugger;
+                var url = $('con555_cdd_uploadFile_id').getUrl() + '?table_name=PRJ_CDD_ITEM_CHECK&header_id=' + check_id;
+                var record = $('con555_detail_result_ds').getCurrentRecord();
+                var oldvalue = file_name ? file_name : null;
+                var contract_id = ${/parameter/@contract_id};
+                paras = {
+                    'contract_id': contract_id
+                };
+                var win = new Leaf.Window({
+                    url: url,
+                    title: '${l:HLS.SUPPORTING_DOCUMENT}',
+                    id: 'con555_cdd_uploadFile_screen_id',
+                    width: 850,
+                    height: 400
+                });
+                win.on('close', function() {
+                    //debugger;
+                    Leaf.request({
+                        url: $('con555_cdd_query_link').getUrl(),
+                        para: paras,
+                        success: function(data) {
+                            $('con555_detail_result_ds').query();
+
+                            var newvalue = $('con555_detail_result_ds').findById(record_id).get('file_name');
+                            //con555_attach_update(oldvalue,newvalue);
+                        },
+                        sync: true
+                    });
+
+                });
+
+            };
+            window['con555_cdd_required_render'] = function(value, record, name) {
+                var project_required_flag = record.get('project_required_flag');
+                if (project_required_flag == 'Y') {
+                    return '<pan style="color:red">' + value + '</pan>';
+                } else {
+                    return value;
+                }
+            };
+            // window['con555_attach_add'] = function(ds) {
+            // var record = $('con555_detail_result_ds').getAt(0);
+            // var current_record = ds.getCurrentRecord();
+            // current_record.data['document_table'] = 'PRJ_CDD_ITEM_CHECK';
+            // current_record.data['cdd_list_id'] = record.get('cdd_list_id');
+            // current_record.data['document_id'] = record.get('document_id');
+            // current_record.data['note'] = record.get('note');
+            // document_category = record.get('document_category');
+            // if (document_category == 'CONTRACT') {
+            // current_record.data['contract_required_flag'] = 'N';
+            // current_record.data['contract_display_flag'] = 'Y';
+            // } else if (document_category == 'PROJECT') {
+            // current_record.data['project_required_flag'] = 'N';
+            // current_record.data['project_display_flag'] = 'Y';
+            // }
+            // };
+            // window['con555_attach_load'] = function(ds) {
+            // var records = ds.getAll();
+            // if (records.length) {
+            // for (var i = 0;i < records.length;i++) {
+            // var record = records[i];
+            // if (Ext.isEmpty(record.get('check_id'))) {
+            // record.dirty = true;
+            // }
+            // }
+            // }
+            // };
+
+            // function con555_attach_update(ds, record, value, oldvalue, newvalue) {
+            // alert('con555_attach_update');
+            // }
+
+            // function con555_attach_query(ds) {
+            // alert('con555_attach_refresh');
+            // }
+
+            function con555_con_contract_back() {
+                //console.log($('con555_contract_query_ds').data[0].getMeta().getField('contract_status_desc'));
+                $('con_contract_content_window').close();
+            }
+
+            function con555_con_contract_reset() {
+                $('con555_detail_ds').reset();
+            }
+
+            function con555_con_contract_save() {
+                var file_date = $('con555_detail_ds').getCurrentRecord().get('creation_date');
+                if (file_date) {
+                    var paras = {
+                        'contract_id': '${/parameter/@contract_id}',
+                        'file_date': file_date
+                    };
+            		Leaf.showConfirm('提示','确认归档完成?',function okfun(){
+            		    Leaf.request({
+                        url: $('con_contract_file_link_id').getUrl(),
+                        para: paras,
+                        success: function(data) {
+                            con555_con_contract_back();
+                        },
+                        sync: true
+                    });
+            		},function(){},300,100);
+
+                }
+                else
+                {
+                    Leaf.showMessage('提示','请填写归档完成信息');
+                }
+            }
+        ]]></script>
+        <a:dataSets>
+            <a:dataSet id="con555_detail_ds" autoCreate="true" fetchAll="true">
+                <a:fields>
+                    <a:field name="contract_number" defaultValue="${/model/con555_get_info/record/@contract_number}" readOnly="true"/>
+                    <a:field name="bp_id_tenant_desc" defaultValue="${/model/con555_get_info/record/@bp_id_tenant_desc}" readOnly="true"/>
+                    <a:field name="creation_date" defaultValue="${/model/con555_get_info/record/@contract_file_date}"/>
+                </a:fields>
+            </a:dataSet>
+            <a:dataSet id="con555_detail_result_ds" autoPageSize="true" autoQuery="true" fetchAll="true" model="acrch.ACRCH001.con_content_query_detail" pageSize="13" queryDataSet="con555_detail_ds" queryUrl="${/request/@context_path}/autocrud/cont.CON555.con_content_query_detail/query?contract_id=${/parameter/@contract_id}" selectFunction="con555_cdd_selectFunc" selectable="true">
+                <a:fields>
+                    <a:field name="paper_required" checkedValue="Y" defaultValue="N" uncheckedValue="N"/>
+                    <a:field name="not_applicable" checkedValue="Y" defaultValue="N" uncheckedValue="N"/>
+                    <!-- <a:field name="paper_content_flag" checkedValue="Y" defaultValue="N" uncheckedValue="N"/> -->
+                    <a:field name="attachment_required" checkedValue="Y" defaultValue="N" uncheckedValue="N"/>
+                    <a:field name="sys_flag" defaultValue="N"/>
+                    <a:field name="document_id" defaultValue="${/parameter/@contract_id}"/>
+                    <a:field name="cdd_list_id" defaultValue="${/parameter/@cdd_list_id}"/>
+                    <a:field name="document_table" defaultValue="CON_CONTRACT"/>
+                    <a:field name="note"/>
+                </a:fields>
+            </a:dataSet>
+        </a:dataSets>
+        <a:screenBody>
+            <a:screenTopToolbar>
+                <a:gridButton click="con555_con_contract_back" text="HLS.BACK"/>
+                <a:gridButton click="con555_con_contract_save" text="归档完成"/>
+            </a:screenTopToolbar>
+            <a:form column="3" labelWidth="120" marginWidth="30" title="基础信息">
+                <a:textField name="contract_number" bindTarget="con555_detail_ds" prompt="合同编号"/>
+                <a:textField name="bp_id_tenant_desc" bindTarget="con555_detail_ds" prompt="承租人名称" width="200"/>
+                <a:datePicker name="creation_date" bindTarget="con555_detail_ds" prompt="归档完成日期"/>
+            </a:form>
+            <a:grid bindTarget="con555_detail_result_ds" height="400" marginWidth="20" navBar="true">
+                <a:toolBar>
+                    <a:button type="add"/>
+                    <a:button type="save"/>
+                    <a:button type="delete"/>
+                </a:toolBar>
+                <a:columns>
+                    <a:column name="description" editorFunction="con555_cdd_editorFunction" prompt="HLS.DOCUMENT_NAME" renderer="con555_cdd_required_render" width="250"/>
+                    <!--<a:column name="attachment_required" editor="con555_cdd_ck_id" prompt="HLS.DIGITAL_FILE" width="40"/>
+                    <a:column name="paper_required" editor="con555_cdd_ck_id" prompt="已提交" width="40"/>-->
+                    <a:column name="attachment" align="center" prompt="附件" renderer="con555_cdd_attachment_render" width="60"/>
+                    <a:column name="file_name" align="center" prompt="附件名" renderer="con555_link_render" width="450"/>
+                    <!-- <a:column name="paper_content_flag" align="center" editor="con555_cdd_ck_id" prompt="纸质是否归档" width="100"/> -->
+                    <a:column name="note" editor="con555_cdd_tf_id" prompt="HLS.COMMENT" width="450"/>
+                    <!--<a:column name="creation_date" prompt="附件上传时期" renderer="Leaf.formatDate" width="150"/>-->
+                </a:columns>
+                <a:editors>
+                    <a:checkBox id="con555_cdd_ck_id"/>
+                    <a:textField id="con555_cdd_tf_id"/>
+                </a:editors>
+            </a:grid>
+        </a:screenBody>
+    </a:view>
+</a:screen>
Index: src/main/resources/leaf_static/modules/acrch/ACRCH001/con_contract_content_query.lview
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/acrch/ACRCH001/con_contract_content_query.lview b/src/main/resources/leaf_static/modules/acrch/ACRCH001/con_contract_content_query.lview
new file mode 100644
--- /dev/null	(revision 586e0a3342bdf9c1f74a1427bf4719efccef1318)
+++ b/src/main/resources/leaf_static/modules/acrch/ACRCH001/con_contract_content_query.lview	(revision 586e0a3342bdf9c1f74a1427bf4719efccef1318)
@@ -0,0 +1,284 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!--
+    $Author: LR
+    $Date: 2013-8-13 上午10:30:25
+    $Revision: 1.0
+    $Purpose:
+-->
+<a:screen xmlns:a="http://www.leaf-framework.org/application" customizationEnabled="true">
+    <a:init-procedure>
+        <a:model-query defaultWhereClause="t1.document_category=&apos;CONTRACT&apos;" fetchAll="true" model="basic.hls_document_type_for_lov" rootPath="con555_document_type_path"/>
+        <a:model-query fetchAll="true" model="cont.CON555.con_contract_business_type_list" rootPath="con555_business_type_list"/>
+        <a:model-query defaultWhereClause="(exists(select 1 from hls_lease_org_assign ha where ha.unit_id=t1.unit_id))" fetchAll="true" model="basic.exp_org_unit_manager_lov" rootPath="con555_exp_org_unit_manager_path"/>
+    </a:init-procedure>
+    <a:view>
+        <!--<a:link id="con_contract_update_link_id" url="${/request/@context_path}/modules/cont/CON500/con_contract_update.lview"/>
+        <a:link id="con_contract_get_layout_code_link_id" model="cont.CON500.con_contract_get_layout_code" modelaction="update"/>-->
+        <a:link id="con_content_record_id" url="${/request/@context_path}/modules/cont/CON555/con_contract_content.lview"/>
+        <a:link id="con_contract_get_layout_code_link_id" model="cont.CON500.con_contract_get_layout_code" modelaction="update"/>
+        <a:link id="con_contract_update_link_id" url="${/request/@context_path}/modules/cont/CON301/con_contract_query_n.lview"/>
+        <a:link id="prj506_virtual_contract_query_link_id" url="${/request/@context_path}/modules/prj/PRJ506/virtual_contract_query.lview"/>
+        <a:link id="prj_project_modify_link" url="${/request/@context_path}/modules/prj/PRJ501N/prj_project_create_tree_n.lview"/>
+        <script><![CDATA[
+            function con555_con_contract_detail() {
+                var records = $('con555_contract_result_ds').getSelected();
+                if (records.length != 1) {
+                    return;
+                }
+                var param = records[0].data;
+                param['document_id'] = records[0].get('contract_id');
+                con555_param_set_value(param);
+            }
+
+            function con555_param_set_value(param) {
+                param['function_code'] = 'CON301';
+                param['function_usage'] = 'QUERY';
+                param['maintain_type'] = 'READONLY';
+                param['url_title'] = '${l:CON301.CONTRACT_DETAIL}';
+                hls_doc_get_layout_code('con_contract_get_layout_code_link_id', param, 'con_contract_update_link_id');
+            }
+
+        function prj506_grid_virtual_con(reocrd_id) {
+            var url_link_id;
+            var record = $('con555_contract_result_ds').findById(reocrd_id);
+            var param = record.data;
+
+                param['function_code'] = 'C0N301D_CON';
+                param['function_usage'] = 'QUERY';
+                param['maintain_type'] = 'READONLY';
+                url_link_id='prj506_virtual_contract_query_link_id';
+
+            //param['document_id'] = record.get('project_id');
+            param['cond_para2'] = record.get('hn_industry_classification');
+            param['url_title'] = '合同明细';
+            // param['layout_debugger_flag'] = 'Y';
+            param['winid'] = 'prj506_virtual_contract_modify_detail_link_id';
+            hls_doc_get_layout_code('con_contract_get_layout_code_link_id', param, url_link_id, 'con555_contract_result_ds');
+        }
+
+
+
+            function con555_render_contractMaintainDs_grid(value, record, name) {
+                if (name == 'contract_number') {
+                    return '<a href="javascript:prj506_grid_virtual_con(' + record.id + ');">' + value + '</a>';
+                }
+            }
+
+
+        function open_project_modify_win(record_id, ds_id) {
+            var record = $(ds_id).findById(record_id);
+            var maintain_type = 'READONLY';
+            var function_usage = 'QUERY';
+            var function_code = 'PRJ505';
+            var param = record.data;
+
+            param['document_id'] = record.get('ref_project_id');
+            param['function_code'] = function_code;
+            param['function_usage'] = function_usage;
+            param['maintain_type'] = maintain_type;
+            param['url_title'] = '${l:HLS.PROJECT_MAITAIN}';
+            //param['layout_debugger_flag']='Y';
+            param['cond_para2'] = record.get('hn_industry_classification');
+            param['cond_para3'] = record.get('binary_classification');
+            param['document_type'] = record.get('document_type');
+            param['wf_function_code'] = '${/parameter/@function_code}';
+            param['winid'] = 'prj501n_main_prj_link_winid';
+            hls_doc_get_layout_code('con_contract_get_layout_code_link_id', param, 'prj_project_modify_link', ds_id);
+        }
+
+
+        function acr001_render_projectMaintainDs_grid(value, record, name) {
+         if (name == 'project_number' && value) {
+                return '<a href="javascript:open_project_modify_win(\'' + record.id + '\',\'' + record.ds.id + '\')">' + value + '</a>';
+            }
+        }
+
+
+            function con555_con_contract_archive() {
+                if ($('con555_contract_result_ds').getCurrentRecord()) {
+                    var record = $('con555_contract_result_ds').getCurrentRecord();
+                    con555_contractMaintainDs_grid_update2(record.get('contract_id'), record.get('cdd_list_id'));
+                }
+            }
+
+            function con555_contractMaintainDs_grid_update2(contract_id, cdd_list_id) {
+                var url = $('con_content_record_id').getUrl();
+                var win = new Leaf.Window({
+                    id: 'con_contract_content_window',
+                    url: url,
+                    params: {
+                        contract_id: contract_id,
+                        cdd_list_id: cdd_list_id
+                    },
+                    title: '合同归档',
+                    fullScreen: true
+                });
+                win.on('close', function() {
+                    $('con555_contract_result_ds').query();
+                });
+            }
+
+
+
+
+
+            function con555_con_contract_query() {
+                //console.log($('con555_contract_query_ds').data[0].getMeta().getField('contract_status_desc'));
+                $('con555_contract_result_ds').query();
+            }
+
+            function con555_con_contract_reset() {
+                $('con555_contract_query_ds').reset();
+            }
+
+            function summaryRenderer(datas, name) {
+
+                var sum = 0;
+                var sum2 = 0;
+                for (var i = 0;i < datas.length;i++) {
+                    record = datas[i];
+                    if (name == "lease_item_amount") {
+                        var t_1 = record.get("lease_item_amount");
+                        var t_2 = parseFloat(t_1);
+                        if (!isNaN(t_2)) {
+                            sum += t_2;
+                        }
+                    }
+                    if (name == "down_payment") {
+                        var d_1 = record.get("down_payment");
+                        var d_2 = parseFloat(d_1);
+                        if (!isNaN(d_2)) {
+                            sum2 += d_2;
+                        }
+                    }
+                }
+                if (name == "bp_tenant_class_n") {
+                    return '<div align="right">合计:</div>';
+                }
+                if (name == "lease_item_amount") {
+                    return '<font color="red">' + Leaf.formatNumber(sum, 2) + '</font>';
+                }
+                if (name == "down_payment") {
+                    return '<font color="red">' + Leaf.formatNumber(sum2, 2) + '</font>';
+                }
+            }
+            /*
+             附件批量下载
+             */
+
+            function con555_batch_down() {
+                var rs = $('con555_contract_result_ds').getCurrentRecord();
+                var contract_id = rs.get('contract_id');
+                var contract_number = rs.get('contract_number');
+                var url = '${/request/@context_path}/modules/cont/CON555/lease_atm_batch_dl.lsc?table_name=CON_CONTRACT&table_pk_value=' + contract_id + '&doc_code=' + contract_number;
+                window.open(url);
+            }
+        ]]></script>
+        <!-- <a:screen-include screen="modules/cont/CON500/con_contract_authority_list_validate.lview?document_category=CONTRACT&amp;function_code=CON555"/> -->
+        <a:screen-include screen="modules/cont/CON500/con_contract_get_layout_code.lview"/>
+        <a:dataSets>
+            <a:dataSet id="con555_employee_name_of_manager_ds">
+                <a:datas dataSource="/model/con555_exp_org_unit_manager_path"/>
+            </a:dataSet>
+            <a:dataSet id="finish_flag_ds" lookupCode="FINISH_FLAG"/>
+            <a:dataSet id="con555_unit_name_ds" loadData="true" model="basic.exp_org_unit_name_lov"/>
+            <a:dataSet id="con555_lease_organization_name_ds" loadData="true" model="basic.hls_lease_organization_for_lov"/>
+            <a:dataSet id="con555_division_name_ds" loadData="true" model="basic.hls_division_for_lov"/>
+            <a:dataSet id="con555_lease_channel_name_ds" loadData="true" model="basic.hls_lease_channel_for_lov"/>
+            <a:dataSet id="con555_wfl_status_name_ds" lookupCode="CON500_WFL_STATUS"/>
+            <a:dataSet id="con555_contract_status_name_ds" lookupCode="CON500_CONTRACT_STATUS"/>
+            <a:dataSet id="con555_companies_ds" loadData="true" model="fnd.fnd_companies"/>
+            <a:dataSet id="con555_document_type_name_ds">
+                <a:datas dataSource="/model/con555_document_type_path"/>
+            </a:dataSet>
+            <a:dataSet id="con555_business_type_ds">
+                <a:datas dataSource="/model/con555_business_type_list"/>
+            </a:dataSet>
+            <a:dataSet id="con555_contract_query_ds" autoCreate="true">
+                <a:fields>
+                    <a:field name="bp_name" autoComplete="true" lovGridHeight="350" lovHeight="500" lovLabelWidth="100" lovService="cont.CON555.hls_bp_master_v_for_lov?bp_category=TENANT" lovWidth="520" title="HLS.BP_TITLE">
+                        <a:mapping>
+                            <a:map from="bp_name" to="bp_name"/>
+                            <a:map from="bp_id" to="bp_id_tenant"/>
+                        </a:mapping>
+                    </a:field>
+                    <a:field name="bp_id_tenant"/>
+                    <!--<a:field name="contract_number" autoComplete="true" lovGridHeight="300" lovHeight="450" lovService="cont.CON531.con_contract_lov" lovWidth="500" title="HLS.CONTRACT_NUMBER">
+                        <a:mapping>
+                            <a:map from="contract_number" to="contract_number"/>
+                            <a:map from="contract_id" to="contract_id"/>
+                        </a:mapping>
+                    </a:field>-->
+                    <a:field name="contract_number" typeCase="Upper"/>
+                    <a:field name="lease_channel_desc" displayField="description" options="con555_lease_channel_name_ds" returnField="lease_channel" valueField="lease_channel"/>
+                    <!--<a:field name="project_number" autoComplete="true" lovGridHeight="300" lovHeight="450" lovService="prj.PRJ501.prj_project_for_lov" lovWidth="500" title="HLS.PROJECT_NUMBER">
+                        <a:mapping>
+                            <a:map from="project_number" to="project_number"/>
+                            <a:map from="project_id" to="project_id"/>
+                        </a:mapping>
+                    </a:field>-->
+                    <a:field name="project_number" typeCase="Upper"/>
+                    <a:field name="business_type_desc" displayField="business_type_desc" options="con555_business_type_ds" returnField="business_type" valueField="business_type"/>
+                    <a:field name="lease_organization_name" displayField="description" options="con555_lease_organization_name_ds" returnField="lease_organization" valueField="lease_organization"/>
+                    <a:field name="contract_wfl_status_desc" displayField="code_value_name" options="con555_wfl_status_name_ds" returnField="user_status_1" valueField="code_value"/>
+                    <a:field name="contract_status_desc" displayField="code_value_name" options="con555_contract_status_name_ds" returnField="contract_status" valueField="code_value"/>
+                    <a:field name="bp_id_agent_level1_n" autoComplete="true" lovGridHeight="350" lovHeight="500" lovLabelWidth="100" lovService="cont.CON555.hls_bp_master_v_for_lov?bp_category=AGENT" lovWidth="520" title="HLS.BP_TITLE">
+                        <a:mapping>
+                            <a:map from="bp_name" to="bp_id_agent_level1_n"/>
+                            <a:map from="bp_id" to="bp_id_agent_level1"/>
+                        </a:mapping>
+                    </a:field>
+                    <a:field name="finish_flag"/>
+                    <a:field name="finish_flag_desc" displayField="code_value_name" options="finish_flag_ds" returnField="finish_flag" valueField="code_value"/>
+                </a:fields>
+            </a:dataSet>
+            <a:dataSet id="con555_contract_result_ds" autoQuery="true" model="acrch.ACRCH001.con_contract_for_query" pageSize="13" queryDataSet="con555_contract_query_ds" queryUrl="${/request/@context_path}/autocrud/acrch.ACRCH001.con_contract_for_query/query" selectable="true" selectionModel="single">
+                <a:fields>
+                    <a:field name="finish_flag"/>
+                    <a:field name="finish_flag_desc" displayField="code_value_name" options="finish_flag_ds" returnField="finish_flag" valueField="code_value"/>
+                </a:fields>
+                <!--  <a:events>
+                    <a:event name="query" handler="aut_authority_list_validate_query"/>
+                </a:events> -->
+            </a:dataSet>
+        </a:dataSets>
+        <a:screenBody>
+            <a:screenTopToolbar>
+                <a:screenTitle/>
+                <a:gridButton click="con555_con_contract_query" text="HLS.QUERY"/>
+                <a:gridButton click="con555_con_contract_reset" text="HLS.RESET"/>
+                <a:gridButton click="con555_con_contract_archive" text="归档"/>
+                <!-- <a:gridButton click="con555_batch_down" text="一键下载"/> -->
+                <!--<a:gridButton click="con555_con_contract_detail" text="CON301.CONTRACT_DETAIL"/>-->
+            </a:screenTopToolbar>
+            <a:form column="4" labelWidth="100" marginWidth="30" title="CON301.CONTRACT_QUERY">
+                <a:textField name="contract_number" bindTarget="con555_contract_query_ds" prompt="HLS.CONTRACT_NUMBER"/>
+                <!-- <a:lov name="bp_name" bindTarget="con555_contract_query_ds" prompt="HLS.TENANT_CODE"/> -->
+                <a:numberField name="lease_item_amount_from" bindTarget="con555_contract_query_ds" prompt="租赁物总价从"/>
+                <a:numberField name="lease_item_amount_to" bindTarget="con555_contract_query_ds" prompt="租赁物总价到"/>
+                <a:comboBox name="lease_channel_desc" bindTarget="con555_contract_query_ds" prompt="HLS.LEASE_CHANNEL_NAME"/>
+                <!-- <a:textField name="project_number" bindTarget="con555_contract_query_ds" prompt="申请编号"/> -->
+                <a:comboBox name="lease_organization_name" bindTarget="con555_contract_query_ds" prompt="事业部"/>
+                <!-- <a:lov name="bp_id_agent_level1_n" bindTarget="con555_contract_query_ds" prompt="经销商"/> -->
+                <a:comboBox name="finish_flag_desc" bindTarget="con555_contract_query_ds" prompt="是否归档完成"/>
+                <a:datePicker name="contract_file_date" bindTarget="con555_contract_query_ds" prompt="归档完成日期"/>
+                <a:comboBox name="contract_status_desc" bindTarget="con555_contract_query_ds" prompt="合同状态"/>
+            </a:form>
+            <a:grid id="con555_con_contract_grid_ds" bindTarget="con555_contract_result_ds" marginHeight="200" marginWidth="30" navBar="true">
+                <a:columns>
+                    <a:column name="project_number" prompt="项目编号" renderer="acr001_render_projectMaintainDs_grid"  width="120"/>
+                    <a:column name="project_name" prompt="项目名称"  width="350"/>
+                    <a:column name="contract_number"  prompt="合同编号" renderer="con555_render_contractMaintainDs_grid"  width="120"/>
+                    <a:column name="contract_name" prompt="合同名称"  width="350"/>
+
+                     <a:column name="bp_name" prompt="承租人名称"  width="200"/>
+                     <a:column name="employee_name" align="center" prompt="业务经理"  width="100"/>
+                    <a:column name="lease_organization_desc" align="center" prompt="业务部"  width="100"/>
+
+                    <a:column name="content_wfl_status_n" align="center"  prompt="合同文本审批状态"  width="100"/>
+
+                </a:columns>
+            </a:grid>
+        </a:screenBody>
+    </a:view>
+</a:screen>
Index: src/main/resources/leaf_static/modules/acrch/ACRCH001/lease_atm_batch_dl.lsc
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/acrch/ACRCH001/lease_atm_batch_dl.lsc b/src/main/resources/leaf_static/modules/acrch/ACRCH001/lease_atm_batch_dl.lsc
new file mode 100644
--- /dev/null	(revision 586e0a3342bdf9c1f74a1427bf4719efccef1318)
+++ b/src/main/resources/leaf_static/modules/acrch/ACRCH001/lease_atm_batch_dl.lsc	(revision 586e0a3342bdf9c1f74a1427bf4719efccef1318)
@@ -0,0 +1,59 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<a:service xmlns:s="leaf.plugin.script" xmlns:a="http://www.leaf-framework.org/application" trace="true">
+    <a:init-procedure>
+        <s:server-script><![CDATA[
+        	//importPackage(java.util.zip);
+            importPackage(java.io);
+            importPackage(org.apache.tools.zip); /*可以传入参数*/
+
+            function writeFile(zos, fn, fp) {
+                var ze = new ZipEntry(fn);
+                zos.putNextEntry(ze);
+                var fis = new FileInputStream(fp);
+                var b = new java.lang.reflect.Array.newInstance(java.lang.Byte.TYPE, 1024 * 64);
+                var len = -1;
+                while ((len = fis.read(b)) != -1) {
+                    zos.write(b, 0, len);
+                }
+                fis.close();
+            }
+
+            function getdate() {
+                var now = new Date()
+                y = now.getFullYear()
+                m = now.getMonth() + 1
+                d = now.getDate()
+                m = m < 10 ? "0" + m : m
+                d = d < 10 ? "0" + d : d
+                return y + "" + m + "" + d
+            }
+            $ctx["__request_type__"] = 'file'; //to indicate this request is not a JSON_REQUEST
+            var resp = $ctx['_instance.javax.servlet.http.HttpServletResponse'];
+            resp.setHeader("Pragma", "No-cache");
+            resp.setHeader("Cache-Control", "no-cache, must-revalidate");
+            var date_str = getdate();
+            var doc_code = $ctx.parameter.doc_code;
+            var filename = doc_code + '-' + date_str + ".zip"
+            resp.setHeader("Content-disposition", "attachment; filename=" + filename);
+            resp.setDateHeader("Expires", 0);
+            resp.setContentType("application/x-msdownload");
+            var zos = new ZipOutputStream(resp.getOutputStream());
+			zos.setEncoding("GBK"); //如果是org.apache.tools.zip需要追加字符集
+            try {
+                var attachment_batch_dl = $bm('cont.CON555.lease_atm_batch_dl');
+                var result = attachment_batch_dl.queryAsMap();
+                var arr = result.getChildren();
+                for (var i = 0;i < arr.length;i++) {
+                    var f = arr[i];
+                    if (f.file_path) {
+                        writeFile(zos, f.file_name, f.file_path);
+                    }
+                }
+            } catch (e) {
+                var logger = $logger("server-script");
+                logger.severe(e.message)
+            }
+            zos.close();
+        ]]></s:server-script>
+    </a:init-procedure>
+</a:service>
Index: src/main/resources/leaf_static/modules/acrch/ARCHIVE002/archive_create.lview
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/acrch/ARCHIVE002/archive_create.lview b/src/main/resources/leaf_static/modules/acrch/ARCHIVE002/archive_create.lview
new file mode 100644
--- /dev/null	(revision 586e0a3342bdf9c1f74a1427bf4719efccef1318)
+++ b/src/main/resources/leaf_static/modules/acrch/ARCHIVE002/archive_create.lview	(revision 586e0a3342bdf9c1f74a1427bf4719efccef1318)
@@ -0,0 +1,146 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!--
+    $Author: zhangxing5129
+    $Date: 2014-8-4 下午01:58:31
+    $Revision: 1.0
+    $Purpose: 商业伙伴维护入口界面
+-->
+<a:screen xmlns:a="http://www.leaf-framework.org/application" customizationEnabled="true" dynamiccreateenabled="true" trace="true">
+    <a:init-procedure>
+
+    </a:init-procedure>
+    <a:view>
+        <a:link id="con_contract_get_layout_code_link_id2" model="cont.CON500.con_contract_get_layout_code" modelaction="update"/>
+        <a:link id="prj_archive_file_link100" url="${/request/@context_path}/modules/acrch/ARCHIVE002/con_contract_file_archive.lview"/>
+        <a:link id="archive_create_link_id" model="acrch.ARCHIVE002.file_archive_batch" modelaction="execute"/>
+        <script><![CDATA[
+
+        //关闭按钮
+        window['${/parameter/@layout_code}_user_button1_layout_dynamic_click'] = function() {
+            $('${/parameter/@ds_id}').query();
+            $('${/parameter/@winid}').close();
+        };
+
+        //保存按钮
+        window['${/parameter/@layout_code}_user_button2_layout_dynamic_click'] = function() {
+            var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'file_archive_batch');
+            if($(ds_id).validate()){
+                var record=$(ds_id).getCurrentRecord();
+                window['${/parameter/@layout_code}_lock_layout_dynamic_window']();
+                Leaf.request({
+                    url: $('archive_create_link_id').getUrl(),
+                    para: {
+                        plan_id: record.get('plan_id'),
+                        project_id: record.get('project_id'),
+                        project_type:record.get('project_type'),
+                        class_type:record.get('class_type'),
+                        contract_id:record.get('contract_id'),
+                        bp_id_tenant:record.get('bp_id_tenant'),
+                        employee_id:record.get('employee_id'),
+                        lease_organization:record.get('lease_organization'),
+                        unit_id: record.get('unit_id')
+                    },
+                    success: function (res) {
+                        window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
+                        var archive_batch_id=res.result.archive_batch_id;
+                        var project_id = record.get('project_id');
+                        var param = record.data;
+                        param['function_code'] = 'ARCHIVE002_D';
+                        param['project_id'] = project_id;
+                        param['archive_batch_id'] = archive_batch_id;
+                        param['url_title'] = '档案归档明细页面';
+                        param['winid'] = 'archive_create_win';
+                        param['ds_id'] = ds_id;
+                        hls_doc_get_layout_code('con_contract_get_layout_code_link_id2', param, 'prj_archive_file_link100', ds_id);
+                        $('${/parameter/@winid}').close();
+                    },
+                    failure: function () {
+                        window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
+                    },
+                    error: function () {
+                        window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
+                    },
+                    scope: this
+                });
+            }
+        };
+
+        //更新事件
+        window['${/parameter/@bp_seq}${/parameter/@layout_code}_on_layout_dynamic_update'] = function(ds, record, name, value, old_value, bp_seq) {
+            var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'file_archive_batch');
+
+            if (ds.id == ds_id) {
+                if (name == 'project_type') {
+                    if(value=='PRJ_PLAN'||value=='PRJ_PLAN_UPDATE'){
+                        record.getField('plan_id').setReadOnly(false);
+                        record.getField('plan_id').setRequired(true);
+                        record.getField('plan_id_n').setReadOnly(false);
+                        record.getField('plan_id_n').setRequired(true);
+
+                        record.set('plan_id',null);
+                        record.set('plan_id_n',null);
+                        record.set('plan_name',null);
+                        record.getField('project_id').setReadOnly(true);
+                        record.getField('project_id').setRequired(false);
+                        record.getField('project_id_n').setReadOnly(true);
+                        record.getField('project_id_n').setRequired(false);
+                        record.set('contract_id',null);
+                        record.set('contract_id_n',null);
+                        record.set('contract_name',null);
+                        record.getField('contract_id').setReadOnly(true);
+                        record.getField('contract_id').setRequired(false);
+                        record.getField('contract_id_n').setReadOnly(true);
+                        record.getField('contract_id_n').setRequired(false);
+                    }else if(value=='PRJ_PAYMENT'||value=='PRJ_AFTER'||value=='PRJ_BEFORE'){//付款先决条件落实，租前租后
+                        record.getField('project_id').setReadOnly(false);
+                        record.getField('project_id').setRequired(true);
+                        record.getField('project_id_n').setReadOnly(false);
+                        record.getField('project_id_n').setRequired(true);
+
+                        record.set('contract_id',null);
+                        record.set('contract_id_n',null);
+                        record.set('contract_name',null);
+                        record.getField('contract_id').setReadOnly(true);
+                        record.getField('contract_id').setRequired(false);
+                        record.getField('contract_id_n').setReadOnly(true);
+                        record.getField('contract_id_n').setRequired(false);
+                        record.set('plan_id',null);
+                        record.set('plan_id_n',null);
+                        record.set('plan_name',null);
+                        record.getField('plan_id').setReadOnly(true);
+                        record.getField('plan_id').setRequired(false);
+                        record.getField('plan_id_n').setReadOnly(true);
+                        record.getField('plan_id_n').setRequired(false);
+                    }else if(value=='PRJ_SIGN'){//合同签约
+                        record.getField('contract_id').setReadOnly(false);
+                        record.getField('contract_id').setRequired(true);
+                        record.getField('contract_id_n').setReadOnly(false);
+                        record.getField('contract_id_n').setRequired(true);
+
+                        record.set('plan_id',null);
+                        record.set('plan_id_n',null);
+                        record.set('plan_name',null);
+                        record.getField('plan_id').setReadOnly(true);
+                        record.getField('plan_id').setRequired(false);
+                        record.getField('plan_id_n').setReadOnly(true);
+                        record.getField('plan_id_n').setRequired(false);
+                        record.set('plan_id',null);
+                        record.set('plan_id_n',null);
+                        record.set('plan_name',null);
+                        record.getField('project_id').setReadOnly(true);
+                        record.getField('project_id').setRequired(false);
+                        record.getField('project_id_n').setReadOnly(true);
+                        record.getField('project_id_n').setRequired(false);
+                    }
+                    record.set('bp_name',null);
+                    record.set('employe_name',null);
+                    record.set('lease_organization',null);
+                    record.set('lease_organization_n',null);
+                }
+            }
+        };
+
+        ]]></script>
+        <a:screen-include screen="modules/cont/CON500/con_contract_get_layout_code.lview"/>
+    </a:view>
+</a:screen>
Index: src/main/resources/leaf_static/modules/acrch/ARCHIVE002/archive_virtual_con_entrance.lview
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/acrch/ARCHIVE002/archive_virtual_con_entrance.lview b/src/main/resources/leaf_static/modules/acrch/ARCHIVE002/archive_virtual_con_entrance.lview
new file mode 100644
--- /dev/null	(revision 33faca6317f7cfd928f5c69aff3882add32116e6)
+++ b/src/main/resources/leaf_static/modules/acrch/ARCHIVE002/archive_virtual_con_entrance.lview	(revision 33faca6317f7cfd928f5c69aff3882add32116e6)
@@ -0,0 +1,138 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!--
+    $Author: zc
+    $Date: 2021年6月29日 10点18分
+    $Revision: 1.0
+    $Purpose: 档案归档入口界面
+-->
+<a:screen xmlns:a="http://www.leaf-framework.org/application" customizationEnabled="true" dynamiccreateenabled="true" trace="true">
+    <a:init-procedure>
+        <a:model-query defaultWhereClause="t1.function_code = &apos;HLS214N&apos;" model="fnd.FND6000.bgfl_common_template_query" rootPath="template_path"/>
+    </a:init-procedure>
+    <a:view>
+        <a:link id="con_contract_get_layout_code_link_id" model="cont.CON500.con_contract_get_layout_code" modelaction="update"/>
+        <a:link id="prj506_virtual_contract_query_link_id" url="${/request/@context_path}/modules/prj/PRJ506/virtual_contract_query.lview"/>
+        <a:link id="prj_project_modify_link2" url="${/request/@context_path}/modules/prj/PRJ501N/prj_project_create_tree_n.lview"/>
+        <a:link id="prj_archive_file_link" url="${/request/@context_path}/modules/acrch/ARCHIVE002/con_contract_file_archive.lview"/>
+        <a:link id="acrchive_create_link_id" url="${/request/@context_path}/modules/acrch/ARCHIVE002/archive_create.lview"/>
+        <a:link id="prj_archive_file_link3" url="${/request/@context_path}/modules/acrch/ARCHIVE002/con_contract_file_archive.lview"/>
+
+        <script><![CDATA[
+        function open_project_modify_win(ds_id,record_id) {
+            var record = $(ds_id).findById(record_id);
+            var maintain_type = 'READONLY';
+            var function_usage = 'QUERY';
+            var function_code = 'PRJ505';
+            var param = record.data;
+
+            param['document_id'] = record.get('ref_project_id');
+            param['function_code'] = function_code;
+            param['function_usage'] = function_usage;
+            param['maintain_type'] = maintain_type;
+            param['url_title'] = '${l:HLS.PROJECT_MAITAIN}';
+            param['cond_para2'] = record.get('hn_industry_classification');
+            param['cond_para3'] = record.get('binary_classification');
+            param['document_type'] = record.get('document_type');
+            param['wf_function_code'] = '${/parameter/@function_code}';
+            param['winid'] = 'prj501n_main_prj_link_winid';
+            hls_doc_get_layout_code('con_contract_get_layout_code_link_id', param, 'prj_project_modify_link2', ds_id);
+        }
+
+        function prj506_grid_virtual_con(ds_id,reocrd_id) {
+            var url_link_id;
+            var record = $(ds_id).findById(reocrd_id);
+            var param = record.data;
+
+            param['function_code'] = 'C0N301D_CON';
+            param['function_usage'] = 'QUERY';
+            param['maintain_type'] = 'READONLY';
+            url_link_id='prj506_virtual_contract_query_link_id';
+
+            //param['document_id'] = record.get('project_id');
+            param['cond_para2'] = record.get('hn_industry_classification');
+            param['url_title'] = '合同明细';
+            // param['layout_debugger_flag'] = 'Y';
+            param['winid'] = 'prj506_virtual_contract_modify_detail_link_id';
+            hls_doc_get_layout_code('con_contract_get_layout_code_link_id', param, url_link_id, ds_id);
+        }
+
+        window['${/parameter/@layout_code}_dynamic_link_renderer'] = function(value, record, name, config_record) {
+            if (name == 'project_number') {
+                return '<a href="javascript:open_project_modify_win(\'' + record.ds.id + '\',\'' + record.id + '\')">' + value + '</a>';
+            }
+            else if (name == 'contract_number') {
+                return '<a href="javascript:prj506_grid_virtual_con(\'' + record.ds.id + '\',\'' + record.id + '\')">' + value + '</a>';
+            }
+            else if(name=='archive_number'){
+                return '<a href="javascript:open_archive_window(\'' + record.ds.id + '\',\'' + record.id + '\')">' + value + '</a>';
+            }
+            return value;
+        };
+
+        function open_archive_window(ds_id,reocrd_id) {
+            debugger;
+            var url_link_id;
+            var record = $(ds_id).findById(reocrd_id);
+            var wfl_status=record.get('wfl_status');
+            var param = record.data;
+            if (wfl_status=='NEW'||wfl_status=='REJECT'){
+                param['function_code'] = 'ARCHIVE002_D';
+                param['function_usage'] = 'UPDATE';
+            }
+            else{
+                param['function_code'] = 'ARCHIVE002_R';
+                param['function_usage'] = 'QUERY';
+            }
+
+//            param['function_usage'] = 'QUERY';
+//            param['maintain_type'] = 'READONLY';
+            url_link_id='prj_archive_file_link3';
+            param['url_title'] = '归档明细';
+            // param['layout_debugger_flag'] = 'Y';
+            param['winid'] = 'prj_archive_file_detail_link_id';
+            param['ds_id'] =ds_id;
+            hls_doc_get_layout_code('con_contract_get_layout_code_link_id', param, url_link_id, ds_id);
+        }
+
+        //档案归档
+        window['${/parameter/@layout_code}_user_button1_layout_dynamic_click'] = function() {
+            var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_project');
+            var records = $(ds_id).getSelected();
+            var record = records[0];
+            var project_id = record.get('project_id');
+            var param = record.data;
+            param['function_code'] = 'ARCHIVE002_D';
+            param['project_id'] = project_id;
+            param['url_title'] = '档案归档明细页面';
+            // param['winid'] = 'con_content_detail_win';
+            hls_doc_get_layout_code('con_contract_get_layout_code_link_id', param, 'prj_archive_file_link', ds_id);
+        };
+
+        //新增按钮
+        window['${/parameter/@layout_code}_user_button2_layout_dynamic_click'] = function() {
+            project_contract_add();
+        };
+
+        function project_contract_add(){
+            var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'file_archive_batch');
+            var param = {};
+            param['function_usage'] = 'UPDATE';
+            param['function_code'] = 'ARCHIVE002_C';
+            param['url_title'] = '档案归档申请创建';
+            param['winid'] = 'acrchive_create_win_id';
+            param['ds_id'] = ds_id;
+            param['screen_width'] = 1145;
+            param['screen_height'] = 360;
+            hls_doc_get_layout_code('con_contract_get_layout_code_link_id', param, 'acrchive_create_link_id', ds_id);
+        }
+
+        window['${/parameter/@layout_code}_on_layout_dynamic_grid_query'] = function(ds, qpara, bp_seq) {
+            // var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_project');
+            // if (ds == $(ds_id)) {
+            //     aut_authority_list_validate_query(ds, qpara);
+            // }
+        };
+        ]]></script>
+        <a:screen-include screen="modules/cont/CON500/con_contract_get_layout_code.lview"/>
+    </a:view>
+</a:screen>
Index: src/main/resources/leaf_static/modules/acrch/ARCHIVE002/con_contract_file_archive.lsc
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/acrch/ARCHIVE002/con_contract_file_archive.lsc b/src/main/resources/leaf_static/modules/acrch/ARCHIVE002/con_contract_file_archive.lsc
new file mode 100644
--- /dev/null	(revision 586e0a3342bdf9c1f74a1427bf4719efccef1318)
+++ b/src/main/resources/leaf_static/modules/acrch/ARCHIVE002/con_contract_file_archive.lsc	(revision 586e0a3342bdf9c1f74a1427bf4719efccef1318)
@@ -0,0 +1,12 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<a:service xmlns:a="http://www.leaf-framework.org/application" xmlns:p="uncertain.proc" trace="true">
+    <a:init-procedure>
+        <a:batch-apply sourcepath="/parameter/details">
+            <a:model-delete model="acrch.ARCHIVE002.con_contract_file_archive"/>
+        </a:batch-apply>
+        <a:model-execute model="acrch.ARCHIVE002.con_contract_file_archive"/>
+    </a:init-procedure>
+    <a:service-output output="/parameter"/>
+</a:service>
+
+
Index: src/main/resources/leaf_static/modules/acrch/ARCHIVE002/con_contract_file_archive.lview
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/acrch/ARCHIVE002/con_contract_file_archive.lview b/src/main/resources/leaf_static/modules/acrch/ARCHIVE002/con_contract_file_archive.lview
new file mode 100644
--- /dev/null	(revision 3b91a98aeb86b0598dc3905b460956ce39825391)
+++ b/src/main/resources/leaf_static/modules/acrch/ARCHIVE002/con_contract_file_archive.lview	(revision 3b91a98aeb86b0598dc3905b460956ce39825391)
@@ -0,0 +1,178 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!--
+    $Author:  Yimeng
+    $Date: 2014-11-27 下午01:58:31
+    $Revision: 1.0
+    $Purpose:
+-->
+<a:screen xmlns:a="http://www.leaf-framework.org/application" customizationEnabled="true" dynamiccreateenabled="true" trace="true">
+<!--    <a:init-procedure>
+        <a:model-query defaultWhereClause="t1.specify_code=&apos;PROJECT_DOC_APPROVER&apos;" model="cont.CON543.lsh_hls_specify_define" rootPath="hls_specify_define_info"/>
+        &lt;!&ndash; <a:model-query model="cont.CON543.prj_project" rootPath="prj_project" /> &ndash;&gt;
+        &lt;!&ndash; <a:model-query defaultWhereClause="" model="cont.CON543.con_contract_for_query" rootPath="" /> &ndash;&gt;
+    </a:init-procedure>-->
+    <a:view>
+        <a:link id="arch002_cdd_uploadFile_id" url="${/request/@context_path}/uploadFile.lview"/>
+        <a:link id="arch002_cdd_downloadFile_id" url="${/request/@context_path}/downloadFile.lview"/>
+        <a:link id="arch002_save_id" model="acrch.ARCHIVE002.file_archive_batch" modelaction="update"/>
+        <a:link id="arch002_delete_id" url="${/request/@context_path}/modules/acrch/ARCHIVE002/con_contract_file_archive.lsc"/>
+        <script><![CDATA[
+        window['${/parameter/@layout_code}_dynamic_link_renderer'] = function(value, record, name, config_record) {
+            if (name == 'attach_file_name') {
+                if (value != null) {
+                    var link = '${/request/@context_path}/atm_download.lsc?attachment_id=';
+                    var str = value.split(';;');
+                    var url = '';
+                    for (var i = 0;i < str.length;i++) {
+                        var temp = str[i].split('--');
+                        if (!Leaf.isEmpty(temp[0])) {
+                            url = url + '<a href=' + link + temp[1] + '>' + temp[0] + '</a>' + ',';
+                        }
+                    }
+                    return url;
+                }
+            } else if (name == 'attachment') {
+                link_function = 'upload_file';
+                return '<a href="javascript:window[\'' + link_function + '\'](\'' + record.id + '\',\'' + name + '\',\'' + config_record.get('query_only') + '\');">' + '附件' + '</a>';
+            }
+        };
+
+        function unlock_tree_window() {
+            window['${/parameter/@bp_seq}${/parameter/@layout_code}_unlock_layout_dynamic_window']();
+        }
+
+        function lock_tree_window() {
+            window['${/parameter/@bp_seq}${/parameter/@layout_code}_lock_layout_dynamic_window']();
+        }
+
+        function upload_file(id, name, query_only) {
+            var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'con_file_archive_attachment');
+            var record = $(ds_id).findById(id);
+            if (record.get('archive_attachment_id')) {
+                var url;
+                if (query_only == 'Y') {
+                    url = $('arch002_cdd_downloadFile_id').getUrl() + '?table_name=CON_FILE_ARCHIVE_ATTACHMENT&header_id=' + record.get('archive_attachment_id');
+                } else {
+                    url = $('arch002_cdd_uploadFile_id').getUrl() + '?table_name=CON_FILE_ARCHIVE_ATTACHMENT&header_id=' + record.get('archive_attachment_id');
+                }
+                var win = new Leaf.Window({
+                    url: url,
+                    title: '${l:HLS.SUPPORTING_DOCUMENT}',
+                    id: 'arch002_cdd_uploadFile_screen_id',
+                    width: 850,
+                    height: 400
+                });
+
+                win.on('close', function() {
+                    record.ds.query();
+                });
+            } else {
+                Leaf.showMessage('${l:HLS.PROMPT}', '请先保存!');
+            }
+        }
+
+        //新增时调用(grid,table,gridBox)
+        window['${/parameter/@bp_seq}${/parameter/@layout_code}_on_layout_dynamic_grid_add'] = function(ds, record, config_records, bp_seq) {
+            var prj_ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'con_file_archive_attachment');
+            if (prj_ds_id == ds.id) {
+                record.set('file_seq', ds.currentIndex);
+                if(record.isNew){
+                    record.set('project_id','${/parameter/@project_id}');
+                    record.set('archive_batch_id','${/parameter/@archive_batch_id}');
+                    record.set('archive_status','NEW');
+                    record.set('archive_status_n','新建');
+                    record.set('important_paper_file_flag','Y');
+                    record.set('important_paper_file_flag_n','是');
+                }
+            }
+        };
+
+
+        //删除
+        window['${/parameter/@layout_code}_G_ARCHIVE_FILE_USER_BUTTON1_layout_dynamic_tab_click'] = function() {
+            var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'con_file_archive_attachment');
+            var records = $(ds_id).getSelected();
+            if (records.length < 1) {
+                Leaf.showErrorMessage('错误', '至少选择一条数据进行操作！');
+            }
+            window['${/parameter/@bp_seq}${/parameter/@layout_code}_lock_layout_dynamic_window']();
+            var param = new Object();
+            var datas = [];
+            for (var i = 0;i < records.length;i++) {
+                if(records[i].get('archive_attachment_id')){
+                    var data = records[i].data;
+                    data['_status'] = 'delete';
+                    datas.push(data);
+                }
+            }
+            param['details'] = datas;
+            param['archive_batch_id'] = '${/parameter/@archive_batch_id}';
+            Leaf.request({
+                url: $('arch002_delete_id').getUrl(),
+                para: param,
+                success: function() {
+                    $(ds_id).query();
+                    window['${/parameter/@bp_seq}${/parameter/@layout_code}_unlock_layout_dynamic_window']();
+                },
+                failure: function() {
+                    window['${/parameter/@bp_seq}${/parameter/@layout_code}_unlock_layout_dynamic_window']();
+                },
+                error: function() {
+                    window['${/parameter/@bp_seq}${/parameter/@layout_code}_unlock_layout_dynamic_window']();
+                },
+                scope: this
+            });
+
+        };
+
+        //保存submitsuccess调用
+        window['${/parameter/@layout_code}_on_layout_dynamic_submitsuccess'] = function(ds, record, res, bp_seq) {
+            var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'con_file_archive_attachment');
+            unlock_tree_window();
+            $(ds_id).query();
+        };
+
+        //提交审批
+        window['${/parameter/@layout_code}_submit_approval_layout_dynamic_click'] = function() {
+            var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'con_file_archive_attachment');
+            //更新归档数据  ps:生成归档编号
+            var records = $(ds_id).getAll();
+            for(var i=0;i<records.length;i++){
+                if (records[i].dirty) {
+                    Leaf.showMessage('${l:HLS.PROMPT}', '${l:HLS.EXECUTE_AFTER_SAVE}');
+                    return;
+                }
+            }
+            if($(ds_id).validate()){
+                Leaf.showConfirm('提示', '确定手工提交档案归档？', function() {
+                    lock_tree_window();
+                    Leaf.request({
+                        url: $('arch002_save_id').getUrl(),
+                        para: {
+                            archive_batch_id:'${/parameter/@archive_batch_id}'
+                        },
+                        success: function() {
+                            Leaf.SideBar.show({
+                                msg: '保存成功',
+                                duration: 3000
+                            });
+                            unlock_tree_window();
+                            $('${/parameter/@winid}').close();
+                            //$('${/parameter/@ds_id}').query();
+                            //$('prj_archive_file_detail_link_id').close();
+                        },
+                        failure: function() {
+                            unlock_tree_window();
+                        },
+                        error: function() {
+                            unlock_tree_window();
+                        },
+                        scope: this
+                    });
+                });
+            }
+        };
+        ]]></script>
+        <a:screen-include screen="modules/cont/CON500/con_contract_get_layout_code.lview"/>
+    </a:view>
+</a:screen>
Index: src/main/resources/leaf_static/modules/acrch/ARCHIVE002/con_contract_file_archive_wfl.lview
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/acrch/ARCHIVE002/con_contract_file_archive_wfl.lview b/src/main/resources/leaf_static/modules/acrch/ARCHIVE002/con_contract_file_archive_wfl.lview
new file mode 100644
--- /dev/null	(revision 19ba0fe0497ec4ae76fbf597fe16898e305da648)
+++ b/src/main/resources/leaf_static/modules/acrch/ARCHIVE002/con_contract_file_archive_wfl.lview	(revision 19ba0fe0497ec4ae76fbf597fe16898e305da648)
@@ -0,0 +1,181 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!--
+    $Author:  Yimeng
+    $Date: 2014-11-27 下午01:58:31
+    $Revision: 1.0
+    $Purpose:
+-->
+<a:screen xmlns:a="http://www.leaf-framework.org/application" customizationEnabled="true" dynamiccreateenabled="true" trace="true">
+    <a:init-procedure>
+        <a:model-query defaultWhereClause="t1.archive_batch_id=${/parameter/@archive_batch_id}" model="acrch.ARCHIVE002.arch002_project_info" rootPath="project_path"/>
+    </a:init-procedure>
+    <a:view>
+        <a:link id="con_contract_get_layout_code_link_id" model="cont.CON500.con_contract_get_layout_code" modelaction="update"/>
+        <a:link id="arch002_cdd_uploadFile_id" url="${/request/@context_path}/uploadFile.lview"/>
+        <a:link id="arch002_cdd_downloadFile_id" url="${/request/@context_path}/downloadFile.lview"/>
+        <a:link id="arch002_save_id" model="acrch.ARCHIVE002.file_archive_batch" modelaction="update"/>
+        <a:link id="prj506_virtual_contract_query_link_id" url="${/request/@context_path}/modules/prj/PRJ506/virtual_contract_query.lview"/>
+        <a:link id="arch002_prj_project_link_id" url="${/request/@context_path}/modules/prj/PRJ501N/prj_project_create_tree_n.lview"/>
+        <div style="display:flex;">
+            <span style="font-size:20px;margin-left:10px;margin-top:1px;font-weight:bold;float:right;color:red;">提示：请注意确认纸质文件和线上文件是否一致！</span>
+        </div>
+        <script><![CDATA[
+
+
+        function arch002_open_project_modify_win(ds_id,record_id) {
+            var record = $(ds_id).findById(record_id);
+            var maintain_type = 'READONLY';
+            var function_usage = 'QUERY';
+            var function_code = 'PRJ505';
+            var param = {};
+            param['project_id'] = record.get('project_id');
+            param['document_id'] = record.get('ref_project_id');
+            param['function_code'] = function_code;
+            param['function_usage'] = function_usage;
+            param['maintain_type'] = maintain_type;
+            param['url_title'] = '项目明细';
+            param['company_id'] = '${/session/@company_id}';
+            //param['layout_debugger_flag']='Y';
+            param['cond_para2'] = record.get('hn_industry_classification');
+            param['cond_para3'] = record.get('binary_classification');
+            param['document_type'] = record.get('document_type');
+            // param['wf_function_code'] = '${/parameter/@function_code}';
+            param['winid'] = 'prj501n_main_prj_link_winid';
+            hls_doc_get_layout_code('con_contract_get_layout_code_link_id', param, 'arch002_prj_project_link_id', ds_id);
+        }
+
+        function prj506_grid_virtual_con(ds_id,reocrd_id) {
+            var url_link_id;
+            var record = $(ds_id).findById(reocrd_id);
+            var param = record.data;
+            param['function_code'] = 'C0N301D_CON';
+            param['function_usage'] = 'QUERY';
+            param['maintain_type'] = 'READONLY';
+            url_link_id='prj506_virtual_contract_query_link_id';
+            //param['document_id'] = record.get('project_id');
+            param['cond_para2'] = record.get('hn_industry_classification');
+            param['url_title'] = '合同明细';
+            // param['layout_debugger_flag'] = 'Y';
+            param['winid'] = 'prj506_virtual_contract_modify_detail_link_id';
+            hls_doc_get_layout_code('con_contract_get_layout_code_link_id', param, url_link_id, ds_id);
+        }
+
+        window['${/parameter/@layout_code}_dynamic_link_renderer'] = function(value, record, name, config_record) {
+            if (name == 'project_number') {
+                if(value){
+                    return '<a href="javascript:arch002_open_project_modify_win(\'' + record.ds.id + '\',\'' + record.id + '\')">' + '项目明细' + '</a>';
+                }
+            }
+            else if (name == 'virtual_con_number') {
+                return '<a href="javascript:prj506_grid_virtual_con(\'' + record.ds.id + '\',\'' + record.id + '\')">' + '合同明细' + '</a>';
+            }
+            else if (name == 'attach_file_name') {
+                if (value != null) {
+                    var link = '${/request/@context_path}/atm_download.lsc?attachment_id=';
+                    var str = value.split(';;');
+                    var url = '';
+                    for (var i = 0;i < str.length;i++) {
+                        var temp = str[i].split('--');
+                        if (!Leaf.isEmpty(temp[0])) {
+                            url = url + '<a href=' + link + temp[1] + '>' + temp[0] + '</a>' + ',';
+                        }
+                    }
+                    return url;
+                }
+            } else if (name == 'attachment') {
+                link_function = 'upload_file';
+                return '<a href="javascript:window[\'' + link_function + '\'](\'' + record.id + '\',\'' + name + '\',\'' + config_record.get('query_only') + '\');">' + '附件' + '</a>';
+            }else if(name == 'cdd_item_name') {
+                var mark_flag = record.get('mark_flag');
+                if(mark_flag == 'Y'){
+                    return '<font color="red">' + value + '</font>';
+                } else{
+                    return value;
+                }
+            }
+        };
+
+
+        function upload_file(id, name, query_only) {
+            var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'con_file_archive_attachment');
+            var record = $(ds_id).findById(id);
+            var current_seq = '${/model/project_path/record/@current_seq}';
+            if (record.get('archive_attachment_id')) {
+                var url;
+                var query_flag='${/parameter/@function_usage}';
+                if (query_flag == 'MODIFY' && current_seq == '40') {
+                    url = $('arch002_cdd_uploadFile_id').getUrl() + '?table_name=CON_FILE_ARCHIVE_ATTACHMENT&header_id=' + record.get('archive_attachment_id');
+                } else {
+                    url = $('arch002_cdd_downloadFile_id').getUrl() + '?table_name=CON_FILE_ARCHIVE_ATTACHMENT&header_id=' + record.get('archive_attachment_id');
+                }
+                var win = new Leaf.Window({
+                    url: url,
+                    title: '${l:HLS.SUPPORTING_DOCUMENT}',
+                    id: 'arch002_cdd_uploadFile_screen_id',
+                    width: 850,
+                    height: 400
+                });
+                win.on('close', function() {
+                    record.ds.query();
+                });
+            } else {
+                Leaf.showMessage('${l:HLS.PROMPT}', '请先保存!');
+            }
+        }
+
+
+        Leaf.onReady(()=>{
+            console.clear()
+            sp_output_view_parameter('${/parameter}')
+            const ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'con_file_archive_attachment');
+            const current_seq = '${/model/project_path/record/@current_seq}';
+
+            $(ds_id).on("beforesubmit", ds=>{
+                if(current_seq === '50') {
+                    ds.getAll().forEach(rec =>{
+                        if(rec.get("archive_progress") === 'ARCHIVING' || rec.get("archive_progress") === "ARCHIVED"){
+                            rec.set("archive_progress", 'ARCHIVED')
+                            rec.set("archive_progress_n", '已归档')
+                            rec.set("archive_date", new Date())
+                        }
+                    })
+                }
+                return true
+            })
+        })
+
+
+        //加载时调用 grid
+        window['${/parameter/@bp_seq}${/parameter/@layout_code}_on_layout_dynamic_grid_load'] = function (ds, record, config_records, bp_seq) {
+            var current_seq = '${/model/project_path/record/@current_seq}';
+            var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'con_file_archive_attachment');
+            var record = $(ds_id).getCurrentRecord();
+            var grid_id = $(ds_id.replace('ds', 'layout_grid_id'));
+            if (current_seq != '40') {
+                grid_id.hideColumn('receive_flag');
+                grid_id.hideColumn('receive_flag_n');
+            }else if (current_seq == '40'){
+                if(record){
+                    record.getField('receive_flag').setReadOnly(false);
+                    record.getField('receive_flag_n').setReadOnly(false);
+                }
+                $('WFL_MANUAL_FILE_ARCHIVE_G_ARCHIVE_FILE_USER_BUTTON1_layout_dynamic_button_id').hide();
+                $('WFL_MANUAL_FILE_ARCHIVE_G_ARCHIVE_FILE_USER_BUTTON2_layout_dynamic_button_id').hide();
+            }else if (current_seq == '50'){
+                $('WFL_MANUAL_FILE_ARCHIVE_G_ARCHIVE_FILE_SAVE_layout_dynamic_button_id').hide();
+            }
+
+            if(!(current_seq === '50') && ds.id === ds_id){
+                $(ds_id).getAll().forEach(rec =>{
+                    rec.getField('document_number').setReadOnly(true);
+                })
+            }
+        }
+
+        //50 节点设置维护文号
+
+        ]]></script>
+        <a:screen-include screen="modules/cont/CON500/con_contract_get_layout_code.lview"/>
+        <a:screen-include screen="modules/simple/simple_util.lview"/>
+    </a:view>
+</a:screen>
Index: src/main/resources/leaf_static/modules/acrch/ARCHIVE002/con_file_archive_info_wfl.lview
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/acrch/ARCHIVE002/con_file_archive_info_wfl.lview b/src/main/resources/leaf_static/modules/acrch/ARCHIVE002/con_file_archive_info_wfl.lview
new file mode 100644
--- /dev/null	(revision 343f08153639828ea9e1265fcf4da4fe8471e7c3)
+++ b/src/main/resources/leaf_static/modules/acrch/ARCHIVE002/con_file_archive_info_wfl.lview	(revision 343f08153639828ea9e1265fcf4da4fe8471e7c3)
@@ -0,0 +1,967 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!--
+    $Author: zc/Sora
+    $Date: 2018-09-18 10:46:02
+    $Revision: 1.1
+    $Purpose: 档案归档附件工作流页面
+    $Tips: 多留意控制台
+-->
+<a:screen xmlns:a="http://www.leaf-framework.org/application" customizationEnabled="true" dynamiccreateenabled="true"
+          trace="true">
+    <a:init-procedure>
+        <a:model-query defaultWhereClause="t1.archive_batch_id=${/parameter/@archive_batch_id}" model="acrch.ARCHIVE002.arch002_project_info" rootPath="project_path"/>
+    </a:init-procedure>
+    <a:view>
+        <a:link id="arch002_cdd_uploadFile_id" url="${/request/@context_path}/uploadFile.lview"/>
+        <a:link id="arch002_cdd_downloadFile_id" url="${/request/@context_path}/downloadFile.lview"/>
+        <a:link id="con_contract_get_layout_code_link_id" model="cont.CON500.con_contract_get_layout_code" modelaction="update"/>
+        <a:link id="prj_project_query_link" url="${/request/@context_path}/modules/prj/PRJ501N/prj_project_create_tree_n.lview"/>
+        <a:link id="prj506_virtual_contract_query_link_id" url="${/request/@context_path}/modules/prj/PRJ506/virtual_contract_query.lview"/>
+        <div style="display:flex;">
+            <span style="font-size:20px;margin-left:10px;margin-top:1px;font-weight:bold;float:right;color:red;">提示：默认全部资料均需归档，请勾选无需归档资料！</span>
+        </div>
+        <script><![CDATA[
+
+        function const_data(){
+            /**
+             * @obj.submit_from 归档来源
+             * @obj.dataset_id 查询dataset的ID集合
+             * @obj.desc 描述
+             * @obj.submit 查询分组
+             */
+            return [
+                {
+                    "submit_from": "PRJ_PLAN",
+                    "dataset_id": ["archive_prj_plan_bp_ds", "archive_compliance_materials_ds"],
+                    "desc": "项目方案",
+                    "tab_group": ["TENANT", "PROJECT"]
+                },
+                {
+                    "submit_from": "PRJ_PLAN_CHANGE",
+                    "dataset_id": ["archive_prj_change_bp_ds", "archive_compliance_materials_ds"],
+                    "desc": "项目方案变更",
+                    "tab_group": ["TENANT", "PROJECT"]
+                },
+                {
+                    "submit_from": "PAYMENT",
+                    "dataset_id": ["archive_payment_ds"],
+                    "desc": "付款先决落实",
+                    "tab_group": []
+                },
+                {
+                    "submit_from": "SIGN",
+                    "dataset_id": ["archive_contract_sign_ds"],
+                    "desc": "合同签约",
+                    "tab_group": ["SIGN"]
+                },
+                {
+                    "submit_from": "PRJ_PLAN_REPORT",
+                    "dataset_id": ["archive_report_ds"],
+                    "desc": "项目报告 - 项目方案",
+                    "tab_group": ["PRJ_CHANGE"]
+                },
+                {
+                    "submit_from": "PRJ_PLAN_REPORT_CHANGE_A",
+                    "dataset_id": ["archive_report_ds"],
+                    "desc": "项目报告 - 项目变更(租前)",
+                    "tab_group": ["PRJ_CHANGE"]
+                },
+                {
+                    "submit_from": "PRJ_PLAN_REPORT_CHANGE_B",
+                    "dataset_id": ["archive_report_ds"],
+                    "desc": "项目报告 - 项目变更(租后)",
+                    "tab_group": ["PRJ_CHANGE"]
+                }
+            ]
+        }
+
+        const view_property = const_data().filter(obj =>{return obj.submit_from === '${/parameter/@submit_from}'})[0]
+
+        function open_cdd_attachment_window(record_id, ds_id,check_id) {
+            let record = $(ds_id).findById(record_id);
+            if (check_id) {
+                let query_flag='${/parameter/@function_usage}';
+                let url_id;
+                if (query_flag === 'MODIFY') {
+                    url_id = $('arch002_cdd_uploadFile_id').getUrl();
+                } else {
+                    url_id = $('arch002_cdd_downloadFile_id').getUrl();
+                }
+                url = url_id + '?table_name=PRJ_CDD_ITEM_CHECK&header_id=' + check_id;
+                let win = new Leaf.Window({
+                    url: url,
+                    title: '${l:HLS.SUPPORTING_DOCUMENT}',
+                    id: 'wfl_cdd_loadFile_screen_id',
+                    width: 850,
+                    height: 400
+                });
+                win.on('close', function() {
+                    record.ds.query();
+                });
+            } else {
+                Leaf.showMessage('${l:HLS.PROMPT}', '请先保存!');
+            }
+        }
+
+
+        function payment_cdd_render_func(value, record, name) {
+            var condition_id=record.get('condition_id');
+            if (name === 'attachment_payment2'){
+                return '<a href="javascript:open_payment_attachment_window2(\'' + condition_id+ '\');">附件</a>';
+            }else if(name === 'file_name'){
+                if (value != null) {
+                    var link = '${/request/@context_path}/atm_download.lsc?attachment_id=';
+                    var str = value.split(';;');
+                    var url = '';
+                    for (var i = 0; i < str.length; i++) {
+                        var temp = str[i].split('--');
+                        if (!Leaf.isEmpty(temp[0])) {
+                            url = url + '<a href=' + link + temp[1] + '>' + temp[0] + '</a>' + ',';
+                        }
+                    }
+                    return url;
+                }
+            }
+        }
+
+        function open_payment_attachment_window(condition_id) {
+            var url = $('arch002_cdd_downloadFile_id').getUrl();
+            var win = new Leaf.Window({
+                url: url,
+                title: '${l:HLS.SUPPORTING_DOCUMENT}',
+                params: {
+                    'table_name': 'HN_CON_PAYMENT_CONDITIONS',
+                    'header_id': condition_id
+                },
+                width: 850,
+                height: 400
+            }).on('close',function(){
+                $('archive_payment_ds').query();
+            });
+        }
+
+        function open_payment_attachment_window2(condition_id) {
+            var query_flag='${/parameter/@function_usage}';
+            if (query_flag === 'MODIFY') {
+                var url = $('arch002_cdd_uploadFile_id').getUrl();
+            } else {
+                var url = $('arch002_cdd_downloadFile_id').getUrl();
+            }
+            var win = new Leaf.Window({
+                url: url,
+                title: '${l:HLS.SUPPORTING_DOCUMENT}',
+                params: {
+                    'table_name': 'HN_CON_PAYMENT_CONDITIONS',
+                    'header_id': condition_id
+                },
+                width: 850,
+                height: 400
+            }).on('close',function(){
+                $('archive_payment_ds').query();
+            });
+        }
+
+        function project_cdd_render_func(value, record, name) {
+            if (name === 'attachment') {
+                return '<a href="javascript:open_cdd_attachment_window(\'' + record.id + '\',\'' + record.ds.id + '\',' + record.get('check_id') + ');">附件</a>';
+            } else if (name === 'attach_file_name') {
+                if (value != null) {
+                    let link = '${/request/@context_path}/atm_download.lsc?attachment_id=';
+                    let str = value.split(';;');
+                    let url = '';
+                    for (let i = 0;i < str.length;i++) {
+                        let temp = str[i].split('--');
+                        if (!Leaf.isEmpty(temp[0])) {
+                            url = url + '<a href=' + link + temp[1] + '>' + temp[0] + '</a>' + ',';
+                        }
+                    }
+                    return url;
+                }
+            }
+            else if(name === 'description') {
+                return sp_format(`<div title={0}>{1}</div>`, value, value)
+            }
+        }
+
+        function archive_detail_ds_load(ds){
+            let current_seq = '${/model/project_path/record/@current_seq}';
+            let records = ds.getAll();
+
+            if (!records.length) {
+                return;
+            }
+
+            ds.getAll().forEach(record =>{
+                if("${/session/@user_id}" === "1"){
+                    //sp_rec_readonly(record)
+                }
+                if(current_seq !== '20'){
+                    record.getField('feedback').setReadOnly(true);
+                } else{
+                    record.getField('note').setReadOnly(true);
+                }
+            })
+        }
+
+
+        function archive_submit_handler(ds){
+            let current_seq = '${/model/project_path/record/@current_seq}';
+            if(current_seq === '20') {
+                ds.getAll().forEach(rec =>{
+                    if(rec.get("archive_status") === 'ARCHIVING' || rec.get("archive_status") === "ARCHIVED"){
+                        rec.set("archive_status", 'ARCHIVED')
+                        rec.set("archive_status_n", '已归档')
+                        rec.set("archive_date", new Date())
+                    } else{
+                        rec.set("archive_date", '')
+                    }
+                })
+            }
+            return true
+        }
+
+        function archive_update_handler(ds, record, name, value){
+            if(name === 'archive_status'){
+                if(value === 'NOT_ARCHIVE' || value === 'NOT_NEED_ARCHIVE'){
+                    record.getField("note").setRequired(true)
+                    record.getField("note").setReadOnly(false)
+                } else{
+                    record.getField("note").setRequired(false)
+                    if('${/model/project_path/record/@current_seq}' === '20'){
+                        record.getField("note").setReadOnly(true)
+                    }
+                }
+            }
+        }
+
+        Leaf.onReady(function() {
+            view_property.dataset_id.forEach(ds_id =>{
+                const ds = $(ds_id)
+                ds.on("submitsuccess", ()=>{ds.query()})
+            })
+
+            let current_seq = '${/model/project_path/record/@current_seq}';
+            if(current_seq !== '20'){
+                for(let i in range(9)){
+                    const btn_id = sp_format(`save_btn{0}_s`, i)
+                    if(document.getElementById(btn_id)){
+                        document.getElementById(btn_id).remove()
+                    }
+                }
+            }
+
+            sp_get_workflow_info("${/parameter}", ()=>{
+                sp_obj_colorful_log(view_property, "页面属性")
+            })
+
+        });
+
+
+
+
+        //工作流中同意按钮调用效验
+        if(typeof(zjwfl5110_ApproveChecker_add) !== "undefined"){
+            zjwfl5110_ApproveChecker_add('agree', function () {
+                const filter_data = const_data().filter(obj =>{
+                    return obj["submit_from"] === '${/parameter/@submit_from}'
+                })[0]
+
+                //判断是否有脏数据
+                return filter_data["dataset_id"].every(ds_id =>{
+                    return sp_ds_dirty_valid($(ds_id))
+                })
+            });
+        }
+
+        function archive_report_save(){
+            const ds = $("archive_report_ds")
+            archive_submit_handler(ds)
+            ds.submit()
+        }
+
+        function archive_prj_plan_bp_save(){
+            const ds = $("archive_prj_plan_bp_ds")
+            archive_submit_handler(ds)
+            ds.submit()
+        }
+
+        function archive_compliance_materials_save(){
+            const ds = $("archive_compliance_materials_ds")
+            archive_submit_handler(ds)
+            ds.submit()
+        }
+
+        function archive_payment_save(){
+            const ds = $("archive_payment_ds")
+            archive_submit_handler(ds)
+            ds.submit()
+        }
+
+        function archive_contract_sign_save(){
+            const ds = $("archive_contract_sign_ds")
+            archive_submit_handler(ds)
+            ds.submit()
+        }
+
+        function archive_prj_change_bp_save(){
+            const ds = $("archive_prj_change_bp_ds")
+            archive_submit_handler(ds)
+            ds.submit()
+        }
+
+
+
+        ]]></script>
+        <a:dataSets>
+            <a:dataSet id="yes_no_ds" lookupCode="YES_NO"/>
+            <a:dataSet id="acrch_type_ds" lookupCode="ACRCH_TYPE"/>
+
+            <a:switch test="/model/project_path/record/@current_seq">
+                <a:case value="20">
+                    <a:dataSet id="archive_status_ds" lookupCode="ARCHIVE_STATUS_ADMIN"/>
+                </a:case>
+                <a:case value="*">
+                    <a:dataSet id="archive_status_ds" lookupCode="ARCHIVE_STATUS"/>
+                </a:case>
+            </a:switch>
+
+
+            <a:dataSet id="arch002_project_info_ds">
+                <a:datas dataSource="/model/project_path"/>
+            </a:dataSet>
+
+            <!--客户资信资料 => 项目方案-->
+            <a:dataSet id="archive_prj_plan_bp_ds" autoQuery="true" fetchAll="true"
+                       model="acrch.ARCHIVE002.server_layout_doc_cdd_item" pageSize="11"
+                       queryUrl="${/request/@context_path}/autocrud/acrch.ARCHIVE002.server_layout_doc_cdd_item/query?base_table_pk=${/parameter/@archive_batch_id}&amp;document_table=FILE_ARCHIVE_BATCH&amp;cdd_list_id=${/model/project_path/record/@arch_cdd_list_id}&amp;attachment_tab_group=TENANT&amp;arch_not_required_flag=N&amp;fix_category=MANAGER&amp;current_seq=${/model/project_path/record/@current_seq}"
+                       selectable="true">
+                <a:fields>
+                    <a:field name="note" requiredMessage="请给暂不归档和无需归档的文件填写说明"/>
+                    <a:field name="arch_required_flag" readOnly="true"/>
+                    <a:field name="arch_required_flag_desc" readOnly="true" displayField="code_value_name" options="yes_no_ds" returnField="arch_required_flag" valueField="code_value"/>
+                    <a:field name="arch_par_has_flag"  defaultValue="Y"/>
+                    <a:field name="arch_par_has_flag_desc"  displayField="code_value_name" options="acrch_type_ds" returnField="arch_par_has_flag" valueField="code_value"/>
+                    <a:field name="archive_status" defaultValue="ARCHIVING"/>
+                    <a:field name="archive_status_desc"  displayField="code_value_name" options="archive_status_ds" returnField="archive_status" valueField="code_value"/>
+                    <a:field name="arch_paper_required_flag" readOnly="true"/>
+                    <a:field name="arch_paper_required_flag_desc" readOnly="true" displayField="code_value_name" options="yes_no_ds" returnField="arch_paper_required_flag" valueField="code_value"/>
+                    <a:field name="receive_flag" defaultValue="Y" readOnly="true"/>
+                    <a:field name="receive_flag_desc" readOnly="true" displayField="code_value_name" options="yes_no_ds" returnField="receive_flag" valueField="code_value"/>
+                </a:fields>
+                <a:events>
+                    <a:event name="load" handler="archive_detail_ds_load"/>
+                    <a:event name="update" handler="archive_update_handler"/>
+                </a:events>
+            </a:dataSet>
+            <!--客户资信资料 => 项目方案变更-->
+            <a:dataSet id="archive_prj_change_bp_ds" autoQuery="true" fetchAll="true"
+                       model="acrch.ARCHIVE002.server_layout_doc_cdd_item" pageSize="11"
+                       queryUrl="${/request/@context_path}/autocrud/acrch.ARCHIVE002.server_layout_doc_cdd_item/query?base_table_pk=${/parameter/@archive_batch_id}&amp;document_table=FILE_ARCHIVE_BATCH&amp;cdd_list_id=${/model/project_path/record/@arch_cdd_list_id}&amp;attachment_tab_group=TENANT&amp;arch_not_required_flag=N&amp;fix_category=MANAGER&amp;current_seq=${/model/project_path/record/@current_seq}"
+                       selectable="true">
+                <a:fields>
+                    <a:field name="note" requiredMessage="请给暂不归档和无需归档的文件填写说明"/>
+                    <a:field name="arch_required_flag" readOnly="true"/>
+                    <a:field name="arch_required_flag_desc" readOnly="true" displayField="code_value_name" options="yes_no_ds" returnField="arch_required_flag" valueField="code_value"/>
+                    <a:field name="arch_par_has_flag"  defaultValue="Y"/>
+                    <a:field name="arch_par_has_flag_desc"  displayField="code_value_name" options="acrch_type_ds" returnField="arch_par_has_flag" valueField="code_value"/>
+                    <a:field name="arch_paper_required_flag" readOnly="true"/>
+                    <a:field name="arch_paper_required_flag_desc" readOnly="true" displayField="code_value_name" options="yes_no_ds" returnField="arch_paper_required_flag" valueField="code_value"/>
+                    <a:field name="receive_flag" defaultValue="Y" readOnly="true"/>
+                    <a:field name="receive_flag_desc" readOnly="true" displayField="code_value_name" options="yes_no_ds" returnField="receive_flag" valueField="code_value"/>
+                    <a:field name="archive_status" defaultValue="ARCHIVING"/>
+                    <a:field name="archive_status_desc"  displayField="code_value_name" options="archive_status_ds" returnField="archive_status" valueField="code_value"/>
+                </a:fields>
+                <a:events>
+                    <a:event name="load" handler="archive_detail_ds_load"/>
+                    <a:event name="update" handler="archive_update_handler"/>
+                </a:events>
+            </a:dataSet>
+            <!--放款前提材料 => 付款先决落实-->
+            <a:dataSet id="archive_payment_ds" autoQuery="true" fetchAll="true"
+                       model="csh.CSH900.hn_con_payment_conditions_detail_new" pageSize="11"
+                       queryUrl="${/request/@context_path}/autocrud/csh.CSH900.hn_con_payment_conditions_detail_new/query?archive_batch_id=${/parameter/@archive_batch_id}&amp;arch_not_required_flag=N&amp;current_seq=${/model/project_path/record/@current_seq}"
+                       selectable="true">
+                <a:fields>
+                    <a:field name="note" requiredMessage="请给暂不归档和无需归档的文件填写说明"/>
+                    <a:field name="arch_required_flag" readOnly="true"/>
+                    <a:field name="arch_required_flag_desc" readOnly="true" displayField="code_value_name" options="yes_no_ds" returnField="arch_required_flag" valueField="code_value"/>
+                    <a:field name="arch_par_has_flag" defaultValue="Y"/>
+                    <a:field name="arch_par_has_flag_desc" displayField="code_value_name" options="acrch_type_ds" returnField="arch_par_has_flag" valueField="code_value"/>
+                    <a:field name="arch_paper_required_flag"/>
+                    <a:field name="arch_paper_required_flag_desc" displayField="code_value_name" options="yes_no_ds" returnField="arch_paper_required_flag" valueField="code_value"/>
+                    <a:field name="receive_flag" defaultValue="Y"/>
+                    <a:field name="receive_flag_desc" displayField="code_value_name" options="yes_no_ds" returnField="receive_flag" valueField="code_value"/>
+                    <a:field name="archive_status" defaultValue="ARCHIVING"/>
+                    <a:field name="archive_status_desc"  displayField="code_value_name" options="archive_status_ds" returnField="archive_status" valueField="code_value"/>
+                </a:fields>
+                <a:events>
+                    <a:event name="load" handler="archive_detail_ds_load"/>
+                    <a:event name="update" handler="archive_update_handler"/>
+                </a:events>
+            </a:dataSet>
+
+            <!--签约执行材料 => 合同签约-->
+            <a:dataSet id="archive_contract_sign_ds" autoQuery="true" fetchAll="true"
+                       model="acrch.ARCHIVE002.server_layout_doc_cdd_item" pageSize="11"
+                       queryUrl="${/request/@context_path}/autocrud/acrch.ARCHIVE002.server_layout_doc_cdd_item/query?base_table_pk=${/parameter/@archive_batch_id}&amp;document_table=FILE_ARCHIVE_BATCH&amp;cdd_list_id=${/model/project_path/record/@arch_cdd_list_id}&amp;attachment_tab_group=SIGN&amp;arch_not_required_flag=N&amp;current_seq=${/model/project_path/record/@current_seq}"
+                       selectable="true">
+                <a:fields>
+                    <a:field name="note" requiredMessage="请给暂不归档和无需归档的文件填写说明"/>
+                    <a:field name="arch_required_flag" readOnly="true"/>
+                    <a:field name="arch_required_flag_desc" readOnly="true" displayField="code_value_name" options="yes_no_ds" returnField="arch_required_flag" valueField="code_value"/>
+                    <a:field name="arch_par_has_flag" defaultValue="Y"/>
+                    <a:field name="arch_par_has_flag_desc" displayField="code_value_name" options="acrch_type_ds" returnField="arch_par_has_flag" valueField="code_value"/>
+                    <a:field name="arch_paper_required_flag"/>
+                    <a:field name="arch_paper_required_flag_desc" displayField="code_value_name" options="yes_no_ds" returnField="arch_paper_required_flag" valueField="code_value"/>
+                    <a:field name="receive_flag" defaultValue="Y"/>
+                    <a:field name="receive_flag_desc" displayField="code_value_name" options="yes_no_ds" returnField="receive_flag" valueField="code_value"/>
+                    <a:field name="archive_status" defaultValue="ARCHIVING"/>
+                    <a:field name="archive_status_desc"  displayField="code_value_name" options="archive_status_ds" returnField="archive_status" valueField="code_value"/>
+                </a:fields>
+                <a:events>
+                    <a:event name="load" handler="archive_detail_ds_load"/>
+                    <a:event name="update" handler="archive_update_handler"/>
+                </a:events>
+            </a:dataSet>
+
+            <!--合规性材料 => 项目方案&项目方案变更-->
+            <a:dataSet id="archive_compliance_materials_ds" autoQuery="true" fetchAll="true"
+                       model="acrch.ARCHIVE002.server_layout_doc_cdd_item" pageSize="11"
+                       queryUrl="${/request/@context_path}/autocrud/acrch.ARCHIVE002.server_layout_doc_cdd_item/query?base_table_pk=${/parameter/@archive_batch_id}&amp;document_table=FILE_ARCHIVE_BATCH&amp;cdd_list_id=${/model/project_path/record/@arch_cdd_list_id}&amp;attachment_tab_group=PROJECT&amp;arch_not_required_flag=N&amp;fix_category=REQUIREMENT&amp;current_seq=${/model/project_path/record/@current_seq}"
+                       selectable="true">
+                <a:fields>
+                    <a:field name="note" requiredMessage="请给暂不归档和无需归档的文件填写说明"/>
+                    <a:field name="arch_required_flag" readOnly="true"/>
+                    <a:field name="arch_required_flag_desc" readOnly="true" displayField="code_value_name" options="yes_no_ds" returnField="arch_required_flag" valueField="code_value"/>
+                    <a:field name="arch_par_has_flag" defaultValue="Y"/>
+                    <a:field name="arch_par_has_flag_desc" displayField="code_value_name" options="acrch_type_ds" returnField="arch_par_has_flag" valueField="code_value"/>
+                    <a:field name="arch_paper_required_flag"/>
+                    <a:field name="arch_paper_required_flag_desc" displayField="code_value_name" options="yes_no_ds" returnField="arch_paper_required_flag" valueField="code_value"/>
+                    <a:field name="receive_flag" defaultValue="Y"/>
+                    <a:field name="receive_flag_desc" displayField="code_value_name" options="yes_no_ds" returnField="receive_flag" valueField="code_value"/>
+                    <a:field name="archive_status" defaultValue="ARCHIVING"/>
+                    <a:field name="archive_status_desc"  displayField="code_value_name" options="archive_status_ds" returnField="archive_status" valueField="code_value"/>
+                </a:fields>
+                <a:events>
+                    <a:event name="load" handler="archive_detail_ds_load"/>
+                    <a:event name="update" handler="archive_update_handler"/>
+                </a:events>
+            </a:dataSet>
+
+            <!--项目报告 => 项目方案&项目方案变更-->
+            <a:dataSet id="archive_report_ds" autoQuery="true" fetchAll="true"
+                       model="acrch.ARCHIVE002.server_layout_doc_cdd_item" pageSize="11"
+                       queryUrl="${/request/@context_path}/autocrud/acrch.ARCHIVE002.server_layout_doc_cdd_item/query?base_table_pk=${/parameter/@archive_batch_id}&amp;document_table=FILE_ARCHIVE_BATCH&amp;cdd_list_id=${/model/project_path/record/@arch_cdd_list_id}&amp;attachment_tab_group=PRJ_CHANGE&amp;fix_category=MANAGER&amp;arch_not_required_flag=N&amp;current_seq=${/model/project_path/record/@current_seq}"
+                       selectable="true">
+                <a:fields>
+                    <a:field name="note" requiredMessage="请给暂不归档和无需归档的文件填写说明"/>
+                    <a:field name="arch_required_flag" readOnly="true"/>
+                    <a:field name="arch_required_flag_desc" readOnly="true" displayField="code_value_name" options="yes_no_ds" returnField="arch_required_flag" valueField="code_value"/>
+                    <a:field name="arch_par_has_flag" defaultValue="Y"/>
+                    <a:field name="arch_par_has_flag_desc" displayField="code_value_name" options="acrch_type_ds" returnField="arch_par_has_flag" valueField="code_value"/>
+                    <a:field name="arch_paper_required_flag"/>
+                    <a:field name="arch_paper_required_flag_desc" displayField="code_value_name" options="yes_no_ds" returnField="arch_paper_required_flag" valueField="code_value"/>
+                    <a:field name="receive_flag" defaultValue="Y"/>
+                    <a:field name="receive_flag_desc" displayField="code_value_name" options="yes_no_ds" returnField="receive_flag" valueField="code_value"/>
+                    <a:field name="archive_status" defaultValue="ARCHIVING"/>
+                    <a:field name="archive_status_desc"  displayField="code_value_name" options="archive_status_ds" returnField="archive_status" valueField="code_value"/>
+                </a:fields>
+                <a:events>
+                    <a:event name="load" handler="archive_detail_ds_load"/>
+                    <a:event name="update" handler="archive_update_handler"/>
+                </a:events>
+            </a:dataSet>
+        </a:dataSets>
+
+        <a:screenBody>
+            <a:switch test="/parameter/@archive_flag">
+                <a:case value="N"/>
+                <a:case value="*">
+                    <a:switch test="/parameter/@submit_from">
+                        <a:case value="PRJ_PLAN">
+                            <a:form marginWidth="25" title="基本信息">
+                                <a:hBox labelWidth="100">
+                                    <a:textField name="bp_id_tenant_n" bindTarget="arch002_project_info_ds" prompt="承租人名称" width="200" readOnly="true"/>
+                                    <a:textField name="plan_number" bindTarget="arch002_project_info_ds" prompt="项目方案编号" readOnly="true"/>
+                                    <a:textField name="plan_name" bindTarget="arch002_project_info_ds" prompt="项目方案名称" readOnly="true" width="250"/>
+                                    <a:textField name="submit_by" bindTarget="arch002_project_info_ds"  prompt="归档责任人" readOnly="true"/>
+                                    <a:textField name="lease_organization_n" bindTarget="arch002_project_info_ds"  prompt="归档部门" readOnly="true"/>
+                                </a:hBox>
+                            </a:form>
+                        </a:case>
+
+                        <a:case value="PRJ_PLAN_REPORT">
+                            <a:form marginWidth="25" title="基本信息">
+                                <a:hBox labelWidth="100">
+                                    <a:textField name="bp_id_tenant_n" bindTarget="arch002_project_info_ds" prompt="承租人名称" width="200" readOnly="true"/>
+                                    <a:textField name="plan_number" bindTarget="arch002_project_info_ds" prompt="项目方案编号" readOnly="true"/>
+                                    <a:textField name="plan_name" bindTarget="arch002_project_info_ds" prompt="项目方案名称" readOnly="true" width="250"/>
+                                    <a:textField name="submit_by" bindTarget="arch002_project_info_ds" prompt="归档责任人"  readOnly="true"/>
+                                    <a:textField name="lease_organization_n" bindTarget="arch002_project_info_ds"  prompt="归档部门" readOnly="true"/>
+                                </a:hBox>
+                            </a:form>
+                        </a:case>
+
+                        <a:case value="PRJ_PLAN_CHANGE">
+                            <a:form marginWidth="25" title="基本信息">
+                                <a:hBox labelWidth="100">
+                                    <a:textField name="bp_id_tenant_n" bindTarget="arch002_project_info_ds" prompt="承租人名称" width="200" readOnly="true"/>
+                                    <a:textField name="plan_number" bindTarget="arch002_project_info_ds" prompt="项目方案编号" readOnly="true"/>
+                                    <a:textField name="plan_name" bindTarget="arch002_project_info_ds" prompt="项目方案名称" readOnly="true" width="250"/>
+                                    <a:textField name="submit_by" bindTarget="arch002_project_info_ds" prompt="归档责任人" readOnly="true"/>
+                                    <a:textField name="lease_organization_n" bindTarget="arch002_project_info_ds"  prompt="归档部门" readOnly="true"/>
+                                </a:hBox>
+                            </a:form>
+                        </a:case>
+
+                        <a:case value="PRJ_PLAN_REPORT_CHANGE_A">
+                            <a:form marginWidth="25" title="基本信息">
+                                <a:hBox labelWidth="100">
+                                    <a:textField name="bp_id_tenant_n" bindTarget="arch002_project_info_ds" prompt="承租人名称" width="200" readOnly="true"/>
+                                    <a:textField name="plan_number" bindTarget="arch002_project_info_ds" prompt="项目方案编号" readOnly="true"/>
+                                    <a:textField name="plan_name" bindTarget="arch002_project_info_ds" prompt="项目方案名称" readOnly="true" width="250"/>
+                                    <a:textField name="submit_by" bindTarget="arch002_project_info_ds" prompt="归档责任人" readOnly="true"/>
+                                    <a:textField name="lease_organization_n" bindTarget="arch002_project_info_ds"  prompt="归档部门" readOnly="true"/>
+                                </a:hBox>
+                            </a:form>
+                        </a:case>
+
+                        <a:case value="PRJ_PLAN_REPORT_CHANGE_B">
+                            <a:form marginWidth="25" title="基本信息">
+                                <a:hBox labelWidth="100">
+                                    <a:textField name="bp_id_tenant_n" bindTarget="arch002_project_info_ds" prompt="承租人名称" width="200" readOnly="true"/>
+                                    <a:textField name="plan_number" bindTarget="arch002_project_info_ds" prompt="项目方案编号" readOnly="true"/>
+                                    <a:textField name="plan_name" bindTarget="arch002_project_info_ds" prompt="项目方案名称" readOnly="true" width="250"/>
+                                    <a:textField name="submit_by" bindTarget="arch002_project_info_ds" prompt="归档责任人" readOnly="true"/>
+                                    <a:textField name="lease_organization_n" bindTarget="arch002_project_info_ds"  prompt="归档部门" readOnly="true"/>
+                                </a:hBox>
+                            </a:form>
+                        </a:case>
+
+                        <a:case value="SIGN">
+                            <a:form marginWidth="25" title="基本信息">
+                                <a:hBox labelWidth="100">
+                                    <a:textField name="bp_id_tenant_n" bindTarget="arch002_project_info_ds" prompt="承租人名称" width="200" readOnly="true"/>
+                                    <a:textField name="contract_number" bindTarget="arch002_project_info_ds" prompt="合同编号" readOnly="true"/>
+                                    <a:textField name="virtual_con_name" bindTarget="arch002_project_info_ds" prompt="合同名称" readOnly="true" width="250"/>
+                                    <a:textField name="submit_by" bindTarget="arch002_project_info_ds" prompt="归档责任人" readOnly="true"/>4
+                                    <a:textField name="lease_organization_n" bindTarget="arch002_project_info_ds"  prompt="归档部门" readOnly="true"/>
+                                </a:hBox>
+
+                            </a:form>
+                        </a:case>
+
+                        <a:case value="*">
+                            <a:form marginWidth="25" title="基本信息">
+                                <a:hBox labelWidth="100">
+                                    <a:textField name="bp_id_tenant_n" bindTarget="arch002_project_info_ds" prompt="承租人名称" width="200" readOnly="true"/>
+                                    <a:textField name="project_number" bindTarget="arch002_project_info_ds" prompt="项目编号" readOnly="true"/>
+                                    <a:textField name="project_name" bindTarget="arch002_project_info_ds" prompt="项目名称" readOnly="true" width="250"/>
+                                    <a:textField name="submit_by" bindTarget="arch002_project_info_ds" prompt="归档责任人" readOnly="true"/>
+                                    <a:textField name="lease_organization_n" bindTarget="arch002_project_info_ds"  prompt="归档部门" readOnly="true"/>
+                                </a:hBox>
+
+                            </a:form>
+                        </a:case>
+                    </a:switch>
+                </a:case>
+            </a:switch>
+
+            <a:switch test="/parameter/@archive_flag">
+                <a:case value="N">
+                    <div style="display:flex;">
+                        <span style="font-size:20px;margin-left:10px;margin-top:1px;font-weight:bold;float:right;color:red;">无须档案归档！</span>
+                    </div>
+                </a:case>
+                <a:case value="*">
+                    <a:switch test="/parameter/@submit_from">
+                        <!--PRJ_PLAN 项目方案工作流-->
+                        <a:case value="PRJ_PLAN">
+                            <a:tabPanel marginHeight="40" marginWidth="25" id="prj_plan_tabs">
+                                <a:tabs>
+                                    <a:tab prompt="客户资信资料" id="bp_credit_info_id2" width="130">
+                                        <a:tabPanel height="400" marginWidth="50">
+                                            <a:tabs>
+                                                <a:tab prompt="归档材料清单" width="140">
+                                                    <a:grid id = "archive_file_grid1_id" bindTarget="archive_prj_plan_bp_ds" marginHeight="200" marginWidth="45" navBar="true">
+                                                        <a:toolBar>
+                                                            <a:button id = "save_btn1" type="save"/>
+                                                            <a:button id = "save_btn1_s" text="一键保存"  icon="${/request/@context_path}/leafresource/leaf.ui.std/hap/button/hlsgridsave.png" btnStyle="background-size: 16px" click="archive_prj_plan_bp_save"/>
+                                                        </a:toolBar>
+                                                        <a:columns>
+                                                            <a:column name="archive_status_desc" align="center" editor="archive_grid1_cb" width="80" prompt="归档状态"/>
+                                                            <a:column name="cdd_category" prompt="文件类型" width="80" />
+                                                            <a:column name="order_num"  prompt="序号" width="30"/>
+                                                            <a:column name="show_seq"  prompt="重要文件" width="100"/>
+                                                            <a:column name="cdd_class"  prompt="文件分类" width="120"/>
+                                                            <a:column name="bp_name"  prompt="商业伙伴名称" width="180"/>
+                                                            <a:column name="description"  prompt="归档范围（资料名称）" renderer="project_cdd_render_func" width="200"/>
+                                                            <a:column name="attachment"   prompt="附件" renderer="project_cdd_render_func" width="100"/>
+                                                            <a:column name="attach_file_name"  prompt="附件名" renderer="project_cdd_render_func" width="300"/>
+                                                            <a:column name="important_concerns"  prompt="文号" editor="archive_grid1_tf" width="100"/>
+                                                            <a:column name="sign_num"  prompt="份数" editor="archive_grid1_nf" width="100"/>
+                                                            <a:column name="arch_par_has_flag_desc"  prompt="归档形式" editor="archive_grid1_cb" width="100"/>
+                                                            <a:column name="investigate_guide_flag_n"  prompt="是否符合审查指引"  width="100"/>
+                                                            <a:column name="reason_alternative"  prompt="不符合原因或替代文件"  width="200"/>
+                                                            <a:column name="archive_date" prompt="归档日期" width="110" renderer="Leaf.formatDateTime"/>
+                                                            <a:column name="note" prompt="说明" width="200" editor="archive_grid1_tf"/>
+                                                            <a:column name="feedback" prompt="档案反馈" width="200" editor="archive_grid1_tf"/>
+                                                        </a:columns>
+                                                        <a:editors>
+                                                            <a:comboBox id="archive_grid1_cb"/>
+                                                            <a:textField id="archive_grid1_tf"/>
+                                                            <a:numberField id="archive_grid1_nf" allowDecimals="false"/>
+                                                        </a:editors>
+                                                    </a:grid>
+                                                </a:tab>
+                                            </a:tabs>
+                                        </a:tabPanel>
+                                    </a:tab>
+
+                                    <a:tab prompt="合规性材料" id="pro_report_info_id" width="130">
+                                        <a:tabPanel height="400" marginWidth="50">
+                                            <a:tabs>
+                                                <a:tab prompt="归档材料清单" width="140">
+                                                    <a:grid id = "archive_file_grid2_id" bindTarget="archive_compliance_materials_ds" marginHeight="200" marginWidth="45" navBar="true">
+                                                        <a:toolBar>
+                                                            <a:button id = "save_btn2" type="save"/>
+                                                            <a:button id = "save_btn2_s" text="一键保存" icon="${/request/@context_path}/leafresource/leaf.ui.std/hap/button/hlsgridsave.png" btnStyle="background-size: 16px" click="archive_compliance_materials_save"/>
+                                                        </a:toolBar>
+                                                        <a:columns>
+                                                            <a:column name="archive_status_desc" align="center" editor="archive_grid0_cb" width="80" prompt="归档状态"/>
+                                                            <a:column name="cdd_category" prompt="文件类型" width="80" />
+                                                            <a:column name="order_num"  prompt="序号" width="30"/>
+                                                            <a:column name="show_seq"  prompt="重要文件" width="100"/>
+                                                            <a:column name="cdd_class"  prompt="文件分类" width="120"/>
+                                                            <a:column name="description"  prompt="归档范围（资料名称）" renderer="project_cdd_render_func" width="200"/>
+                                                            <a:column name="attachment"   prompt="附件" renderer="project_cdd_render_func" width="100"/>
+                                                            <a:column name="attach_file_name"  prompt="附件名" renderer="project_cdd_render_func" width="300"/>
+                                                            <a:column name="important_concerns"  prompt="文号" editor="archive_grid0_tf" width="100"/>
+                                                            <a:column name="sign_num"  prompt="份数" editor="archive_grid0_nf" width="100"/>
+                                                            <a:column name="arch_par_has_flag_desc"  prompt="归档形式" editor="archive_grid0_cb" width="100"/>
+                                                            <a:column name="investigate_guide_flag_n"  prompt="是否符合审查指引"  width="100"/>
+                                                            <a:column name="reason_alternative"  prompt="不符合原因或替代文件"  width="200"/>
+                                                            <a:column name="archive_date" prompt="归档日期" width="110" renderer="Leaf.formatDate"/>
+                                                            <a:column name="note" prompt="说明" width="200" editor="archive_grid0_tf"/>
+                                                            <a:column name="feedback" prompt="档案反馈" width="200" editor="archive_grid0_tf"/>
+
+                                                        </a:columns>
+                                                        <a:editors>
+                                                            <a:comboBox id="archive_grid0_cb"/>
+                                                            <a:textField id="archive_grid0_tf"/>
+                                                            <a:numberField id="archive_grid0_nf" allowDecimals="false"/>
+                                                        </a:editors>
+                                                    </a:grid>
+                                                </a:tab>
+                                            </a:tabs>
+                                        </a:tabPanel>
+                                    </a:tab>
+                                </a:tabs>
+                            </a:tabPanel>
+                        </a:case>
+
+                        <!--PRJ_PLAN 项目方案工作流-->
+                        <a:case value="PRJ_PLAN_REPORT">
+                            <a:tabPanel marginHeight="40" marginWidth="25" id="prj_plan_report_tabs">
+                                <a:tabs>
+                                    <a:tab prompt="项目报告" id="plan_report_info_id" width="130">
+                                        <a:tabPanel height="400" marginWidth="50">
+                                            <a:tabs>
+                                                <a:tab prompt="归档材料清单" width="140">
+                                                    <a:grid id = "archive_file_grid3_id" bindTarget="archive_report_ds" marginHeight="200" marginWidth="45" navBar="true">
+                                                        <a:toolBar>
+                                                            <a:button id = "save_btn3" type="save"/>
+                                                            <a:button id = "save_btn3_s" text="一键保存" icon="${/request/@context_path}/leafresource/leaf.ui.std/hap/button/hlsgridsave.png" btnStyle="background-size: 16px"  click="archive_report_save"/>
+                                                        </a:toolBar>
+                                                        <a:columns>
+                                                            <a:column name="archive_status_desc" align="center" editor="archive_grid12_cb" width="80" prompt="归档状态"/>
+                                                            <a:column name="cdd_category" prompt="文件类型" width="80" />
+                                                            <a:column name="order_num"  prompt="序号" width="30"/>
+                                                            <a:column name="show_seq"  prompt="重要文件" width="100"/>
+                                                            <a:column name="cdd_class"  prompt="文件分类" width="120"/>
+                                                            <a:column name="description"  prompt="归档范围（资料名称）" renderer="project_cdd_render_func" width="200"/>
+                                                            <a:column name="attachment"   prompt="附件" renderer="project_cdd_render_func" width="100"/>
+                                                            <a:column name="attach_file_name"  prompt="附件名" renderer="project_cdd_render_func" width="300"/>
+                                                            <a:column name="important_concerns"  prompt="文号" editor="archive_grid12_tf" width="100"/>
+                                                            <a:column name="sign_num"  prompt="份数" editor="archive_grid12_nf" width="100"/>
+                                                            <a:column name="arch_par_has_flag_desc"  prompt="归档形式" editor="archive_grid12_cb" width="100"/>
+                                                            <a:column name="archive_date" prompt="归档日期" width="110" renderer="Leaf.formatDate"/>
+                                                            <a:column name="note" prompt="说明" width="200" editor="archive_grid12_tf"/>
+                                                            <a:column name="feedback" prompt="档案反馈" width="200" editor="archive_grid12_tf"/>
+                                                        </a:columns>
+                                                        <a:editors>
+                                                            <a:comboBox id="archive_grid12_cb"/>
+                                                            <a:textField id="archive_grid12_tf"/>
+                                                            <a:numberField id="archive_grid12_nf" allowDecimals="false"/>
+                                                        </a:editors>
+                                                    </a:grid>
+                                                </a:tab>
+                                            </a:tabs>
+                                        </a:tabPanel>
+                                    </a:tab>
+                                </a:tabs>
+                            </a:tabPanel>
+                        </a:case>
+
+                        <!--PAYMENT  付款先决条件落实审批流程-->
+                        <a:case value="PAYMENT">
+                            <a:tabPanel marginHeight="40" marginWidth="25">
+                                <a:tabs>
+                                    <a:tab prompt="放款前提材料" id="bp_credit_info_id" width="130">
+                                        <a:tabPanel height="400" marginWidth="50">
+                                            <a:tabs>
+                                                <a:tab prompt="归档材料清单" width="140">
+                                                    <a:grid id = "archive_file_grid4_id" bindTarget="archive_payment_ds" marginHeight="200" marginWidth="45" navBar="true">
+                                                        <a:toolBar>
+                                                            <a:button id="save_btn4" type="save"/>
+                                                            <a:button id="save_btn4_s" text="一键保存" icon="${/request/@context_path}/leafresource/leaf.ui.std/hap/button/hlsgridsave.png" btnStyle="background-size: 16px" click="archive_payment_save"/>
+                                                        </a:toolBar>
+                                                        <a:columns>
+                                                            <a:column name="archive_status_desc" align="center" editor="archive_grid8_cb" width="80" prompt="归档状态"/>
+                                                            <a:column name="cdd_category" prompt="文件类型" width="80" />
+                                                            <a:column name="order_num"  prompt="序号" width="30"/>
+                                                            <a:column name="show_seq"  prompt="重要文件" width="100"/>
+                                                            <a:column name="cdd_class"  prompt="文件分类" width="120"/>
+                                                            <a:column name="description"  prompt="归档范围（资料名称）" renderer="project_cdd_render_func" width="200"/>
+                                                            <a:column name="attachment_payment2"   prompt="附件" renderer="payment_cdd_render_func" width="100"/>
+                                                            <a:column name="file_name"  prompt="附件名" renderer="payment_cdd_render_func" width="300"/>
+                                                            <a:column name="important_concerns"  prompt="文号" editor="archive_grid8_tf" width="100"/>
+                                                            <a:column name="sign_num"  prompt="份数" editor="archive_grid8_nf" width="100"/>
+                                                            <a:column name="arch_par_has_flag_desc"  prompt="归档形式" editor="archive_grid8_cb" width="100"/>
+                                                            <a:column name="archive_date" prompt="归档日期" width="110" renderer="Leaf.formatDate"/>
+                                                            <a:column name="note" prompt="说明" width="200" editor="archive_grid8_tf"/>
+                                                            <a:column name="feedback" prompt="档案反馈" width="200" editor="archive_grid8_tf"/>
+                                                        </a:columns>
+                                                        <a:editors>
+                                                            <a:comboBox id="archive_grid8_cb"/>
+                                                            <a:textField id="archive_grid8_tf"/>
+                                                            <a:numberField id="archive_grid8_nf" allowDecimals="false"/>
+                                                        </a:editors>
+                                                    </a:grid>
+                                                </a:tab>
+                                            </a:tabs>
+                                        </a:tabPanel>
+                                    </a:tab>
+                                </a:tabs>
+                            </a:tabPanel>
+                        </a:case>
+
+                        <!--SIGN 合同审批以及签约工作流-->
+                        <a:case value="SIGN">
+                            <a:tabPanel marginHeight="40" marginWidth="25">
+                                <a:tabs>
+                                    <a:tab prompt="签约执行材料" id="bp_credit_info_id" width="130">
+                                        <a:tabPanel height="400" marginWidth="50">
+                                            <a:tabs>
+                                                <a:tab prompt="归档材料清单" width="140">
+                                                    <a:grid id = "archive_file_grid5_id" bindTarget="archive_contract_sign_ds" marginHeight="200" marginWidth="45" navBar="true">
+                                                        <a:toolBar>
+                                                            <a:button id="save_btn5" type="save"/>
+                                                            <a:button id="save_btn5_s" text="一键保存" icon="${/request/@context_path}/leafresource/leaf.ui.std/hap/button/hlsgridsave.png" btnStyle="background-size: 16px" click="archive_contract_sign_save"/>
+                                                        </a:toolBar>
+                                                        <a:columns>
+                                                            <a:column name="archive_status_desc" align="center" editor="archive_grid9_cb" width="80" prompt="归档状态"/>
+                                                            <a:column name="cdd_category" prompt="文件类型" width="80" />
+                                                            <a:column name="order_num"  prompt="序号" width="30"/>
+                                                            <a:column name="show_seq"  prompt="重要文件" width="100"/>
+                                                            <a:column name="cdd_class"  prompt="文件分类" width="120"/>
+                                                            <a:column name="description"  prompt="归档范围（资料名称）" renderer="project_cdd_render_func" width="200"/>
+                                                            <a:column name="attachment"   prompt="附件" renderer="project_cdd_render_func" width="100"/>
+                                                            <a:column name="attach_file_name"  prompt="附件名" renderer="project_cdd_render_func" width="300"/>
+                                                            <a:column name="important_concerns"  prompt="文号" editor="archive_grid9_tf" width="100"/>
+                                                            <a:column name="sign_num"  prompt="份数" editor="archive_grid9_nf" width="100"/>
+                                                            <a:column name="arch_par_has_flag_desc"  prompt="归档形式" editor="archive_grid9_cb" width="100"/>
+                                                            <a:column name="archive_date" prompt="归档日期" width="110" renderer="Leaf.formatDate"/>
+                                                            <a:column name="note" prompt="说明" width="200" editor="archive_grid9_tf"/>
+                                                            <a:column name="feedback" prompt="档案反馈" width="200" editor="archive_grid9_tf"/>
+                                                        </a:columns>
+                                                        <a:editors>
+                                                            <a:comboBox id="archive_grid9_cb"/>
+                                                            <a:textField id="archive_grid9_tf"/>
+                                                            <a:numberField id="archive_grid9_nf" allowDecimals="false"/>
+                                                        </a:editors>
+                                                    </a:grid>
+                                                </a:tab>
+                                            </a:tabs>
+                                        </a:tabPanel>
+                                    </a:tab>
+                                </a:tabs>
+                            </a:tabPanel>
+                        </a:case>
+
+                        <!--项目方案变更-->
+                        <a:case value="PRJ_PLAN_CHANGE">
+                            <a:tabPanel marginHeight="40" marginWidth="25" id="prj_change_tabs">
+                                <a:tabs>
+                                    <a:tab prompt="客户资信资料" id="bp_credit_info_id" width="130">
+                                        <a:tabPanel height="400" marginWidth="50">
+                                            <a:tabs>
+                                                <a:tab prompt="归档材料清单" width="140">
+                                                    <a:grid id = "archive_file_grid6_id" bindTarget="archive_prj_change_bp_ds" marginHeight="200" marginWidth="45" navBar="true">
+                                                        <a:toolBar>
+                                                            <a:button id = "save_btn6" type="save"/>
+                                                            <a:button id = "save_btn6_s" type="archive_prj_change_bp_save" text="一键保存" icon="${/request/@context_path}/leafresource/leaf.ui.std/hap/button/hlsgridsave.png" btnStyle="background-size: 16px"/>
+                                                        </a:toolBar>
+                                                        <a:columns>
+                                                            <a:column name="archive_status_desc" align="center" editor="archive_grid1_cb" width="80" prompt="归档状态"/>
+                                                            <a:column name="cdd_category" prompt="文件类型" width="80" />
+                                                            <a:column name="order_num"  prompt="序号" width="30"/>
+                                                            <a:column name="show_seq"  prompt="重要文件" width="100"/>
+                                                            <a:column name="cdd_class"  prompt="文件分类" width="120"/>
+                                                            <a:column name="description"  prompt="归档范围（资料名称）" renderer="project_cdd_render_func" width="200"/>
+                                                            <a:column name="attachment"   prompt="附件" renderer="project_cdd_render_func" width="100"/>
+                                                            <a:column name="attach_file_name"  prompt="附件名" renderer="project_cdd_render_func" width="300"/>
+                                                            <a:column name="important_concerns"  prompt="文号" editor="archive_grid1_tf" width="100"/>
+                                                            <a:column name="sign_num"  prompt="份数" editor="archive_grid1_nf" width="100"/>
+                                                            <a:column name="arch_par_has_flag_desc"  prompt="归档形式" editor="archive_grid1_cb" width="100"/>
+                                                            <a:column name="archive_date" prompt="归档日期" width="110" renderer="Leaf.formatDate"/>
+                                                            <a:column name="note" prompt="说明" width="200" editor="archive_grid1_tf"/>
+                                                            <a:column name="feedback" prompt="档案反馈" width="200" editor="archive_grid1_tf"/>
+
+                                                        </a:columns>
+                                                        <a:editors>
+                                                            <a:comboBox id="archive_grid1_cb"/>
+                                                            <a:textField id="archive_grid1_tf"/>
+                                                            <a:numberField id="archive_grid1_nf" allowDecimals="false"/>
+                                                        </a:editors>
+                                                    </a:grid>
+                                                </a:tab>
+                                            </a:tabs>
+                                        </a:tabPanel>
+                                    </a:tab>
+
+                                    <a:tab prompt="合规性材料" id="change_report_info_id" width="130">
+                                        <a:tabPanel height="400" marginWidth="50">
+                                            <a:tabs>
+                                                <a:tab prompt="归档材料清单" width="140">
+                                                    <a:grid id = "archive_file_grid7_id" bindTarget="archive_compliance_materials_ds" marginHeight="200" marginWidth="45" navBar="true">
+                                                        <a:toolBar>
+                                                            <a:button id = "save_btn7" type="save"/>
+                                                            <a:button id = "save_btn7_s" text="一键保存" icon="${/request/@context_path}/leafresource/leaf.ui.std/hap/button/hlsgridsave.png" btnStyle="background-size: 16px" click="archive_compliance_materials_save"/>
+                                                        </a:toolBar>
+                                                        <a:columns>
+                                                            <a:column name="archive_status_desc" align="center" editor="archive_grid12_cb" width="80" prompt="归档状态"/>
+                                                            <a:column name="cdd_category" prompt="文件类型" width="80" />
+                                                            <a:column name="order_num"  prompt="序号" width="30"/>
+                                                            <a:column name="show_seq"  prompt="重要文件" width="100"/>
+                                                            <a:column name="cdd_class"  prompt="文件分类" width="120"/>
+                                                            <a:column name="description"  prompt="归档范围（资料名称）" renderer="project_cdd_render_func" width="200"/>
+                                                            <a:column name="attachment"   prompt="附件" renderer="project_cdd_render_func" width="100"/>
+                                                            <a:column name="attach_file_name"  prompt="附件名" renderer="project_cdd_render_func" width="300"/>
+                                                            <a:column name="important_concerns"  prompt="文号" editor="archive_grid12_tf" width="100"/>
+                                                            <a:column name="sign_num"  prompt="份数" editor="archive_grid12_nf" width="100"/>
+                                                            <a:column name="arch_par_has_flag_desc"  prompt="归档形式" editor="archive_grid12_cb" width="100"/>
+                                                            <a:column name="archive_date" prompt="归档日期" width="110" renderer="Leaf.formatDate"/>
+                                                            <a:column name="note" prompt="说明" width="200" editor="archive_grid12_tf"/>
+                                                            <a:column name="feedback" prompt="档案反馈" width="200" editor="archive_grid12_tf"/>
+                                                        </a:columns>
+                                                        <a:editors>
+                                                            <a:comboBox id="archive_grid12_cb"/>
+                                                            <a:textField id="archive_grid12_tf"/>
+
+                                                            <a:numberField id="archive_grid12_nf" allowDecimals="false"/>
+                                                        </a:editors>
+                                                    </a:grid>
+                                                </a:tab>
+                                            </a:tabs>
+                                        </a:tabPanel>
+                                    </a:tab>
+                                </a:tabs>
+                            </a:tabPanel>
+                        </a:case>
+
+                        <!--项目方案变更 项目报告-->
+                        <a:case value="PRJ_PLAN_REPORT_CHANGE_A">
+                            <a:tabPanel marginHeight="40" marginWidth="25" id="prj_change_tabs">
+                                <a:tabs>
+                                    <a:tab prompt="项目报告" id="change_report_info_id" width="130">
+                                        <a:tabPanel height="400" marginWidth="50">
+                                            <a:tabs>
+                                                <a:tab prompt="归档材料清单" width="140">
+                                                    <a:grid id = "archive_file_grid8_id" bindTarget="archive_report_ds" marginHeight="200" marginWidth="45" navBar="true">
+                                                        <a:toolBar>
+                                                            <a:button id = "save_btn8" type="save"/>
+                                                            <a:button id = "save_btn8_s" click="archive_report_save" text="一键保存" icon="${/request/@context_path}/leafresource/leaf.ui.std/hap/button/hlsgridsave.png" btnStyle="background-size: 16px"/>
+                                                        </a:toolBar>
+                                                        <a:columns>
+                                                            <a:column name="archive_status_desc" align="center" editor="archive_grid14_cb" width="80" prompt="归档状态"/>
+                                                            <a:column name="cdd_category" prompt="文件类型" width="80" />
+                                                            <a:column name="order_num"  prompt="序号" width="30"/>
+                                                            <a:column name="show_seq"  prompt="重要文件" width="100"/>
+                                                            <a:column name="cdd_class"  prompt="文件分类" width="120"/>
+                                                            <a:column name="description"  prompt="归档范围（资料名称）" renderer="project_cdd_render_func" width="200"/>
+                                                            <a:column name="attachment"   prompt="附件" renderer="project_cdd_render_func" width="100"/>
+                                                            <a:column name="attach_file_name"  prompt="附件名" renderer="project_cdd_render_func" width="300"/>
+                                                            <a:column name="important_concerns"  prompt="文号" editor="archive_grid14_tf" width="100"/>
+                                                            <a:column name="sign_num"  prompt="份数" editor="archive_grid14_nf" width="100"/>
+                                                            <a:column name="arch_par_has_flag_desc"  prompt="归档形式" editor="archive_grid14_cb" width="100"/>
+                                                            <a:column name="archive_date" prompt="归档日期" width="110" renderer="Leaf.formatDate"/>
+                                                            <a:column name="note" prompt="说明" width="200" editor="archive_grid14_tf"/>
+                                                            <a:column name="feedback" prompt="档案反馈" width="200" editor="archive_grid14_tf"/>
+                                                        </a:columns>
+                                                        <a:editors>
+                                                            <a:comboBox id="archive_grid14_cb"/>
+                                                            <a:textField id="archive_grid14_tf"/>
+                                                            <a:numberField id="archive_grid14_nf" allowDecimals="false"/>
+                                                        </a:editors>
+                                                    </a:grid>
+                                                </a:tab>
+                                            </a:tabs>
+                                        </a:tabPanel>
+                                    </a:tab>
+                                </a:tabs>
+                            </a:tabPanel>
+                        </a:case>
+
+                        <a:case value="PRJ_PLAN_REPORT_CHANGE_B">
+                            <a:tabPanel marginHeight="40" marginWidth="25" id="prj_change_tabs">
+                                <a:tabs>
+                                    <a:tab prompt="项目报告" id="change_report_info_id" width="130">
+                                        <a:tabPanel height="400" marginWidth="50">
+                                            <a:tabs>
+                                                <a:tab prompt="归档材料清单" width="140">
+                                                    <a:grid id = "archive_file_grid9_id" bindTarget="archive_report_ds" marginHeight="200" marginWidth="45" navBar="true">
+                                                        <a:toolBar>
+                                                            <a:button id = "save_btn9" type="save"/>
+                                                            <a:button id = "save_btn9_s" click="archive_report_save" text="一键保存" icon="${/request/@context_path}/leafresource/leaf.ui.std/hap/button/hlsgridsave.png" btnStyle="background-size: 16px"/>
+                                                        </a:toolBar>
+                                                        <a:columns>
+                                                            <a:column name="archive_status_desc" align="center" editor="archive_grid14_cb" width="80" prompt="归档状态"/>
+                                                            <a:column name="cdd_category" prompt="文件类型" width="80" />
+                                                            <a:column name="order_num"  prompt="序号" width="30"/>
+                                                            <a:column name="show_seq"  prompt="重要文件" width="100"/>
+                                                            <a:column name="cdd_class"  prompt="文件分类" width="120"/>
+                                                            <a:column name="description"  prompt="归档范围（资料名称）" renderer="project_cdd_render_func" width="200"/>
+                                                            <a:column name="attachment"   prompt="附件" renderer="project_cdd_render_func" width="100"/>
+                                                            <a:column name="attach_file_name"  prompt="附件名" renderer="project_cdd_render_func" width="300"/>
+                                                            <a:column name="important_concerns"  prompt="文号" editor="archive_grid14_tf" width="100"/>
+                                                            <a:column name="sign_num"  prompt="份数" editor="archive_grid14_nf" width="100"/>
+                                                            <a:column name="arch_par_has_flag_desc"  prompt="归档形式" editor="archive_grid14_cb" width="100"/>
+                                                            <a:column name="archive_date" prompt="归档日期" width="110" renderer="Leaf.formatDate"/>
+                                                            <a:column name="note" prompt="说明" width="200" editor="archive_grid14_tf"/>
+                                                            <a:column name="feedback" prompt="档案反馈" width="200" editor="archive_grid14_tf"/>
+
+                                                        </a:columns>
+                                                        <a:editors>
+                                                            <a:comboBox id="archive_grid14_cb"/>
+                                                            <a:textField id="archive_grid14_tf"/>
+                                                            <a:numberField id="archive_grid14_nf" allowDecimals="false"/>
+                                                        </a:editors>
+                                                    </a:grid>
+                                                </a:tab>
+                                            </a:tabs>
+                                        </a:tabPanel>
+                                    </a:tab>
+                                </a:tabs>
+                            </a:tabPanel>
+                        </a:case>
+                    </a:switch>
+                </a:case>
+            </a:switch>
+        </a:screenBody>
+        <script><![CDATA[
+
+        ]]></script>
+        <a:screen-include screen="modules/simple/simple_util.lview"/>
+    </a:view>
+</a:screen>
Index: src/main/resources/leaf_static/modules/acrch/ARCHIVE003/archive_auto_file_detail.lview
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/acrch/ARCHIVE003/archive_auto_file_detail.lview b/src/main/resources/leaf_static/modules/acrch/ARCHIVE003/archive_auto_file_detail.lview
new file mode 100644
--- /dev/null	(revision 30e975a9b726d3d5f6018efede0d5ac008e8fae6)
+++ b/src/main/resources/leaf_static/modules/acrch/ARCHIVE003/archive_auto_file_detail.lview	(revision 30e975a9b726d3d5f6018efede0d5ac008e8fae6)
@@ -0,0 +1,683 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!--
+    $Author: zc
+    $Date: 2018-09-18 10:46:02
+    $Revision: 1.0
+    $Purpose: 档案归档附件
+-->
+<a:screen xmlns:c="leaf.application.action" xmlns:a="http://www.leaf-framework.org/application" xmlns:p="uncertain.proc" trace="true">
+    <a:init-procedure>
+        <a:model-query defaultWhereClause="t1.archive_batch_id=${/parameter/@archive_batch_id}" model="acrch.ARCHIVE002.arch002_project_info" rootPath="project_path"/>
+    </a:init-procedure>
+    <a:view>
+        <a:link id="arch002_cdd_uploadFile_id" url="${/request/@context_path}/uploadFile.lview"/>
+        <a:link id="arch002_cdd_downloadFile_id" url="${/request/@context_path}/downloadFile.lview"/>
+        <script><![CDATA[
+        function contract_screen_quit() {
+            $('prj_archive_auto_file_detail_winid').close();
+        }
+        function open_cdd_attachment_window(record_id, ds_id,check_id) {
+            let record = $(ds_id).findById(record_id);
+            if (check_id) {
+                let query_flag='${/parameter/@function_usage}';
+                let url_id;
+                if (query_flag === 'MODIFY') {
+                    url_id = $('arch002_cdd_uploadFile_id').getUrl();
+                } else {
+                    url_id = $('arch002_cdd_downloadFile_id').getUrl();
+                }
+                url = url_id + '?table_name=PRJ_CDD_ITEM_CHECK&header_id=' + check_id;
+                let win = new Leaf.Window({
+                    url: url,
+                    title: '${l:HLS.SUPPORTING_DOCUMENT}',
+                    id: 'wfl_cdd_loadFile_screen_id',
+                    width: 850,
+                    height: 400
+                });
+                win.on('close', function() {
+                    record.ds.query();
+                });
+            } else {
+                Leaf.showMessage('${l:HLS.PROMPT}', '请先保存!');
+            }
+        }
+
+        //商业伙伴附件记录
+        function open_bp_attachment_window(hn_record_id) {
+            if (hn_record_id) {
+                var url = $('arch002_cdd_downloadFile_id').getUrl() + '?table_name=HN_BP_ATTACHMENT_RECORD&header_id=' + record.get('hn_record_id');
+                var win = new Leaf.Window({
+                    url: url,
+                    title: '${l:HLS.SUPPORTING_DOCUMENT}',
+                    id: 'hn_project_bp_attachtment_record_id',
+                    width: 850,
+                    height: 400
+                });
+            }
+        };
+
+        function upload_file(check_id) {
+            if (check_id) {
+                var url;
+                var query_flag='${/parameter/@function_usage}';
+                if (query_flag === 'MODIFY') {
+                    url = $('arch002_cdd_uploadFile_id').getUrl() + '?table_name=PRJ_CDD_ITEM_CHECK&header_id=' + check_id;
+                } else {
+                    url = $('arch002_cdd_downloadFile_id').getUrl() + '?table_name=PRJ_CDD_ITEM_CHECK&header_id=' + check_id;
+                }
+                var win = new Leaf.Window({
+                    url: url,
+                    title: '${l:HLS.SUPPORTING_DOCUMENT}',
+                    id: 'arch002_cdd_uploadFile_screen_id',
+                    width: 850,
+                    height: 400
+                });
+                win.on('close', function() {
+                    record.ds.query();
+                });
+            } else {
+                Leaf.showMessage('${l:HLS.PROMPT}', '请先保存!');
+            }
+        }
+
+        function project_cdd_render_func(value, record, name) {
+            if (name === 'attachment') {
+                return '<a href="javascript:open_cdd_attachment_window(\'' + record.id + '\',\'' + record.ds.id + '\',' + record.get('check_id') + ');">附件</a>';
+            } else if (name === 'attach_file_name') {
+                if (value != null) {
+                    let link = '${/request/@context_path}/atm_download.lsc?attachment_id=';
+                    let str = value.split(';;');
+                    let url = '';
+                    for (let i = 0;i < str.length;i++) {
+                        let temp = str[i].split('--');
+                        if (!Leaf.isEmpty(temp[0])) {
+                            url = url + '<a href=' + link + temp[1] + '>' + temp[0] + '</a>' + ',';
+                        }
+                    }
+                    return url;
+                }
+            }
+            else if(name === 'description') {
+                return value;
+            }else if (name === 'bp_attachment') {
+                return '<a href="javascript:open_bp_attachment_window(' + record.get('hn_record_id') + ');">附件</a>';
+            }
+            else if(name === 'seq_num'){
+                return $(record.ds.id).indexOf(record) + 1
+            }
+        }
+
+
+        function payment_cdd_render_func(value, record, name) {
+            var condition_id=record.get('condition_id');
+            if (name=='attachment_payment2'){
+                return '<a href="javascript:open_payment_attachment_window2(\'' + condition_id+ '\');">附件</a>';
+            }
+            else{
+                return '<a href="javascript:open_payment_attachment_window(\'' + condition_id+ '\');">'+value+'</a>';
+            }
+        }
+
+        function open_payment_attachment_window(condition_id) {
+
+            var url = $('arch002_cdd_downloadFile_id').getUrl();
+            var win = new Leaf.Window({
+                url: url,
+                title: '${l:HLS.SUPPORTING_DOCUMENT}',
+                params: {
+                    'table_name': 'HN_CON_PAYMENT_CONDITIONS',
+                    'header_id': condition_id
+                },
+                width: 850,
+                height: 400
+            }).on('close',function(){
+                $('archive_payment_cdd_result_ds').query();
+            });
+        }
+
+        function open_payment_attachment_window2(condition_id) {
+            var query_flag='${/parameter/@function_usage}';
+            let url = query_flag === 'MODIFY'?$('arch002_cdd_uploadFile_id').getUrl():$('arch002_cdd_downloadFile_id').getUrl()
+            var win = new Leaf.Window({
+                url: url,
+                title: '${l:HLS.SUPPORTING_DOCUMENT}',
+                params: {
+                    'table_name': 'HN_CON_PAYMENT_CONDITIONS_NEW',
+                    'header_id': condition_id
+                },
+                width: 850,
+                height: 400
+            }).on('close',function(){
+                $('archive_payment_cdd_result_ds').query();
+            });
+        }
+
+
+        function pro_report_load(ds){
+            ds.getAll().forEach(record =>{
+                if(!record.get("cdd_category")){
+                    record.set("cdd_category", "要件类")
+                }
+            })
+        }
+
+        Leaf.onReady(()=>{
+            sp_output_view_parameter('${/parameter/}')
+        })
+
+
+
+        ]]></script>
+        <a:screen-include screen="modules/cont/CON500/con_contract_get_layout_code.lview"/>
+        <a:screen-include screen="modules/simple/simple_util.lview"/>
+        <a:dataSets>
+            <a:dataSet id="yes_no_ds" lookupCode="YES_NO"/>
+            <a:dataSet id="arch002_project_info_ds">
+                <a:datas dataSource="/model/project_path"/>
+            </a:dataSet>
+            <!--客户资信资料 => 项目方案-->
+            <a:dataSet id="archive_bp_cdd_result_ds" autoQuery="true" fetchAll="true"
+                       model="acrch.ARCHIVE002.server_layout_doc_cdd_item" pageSize="11"
+                       queryUrl="${/request/@context_path}/autocrud/acrch.ARCHIVE002.server_layout_doc_cdd_item/query?base_table_pk=${/parameter/@archive_batch_id}&amp;document_table=FILE_ARCHIVE_BATCH&amp;cdd_list_id=${/model/project_path/record/@arch_cdd_list_id}&amp;attachment_tab_group=TENANT&amp;fix_category=MANAGER&amp;arch_not_required_flag=N"
+                       selectable="true">
+                <a:fields>
+                    <a:field name="note"/>
+                    <a:field name="description"/>
+                    <a:field name="arch_required_flag" readOnly="true"/>
+                    <a:field name="arch_required_flag_desc" readOnly="true" displayField="code_value_name" options="yes_no_ds" returnField="arch_required_flag" valueField="code_value"/>
+                    <a:field name="arch_par_has_flag" readOnly="true"/>
+                    <a:field name="arch_par_has_flag_desc" readOnly="true" displayField="code_value_name" options="yes_no_ds" returnField="arch_par_has_flag" valueField="code_value"/>
+                    <a:field name="arch_paper_required_flag" readOnly="true"/>
+                    <a:field name="arch_paper_required_flag_desc" readOnly="true" displayField="code_value_name" options="yes_no_ds" returnField="arch_paper_required_flag" valueField="code_value"/>
+                    <a:field name="receive_flag" readOnly="true"/>
+                    <a:field name="receive_flag_desc" readOnly="true" displayField="code_value_name" options="yes_no_ds" returnField="receive_flag" valueField="code_value"/>
+                </a:fields>
+            </a:dataSet>
+
+
+            <!--放款前提材料 => 付款先决落实-->
+            <a:dataSet id="archive_payment_cdd_result_ds" autoQuery="true" fetchAll="true"
+                       model="csh.CSH900.hn_con_payment_conditions_detail_new" pageSize="11"
+                       queryUrl="${/request/@context_path}/autocrud/csh.CSH900.hn_con_payment_conditions_detail_new/query?archive_batch_id=${/parameter/@archive_batch_id}"
+                       selectable="true">
+                <a:fields>
+                    <a:field name="note"/>
+                    <a:field name="description"/>
+                    <a:field name="arch_required_flag"/>
+                    <a:field name="arch_required_flag_desc" displayField="code_value_name" options="yes_no_ds" returnField="arch_required_flag" valueField="code_value"/>
+                    <a:field name="arch_par_has_flag"/>
+                    <a:field name="arch_par_has_flag_desc" displayField="code_value_name" options="yes_no_ds" returnField="arch_par_has_flag" valueField="code_value"/>
+                    <a:field name="arch_paper_required_flag"/>
+                    <a:field name="arch_paper_required_flag_desc" displayField="code_value_name" options="yes_no_ds" returnField="arch_paper_required_flag" valueField="code_value"/>
+                    <a:field name="receive_flag"/>
+                    <a:field name="receive_flag_desc" displayField="code_value_name" options="yes_no_ds" returnField="receive_flag" valueField="code_value"/>
+                </a:fields>
+            </a:dataSet>
+
+            <!--签约执行材料 => 合同签约-->
+            <a:dataSet id="archive_sign_cdd_result_ds" autoQuery="true" fetchAll="true"
+                       model="acrch.ARCHIVE002.server_layout_doc_cdd_item" pageSize="11"
+                       queryUrl="${/request/@context_path}/autocrud/acrch.ARCHIVE002.server_layout_doc_cdd_item/query?base_table_pk=${/parameter/@archive_batch_id}&amp;document_table=FILE_ARCHIVE_BATCH&amp;cdd_list_id=${/model/project_path/record/@arch_cdd_list_id}&amp;attachment_tab_group=SIGN&amp;arch_not_required_flag=N"
+                       selectable="true">
+                <a:fields>
+                    <a:field name="note"/>
+                    <a:field name="description"/>
+                    <a:field name="arch_required_flag"/>
+                    <a:field name="arch_required_flag_desc" displayField="code_value_name" options="yes_no_ds" returnField="arch_required_flag" valueField="code_value"/>
+                    <a:field name="arch_par_has_flag"/>
+                    <a:field name="arch_par_has_flag_desc" displayField="code_value_name" options="yes_no_ds" returnField="arch_par_has_flag" valueField="code_value"/>
+                    <a:field name="arch_paper_required_flag"/>
+                    <a:field name="arch_paper_required_flag_desc" displayField="code_value_name" options="yes_no_ds" returnField="arch_paper_required_flag" valueField="code_value"/>
+                    <a:field name="receive_flag"/>
+                    <a:field name="receive_flag_desc" displayField="code_value_name" options="yes_no_ds" returnField="receive_flag" valueField="code_value"/>
+                </a:fields>
+            </a:dataSet>
+
+            <!--合规性材料 => 项目方案&项目方案变更-->
+            <a:dataSet id="pro_report_cdd_result_ds" autoQuery="true" fetchAll="true"
+                       model="acrch.ARCHIVE002.server_layout_doc_cdd_item" pageSize="11"
+                       queryUrl="${/request/@context_path}/autocrud/acrch.ARCHIVE002.server_layout_doc_cdd_item/query?base_table_pk=${/parameter/@archive_batch_id}&amp;document_table=FILE_ARCHIVE_BATCH&amp;cdd_list_id=${/model/project_path/record/@arch_cdd_list_id}&amp;attachment_tab_group=PROJECT&amp;fix_category=REQUIREMENT&amp;arch_not_required_flag=N"
+                       selectable="true">
+                <a:fields>
+                    <a:field name="note"/>
+                    <a:field name="description"/>
+                    <a:field name="arch_required_flag" readOnly="true"/>
+                    <a:field name="arch_required_flag_desc" readOnly="true" displayField="code_value_name" options="yes_no_ds" returnField="arch_required_flag" valueField="code_value"/>
+                    <a:field name="arch_par_has_flag" defaultValue="Y"/>
+                    <a:field name="arch_par_has_flag_desc" displayField="code_value_name" options="yes_no_ds" returnField="arch_par_has_flag" valueField="code_value"/>
+                    <a:field name="arch_paper_required_flag"/>
+                    <a:field name="arch_paper_required_flag_desc" displayField="code_value_name" options="yes_no_ds" returnField="arch_paper_required_flag" valueField="code_value"/>
+                    <a:field name="receive_flag" defaultValue="Y"/>
+                    <a:field name="receive_flag_desc" displayField="code_value_name" options="yes_no_ds" returnField="receive_flag" valueField="code_value"/>
+                </a:fields>
+            </a:dataSet>
+
+            <!--项目报告 => 项目方案&项目方案变更-->
+            <a:dataSet id="prj_report_cdd_result_ds" autoQuery="true" fetchAll="true"
+                       model="acrch.ARCHIVE002.server_layout_doc_cdd_item" pageSize="11"
+                       queryUrl="${/request/@context_path}/autocrud/acrch.ARCHIVE002.server_layout_doc_cdd_item/query?base_table_pk=${/parameter/@archive_batch_id}&amp;document_table=FILE_ARCHIVE_BATCH&amp;cdd_list_id=${/model/project_path/record/@arch_cdd_list_id}&amp;arch_not_required_flag=N&amp;attachment_tab_group=PRJ_CHANGE"
+                       selectable="true">
+                <a:fields>
+                    <a:field name="note"/>
+                    <a:field name="description"/>
+                    <a:field name="arch_required_flag" readOnly="true"/>
+                    <a:field name="arch_required_flag_desc" readOnly="true" displayField="code_value_name" options="yes_no_ds" returnField="arch_required_flag" valueField="code_value"/>
+                    <a:field name="arch_par_has_flag" defaultValue="Y"/>
+                    <a:field name="arch_par_has_flag_desc" displayField="code_value_name" options="acrch_type_ds" returnField="arch_par_has_flag" valueField="code_value"/>
+                    <a:field name="arch_paper_required_flag"/>
+                    <a:field name="arch_paper_required_flag_desc" displayField="code_value_name" options="yes_no_ds" returnField="arch_paper_required_flag" valueField="code_value"/>
+                    <a:field name="receive_flag" defaultValue="Y"/>
+                    <a:field name="receive_flag_desc" displayField="code_value_name" options="yes_no_ds" returnField="receive_flag" valueField="code_value"/>
+                </a:fields>
+            </a:dataSet>
+        </a:dataSets>
+        <a:screenBody>
+            <a:screenTopToolbar>
+                <a:gridButton click="contract_screen_quit" text="HLS.EXIT"/>
+            </a:screenTopToolbar>
+            <a:switch test="/parameter/@submit_from">
+                <a:case value="SIGN">
+                    <a:form marginWidth="25" title="基本信息">
+                        <a:hBox labelWidth="100">
+                            <a:textField name="bp_id_tenant_n" bindTarget="arch002_project_info_ds" prompt="承租人名称" width="200" readOnly="true"/>
+                            <a:textField name="contract_number" bindTarget="arch002_project_info_ds" prompt="合同编号" readOnly="true"/>
+                            <a:textField name="virtual_con_name" bindTarget="arch002_project_info_ds" prompt="合同名称" readOnly="true" width="250"/>
+                            <a:textField name="submit_by" bindTarget="arch002_project_info_ds" prompt="归档责任人" readOnly="true"/>
+                            <a:textField name="lease_organization_n" bindTarget="arch002_project_info_ds"  prompt="归档部门" readOnly="true"/>
+                        </a:hBox>
+                    </a:form>
+                </a:case>
+                <a:case value="PAYMENT">
+                    <a:form marginWidth="25" title="基本信息">
+                        <a:hBox labelWidth="100">
+                            <a:textField name="bp_id_tenant_n" bindTarget="arch002_project_info_ds" prompt="承租人名称" width="200" readOnly="true"/>
+                            <a:textField name="project_number" bindTarget="arch002_project_info_ds" prompt="项目编号" readOnly="true"/>
+                            <a:textField name="project_name" bindTarget="arch002_project_info_ds" prompt="项目名称" readOnly="true" width="250"/>
+                            <a:textField name="submit_by" bindTarget="arch002_project_info_ds" prompt="归档责任人" readOnly="true"/>
+                            <a:textField name="lease_organization_n" bindTarget="arch002_project_info_ds"  prompt="归档部门" readOnly="true"/>
+                        </a:hBox>
+                    </a:form>
+                </a:case>
+
+                <a:case value="*">
+                    <a:form marginWidth="25" title="基本信息">
+                        <a:hBox labelWidth="100">
+                            <a:textField name="bp_id_tenant_n" bindTarget="arch002_project_info_ds" prompt="承租人名称" width="200" readOnly="true"/>
+                            <a:textField name="plan_number" bindTarget="arch002_project_info_ds" prompt="项目方案编号" readOnly="true"/>
+                            <a:textField name="plan_name" bindTarget="arch002_project_info_ds" prompt="项目方案名称" readOnly="true" width="250"/>
+                            <a:textField name="submit_by" bindTarget="arch002_project_info_ds" prompt="归档责任人" readOnly="true"/>
+                            <a:textField name="lease_organization_n" bindTarget="arch002_project_info_ds"  prompt="归档部门" readOnly="true"/>
+                        </a:hBox>
+                    </a:form>
+                </a:case>
+            </a:switch>
+            <a:switch test="/parameter/@submit_from">
+                <!--PRJ_PLAN 项目方案工作流-->
+                <a:case value="PRJ_PLAN">
+                    <a:tabPanel marginHeight="40" marginWidth="25">
+                        <a:tabs>
+                            <a:tab prompt="客户资信资料" id="bp_credit_info_id" width="130">
+                                <a:tabPanel height="400" marginWidth="50">
+                                    <a:tabs>
+                                        <a:tab prompt="归档材料清单" width="140">
+                                            <a:grid id = "archive_file_grid1_id" bindTarget="archive_bp_cdd_result_ds" marginHeight="200" marginWidth="45" navBar="true">
+                                                <a:columns>
+                                                    <a:column name="archive_status_n"  prompt="归档状态" width="80"/>
+                                                    <a:column name="cdd_category" prompt="文件类型" width="80" />
+                                                    <a:column name="order_num"  prompt="序号" width="30"/>
+                                                    <a:column name="show_seq"  prompt="重要文件" width="100"/>
+                                                    <a:column name="cdd_class"  prompt="文件分类" width="120"/>
+                                                    <a:column name="description"  prompt="归档范围（资料名称）" renderer="project_cdd_render_func" width="200"/>
+                                                    <a:column name="attachment"   prompt="附件" renderer="project_cdd_render_func" width="100"/>
+                                                    <a:column name="attach_file_name"  prompt="附件名" renderer="project_cdd_render_func" width="300"/>
+                                                    <a:column name="important_concerns"  prompt="文号" editor="archive_grid1_tf" width="100"/>
+                                                    <a:column name="sign_num"  prompt="份数" editor="archive_grid1_nf" width="100"/>
+                                                    <a:column name="arch_par_has_flag_desc"  prompt="归档形式" editor="archive_grid1_cb" width="100"/>
+                                                    <a:column name="archive_date" prompt="归档日期" width="110" renderer="Leaf.formatDate"/>
+                                                    <a:column name="note" prompt="说明" width="300" editor="archive_grid1_tf"/>
+                                                </a:columns>
+                                                <a:editors>
+                                                    <a:comboBox id="archive_grid1_cb"/>
+                                                </a:editors>
+                                            </a:grid>
+                                        </a:tab>
+                                    </a:tabs>
+                                </a:tabPanel>
+                            </a:tab>
+
+                            <a:tab prompt="合规性材料" id="change_report_info_id" width="130">
+                                <a:tabPanel height="400" marginWidth="50">
+                                    <a:tabs>
+                                        <a:tab prompt="归档材料清单" width="140">
+                                            <a:grid id = "archive_file_grid13_id" bindTarget="pro_report_cdd_result_ds" marginHeight="200" marginWidth="45" navBar="true">
+
+                                                <a:columns>
+                                                    <a:column name="archive_status_n"  prompt="归档状态" width="80"/>
+                                                    <a:column name="cdd_category" prompt="文件类型" width="80" />
+                                                    <a:column name="order_num"  prompt="序号" width="30"/>
+                                                    <a:column name="show_seq"  prompt="重要文件" width="100"/>
+                                                    <a:column name="cdd_class"  prompt="文件分类" width="120"/>
+                                                    <a:column name="description"  prompt="归档范围（资料名称）" renderer="project_cdd_render_func" width="200"/>
+                                                    <a:column name="attachment"   prompt="附件" renderer="project_cdd_render_func" width="100"/>
+                                                    <a:column name="attach_file_name"  prompt="附件名" renderer="project_cdd_render_func" width="300"/>
+                                                    <a:column name="important_concerns"  prompt="文号" editor="archive_grid12_tf" width="100"/>
+                                                    <a:column name="sign_num"  prompt="份数" editor="archive_grid12_nf" width="100"/>
+                                                    <a:column name="arch_par_has_flag_desc"  prompt="归档形式" editor="archive_grid12_cb" width="100"/>
+                                                    <!--<a:column name="arch_paper_required_flag_desc"  prompt="是否为重要资料" editor="archive_grid1_cb" width="120"/>-->
+                                                    <!--<a:column name="receive_flag_desc"  prompt="是否收到纸质资料" editor="archive_grid1_cb" width="110"/>-->
+                                                    <a:column name="archive_date" prompt="归档日期" width="110" renderer="Leaf.formatDate"/>
+                                                    <a:column name="note" prompt="说明" width="300" editor="archive_grid12_tf"/>
+                                                </a:columns>
+                                                <a:editors>
+                                                    <a:comboBox id="archive_grid12_cb"/>
+                                                    <a:textField id="archive_grid12_tf"/>
+
+                                                    <a:numberField id="archive_grid12_nf" allowDecimals="false"/>
+                                                </a:editors>
+                                            </a:grid>
+                                        </a:tab>
+                                    </a:tabs>
+                                </a:tabPanel>
+                            </a:tab>
+                        </a:tabs>
+                    </a:tabPanel>
+                </a:case>
+                <!--PAYMENT  付款先决条件落实审批流程-->
+                <a:case value="PAYMENT">
+                    <a:tabPanel marginHeight="40" marginWidth="25">
+                        <a:tabs>
+                            <a:tab prompt="放款前提材料" id="bp_credit_info_id" width="130">
+                                <a:tabPanel height="400" marginWidth="50">
+                                    <a:tabs>
+                                        <a:tab prompt="归档材料清单" width="140">
+                                            <a:grid id = "archive_file_grid8_id" bindTarget="archive_payment_cdd_result_ds" marginHeight="200" marginWidth="45" navBar="true">
+                                                <a:columns>
+                                                    <a:column name="archive_status_n"  prompt="归档状态" width="80"/>
+                                                    <a:column name="cdd_category" prompt="文件类型" width="80" />
+                                                    <a:column name="order_num"  prompt="序号" width="30"/>
+                                                    <a:column name="show_seq"  prompt="重要文件" width="100"/>
+                                                    <a:column name="cdd_class"  prompt="文件分类" width="120"/>
+                                                    <a:column name="description"  prompt="归档范围（资料名称）" renderer="project_cdd_render_func" width="200"/>
+                                                    <a:column name="attachment_payment2"   prompt="附件" renderer="payment_cdd_render_func" width="100"/>
+                                                    <a:column name="file_name"  prompt="附件名" renderer="payment_cdd_render_func" width="300"/>
+                                                    <a:column name="important_concerns"  prompt="文号" editor="archive_grid8_tf" width="100"/>
+                                                    <a:column name="sign_num"  prompt="份数" editor="archive_grid8_nf" width="100"/>
+                                                    <a:column name="arch_par_has_flag_desc"  prompt="归档形式" editor="archive_grid8_cb" width="100"/>
+                                                    <a:column name="creation_date_s" prompt="归档日期" width="110"/>
+                                                    <a:column name="note" prompt="说明" width="300" editor="archive_grid8_tf"/>
+
+                                                </a:columns>
+                                                <a:editors>
+                                                    <a:comboBox id="archive_grid7_cb"/>
+                                                </a:editors>
+                                            </a:grid>
+                                        </a:tab>
+                                    </a:tabs>
+                                </a:tabPanel>
+                            </a:tab>
+                        </a:tabs>
+                    </a:tabPanel>
+                </a:case>
+                <!--SIGN 合同审批以及签约工作流-->
+                <a:case value="SIGN">
+                    <a:tabPanel marginHeight="40" marginWidth="25">
+                        <a:tabs>
+                            <a:tab prompt="签约执行材料" id="bp_credit_info_id" width="130">
+                                <a:tabPanel height="400" marginWidth="50">
+                                    <a:tabs>
+                                        <a:tab prompt="归档材料清单" width="140">
+                                            <a:grid id = "archive_file_grid9_id" bindTarget="archive_sign_cdd_result_ds" marginHeight="200" marginWidth="45" navBar="true">
+                                                <a:columns>
+                                                    <a:column name="archive_status_n"  prompt="归档状态" width="80"/>
+                                                    <a:column name="cdd_category" prompt="文件类型" width="80" />
+                                                    <a:column name="order_num"  prompt="序号" width="30"/>
+                                                    <a:column name="show_seq"  prompt="重要文件" width="100"/>
+                                                    <a:column name="cdd_class"  prompt="文件分类" width="120"/>
+                                                    <a:column name="description"  prompt="归档范围（资料名称）" renderer="project_cdd_render_func" width="200"/>
+                                                    <a:column name="attachment"   prompt="附件" renderer="project_cdd_render_func" width="100"/>
+                                                    <a:column name="attach_file_name"  prompt="附件名" renderer="project_cdd_render_func" width="300"/>
+                                                    <a:column name="important_concerns"  prompt="文号" editor="archive_grid9_tf" width="100"/>
+                                                    <a:column name="sign_num"  prompt="份数" editor="archive_grid9_nf" width="100"/>
+                                                    <a:column name="arch_par_has_flag_desc"  prompt="归档形式" editor="archive_grid9_cb" width="100"/>
+                                                    <a:column name="archive_date" prompt="归档日期" width="110" renderer="Leaf.formatDate"/>
+                                                    <a:column name="note" prompt="说明" width="300" editor="archive_grid9_tf"/>
+                                                </a:columns>
+                                                <a:editors>
+                                                    <a:comboBox id="archive_grid9_cb"/>
+                                                </a:editors>
+                                            </a:grid>
+                                        </a:tab>
+                                    </a:tabs>
+                                </a:tabPanel>
+                            </a:tab>
+                        </a:tabs>
+                    </a:tabPanel>
+                </a:case>
+                <!--项目变更-->
+                <a:case value="PRJ_PLAN_CHANGE">
+                    <a:tabPanel marginHeight="40" marginWidth="25">
+                        <a:tabs>
+                            <a:tab prompt="客户资信资料" id="bp_credit_info_id" width="130">
+                                <a:tabPanel height="400" marginWidth="50">
+                                    <a:tabs>
+                                        <a:tab prompt="归档材料清单" width="140">
+                                            <a:grid id = "archive_file_grid1_id" bindTarget="archive_bp_cdd_result_ds" marginHeight="200" marginWidth="45" navBar="true">
+                                                <a:columns>
+                                                    <a:column name="archive_status_n"  prompt="归档状态" width="80"/>
+                                                    <a:column name="cdd_category" prompt="文件类型" width="80" />
+                                                    <a:column name="order_num"  prompt="序号" width="30"/>
+                                                    <a:column name="show_seq"  prompt="重要文件" width="100"/>
+                                                    <a:column name="cdd_class"  prompt="文件分类" width="120"/>
+                                                    <a:column name="description"  prompt="归档范围（资料名称）" renderer="project_cdd_render_func" width="200"/>
+                                                    <a:column name="attachment"   prompt="附件" renderer="project_cdd_render_func" width="100"/>
+                                                    <a:column name="attach_file_name"  prompt="附件名" renderer="project_cdd_render_func" width="300"/>
+                                                    <a:column name="important_concerns"  prompt="文号"  width="100"/>
+                                                    <a:column name="sign_num"  prompt="份数" editor="archive_grid1_nf" width="100"/>
+                                                    <a:column name="arch_par_has_flag_desc"  prompt="归档形式" editor="archive_grid1_cb" width="100"/>
+                                                    <a:column name="archive_date" prompt="归档日期" width="110" renderer="Leaf.formatDate"/>
+                                                    <a:column name="note" prompt="说明" width="300" />
+                                                </a:columns>
+                                                <a:editors>
+                                                    <a:comboBox id="archive_grid1_cb"/>
+                                                </a:editors>
+                                            </a:grid>
+                                        </a:tab>
+                                    </a:tabs>
+                                </a:tabPanel>
+                            </a:tab>
+
+                            <a:tab prompt="合规性材料" id="change_report_info_id" width="130">
+                                <a:tabPanel height="400" marginWidth="50">
+                                    <a:tabs>
+                                        <a:tab prompt="归档材料清单" width="140">
+                                            <a:grid id = "archive_file_grid13_id" bindTarget="pro_report_cdd_result_ds" marginHeight="200" marginWidth="45" navBar="true">
+
+                                                <a:columns>
+                                                    <a:column name="archive_status_n"  prompt="归档状态" width="80"/>
+                                                    <a:column name="cdd_category" prompt="文件类型" width="80" />
+                                                    <a:column name="order_num"  prompt="序号" width="30"/>
+                                                    <a:column name="show_seq"  prompt="重要文件" width="100"/>
+                                                    <a:column name="cdd_class"  prompt="文件分类" width="120"/>
+                                                    <a:column name="description"  prompt="归档范围（资料名称）" renderer="project_cdd_render_func" width="200"/>
+                                                    <a:column name="attachment"   prompt="附件" renderer="project_cdd_render_func" width="100"/>
+                                                    <a:column name="attach_file_name"  prompt="附件名" renderer="project_cdd_render_func" width="300"/>
+                                                    <!--<a:column name="plan_bp_attachment" prompt="附件(项目方案)" renderer="project_cdd_render_func" width="100"/>-->
+                                                    <!--<a:column name="plan_attach_file_name"  prompt="附件名(项目方案)" renderer="project_cdd_render_func" width="300"/>-->
+                                                    <!--<a:column name="arch_required_flag_desc"  prompt="是否必传" editor="archive_grid1_cb" width="100"/>-->
+                                                    <a:column name="important_concerns"  prompt="文号" editor="archive_grid12_tf" width="100"/>
+                                                    <a:column name="sign_num"  prompt="份数" editor="archive_grid12_nf" width="100"/>
+                                                    <a:column name="arch_par_has_flag_desc"  prompt="归档形式" editor="archive_grid12_cb" width="100"/>
+                                                    <!--<a:column name="arch_paper_required_flag_desc"  prompt="是否为重要资料" editor="archive_grid1_cb" width="120"/>-->
+                                                    <!--<a:column name="receive_flag_desc"  prompt="是否收到纸质资料" editor="archive_grid1_cb" width="110"/>-->
+                                                    <a:column name="archive_date" prompt="归档日期" width="110" renderer="Leaf.formatDate"/>
+                                                    <a:column name="note" prompt="说明" width="300" editor="archive_grid12_tf"/>
+                                                </a:columns>
+                                                <a:editors>
+                                                    <a:comboBox id="archive_grid12_cb"/>
+                                                    <a:textField id="archive_grid12_tf"/>
+
+                                                    <a:numberField id="archive_grid12_nf" allowDecimals="false"/>
+                                                </a:editors>
+                                            </a:grid>
+                                        </a:tab>
+                                    </a:tabs>
+                                </a:tabPanel>
+                            </a:tab>
+
+
+                        </a:tabs>
+                    </a:tabPanel>
+                </a:case>
+
+                <!--SIGN 合同审批以及签约工作流-->
+                <a:case value="CON_CHANGE">
+                    <a:tabPanel marginHeight="40" marginWidth="25">
+                        <a:tabs>
+                            <a:tab prompt="签约执行材料" id="bp_credit_info_id" width="130">
+                                <a:tabPanel height="400" marginWidth="50">
+                                    <a:tabs>
+                                        <a:tab prompt="归档材料清单" width="140">
+                                            <a:grid id = "archive_file_grid10_id" bindTarget="archive_sign_cdd_result_ds" marginHeight="200" marginWidth="45" navBar="true">
+                                                <a:columns>
+                                                    <a:column name="archive_status_n"  prompt="归档状态" width="80"/>
+                                                    <a:column name="cdd_category" prompt="文件类型" width="80" />
+                                                    <a:column name="order_num"  prompt="序号" width="30"/>
+                                                    <a:column name="show_seq"  prompt="重要文件" width="100"/>
+                                                    <a:column name="cdd_class"  prompt="文件分类" width="120"/>
+                                                    <a:column name="description"  prompt="归档范围（资料名称）" renderer="project_cdd_render_func" width="200"/>
+                                                    <a:column name="attachment"   prompt="附件" renderer="project_cdd_render_func" width="100"/>
+                                                    <a:column name="attach_file_name"  prompt="附件名" renderer="project_cdd_render_func" width="300"/>
+                                                    <a:column name="important_concerns"  prompt="文号" editor="archive_grid1_tf" width="100"/>
+                                                    <a:column name="sign_num"  prompt="份数" editor="archive_grid1_nf" width="100"/>
+                                                    <a:column name="arch_par_has_flag_desc"  prompt="归档形式" editor="archive_grid1_cb" width="100"/>
+                                                    <a:column name="archive_date" prompt="归档日期" width="110" renderer="Leaf.formatDate"/>
+                                                    <a:column name="note" prompt="说明" width="300" editor="archive_grid1_tf"/>
+                                                </a:columns>
+                                                <a:editors>
+                                                    <a:comboBox id="archive_grid10_cb"/>
+                                                </a:editors>
+                                            </a:grid>
+                                        </a:tab>
+                                    </a:tabs>
+                                </a:tabPanel>
+                            </a:tab>
+                        </a:tabs>
+                    </a:tabPanel>
+                </a:case>
+                <!--                项目报告-->
+                <a:case value="PRJ_PLAN_REPORT">
+                    <a:tabPanel marginHeight="40" marginWidth="25" id="prj_plan_report_tabs">
+                        <a:tabs>
+                            <a:tab prompt="项目报告" id="pro_report_info_id" width="130">
+                                <a:tabPanel height="400" marginWidth="50">
+                                    <a:tabs>
+                                        <a:tab prompt="归档材料清单" width="140">
+                                            <a:grid id = "archive_file_grid11_id" bindTarget="prj_report_cdd_result_ds" marginHeight="200" marginWidth="45" navBar="true">
+                                                <a:columns>
+                                                    <a:column name="archive_status_n"  prompt="归档状态" width="80"/>
+                                                    <a:column name="cdd_category" prompt="文件类型" width="80" />
+                                                    <a:column name="order_num"  prompt="序号" width="30"/>
+                                                    <a:column name="show_seq"  prompt="重要文件" width="100"/>
+                                                    <a:column name="cdd_class"  prompt="文件分类" width="120"/>
+                                                    <a:column name="description"  prompt="归档范围（资料名称）" renderer="project_cdd_render_func" width="200"/>
+                                                    <a:column name="attachment"   prompt="附件" renderer="project_cdd_render_func" width="100"/>
+                                                    <a:column name="attach_file_name"  prompt="附件名" renderer="project_cdd_render_func" width="300"/>
+                                                    <a:column name="important_concerns"  prompt="文号" editor="archive_grid14_tf" width="100"/>
+                                                    <a:column name="sign_num"  prompt="份数" editor="archive_grid14_nf" width="100"/>
+                                                    <a:column name="arch_par_has_flag_desc"  prompt="归档形式" editor="archive_grid14_cb" width="100"/>
+                                                    <a:column name="archive_date" prompt="归档日期" width="110" renderer="Leaf.formatDate"/>
+                                                    <a:column name="note" prompt="说明" width="300" editor="archive_grid14_tf"/>
+                                                </a:columns>
+                                                <a:editors>
+                                                    <a:comboBox id="archive_grid11_cb"/>
+                                                    <a:textField id="archive_grid11_tf"/>
+                                                </a:editors>
+                                            </a:grid>
+                                        </a:tab>
+                                    </a:tabs>
+                                </a:tabPanel>
+                            </a:tab>
+                        </a:tabs>
+                    </a:tabPanel>
+                </a:case>
+                <a:case value="PRJ_PLAN_REPORT_CHANGE_A">
+                    <a:tabPanel marginHeight="40" marginWidth="25" id="prj_plan_report_tabs">
+                        <a:tabs>
+                            <a:tab prompt="项目报告" id="change_report_info_id" width="130">
+                                <a:tabPanel height="400" marginWidth="50">
+                                    <a:tabs>
+                                        <a:tab prompt="归档材料清单" width="140">
+                                            <a:grid id = "archive_file_grid12_id" bindTarget="prj_report_cdd_result_ds" marginHeight="200" marginWidth="45" navBar="true">
+                                                <a:columns>
+                                                    <a:column name="archive_status_n"  prompt="归档状态" width="80"/>
+                                                    <a:column name="cdd_category" prompt="文件类型" width="80" />
+                                                    <a:column name="order_num"  prompt="序号" width="30"/>
+                                                    <a:column name="show_seq"  prompt="重要文件" width="100"/>
+                                                    <a:column name="cdd_class"  prompt="文件分类" width="120"/>
+                                                    <a:column name="description"  prompt="归档范围（资料名称）" renderer="project_cdd_render_func" width="200"/>
+                                                    <a:column name="attachment"   prompt="附件" renderer="project_cdd_render_func" width="100"/>
+                                                    <a:column name="attach_file_name"  prompt="附件名" renderer="project_cdd_render_func" width="300"/>
+                                                    <!--<a:column name="plan_bp_attachment" prompt="附件(项目方案)" renderer="project_cdd_render_func" width="100"/>-->
+                                                    <!--<a:column name="plan_attach_file_name"  prompt="附件名(项目方案)" renderer="project_cdd_render_func" width="300"/>-->
+                                                    <!--<a:column name="arch_required_flag_desc"  prompt="是否必传" editor="archive_grid1_cb" width="100"/>-->
+                                                    <a:column name="important_concerns"  prompt="文号" editor="archive_grid14_tf" width="100"/>
+                                                    <a:column name="sign_num"  prompt="份数" editor="archive_grid14_nf" width="100"/>
+                                                    <a:column name="arch_par_has_flag_desc"  prompt="归档形式" editor="archive_grid14_cb" width="100"/>
+                                                    <!--<a:column name="arch_paper_required_flag_desc"  prompt="是否为重要资料" editor="archive_grid1_cb" width="120"/>-->
+                                                    <!--<a:column name="receive_flag_desc"  prompt="是否收到纸质资料" editor="archive_grid1_cb" width="110"/>-->
+                                                    <a:column name="archive_date" prompt="归档日期" width="110" renderer="Leaf.formatDate"/>
+                                                    <a:column name="note" prompt="说明" width="300" editor="archive_grid14_tf"/>
+                                                </a:columns>
+                                                <a:editors>
+                                                    <a:comboBox id="archive_grid12_cb"/>
+                                                    <a:textField id="archive_grid12_tf"/>
+                                                </a:editors>
+                                            </a:grid>
+                                        </a:tab>
+                                    </a:tabs>
+                                </a:tabPanel>
+                            </a:tab>
+                        </a:tabs>
+                    </a:tabPanel>
+                </a:case>
+
+                <a:case value="PRJ_PLAN_REPORT_CHANGE_B">
+                    <a:tabPanel marginHeight="40" marginWidth="25" id="prj_plan_report_tabs">
+                        <a:tabs>
+                            <a:tab prompt="项目报告" id="change_report_info_id" width="130">
+                                <a:tabPanel height="400" marginWidth="50">
+                                    <a:tabs>
+                                        <a:tab prompt="归档材料清单" width="140">
+                                            <a:grid id = "archive_file_grid12_id" bindTarget="prj_report_cdd_result_ds" marginHeight="200" marginWidth="45" navBar="true">
+                                                <a:columns>
+                                                    <a:column name="archive_status_n"  prompt="归档状态" width="80"/>
+                                                    <a:column name="cdd_category" prompt="文件类型" width="80" />
+                                                    <a:column name="order_num"  prompt="序号" width="30"/>
+                                                    <a:column name="show_seq"  prompt="重要文件" width="100"/>
+                                                    <a:column name="cdd_class"  prompt="文件分类" width="120"/>
+                                                    <a:column name="description"  prompt="归档范围（资料名称）" renderer="project_cdd_render_func" width="200"/>
+                                                    <a:column name="attachment"   prompt="附件" renderer="project_cdd_render_func" width="100"/>
+                                                    <a:column name="attach_file_name"  prompt="附件名" renderer="project_cdd_render_func" width="300"/>
+                                                    <a:column name="important_concerns"  prompt="文号" editor="archive_grid14_tf" width="100"/>
+                                                    <a:column name="sign_num"  prompt="份数" editor="archive_grid14_nf" width="100"/>
+                                                    <a:column name="arch_par_has_flag_desc"  prompt="归档形式" editor="archive_grid14_cb" width="100"/>
+                                                    <a:column name="archive_date" prompt="归档日期" width="110" renderer="Leaf.formatDate"/>
+                                                    <a:column name="note" prompt="说明" width="300" editor="archive_grid14_tf"/>
+                                                </a:columns>
+                                                <a:editors>
+                                                    <a:comboBox id="archive_grid12_cb"/>
+                                                    <a:textField id="archive_grid12_tf"/>
+                                                </a:editors>
+                                            </a:grid>
+                                        </a:tab>
+                                    </a:tabs>
+                                </a:tabPanel>
+                            </a:tab>
+                        </a:tabs>
+                    </a:tabPanel>
+                </a:case>
+            </a:switch>
+        </a:screenBody>
+    </a:view>
+
+</a:screen>
Index: src/main/resources/leaf_static/modules/acrch/ARCHIVE003/archive_file_batch_info.lview
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/acrch/ARCHIVE003/archive_file_batch_info.lview b/src/main/resources/leaf_static/modules/acrch/ARCHIVE003/archive_file_batch_info.lview
new file mode 100644
--- /dev/null	(revision 586e0a3342bdf9c1f74a1427bf4719efccef1318)
+++ b/src/main/resources/leaf_static/modules/acrch/ARCHIVE003/archive_file_batch_info.lview	(revision 586e0a3342bdf9c1f74a1427bf4719efccef1318)
@@ -0,0 +1,107 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!--
+    $Author: zc
+    $Date: 2021年6月29日 10点18分
+    $Revision: 1.0
+    $Purpose: 档案归档历史
+-->
+<a:screen xmlns:a="http://www.leaf-framework.org/application" customizationEnabled="true" dynamiccreateenabled="true" trace="true">
+    <a:view>
+        <a:link id="prj_archive_file_detail_link" url="${/request/@context_path}/modules/acrch/ARCHIVE003/archive_file_detail.lview"/>
+        <a:link id="prj_archive_auto_file_detail_link" url="${/request/@context_path}/modules/acrch/ARCHIVE003/archive_auto_file_detail.lview"/>
+        <a:link id="archive_cancel_link_id" model="acrch.ARCHIVE002.bp_doc_cdd_item" modelaction="batch_update"/>
+        <script><![CDATA[
+            //电子档案归档明细
+            function arch003_grid_virtual_con(ds_id,reocrd_id) {
+                var url_link_id;
+                var record = $(ds_id).findById(reocrd_id);
+                var param = record.data;
+                var archive_batch_id = record.get('archive_batch_id');
+                var submit_type = record.get('submit_type');
+                if(submit_type == 'AUTO'){
+                    url_link_id = $('prj_archive_auto_file_detail_link').getUrl();
+                    param['archive_batch_id'] = archive_batch_id;
+                    param['submit_type'] = record.get('submit_type');
+                    debugger;
+                    param['light_power_flag'] = record.get('light_power_flag');
+
+                    param['url_title'] = '电子档归档明细';
+
+                    if(record.get('wfl_status')=='APPROVED'){
+                        param['confirm_flag'] = 'Y';
+                    }
+
+                    new Leaf.Window({
+                        id: 'prj_archive_auto_file_detail_winid',
+                        params: param,
+                        url: url_link_id,
+                        title: param['url_title'],
+                        fullScreen:true
+                    });
+                }else if(submit_type == 'MANUAL'){
+                    url_link_id = 'prj_archive_file_detail_link';
+                    param['archive_batch_id'] = archive_batch_id;
+                    param['submit_type'] = record.get('submit_type');
+                    param['url_title'] = '电子档归档明细';
+                    param['function_code'] = 'ARCHIVE003_D';
+                    hls_doc_get_layout_code('con_contract_get_layout_code_link_id', param, url_link_id, ds_id);
+                }
+
+                // param['winid'] = 'con_content_detail_win';
+            };
+
+            window['${/parameter/@layout_code}_dynamic_link_renderer'] = function(value, record, name, config_record) {
+                if (name == 'archive_info_detail') {
+                    return '<a href="javascript:arch003_grid_virtual_con(\'' + record.ds.id + '\',\'' + record.id + '\')">' + '归档明细' + '</a>';
+                }
+                return value;
+            };
+
+         //作废
+        window['${/parameter/@layout_code}_user_button1_layout_dynamic_click'] = function() {
+            var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'file_archive_batch');
+            var records = $(ds_id).getSelected();
+            var datas = [];
+            if (records.length == 0) {
+                Leaf.showInfoMessage('提示', '请至少选择一行！', null, 200, 100);
+                return;
+            }
+
+            for(var i=0;i<records.length;i++){
+                if (records[i].get('wfl_status')!='NEW'&&records[i].get('wfl_status')!='REJECT') {
+                    Leaf.showMessage('${l:HLS.PROMPT}', '只有新建和拒绝的单据才可以作废！');
+                    return;
+                }
+                var data = {};
+                data['archive_batch_id'] = records[i].get('archive_batch_id');
+                data['_status'] = 'update';
+                datas.push(data);
+            }
+            window['${/parameter/@bp_seq}${/parameter/@layout_code}_lock_layout_dynamic_window']();
+            Leaf.request({
+                url: $('archive_cancel_link_id').getUrl(),
+                para: datas,
+                success: function (res) {
+                    Leaf.SideBar.show({
+                        msg: '提交成功',
+                        duration: 2000
+                    });
+                    window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
+                   $(ds_id).query();
+                },
+                failure: function () {
+                    window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
+                },
+                error: function () {
+                    window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
+                },
+                scope: this
+            });
+
+
+        };
+
+        ]]></script>
+        <a:screen-include screen="modules/cont/CON500/con_contract_get_layout_code.lview"/>
+    </a:view>
+</a:screen>
Index: src/main/resources/leaf_static/modules/acrch/ARCHIVE003/archive_file_detail.lview
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/acrch/ARCHIVE003/archive_file_detail.lview b/src/main/resources/leaf_static/modules/acrch/ARCHIVE003/archive_file_detail.lview
new file mode 100644
--- /dev/null	(revision 586e0a3342bdf9c1f74a1427bf4719efccef1318)
+++ b/src/main/resources/leaf_static/modules/acrch/ARCHIVE003/archive_file_detail.lview	(revision 586e0a3342bdf9c1f74a1427bf4719efccef1318)
@@ -0,0 +1,88 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!--
+    $Author:  Yimeng
+    $Date: 2014-11-27 下午01:58:31
+    $Revision: 1.0
+    $Purpose:
+-->
+<a:screen xmlns:a="http://www.leaf-framework.org/application" customizationEnabled="true" dynamiccreateenabled="true" trace="true">
+    <a:view>
+        <a:link id="arch002_cdd_uploadFile_id" url="${/request/@context_path}/uploadFile.lview"/>
+        <a:link id="arch002_cdd_downloadFile_id" url="${/request/@context_path}/downloadFile.lview"/>
+        <a:link id="arch002_save_id" model="acrch.ARCHIVE002.file_archive_batch" modelaction="update"/>
+        <script><![CDATA[
+        window['${/parameter/@layout_code}_dynamic_link_renderer'] = function(value, record, name, config_record) {
+            if (name == 'attach_file_name') {
+                if (value != null) {
+                    var link = '${/request/@context_path}/atm_download.lsc?attachment_id=';
+                    var str = value.split(';;');
+                    var url = '';
+                    for (var i = 0;i < str.length;i++) {
+                        var temp = str[i].split('--');
+                        if (!Leaf.isEmpty(temp[0])) {
+                            url = url + '<a href=' + link + temp[1] + '>' + temp[0] + '</a>' + ',';
+                        }
+                    }
+                    return url;
+                }
+            } else if (name == 'attachment') {
+                var submit_type = '${/parameter/@submit_type}';
+                var link_function;
+                if(submit_type == 'MANUAL'){
+                    link_function = 'upload_file';
+                }else{
+                    link_function = '${/parameter/@layout_code}_cdd_attachtment_upload';
+                }
+                return '<a href="javascript:window[\'' + link_function + '\'](\'' + record.id + '\',\'' + name + '\',\'' + config_record.get('query_only') + '\',\'' + record.ds.id + '\');">' + '附件' + '</a>';
+            }
+        };
+
+        function upload_file(id, name, query_only,ds_id) {
+            var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'con_file_archive_attachment');
+            var record = $(ds_id).findById(id);
+            if (record.get('archive_attachment_id')) {
+                var url= $('arch002_cdd_downloadFile_id').getUrl() + '?table_name=CON_FILE_ARCHIVE_ATTACHMENT&header_id=' + record.get('archive_attachment_id');
+                var win = new Leaf.Window({
+                    url: url,
+                    title: '${l:HLS.SUPPORTING_DOCUMENT}',
+                    id: 'arch002_cdd_uploadFile_screen_id',
+                    width: 850,
+                    height: 400
+                });
+
+                win.on('close', function() {
+                    record.ds.query();
+                });
+            } else {
+                Leaf.showMessage('${l:HLS.PROMPT}', '请先保存!');
+
+            }
+        }
+
+        window['${/parameter/@layout_code}_cdd_attachtment_upload'] = function (id, name, query_only,ds_id) {
+            var record = $(ds_id).findById(id);
+            if (record.get('check_id')) {
+                var url = $('arch002_cdd_downloadFile_id').getUrl() + '?table_name=PRJ_CDD_ITEM_CHECK&header_id=' + record.get('check_id');
+                var win = new Leaf.Window({
+                    url: url,
+                    title: '${l:HLS.SUPPORTING_DOCUMENT}',
+                    id: '${/parameter/@layout_code}_cdd_uploadFile_id',
+                    width: 850,
+                    height: 400
+                });
+                win.on('close', function () {
+                    record.ds.query();
+                });
+            } else {
+                Leaf.showMessage('${l:HLS.PROMPT}', '请先保存!');
+            }
+        };
+        function setTab(tab,display){
+            Ext.fly(tab).setStyle({
+                display:display
+            });
+        }
+        ]]></script>
+        <a:screen-include screen="modules/cont/CON500/con_contract_get_layout_code.lview"/>
+    </a:view>
+</a:screen>
Index: src/main/resources/leaf_static/modules/acrch/ARCHIVE003/archive_file_history_entrance.lview
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/acrch/ARCHIVE003/archive_file_history_entrance.lview b/src/main/resources/leaf_static/modules/acrch/ARCHIVE003/archive_file_history_entrance.lview
new file mode 100644
--- /dev/null	(revision 30e975a9b726d3d5f6018efede0d5ac008e8fae6)
+++ b/src/main/resources/leaf_static/modules/acrch/ARCHIVE003/archive_file_history_entrance.lview	(revision 30e975a9b726d3d5f6018efede0d5ac008e8fae6)
@@ -0,0 +1,138 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!--
+    $Author: zc
+    $Date: 2021年6月29日 10点18分
+    $Revision: 1.0
+    $Purpose: 档案归档历史入口界面
+-->
+<a:screen xmlns:a="http://www.leaf-framework.org/application" customizationEnabled="true" dynamiccreateenabled="true" trace="true">
+    <a:view>
+        <a:link id="con_contract_get_layout_code_link_id_" model="cont.CON500.con_contract_get_layout_code" modelaction="update"/>
+        <a:link id="prj506_virtual_contract_query_link_id_" url="${/request/@context_path}/modules/prj/PRJ506/virtual_contract_query.lview"/>
+        <a:link id="prj_project_modify_link2" url="${/request/@context_path}/modules/prj/PRJ501N/prj_project_create_tree_n.lview"/>
+        <a:link id="prj_archive_file_link" url="${/request/@context_path}/modules/acrch/ARCHIVE002/con_contract_file_archive.lview"/>
+        <a:link id="prj_archive_file_detail_link" url="${/request/@context_path}/modules/acrch/ARCHIVE003/archive_file_detail.lview"/>
+        <a:link id="prj_archive_auto_file_detail_link" url="${/request/@context_path}/modules/acrch/ARCHIVE003/archive_auto_file_detail.lview"/>
+        <a:link id="archive_batch_detail_link" url="${/request/@context_path}/modules/acrch/ARCHIVE003/archive_plan_reneder_detail.lview"/>
+        <script><![CDATA[
+
+        function open_project_modify_win(ds_id,record_id) {
+            var record = $(ds_id).findById(record_id);
+            var maintain_type = 'READONLY';
+            var function_usage = 'QUERY';
+            var function_code = 'PRJ505';
+            var param = record.data;
+
+            param['document_id'] = record.get('ref_project_id');
+            param['function_code'] = function_code;
+            param['function_usage'] = function_usage;
+            param['maintain_type'] = maintain_type;
+            param['url_title'] = '${l:HLS.PROJECT_MAITAIN}';
+            //param['layout_debugger_flag']='Y';
+            param['cond_para2'] = record.get('hn_industry_classification');
+            param['cond_para3'] = record.get('binary_classification');
+            param['document_type'] = record.get('document_type');
+            param['wf_function_code'] = '${/parameter/@function_code}';
+            param['winid'] = 'prj501n_main_prj_link_winid';
+            hls_doc_get_layout_code('con_contract_get_layout_code_link_id_', param, 'prj_project_modify_link2', ds_id);
+        }
+
+        function prj506_grid_virtual_con(ds_id,reocrd_id) {
+            var url_link_id;
+            var record = $(ds_id).findById(reocrd_id);
+            var param = record.data;
+            param['function_code'] = 'C0N301D_CON';
+            param['function_usage'] = 'QUERY';
+            param['maintain_type'] = 'READONLY';
+            url_link_id='prj506_virtual_contract_query_link_id_';
+            param['cond_para2'] = record.get('hn_industry_classification');
+            param['url_title'] = '合同明细';
+            param['winid'] = 'prj506_virtual_contract_modify_detail_link_id';
+            hls_doc_get_layout_code('con_contract_get_layout_code_link_id_', param, url_link_id, ds_id);
+        }
+
+        /*function arch003_grid_archive_batch(ds_id,reocrd_id){
+            var url_link_id;
+            var record = $(ds_id).findById(reocrd_id);
+            var param = record.data;
+            param['function_code'] = 'ARCHIVE003_B';
+            param['function_usage'] = 'QUERY';
+            param['maintain_type'] = 'READONLY';
+            param['archive_batch_id'] = record.get('archive_batch_id');
+            url_link_id='prj_archive_batch_link';
+            param['url_title'] = '档案归档历史记录';
+            param['winid'] = 'prj_archive_batch_detail_link_id';
+            hls_doc_get_layout_code('con_contract_get_layout_code_link_id_', param, url_link_id, ds_id);
+        }*/
+        //电子档案归档明细
+        function arch003_grid_archive_batch(ds_id,reocrd_id) {
+            var url_link_id;
+            var record = $(ds_id).findById(reocrd_id);
+            var param = record.data;
+            if(record.get('submit_type') == 'AUTO'){
+                url_link_id = $('prj_archive_auto_file_detail_link').getUrl();
+                param['archive_batch_id'] = record.get('archive_batch_id');
+                param['submit_type'] = record.get('submit_type');
+                param['light_power_flag'] = record.get('light_power_flag');
+                param['url_title'] = '电子档归档明细';
+                if(record.get('wfl_status')=='APPROVED'){
+                    param['confirm_flag'] = 'Y';
+                }
+                new Leaf.Window({
+                    id: 'prj_archive_auto_file_detail_winid',
+                    params: param,
+                    url: url_link_id,
+                    title: param['url_title'],
+                    fullScreen:true
+                });
+            }else if(record.get('submit_type') == 'MANUAL'){
+                url_link_id = 'prj_archive_file_detail_link';
+                param['archive_batch_id'] = record.get('archive_batch_id');
+                param['submit_type'] = record.get('submit_type');
+                param['url_title'] = '电子档归档明细';
+                param['function_code'] = 'ARCHIVE003_D';
+                hls_doc_get_layout_code('con_contract_get_layout_code_link_id_', param, url_link_id, ds_id);
+            }
+        };
+
+        function open_plan_modify_win(ds_id,record_id) {
+            var record = $(ds_id).findById(record_id);
+            var url = $('archive_batch_detail_link').getUrl();
+            var win = new Leaf.Window({
+                id: 'detail_winid',
+                url: url,
+                params: {
+                    archive_batch_id: record.get('archive_batch_id'),
+                    winId: 'detail_winid'
+                },
+                title: '明细信息',
+                fullScreen: true
+            });
+            win.on('close', function () {
+                $(ds_id).query();
+            });
+        }
+
+        window['${/parameter/@layout_code}_dynamic_link_renderer'] = function(value, record, name, config_record) {
+            if (name == 'virtual_con_number') {
+                if(value){
+                    return '<a href="javascript:prj506_grid_virtual_con(\'' + record.ds.id + '\',\'' + record.id + '\')">' + value + '</a>';
+                }
+            }else if (name == 'archive_batch_info'){
+                return '<a href="javascript:arch003_grid_archive_batch(\'' + record.ds.id + '\',\'' + record.id + '\')">' + '档案明细' + '</a>';
+            }else if (name == 'project_number') {
+                return '<a href="javascript:open_project_modify_win(\'' + record.ds.id + '\',\'' + record.id + '\')">' + value + '</a>';
+            }else if (name == 'plan_number') {
+                if(value){
+                    return '<a href="javascript:open_plan_modify_win(\'' + record.ds.id + '\',\'' + record.id + '\')">' + value + '</a>';
+                }
+            }
+            return value;
+        };
+
+
+        ]]></script>
+        <a:screen-include screen="modules/cont/CON500/con_contract_get_layout_code.lview"/>
+        <a:screen-include screen="modules/simple/simple_util.lview"/>
+    </a:view>
+</a:screen>
Index: src/main/resources/leaf_static/modules/acrch/ARCHIVE003/archive_plan_reneder_detail.lview
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/acrch/ARCHIVE003/archive_plan_reneder_detail.lview b/src/main/resources/leaf_static/modules/acrch/ARCHIVE003/archive_plan_reneder_detail.lview
new file mode 100644
--- /dev/null	(revision 586e0a3342bdf9c1f74a1427bf4719efccef1318)
+++ b/src/main/resources/leaf_static/modules/acrch/ARCHIVE003/archive_plan_reneder_detail.lview	(revision 586e0a3342bdf9c1f74a1427bf4719efccef1318)
@@ -0,0 +1,101 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!--
+    $Author: zxt
+    $Date: 2020-10-20 上午9:27:18
+    $Revision: 1.0
+    $Purpose:
+-->
+<a:screen xmlns:a="http://www.leaf-framework.org/application" customizationEnabled="true"
+          trace="true">
+    <a:init-procedure/>
+    <a:view>
+        <a:link id="hn_wfl_approve_download_link_id_d" url="${/request/@context_path}/downloadFile.lview"/>
+        <script><![CDATA[
+
+        function con_file_archive_attachment_close() {
+            $('detail_winid').close();
+        }
+        function open_attachment_window_cdd(record_id, ds_id) {
+            var record = $(ds_id).findById(record_id);
+            var win = new Leaf.Window({
+                url: $('hn_wfl_approve_download_link_id_d').getUrl() + '?table_name=CON_FILE_ARCHIVE_ATTACHMENT&header_id=' + record.get('archive_attachment_id'),
+                title: '${l:HLS.SUPPORTING_DOCUMENT}',
+                id: 'arch002_cdd_uploadFile_screen_id',
+                width: 850,
+                height: 400
+            });
+            win.on('close', function() {
+                $(ds_id).query();
+            });
+        }
+        function con_file_archive_attachment_ds_renderer(value, record, name) {
+            if (name === 'attachments') {
+                return '<a href="javascript:open_attachment_window_cdd(\'' + record.id + '\',\'' + record.ds.id + '\')">' + value + '</a>';
+            } else if (name == 'attach_file_name') {
+                if (value != null) {
+                    var link = '${/request/@context_path}/atm_download.lsc?attachment_id=';
+                    var str = value.split(';;');
+                    var url = '';
+                    for (var i = 0; i < str.length; i++) {
+                        var temp = str[i].split('--');
+                        if (!Leaf.isEmpty(temp[0])) {
+                            url = url + '<a href=' + link + temp[1] + '>' + temp[0] + '</a>' + ',';
+                        }
+                    }
+                    return url;
+                }
+            }
+        }
+
+        ]]></script>
+        <a:dataSets>
+            <a:dataSet id="con_file_archive_attachment_ds" autoQuery="true" model="acrch.ARCHIVE003.con_file_archive_attachment"
+                       queryUrl="${/request/@context_path}/autocrud/acrch.ARCHIVE003.con_file_archive_attachment/query?archive_batch_id=${/parameter/@archive_batch_id}">
+                <a:fields>
+                    <a:field name="file_type" readOnly="true"/>
+                    <a:field name="file_type_n" readOnly="true"/>
+                    <a:field name="file_seq" readOnly="true"/>
+                    <a:field name="important_flag" readOnly="true" unCheckedValue="N" checkedValue="Y"/>
+                    <a:field name="file_classification" readOnly="true"/>
+                    <a:field name="cdd_item_name" readOnly="true"/>
+                    <a:field name="document_number" readOnly="true"/>
+                    <a:field name="copies_number" readOnly="true"/>
+                    <a:field name="archive_form" readOnly="true"/>
+                    <a:field name="archive_date" readOnly="true"/>
+                    <a:field name="remark" readOnly="true"/>
+                </a:fields>
+            </a:dataSet>
+        </a:dataSets>
+        <a:screenBody>
+            <a:screenTopToolbar>
+                <a:gridButton text="退出" click="con_file_archive_attachment_close"/>
+            </a:screenTopToolbar>
+            <a:grid id="con_file_archive_attachment_grid_id" bindTarget="con_file_archive_attachment_ds"
+                    navBar="true" height="250" marginWidth="30">
+                <a:columns>
+                    <!--<a:column name="project_number" width="150" align="left" prompt="归档标识"/>-->
+                    <a:column name="file_type_n" width="240" align="left" prompt="文件类型"/>
+                    <a:column name="file_seq" width="150" align="left" prompt="序号"/>
+                    <a:column name="important_flag" width="150" align="center" editor="grid_ck" prompt="重要文件★"/>
+                    <a:column name="file_classification" width="150" align="center" prompt="文件分类"/>
+                    <a:column name="cdd_item_name" width="150" align="center" prompt="归档范围(资料名称)"/>
+                    <a:column name="attachment" width="150" align="center" prompt="附件" renderer="con_file_archive_attachment_ds_renderer"/>
+                    <a:column name="attach_file_name" width="150" align="center" prompt="附件名" editor="con_file_archive_attachment_ds_renderer"/>
+                    <a:column name="document_number" width="150" align="center" prompt="文号"/>
+                    <a:column name="copies_number" width="150" align="center" prompt="份数"/>
+                    <a:column name="archive_form" width="150" align="center" prompt="归档形式"/>
+                    <a:column name="archive_date" width="150" align="center" editor="grid_dp" prompt="归档日期"/>
+                    <a:column name="remark" width="150" align="center" prompt="说明"/>
+                </a:columns>
+                <a:editors>
+                    <a:datePicker id="grid_dp"/>
+                    <a:comboBox id="grid_cb"/>
+                    <a:textField id="grid_tf"/>
+                    <a:checkBox id="grid_ck"/>
+                    <a:numberField id="grid_nb"/>
+                </a:editors>
+            </a:grid>
+        </a:screenBody>
+        <a:screen-include screen="modules/cont/CON500/con_contract_get_layout_code.lview"/>
+    </a:view>
+</a:screen>
Index: src/main/resources/leaf_static/modules/hls/HLS214N/hls_bp_master_modify.lview
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/hls/HLS214N/hls_bp_master_modify.lview b/src/main/resources/leaf_static/modules/hls/HLS214N/hls_bp_master_modify.lview
--- a/src/main/resources/leaf_static/modules/hls/HLS214N/hls_bp_master_modify.lview	(revision 3ec71beb9eade34ba61d6c828d11f3a093cb67e0)
+++ b/src/main/resources/leaf_static/modules/hls/HLS214N/hls_bp_master_modify.lview	(revision 586e0a3342bdf9c1f74a1427bf4719efccef1318)
@@ -50,6 +50,7 @@
                 });
             };

+
             //财务报表模板查看
             window['${/parameter/@layout_code}_user_button2_layout_dynamic_click'] = function() {
                 var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'hls_bp_master');
@@ -129,6 +130,26 @@
                     column_stockholdingratio3.renderer = "${/parameter/@layout_code}_g_manager_seedetail_column_ln_3";

                 }
+
+
+                 var file_ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_cdd_item_doc_ref');
+                 if (ds.id == file_ds_id) {
+                    var records=$(file_ds_id).getAll();
+
+                     for (var i = 0;i < records.length;i++) {
+                         var record = records[i];
+                         var investigate_guide_flag=record.get('investigate_guide_flag');
+                         if (investigate_guide_flag == 'N') {
+                             record.getField('reason_alternative').setReadOnly(false);
+                             record.getField('reason_alternative').setRequired(true);
+
+                         } else {
+                             // record.getField('reason_alternative').setReadOnly(true);
+                             record.getField('reason_alternative').setRequired(false);
+
+                         }
+                     }
+                     }
             };

             window['${/parameter/@layout_code}_user_button3_layout_dynamic_click'] = function() {
@@ -180,13 +201,29 @@
                         height: 400
                     });
                     win.on('close', function() {
+                        //i=1;
+                        Leaf.request({
+                            url: '${/request/@context_path}/autocrud/update_file_version_by_pk/execute',
+                            para: {
+                                table_name: 'PRJ_CDD_ITEM_CHECK',
+                                table_pk_value: record.get('check_id')
+                            },
+                            scope: this
+                        });
                         record.ds.query(dsCurrentPage);
                     });
                 } else {
                     Leaf.showMessage('${l:HLS.PROMPT}', '请先保存!');
                 }
             };
+        //查询时调用(grid,table,gridBox)
+        window['${/parameter/@bp_seq}${/parameter/@layout_code}_on_layout_dynamic_grid_query'] = function(ds, qpara, bp_seq) {
+            var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_cdd_item_doc_ref');

+            if (ds == $(ds_id)) {
+                i = 1;
+            }
+        };
         /*预留印鉴表超链接*/
         window['${/parameter/@layout_code}_hls213n_hls_bp_rese_table_upload'] = function(id, name, query_only) {
             var record = window['${/parameter/@layout_code}_hls_link_render_record'][id + '---' + name];
@@ -323,6 +360,14 @@
                 }
             }

+            var i = 1
+            function get_order_number(ds_id, record_id){
+                var record = $(ds_id).findById(record_id);
+                var a = i;
+                i++;
+                return a;
+            }
+
             //客户分级历史版本明细   add dxp 2020-09-14
             function open_detail_read_only_bp(ds_id, record_id) {
                 var record = $(ds_id).findById(record_id);
@@ -396,10 +441,22 @@
                     return '<a href="javascript:window[\'' + link_function + '\'](\'' + record.id + '\',\'' + name + '\',\'' + config_record.get('query_only') + '\');">' + config_record.get('prompt') + '</a>';
                 }else if (name == "detail" && !record.isNew) {
                     return '<a href="javascript:open_detail_read_only_bp(\'' + record.ds.id + '\',\'' + record.id + '\')">' + '明细' + '</a>';
+                }else if(name == 'order_number'){
+                    return get_order_number(record.ds.id,record.id);
                 }
             };
             //更新时调用
             window['${/parameter/@bp_seq}${/parameter/@layout_code}_on_layout_dynamic_update'] = function(ds, record, name, value, old_value, bp_seq) {
+                if(name == 'bp_name'){
+                    if(value != old_value){
+                        record.set('post_itfc_status','NEW');
+                        record.set('post_itfc_vender_status','NEW');
+                    }
+                    if(value != old_value){
+                        record.set('post_fund_status','NEW'); //add 资金同步标志  2020-08-04
+                    }
+                }
+                debugger;
                 var role_ds = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'hls_bp_master_role');
                 if (role_ds == ds.id){
                     var primary_flag = record.get('primary_flag');
@@ -463,6 +520,21 @@
                             record.getField('business_license_num_n').setReadOnly(true);
                             record.getField('business_license_num_n').setRequired(false);
                             record.set('business_license_num_n', '');
+                        }
+                    }
+                }
+                var file_ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_cdd_item_doc_ref');
+                debugger;
+                if (ds.id == file_ds_id) {
+                    if (name == 'investigate_guide_flag') {
+                        if (value == 'N') {
+                            record.getField('reason_alternative').setReadOnly(false);
+                            record.getField('reason_alternative').setRequired(true);
+
+                        } else {
+                           // record.getField('reason_alternative').setReadOnly(true);
+                            record.getField('reason_alternative').setRequired(false);
+
                         }
                     }
                 }
@@ -502,6 +574,8 @@
                         }
                     }
                 }
+
+
                };
              //保存前调用
             window['${/parameter/@bp_seq}${/parameter/@layout_code}_on_layout_dynamic_before_submit'] = function(ds, record) {
@@ -838,18 +912,7 @@
                     return value;
                 }
             };
-            //更新时调用
-            window['${/parameter/@bp_seq}${/parameter/@layout_code}_on_layout_dynamic_update'] = function(ds, record, name, value, old_value, bp_seq) {
-                if(name == 'bp_name'){
-            	    if(value != old_value){
-            	    	record.set('post_itfc_status','NEW');
-            	    	record.set('post_itfc_vender_status','NEW');
-            	    }
-                    if(value != old_value){
-                        record.set('post_fund_status','NEW'); //add 资金同步标志  2020-08-04
-                    }
-            	}
-            };
+
         ]]></script>
     </a:view>
 </a:screen>
Index: src/main/resources/leaf_static/modules/prj/PRJ501Z/hn_prj_plan_attachment.lview
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/prj/PRJ501Z/hn_prj_plan_attachment.lview b/src/main/resources/leaf_static/modules/prj/PRJ501Z/hn_prj_plan_attachment.lview
--- a/src/main/resources/leaf_static/modules/prj/PRJ501Z/hn_prj_plan_attachment.lview	(revision 3ec71beb9eade34ba61d6c828d11f3a093cb67e0)
+++ b/src/main/resources/leaf_static/modules/prj/PRJ501Z/hn_prj_plan_attachment.lview	(revision 586e0a3342bdf9c1f74a1427bf4719efccef1318)
@@ -19,6 +19,7 @@
         <a:link id="hn_project_plan_check_save_link" model="prj.PRJ501Z.hn_prj_plan_check_cdd" modelaction="update"/>
         <script><![CDATA[

+
         window['${/parameter/@layout_code}_prj500Z_cdd_attachtment_upload'] = function (id,  name, query_only) {
             var record = window['${/parameter/@layout_code}_hls_link_render_record'][id + '---' + name];
             var dsCurrentPage = record.ds.currentPage;
@@ -58,7 +59,17 @@
                     width: 850,
                     height: 400
                 });
+
                 win.on('close', function () {
+                    Leaf.request({
+                        url: '${/request/@context_path}/autocrud/update_file_version_by_pk/execute',
+                        para: {
+                            table_name: 'PRJ_CDD_ITEM_CHECK',
+                            table_pk_value: record.get('check_id')
+                        },
+                        scope: this
+                    });
+
                     record.ds.query(dsCurrentPage);
                 });
             } else {
@@ -113,6 +124,49 @@
             }
             ds.query(ds.currentPage);
         };
+        //加载时调用(attach)
+        window['${/parameter/@bp_seq}${/parameter/@layout_code}_on_layout_dynamic_attach_load'] = function(ds, record, config_records, bp_seq) {
+            var cdd_ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_cdd_item_doc_ref');
+
+            if (ds.id == cdd_ds_id) {
+                if (record) {
+                    var function_code = '${/parameter/@function_code}';
+                    var current_seq = '${/parameter/@current_seq}';
+                    var important_file_flag = '${/parameter/@important_file_flag}';
+                    if (function_code == 'PRJ501ZW_AMTU'){
+                        // 风控评审
+                        if (important_file_flag == 'Y') {
+                            record.getField('arch_par_has_flag').setRequired(false);
+                            record.getField('arch_par_has_flag').setReadOnly(true);
+                            record.getField('arch_paper_required_flag').setReadOnly(false);
+                        }else if (important_file_flag == 'E'){
+                            record.getField('arch_par_has_flag').setRequired(false);
+                            record.getField('arch_par_has_flag').setReadOnly(false);
+                            record.getField('arch_paper_required_flag').setRequired(false);
+                            record.getField('arch_paper_required_flag').setReadOnly(true);
+                        }
+                    }
+                }
+
+            }
+
+        };
+
+        //更新时调用
+        window['${/parameter/@bp_seq}${/parameter/@layout_code}_on_layout_dynamic_update'] = function(ds, record, name, value, old_value, bp_seq) {
+            let cdd_ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_cdd_item_doc_ref');
+            if (ds.id === cdd_ds_id) {
+                if(name === 'investigate_guide_flag'){
+                    if(value === 'N'){
+                        record.getField('reason_alternative').setRequired(true);
+                    }
+                    else if(value === 'Y'){
+                        record.getField('reason_alternative').setRequired(false);
+                    }
+                }
+            }
+        }
+

         ]]></script>
         <a:screen-include screen="modules/cont/CON500/con_contract_get_layout_code.lview"/>
Index: src/main/resources/leaf_static/modules/prj/PRJ501Z/hn_prj_project_plan_modify.lview
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/prj/PRJ501Z/hn_prj_project_plan_modify.lview b/src/main/resources/leaf_static/modules/prj/PRJ501Z/hn_prj_project_plan_modify.lview
--- a/src/main/resources/leaf_static/modules/prj/PRJ501Z/hn_prj_project_plan_modify.lview	(revision 3ec71beb9eade34ba61d6c828d11f3a093cb67e0)
+++ b/src/main/resources/leaf_static/modules/prj/PRJ501Z/hn_prj_project_plan_modify.lview	(revision 586e0a3342bdf9c1f74a1427bf4719efccef1318)
@@ -313,10 +313,10 @@

         //支撑性文件
         function prj_project_plan_attachment() {
-            if(typeof(check_result_ds())!='undefined'&&!Ext.isEmpty(check_result_ds())){
-                Leaf.showMessage('提示',check_result_ds());
-                return;
-            }
+            // if(typeof(check_result_ds())!='undefined'&&!Ext.isEmpty(check_result_ds())){
+            //     Leaf.showMessage('提示',check_result_ds());
+            //     return;
+            // }
             var ds = $('prj_project_plan_detail_result_ds');
             var ds_id = ds.id;
             var plan_id = '${/parameter/@plan_id}';
@@ -430,14 +430,8 @@
                     var r_user_id=record.get('owner_id');
                     var cdd_item=record.get('cdd_item');
                     var text;
-                    //▲业务组尽调报告仅单据所有者可以上传下载
-                    if(r_user_id==user_id && cdd_item=='HN_PRJ_DOC_REF_10' && ('${/parameter/@wfl_status_n}'=='拒绝'||'${/parameter/@wfl_status_n}'=='新建')){
-                        url = $('hn_wfl_approve_upload_link_id').getUrl();
-                        text = '上传/删除';
-                    }else{
-                        var url = $('prj_excel_downloadFile_id').getUrl();
-                        text= '下载';
-                    }
+                    var url = $('prj_excel_downloadFile_id').getUrl();
+                    text= '下载';
                 return '<a href="javascript:open_attachment_window_cdd(' + record.get('check_id') + ',\'' + url + '\')">' + text + '</a>';
             } else if (name == 'file_name') {
                 if (value != null) {
Index: src/main/java/com/hand/hls/file/controllers/HnCopyFileController.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/java/com/hand/hls/file/controllers/HnCopyFileController.java b/src/main/java/com/hand/hls/file/controllers/HnCopyFileController.java
--- a/src/main/java/com/hand/hls/file/controllers/HnCopyFileController.java	(revision 33faca6317f7cfd928f5c69aff3882add32116e6)
+++ b/src/main/java/com/hand/hls/file/controllers/HnCopyFileController.java	(revision 40f9db19584377987c2cd103792e716e03ebefdc)
@@ -35,10 +35,14 @@

     public static final String SOURCE_BP_DELETE_TYPE = "HN_BP_ATTACHMENT_RECORD";

+
+
     @RequestMapping(value = "/projectCopyFileByBp", method = RequestMethod.POST)
     public ResponseData hnCopyFileSelectCount(@ModelAttribute(LEAF_PARAM_NAME) LeafRequestData requestData,
                                                HttpServletRequest request) {
         ResponseData responseData = new ResponseData(true);
+        String flag="Y";
+        System.out.println("in");
         try {
             HttpSession session = request.getSession(false);
             Long userId = (Long) session.getAttribute(IRequest.FIELD_USER_ID);
@@ -55,67 +59,16 @@
             //项目同步商业伙伴  p_type = SYNCHRO   同步    p_type = UPDATE 更新
             List<PrjProjectBpEntity> projectList = iHnCopyFileSelectCountService.queryProjectList(prjProjectBpEntityr);
             for (PrjProjectBpEntity item : projectList) {
-                long prjBpId = item.getPrjBpId();
-                Long bpId = item.getBpId();
-                prjProjectBpEntityr.setPrjBpId(prjBpId);
-                prjProjectBpEntityr.setBpId(bpId);
-                //查询附件记录是否存在
-                v_count_num = iHnCopyFileSelectCountService.queryCountNum(prjProjectBpEntityr);
-                v_count_num1 = iHnCopyFileSelectCountService.queryCountNum1(prjProjectBpEntityr);
-                HlsBpMasterEntity hbm = iHnCopyFileSelectCountService.queryBpList(prjProjectBpEntityr);
-                Long cddListId = hbm.getCddListId();
-
-                prjCddItemEntity.setTabGroup(BP_TAB_GROUP);
-                PrjCddItemEntity tabGroupId = hnBpAttachSyncService.queryTabGroupId(prjCddItemEntity);
-                Long tabGroupId1 = tabGroupId.getTabGroupId();
-
-                if("".equals(tabGroupId1) && tabGroupId1 != null){
-                    tabGroupId1 = (long)4;
-                }
-
-                // 存在记录仅仅拷贝附件  如果有新的列  则拷贝
-                if (("SYNCHRO".equals(p_type)) && p_type != null  && (v_count_num > 0) && (v_count_num1 > 0)) {
-                    prjCddItemEntity.setPrjBpId(prjBpId);
-                    prjCddItemEntity.setBpId(bpId);
-                    prjCddItemEntity.setCddListId(cddListId);
-                    prjCddItemEntity.setTabGroupId(tabGroupId1);
-                    prjCddItemEntity.setTableName(BP_DOCUMENT_TABLE_NAME);
-                    hnBpAttachSyncService.copyBpAttachSync(prjCddItemEntity,prjProjectBpEntityr,hnBpAttachmentRecordEntity,
-                            userId);
-                }
-                else if ( ("UPDATE".equals(p_type)) && p_type != null   && (v_count_num > 0) && (v_count_num1 > 0)) {
-                    //-- 改变了商业伙伴
-                    return null;
-                }
-                //-- 改变了商业伙伴要先删除记录 然后在插入    此处删除全部记录
-                else if (("UPDATE".equals(p_type)) && p_type != null   && (v_count_num == 0) && (v_count_num1 > 0)  ) {
-                    prjCddItemEntity.setPrjBpId(prjBpId);
-                    //DELETE fnd_atm_attachment
-                    prjCddItemEntity.setTableName(SOURCE_BP_DELETE_TYPE);
-                    hnBpAttachSyncService.delBpAttachment(prjCddItemEntity);
-                    //copy_bp_attach
-                    hnBpAttachSyncService.copyBpAttach(prjCddItemEntity,
-                            prjProjectBpEntityr,
-                            hnBpAttachmentRecordEntity,
-                            userId);
-                } else {
-                    //copy_bp_attach
-                    prjCddItemEntity.setPrjBpId(prjBpId);
-                    prjCddItemEntity.setBpId(bpId);
-                    prjCddItemEntity.setCddListId(cddListId);
-                    prjCddItemEntity.setTabGroupId(tabGroupId1);
-                    prjCddItemEntity.setTableName(BP_DOCUMENT_TABLE_NAME);
-                    hnBpAttachSyncService.copyBpAttach(prjCddItemEntity,
-                            prjProjectBpEntityr,
-                            hnBpAttachmentRecordEntity,
-                            userId);
-
-                }
+                flag=  hnBpAttachSyncService.copyBpFile(item,prjProjectBpEntityr, p_type,userId);
             }
         }catch (Exception e){
             responseData.setSuccess(false);
             responseData.setMessage(e.getMessage());
         }
+        if("N".equals(flag)){
+            responseData.setSuccess(false);
+            responseData.setMessage("文件同步失败！");
+        }
         return responseData;
     }
 }
Index: src/main/java/com/hand/hls/file/dto/HnBpAttachmentRecordEntity.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/java/com/hand/hls/file/dto/HnBpAttachmentRecordEntity.java b/src/main/java/com/hand/hls/file/dto/HnBpAttachmentRecordEntity.java
--- a/src/main/java/com/hand/hls/file/dto/HnBpAttachmentRecordEntity.java	(revision 33faca6317f7cfd928f5c69aff3882add32116e6)
+++ b/src/main/java/com/hand/hls/file/dto/HnBpAttachmentRecordEntity.java	(revision 40f9db19584377987c2cd103792e716e03ebefdc)
@@ -26,6 +26,13 @@
     private Long programId;
     private Long lastUpdateLogin;

+    private String cddCategory;
+    private String projectRequiredFlag;
+    private String lenderTabGroup;
+    private String showSeq;
+    private String investigateGuideFlag;
+    private String reasonAlternative;
+
     @Transient
     private String tableName;

@@ -207,6 +214,54 @@
         this.lastUpdateLogin = lastUpdateLogin;
     }

+    public String getCddCategory() {
+        return cddCategory;
+    }
+
+    public void setCddCategory(String cddCategory) {
+        this.cddCategory = cddCategory;
+    }
+
+    public String getProjectRequiredFlag() {
+        return projectRequiredFlag;
+    }
+
+    public void setProjectRequiredFlag(String projectRequiredFlag) {
+        this.projectRequiredFlag = projectRequiredFlag;
+    }
+
+    public String getLenderTabGroup() {
+        return lenderTabGroup;
+    }
+
+    public void setLenderTabGroup(String lenderTabGroup) {
+        this.lenderTabGroup = lenderTabGroup;
+    }
+
+    public String getShowSeq() {
+        return showSeq;
+    }
+
+    public void setShowSeq(String showSeq) {
+        this.showSeq = showSeq;
+    }
+
+    public String getInvestigateGuideFlag() {
+        return investigateGuideFlag;
+    }
+
+    public void setInvestigateGuideFlag(String investigateGuideFlag) {
+        this.investigateGuideFlag = investigateGuideFlag;
+    }
+
+    public String getReasonAlternative() {
+        return reasonAlternative;
+    }
+
+    public void setReasonAlternative(String reasonAlternative) {
+        this.reasonAlternative = reasonAlternative;
+    }
+
     @Override
     public boolean equals(Object o) {
         if (this == o) return true;
Index: src/main/java/com/hand/hls/file/dto/HnCddRefCheckEntity.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/java/com/hand/hls/file/dto/HnCddRefCheckEntity.java b/src/main/java/com/hand/hls/file/dto/HnCddRefCheckEntity.java
--- a/src/main/java/com/hand/hls/file/dto/HnCddRefCheckEntity.java	(revision 33faca6317f7cfd928f5c69aff3882add32116e6)
+++ b/src/main/java/com/hand/hls/file/dto/HnCddRefCheckEntity.java	(revision 40f9db19584377987c2cd103792e716e03ebefdc)
@@ -15,6 +15,21 @@
     private String documentTable;
     private long cddItemId;

+    @Transient
+    private String cddCategory;
+    @Transient
+    private String projectRequiredFlag;
+    @Transient
+    private String lenderTabGroup;
+    @Transient
+    private String showSeq;
+    @Transient
+    private String investigateGuideFlag;
+    @Transient
+    private String reasonAlternative;
+
+
+
     @Transient
     private Long checkId;

@@ -103,6 +118,54 @@
         this.id = id;
     }

+    public String getCddCategory() {
+        return cddCategory;
+    }
+
+    public void setCddCategory(String cddCategory) {
+        this.cddCategory = cddCategory;
+    }
+
+    public String getProjectRequiredFlag() {
+        return projectRequiredFlag;
+    }
+
+    public void setProjectRequiredFlag(String projectRequiredFlag) {
+        this.projectRequiredFlag = projectRequiredFlag;
+    }
+
+    public String getLenderTabGroup() {
+        return lenderTabGroup;
+    }
+
+    public void setLenderTabGroup(String lenderTabGroup) {
+        this.lenderTabGroup = lenderTabGroup;
+    }
+
+    public String getShowSeq() {
+        return showSeq;
+    }
+
+    public void setShowSeq(String showSeq) {
+        this.showSeq = showSeq;
+    }
+
+    public String getInvestigateGuideFlag() {
+        return investigateGuideFlag;
+    }
+
+    public void setInvestigateGuideFlag(String investigateGuideFlag) {
+        this.investigateGuideFlag = investigateGuideFlag;
+    }
+
+    public String getReasonAlternative() {
+        return reasonAlternative;
+    }
+
+    public void setReasonAlternative(String reasonAlternative) {
+        this.reasonAlternative = reasonAlternative;
+    }
+
     @Override
     public boolean equals(Object o) {
         if (this == o) return true;
Index: src/main/java/com/hand/hls/file/dto/PrjCddItemEntity.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/java/com/hand/hls/file/dto/PrjCddItemEntity.java b/src/main/java/com/hand/hls/file/dto/PrjCddItemEntity.java
--- a/src/main/java/com/hand/hls/file/dto/PrjCddItemEntity.java	(revision 33faca6317f7cfd928f5c69aff3882add32116e6)
+++ b/src/main/java/com/hand/hls/file/dto/PrjCddItemEntity.java	(revision 40f9db19584377987c2cd103792e716e03ebefdc)
@@ -73,6 +73,7 @@
     @Transient
     private String tabGroup;

+
     public String getTabGroup() {
         return tabGroup;
     }
Index: src/main/java/com/hand/hls/file/mapper/HnBpAttachmentRecordrMapper.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/java/com/hand/hls/file/mapper/HnBpAttachmentRecordrMapper.java b/src/main/java/com/hand/hls/file/mapper/HnBpAttachmentRecordrMapper.java
--- a/src/main/java/com/hand/hls/file/mapper/HnBpAttachmentRecordrMapper.java	(revision 33faca6317f7cfd928f5c69aff3882add32116e6)
+++ b/src/main/java/com/hand/hls/file/mapper/HnBpAttachmentRecordrMapper.java	(revision 40f9db19584377987c2cd103792e716e03ebefdc)
@@ -12,4 +12,6 @@

     Long queryCopyFileRecordNextval();

+    void updateBpAttachmentByRecordId(HnBpAttachmentRecordEntity hnBpAttachmentRecordEntity);
+
 }
\ No newline at end of file
Index: src/main/java/com/hand/hls/file/service/IFndAtmTableCopyService.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/java/com/hand/hls/file/service/IFndAtmTableCopyService.java b/src/main/java/com/hand/hls/file/service/IFndAtmTableCopyService.java
--- a/src/main/java/com/hand/hls/file/service/IFndAtmTableCopyService.java	(revision 33faca6317f7cfd928f5c69aff3882add32116e6)
+++ b/src/main/java/com/hand/hls/file/service/IFndAtmTableCopyService.java	(revision 40f9db19584377987c2cd103792e716e03ebefdc)
@@ -19,6 +19,10 @@
     * @param  userId Long
     * @throws IOException On run error
     * */
+
    void fndAtmTableCopy( HnBpAttachmentRecordEntity hnBpAttachmentRecordEntity,
            Long recordId, Long userId) throws IOException;
+
+   void fndAtmTableCopyNew( HnBpAttachmentRecordEntity hnBpAttachmentRecordEntity,
+                         Long recordId, Long userId) throws IOException;
 }
Index: src/main/java/com/hand/hls/file/service/IHnBpAttachSyncService.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/java/com/hand/hls/file/service/IHnBpAttachSyncService.java b/src/main/java/com/hand/hls/file/service/IHnBpAttachSyncService.java
--- a/src/main/java/com/hand/hls/file/service/IHnBpAttachSyncService.java	(revision 33faca6317f7cfd928f5c69aff3882add32116e6)
+++ b/src/main/java/com/hand/hls/file/service/IHnBpAttachSyncService.java	(revision 40f9db19584377987c2cd103792e716e03ebefdc)
@@ -13,11 +13,11 @@
  */
 public interface IHnBpAttachSyncService {
     /**
-    * 查询table_name = 'PRJ_CDD_ITEM_CHECK' 的记录
-    *
-    * @param  hnBpAttachmentRecordEntity HnBpAttachmentRecordEntity
-    * @return Result<FndAtmAttachmentMultiEntity>
-    * */
+     * 查询table_name = 'PRJ_CDD_ITEM_CHECK' 的记录
+     *
+     * @param  hnBpAttachmentRecordEntity HnBpAttachmentRecordEntity
+     * @return Result<FndAtmAttachmentMultiEntity>
+     * */
     List<FndAtmAttachmentMultiEntity>  queryAttachmentMultiByCheckId (HnBpAttachmentRecordEntity hnBpAttachmentRecordEntity);

     /**
@@ -49,17 +49,17 @@
      * */
     int addFndAtmAttachment(FndAtmAttachmentEntity fndAtmAttachmentEntity);
     /**
-    * 存在记录仅仅拷贝附件  如果有新的列  则拷贝
-    *
-    * @param  prjCddItemEntity PrjCddItemEntity
-    * @param  prjProjectBpEntity PrjProjectBpEntity
-    * @param  hnBpAttachmentRecordEntity HnBpAttachmentRecordEntity
-    * @param  userId Long
-    * @return Result<FndAtmAttachmentMultiEntity>
-    * @throws IOException On run error
-    * */
+     * 存在记录仅仅拷贝附件  如果有新的列  则拷贝
+     *
+     * @param  prjCddItemEntity PrjCddItemEntity
+     * @param  prjProjectBpEntity PrjProjectBpEntity
+     * @param  hnBpAttachmentRecordEntity HnBpAttachmentRecordEntity
+     * @param  userId Long
+     * @return Result<FndAtmAttachmentMultiEntity>
+     * @throws IOException On run error
+     * */
     public void copyBpAttachSync(PrjCddItemEntity prjCddItemEntity, PrjProjectBpEntity prjProjectBpEntity, HnBpAttachmentRecordEntity hnBpAttachmentRecordEntity,
-                                    Long userId) throws IOException;
+                                 Long userId) throws IOException;



@@ -112,12 +112,12 @@


     /*FndAtmAttachmentEntity selectByCodeAndPkValue(FndAtmAttachmentMultiEntity fndAtmAttachmentMultiEntity);
-*/
+     */
     /**
-    * 查询tabGroupId
-    * @param  prjCddItemEntity PrjCddItemEntity
-    * @return  PrjCddItemEntity
-    * */
+     * 查询tabGroupId
+     * @param  prjCddItemEntity PrjCddItemEntity
+     * @return  PrjCddItemEntity
+     * */
     PrjCddItemEntity queryTabGroupId(PrjCddItemEntity prjCddItemEntity);

     /**
@@ -126,4 +126,15 @@
      * @param prjCddItemEntity PrjCddItemEntity
      * */
     void delBpAttachment(PrjCddItemEntity prjCddItemEntity);
+
+
+    /**
+     * 复制商业伙伴附件的功能
+     * @param item
+     * @param prjProjectBpEntityr
+     * @param p_type
+     * @param userId
+     * @return
+     */
+    String copyBpFile(PrjProjectBpEntity item,PrjProjectBpEntity prjProjectBpEntityr,String p_type, Long userId);
 }
Index: src/main/java/com/hand/hls/file/service/impl/FndAtmTableCopuServiceImpl.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/java/com/hand/hls/file/service/impl/FndAtmTableCopuServiceImpl.java b/src/main/java/com/hand/hls/file/service/impl/FndAtmTableCopuServiceImpl.java
--- a/src/main/java/com/hand/hls/file/service/impl/FndAtmTableCopuServiceImpl.java	(revision 33faca6317f7cfd928f5c69aff3882add32116e6)
+++ b/src/main/java/com/hand/hls/file/service/impl/FndAtmTableCopuServiceImpl.java	(revision 40f9db19584377987c2cd103792e716e03ebefdc)
@@ -22,6 +22,7 @@
 public class FndAtmTableCopuServiceImpl implements IFndAtmTableCopyService {


+
     @Autowired
     private IHnBpAttachSyncService hnBpAttachSyncService;

@@ -139,4 +140,85 @@
         }
     }

+
+    @Override
+    public void fndAtmTableCopyNew(HnBpAttachmentRecordEntity hnBpAttachmentRecordEntity, Long HnRecordId, Long userId) throws IOException {
+        hnBpAttachmentRecordEntity.setTableName(PRJ_CDD_ITEM_CHECK_TABLE_NAME );
+        List<FndAtmAttachmentMultiEntity> attachmentMultiByCheckId = hnBpAttachSyncService.queryAttachmentMultiByCheckId(hnBpAttachmentRecordEntity);
+        for (FndAtmAttachmentMultiEntity multiItem : attachmentMultiByCheckId) {
+            Long record_id = hnBpAttachSyncService.queryNextval();
+            String table_pk_value = HnRecordId.toString();
+            Date last_update_date = new Date();
+            Long last_updated_by = userId;
+            FndAtmAttachmentMultiEntity fndAtmAttachmentMultiEntity = new FndAtmAttachmentMultiEntity();
+            fndAtmAttachmentMultiEntity.setRecordId(record_id);
+            fndAtmAttachmentMultiEntity.setTableName(TABLE_NAME);
+            fndAtmAttachmentMultiEntity.setTablePkValue(table_pk_value);
+            fndAtmAttachmentMultiEntity.setCreationDate(new Date());
+            fndAtmAttachmentMultiEntity.setLastUpdateDate(last_update_date);
+            fndAtmAttachmentMultiEntity.setLastUpdatedBy(last_updated_by);
+            fndAtmAttachmentMultiEntity.setCopyFlag("Y");
+            iHnCopyFileSelectCountService.addAttachmentMulti(fndAtmAttachmentMultiEntity);
+            Long attachmentId = multiItem.getAttachmentId();
+            fndAtmAttachmentMultiEntity.setAttachmentId(attachmentId);
+            List<FndAtmAttachmentEntity> attachmentList = hnBpAttachSyncService.queryAttachmentList(fndAtmAttachmentMultiEntity);
+            DbaDirectoriesEntity dbaDirectoriesEntity = new DbaDirectoriesEntity();
+            for (FndAtmAttachmentEntity attachmentItem : attachmentList) {
+                dbaDirectoriesEntity.setDirectoryName(HLS_BP_ATTACH_DIR);
+                //List<DbaDirectoriesEntity> dbaDirectoriesByConditions = dbaDirectoriesMapper.queryDbaDirectoriesByConditions(dbaDirectoriesEntity);
+                //if(dbaDirectoriesByConditions.size() > 0){
+                    String sysGuid = hnBpAttachSyncService.querySysGuid();
+                    SysParameterValuesEntity sysParameterValues = sysParameterMapper.querySysParameterValueByParameterCode(BP_ATTACH_RECORD_FILE);
+                    String newPath;
+                    String parameterValue = sysParameterValues.getParameterValue();
+                  //  String directoryPath = dbaDirectoriesByConditions.get(0).getDirectoryPath();
+                   // newPath = directoryPath + parameterValue + "/" + sysGuid;
+                    newPath=attachmentItem.getFilePath();
+                    Long attachment_id = hnBpAttachSyncMapper.queryAttachmentId();
+                    FndAtmAttachmentEntity fndAtmAttachmentEntity = new FndAtmAttachmentEntity();
+                    fndAtmAttachmentEntity.setSourceTypeCode(SOURCE_TYPE_CODE);
+                    fndAtmAttachmentEntity.setSourcePkValue(record_id.toString());
+                    fndAtmAttachmentEntity.setContent(attachmentItem.getContent());
+                    fndAtmAttachmentEntity.setFileTypeCode(attachmentItem.getFileTypeCode());
+                    fndAtmAttachmentEntity.setMimeType(attachmentItem.getMimeType());
+                    fndAtmAttachmentEntity.setFileName(attachmentItem.getFileName());
+                    fndAtmAttachmentEntity.setFileSize(attachmentItem.getFileSize());
+                    fndAtmAttachmentEntity.setFilePath(attachmentItem.getFilePath());
+                    fndAtmAttachmentEntity.setCreatedBy(userId);
+                    fndAtmAttachmentEntity.setCreationDate(new Date());
+                    fndAtmAttachmentEntity.setLastUpdateDate(new Date());
+                    fndAtmAttachmentEntity.setLastUpdatedBy(userId);
+                    fndAtmAttachmentEntity.setAttachmentId(attachment_id);
+                    hnBpAttachSyncService.addFndAtmAttachment(fndAtmAttachmentEntity);
+                    fndAtmAttachmentMultiEntity.setAttachmentId(attachment_id);
+                    iHnCopyFileSelectCountService.updateFndAtmAttachmentMulti(fndAtmAttachmentMultiEntity);
+                   // boolean flag = iHnCopyFileRecordService.copyFile(attachmentItem.getFilePath(), newPath);
+                    //if(flag == true){
+                        HnCopyFileRecord insertCopyRecord = new HnCopyFileRecord();
+                        HnBpAttachmentRecordEntity hnBpAttachmentRecordEntity1 = new HnBpAttachmentRecordEntity();
+                        hnBpAttachmentRecordEntity1.setHnRecordId(HnRecordId);
+                        HnBpAttachmentRecordEntity getBpAttachmentInfo = hnBpAttachmentRecordrMapper.queryBpAttachmentReordByRecordId(hnBpAttachmentRecordEntity1);
+                        Long fileRecordId = hnBpAttachmentRecordrMapper.queryCopyFileRecordNextval();
+                        insertCopyRecord.setFileRecordId(fileRecordId);
+                        insertCopyRecord.setDocumentId(getBpAttachmentInfo.getDocumentId());
+                        insertCopyRecord.setDocumentType(getBpAttachmentInfo.getCddType());
+                        insertCopyRecord.setBpId(getBpAttachmentInfo.getBpId());
+                        insertCopyRecord.setHnRecordId(HnRecordId);
+                        insertCopyRecord.setFndRecordId(record_id);
+                        insertCopyRecord.setFndAttachmentId(attachment_id);
+                        insertCopyRecord.setOldPath(fndAtmAttachmentEntity.getFilePath());
+                        insertCopyRecord.setNewPath(newPath);
+                        insertCopyRecord.setFinishedFlag(COPU_FILE_FINISHED_FLAG_Y);
+                        insertCopyRecord.setCreatedBy(userId);
+                        insertCopyRecord.setCreationDate(new Date());
+                        insertCopyRecord.setLastUpdateDate(new Date());
+                        insertCopyRecord.setLastUpdatedBy(userId);
+                        insertCopyRecord.setCopyLog(COPU_FILE_SUCCESS_LOG);
+                        hnCopyFileRecordMapper.insertSelective(insertCopyRecord);
+                   // }
+                //}
+            }
+        }
+    }
+
 }
\ No newline at end of file
Index: src/main/java/com/hand/hls/file/service/impl/HnBpAttachSyncServiceImpl.java
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/java/com/hand/hls/file/service/impl/HnBpAttachSyncServiceImpl.java b/src/main/java/com/hand/hls/file/service/impl/HnBpAttachSyncServiceImpl.java
--- a/src/main/java/com/hand/hls/file/service/impl/HnBpAttachSyncServiceImpl.java	(revision 33faca6317f7cfd928f5c69aff3882add32116e6)
+++ b/src/main/java/com/hand/hls/file/service/impl/HnBpAttachSyncServiceImpl.java	(revision 40f9db19584377987c2cd103792e716e03ebefdc)
@@ -2,10 +2,7 @@

 import com.hand.hls.file.dto.*;
 import com.hand.hls.file.mapper.*;
-import com.hand.hls.file.service.IFndAtmTableCopyService;
-import com.hand.hls.file.service.IHnBpAttachSyncService;
-import com.hand.hls.file.service.IHnCopyFileRecordService;
-import com.hand.hls.file.service.IUpdateProjectCopyNoteService;
+import com.hand.hls.file.service.*;
 import org.slf4j.Logger;
 import org.slf4j.LoggerFactory;
 import org.springframework.beans.factory.annotation.Autowired;
@@ -45,6 +42,10 @@

     public static final String DELETE_FILE_FLAG_Y = "Y";

+    public static final String BP_DOCUMENT_TABLE_NAME = "HLS_BP_MASTER";
+
+    public static final String BP_TAB_GROUP = "TENANT";
+
     private Logger logger = LoggerFactory.getLogger(getClass());

     @Autowired
@@ -71,6 +72,13 @@
     @Autowired
     private FndAtmAttachmentMutiMapper fndAtmAttachmentMutiMapper;

+    @Autowired
+    private IHnCopyFileSelectCountService iHnCopyFileSelectCountService;
+
+    @Autowired
+    private IHnBpAttachSyncService hnBpAttachSyncService;
+
+
     @Override
     public List<FndAtmAttachmentMultiEntity> queryAttachmentMultiByCheckId(HnBpAttachmentRecordEntity hnBpAttachmentRecordEntity) {
         return hnBpAttachSyncMapper.queryAttachmentMultiByCheckId(hnBpAttachmentRecordEntity);
@@ -150,10 +158,11 @@
             hnBpAttachmentRecordEntity.setBpId(bpId);
             hnBpAttachmentRecordEntity.setCddItem(cddItem);
             int i = hnBpAttachmentRecordrMapper.insertSelective(hnBpAttachmentRecordEntity);
-            fndAtmTableCopyService.fndAtmTableCopy(hnBpAttachmentRecordEntity, recordId, userId);
+            fndAtmTableCopyService.fndAtmTableCopyNew(hnBpAttachmentRecordEntity, recordId, userId);
             vOrderSquence = vOrderSquence + 1;
         }

+
     }

     @Override
@@ -196,7 +205,7 @@
                         deleteAtmRecord(hlsCusFndAtmAttachmentMulti, queryAttachmentRecord, deleteFileFlag);
                     }
                 } catch (IOException e) {
-                    logger.error(DELETE_FILE_ERROR);
+                    logger.error(DELETE_FILE_ERROR + "文件路径为" + queryAttachmentRecord.getFilePath());
                 }
             }
     }
@@ -205,13 +214,12 @@
     void deleteAtmRecord(FndAtmAttachmentMultiEntity hlsCusFndAtmAttachmentMulti,
                          FndAtmAttachmentEntity fndAtmAttachmentDto,String deleteFileFlag) throws IOException {
        if (deleteFileFlag == DELETE_FILE_FLAG_Y) {
-            boolean flag = iHnCopyFileRecordService.deleteFile(fndAtmAttachmentDto.getFilePath());
-            if (flag == true) {
-                this.fndAtmAttachmentMapper.deleteByPrimaryKey(fndAtmAttachmentDto);
-                this.fndAtmAttachmentMutiMapper.deleteByPrimaryKey(hlsCusFndAtmAttachmentMulti);
-            } else{
+           boolean flag = iHnCopyFileRecordService.deleteFile(fndAtmAttachmentDto.getFilePath());
+           this.fndAtmAttachmentMapper.deleteByPrimaryKey(fndAtmAttachmentDto);
+           this.fndAtmAttachmentMutiMapper.deleteByPrimaryKey(hlsCusFndAtmAttachmentMulti);
+           if(!flag) {
                 throw new IOException(DELETE_FILE_ERROR);
-            }
+           }
         } else {
             this.fndAtmAttachmentMapper.deleteByPrimaryKey(fndAtmAttachmentDto);
             this.fndAtmAttachmentMutiMapper.deleteByPrimaryKey(hlsCusFndAtmAttachmentMulti);
@@ -237,6 +245,7 @@
         Date date = new Date();
         //--拷贝商业伙伴附件 插入记录表 直接查询出对应的附件表 将对应的 table_name 和tablpe_pk_value 换掉
         for (HnCddRefCheckEntity item1 : bpList) {
+            System.out.println(item1.toString());
             Long checkId = item1.getCheckId();
             prjCddItemEntity.setCheckId(checkId);
             int bpCountNum = hnBpAttachSyncMapper.queryBpCountNum(prjCddItemEntity);
@@ -248,7 +257,9 @@
                 hnBpAttachmentRecordEntity.setHnRecordId(hnRecordId);
                 hnBpAttachmentRecordEntity.setCheckId(checkId);
                 prjCddItemEntity.setHnRecordId(hnRecordId);
-                fndAtmTableCopyService.fndAtmTableCopy(hnBpAttachmentRecordEntity,hnRecordId,userId);
+                fndAtmTableCopyService.fndAtmTableCopyNew(hnBpAttachmentRecordEntity,hnRecordId,userId);
+                //更新商业伙伴附件信息
+                updateBpAttachmentInfo(item1, hnRecordId);
             } else {
                 String v_note = "";
                 String cddItem = "";
@@ -280,11 +291,35 @@
                 hnBpAttachmentRecordEntity.setCheckId(checkId);
                 hnBpAttachmentRecordEntity.setBpId(bpId);
                 hnBpAttachmentRecordEntity.setCddItem(cddItem);
+                hnBpAttachmentRecordEntity.setCddCategory(item1.getCddCategory());
+                hnBpAttachmentRecordEntity.setInvestigateGuideFlag(item1.getInvestigateGuideFlag());
+                hnBpAttachmentRecordEntity.setShowSeq(item1.getShowSeq());
+                hnBpAttachmentRecordEntity.setReasonAlternative(item1.getReasonAlternative());
+                hnBpAttachmentRecordEntity.setLenderTabGroup(item1.getLenderTabGroup());
+                hnBpAttachmentRecordEntity.setProjectRequiredFlag(item1.getProjectRequiredFlag());
                 int i = hnBpAttachmentRecordrMapper.insertSelective(hnBpAttachmentRecordEntity);
-                fndAtmTableCopyService.fndAtmTableCopy(hnBpAttachmentRecordEntity, recordId, userId);
+                fndAtmTableCopyService.fndAtmTableCopyNew(hnBpAttachmentRecordEntity, recordId, userId);
             }
         }
     }
+
+    /**
+     * 更新 项目方案中的项目 的 商业伙伴的附件信息
+     * @param bpAttachmentInfo 在商业伙伴附件信息表里查出来的数据
+     * @param hnRecordId 商业伙伴附件信息表主键ID
+     */
+    private void updateBpAttachmentInfo(HnCddRefCheckEntity bpAttachmentInfo, Long hnRecordId){
+        HnBpAttachmentRecordEntity updateAttachmentInfo = new HnBpAttachmentRecordEntity();
+        updateAttachmentInfo.setHnRecordId(hnRecordId);
+        updateAttachmentInfo.setCddCategory(bpAttachmentInfo.getCddCategory());
+        updateAttachmentInfo.setInvestigateGuideFlag(bpAttachmentInfo.getInvestigateGuideFlag());
+        updateAttachmentInfo.setShowSeq(bpAttachmentInfo.getShowSeq());
+        updateAttachmentInfo.setReasonAlternative(bpAttachmentInfo.getReasonAlternative());
+        updateAttachmentInfo.setLenderTabGroup(bpAttachmentInfo.getLenderTabGroup());
+        updateAttachmentInfo.setProjectRequiredFlag(bpAttachmentInfo.getProjectRequiredFlag());
+        hnBpAttachmentRecordrMapper.updateBpAttachmentByRecordId(updateAttachmentInfo);
+        logger.debug("hello");
+    }

     @Override
     public void delBpAttachment(PrjCddItemEntity prjCddItemEntity) {
@@ -294,4 +329,69 @@
             //delete hn_bp_attachment_record
             hnBpAttachSyncMapper.delAtmAttachmentRecord(prjCddItemEntity);
     }
+
+    @Override
+    public String copyBpFile(PrjProjectBpEntity item,PrjProjectBpEntity prjProjectBpEntityr,String p_type, Long userId) {
+        try {
+        int v_count_num;
+        int v_count_num1;
+        PrjCddItemEntity prjCddItemEntity = new PrjCddItemEntity();
+        HnBpAttachmentRecordEntity hnBpAttachmentRecordEntity = new HnBpAttachmentRecordEntity();
+        long prjBpId = item.getPrjBpId();
+        Long bpId = item.getBpId();
+        prjProjectBpEntityr.setPrjBpId(prjBpId);
+        prjProjectBpEntityr.setBpId(bpId);
+        //查询附件记录是否存在
+        v_count_num = iHnCopyFileSelectCountService.queryCountNum(prjProjectBpEntityr);
+        v_count_num1 = iHnCopyFileSelectCountService.queryCountNum1(prjProjectBpEntityr);
+        HlsBpMasterEntity hbm = iHnCopyFileSelectCountService.queryBpList(prjProjectBpEntityr);
+        Long cddListId = hbm.getCddListId();
+
+        prjCddItemEntity.setTabGroup(BP_TAB_GROUP);
+        PrjCddItemEntity tabGroupId = hnBpAttachSyncService.queryTabGroupId(prjCddItemEntity);
+        Long tabGroupId1 = tabGroupId.getTabGroupId();
+
+        if("".equals(tabGroupId1) && tabGroupId1 != null){
+            tabGroupId1 = (long)4;
+        }
+
+        // 存在记录仅仅拷贝附件  如果有新的列  则拷贝
+        if (("SYNCHRO".equals(p_type)) && p_type != null  && (v_count_num > 0) && (v_count_num1 > 0)) {
+            prjCddItemEntity.setPrjBpId(prjBpId);
+            prjCddItemEntity.setBpId(bpId);
+            prjCddItemEntity.setCddListId(cddListId);
+            prjCddItemEntity.setTabGroupId(tabGroupId1);
+            prjCddItemEntity.setTableName(BP_DOCUMENT_TABLE_NAME);
+            hnBpAttachSyncService.copyBpAttachSync(prjCddItemEntity,prjProjectBpEntityr,hnBpAttachmentRecordEntity, userId);
+        }
+        else if ( ("UPDATE".equals(p_type)) && p_type != null   && (v_count_num > 0) && (v_count_num1 > 0)) {
+            //-- 改变了商业伙伴
+
+        }
+        //-- 改变了商业伙伴要先删除记录 然后在插入    此处删除全部记录
+        else if (("UPDATE".equals(p_type)) && p_type != null   && (v_count_num == 0) && (v_count_num1 > 0)  ) {
+            prjCddItemEntity.setPrjBpId(prjBpId);
+            //DELETE fnd_atm_attachment
+            prjCddItemEntity.setTableName(SOURCE_BP_DELETE_TYPE);
+            hnBpAttachSyncService.delBpAttachment(prjCddItemEntity);
+            //copy_bp_attach
+            hnBpAttachSyncService.copyBpAttach(prjCddItemEntity, prjProjectBpEntityr, hnBpAttachmentRecordEntity,userId);
+        } else {
+            //copy_bp_attach
+            prjCddItemEntity.setPrjBpId(prjBpId);
+            prjCddItemEntity.setBpId(bpId);
+            prjCddItemEntity.setCddListId(cddListId);
+            prjCddItemEntity.setTabGroupId(tabGroupId1);
+            prjCddItemEntity.setTableName(BP_DOCUMENT_TABLE_NAME);
+            hnBpAttachSyncService.copyBpAttach(prjCddItemEntity, prjProjectBpEntityr, hnBpAttachmentRecordEntity, userId);
+
+        }
+        return "Y";
+        }catch (Exception e){
+            return "N";
+        }
+//                //对于重复的进行删除
+//                HnBpAttachmentRecordEntity hnBpAttachmentRecordEntityP = new HnBpAttachmentRecordEntity();
+    }
+
 }
\ No newline at end of file
Index: src/main/resources/com/hand/hls/file/mapper/HnBpAttachSyncMapper.xml
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/com/hand/hls/file/mapper/HnBpAttachSyncMapper.xml b/src/main/resources/com/hand/hls/file/mapper/HnBpAttachSyncMapper.xml
--- a/src/main/resources/com/hand/hls/file/mapper/HnBpAttachSyncMapper.xml	(revision 33faca6317f7cfd928f5c69aff3882add32116e6)
+++ b/src/main/resources/com/hand/hls/file/mapper/HnBpAttachSyncMapper.xml	(revision 40f9db19584377987c2cd103792e716e03ebefdc)
@@ -13,6 +13,12 @@
         <result column="CDD_ITEM_ID" property="cddItemId" jdbcType="DECIMAL" />
         <result column="CHECK_ID" property="checkId" jdbcType="DECIMAL" />
         <result column="TAB_GROUP" property="tabGroup" jdbcType="VARCHAR" />
+        <result column="CDD_CATEGORY" property="cddCategory" jdbcType="VARCHAR"/>
+        <result column="PROJECT_REQUIRED_FLAG" property="projectRequiredFlag" jdbcType="VARCHAR"/>
+        <result column="LENDER_TAB_GROUP" property="lenderTabGroup" jdbcType="VARCHAR"/>
+        <result column="SHOW_SEQ" property="showSeq" jdbcType="VARCHAR"/>
+        <result column="INVESTIGATE_GUIDE_FLAG" property="investigateGuideFlag" jdbcType="VARCHAR"/>
+        <result column="REASON_ALTERNATIVE" property="reasonAlternative" jdbcType="VARCHAR"/>
     </resultMap>
     <resultMap id="BaseResultMuiltMap" type="com.hand.hls.file.dto.FndAtmAttachmentMultiEntity">
         <result column="RECORD_ID" property="recordId" jdbcType="DECIMAL" />
@@ -61,39 +67,48 @@
             resultMap="BaseResultMap">

         SELECT pp.check_id,pci.cdd_item,pp.document_id,pp.document_table,
-               pp.cdd_item_id,pci.description,pci.order_seq,pci.note,tg.tab_group_id
-                    FROM (SELECT pcf.check_id,
-                                 pcf.document_id,
-                                 pcf.document_table,
-                                 pck.cdd_item_id
-                            FROM prj_cdd_item_doc_ref pcf,
-                                 prj_cdd_item_check   pck
-                           WHERE pcf.document_table = #{tableName,jdbcType=VARCHAR}
-                             AND pcf.document_id = #{bpId,jdbcType=DECIMAL} -- p_bp_id
-                             AND pck.check_id = pcf.check_id) pp,
-                         prj_cdd_item pci,
-                         prj_cdd_item_list_grp_tab lgt,
-                         prj_cdd_item_tab_group tg
-                   WHERE pci.cdd_item_id = lgt.cdd_item_id
-                     AND lgt.TAB_GROUP_ID = tg.TAB_GROUP_ID(+)
-                     AND nvl(lgt.enabled_flag, 'Y') = 'Y'
-                     AND nvl(tg.enabled_flag, 'Y') = 'Y'
-                     AND nvl(tg.tab_group_id, -1) = nvl(#{tabGroupId,jdbcType=DECIMAL}, -1)
-                     AND pci.cdd_item_id = pp.cdd_item_id(+)
-                     AND (nvl(pci.sys_flag, 'N') = 'Y' OR
-                         (nvl(pci.sys_flag, 'N') = 'N' AND
-                         pp.check_id IS NOT NULL))
-                     AND pci.cdd_list_id =
-                         nvl(#{cddListId,jdbcType=DECIMAL}, #{cddListId,jdbcType=DECIMAL})
-                     AND pci.enabled_flag = 'Y'
-                     AND lgt.cdd_list_id = #{cddListId,jdbcType=DECIMAL}
-                   ORDER BY lgt.seq_num ASC
+               pp.cdd_item_id,pci.description,pci.order_seq,pci.note,tg.tab_group_id,
+               (select cdd_category from prj_cdd_item_templet pct where pct.cdd_item = pci.cdd_item and pct.cdd_category is not null AND ROWNUM=1) cdd_category,
+               pci.project_required_flag,
+               pci.lender_tab_group,
+               pci.show_seq,
+               nvl(pp.investigate_guide_flag, 'Y') investigate_guide_flag,
+               pp.reason_alternative
+
+        FROM (SELECT pcf.check_id,
+                     pcf.document_id,
+                     pcf.document_table,
+                     pck.cdd_item_id,
+                     pck.investigate_guide_flag,
+                     pck.reason_alternative
+              FROM prj_cdd_item_doc_ref pcf,
+                   prj_cdd_item_check   pck
+              WHERE pcf.document_table = #{tableName,jdbcType=VARCHAR}
+                AND pcf.document_id = #{bpId,jdbcType=DECIMAL} -- p_bp_id
+                AND pck.check_id = pcf.check_id) pp,
+             prj_cdd_item pci,
+             prj_cdd_item_list_grp_tab lgt,
+             prj_cdd_item_tab_group tg
+        WHERE pci.cdd_item_id = lgt.cdd_item_id
+          AND lgt.TAB_GROUP_ID = tg.TAB_GROUP_ID(+)
+          AND nvl(lgt.enabled_flag, 'Y') = 'Y'
+          AND nvl(tg.enabled_flag, 'Y') = 'Y'
+          AND nvl(tg.tab_group_id, -1) = nvl(#{tabGroupId,jdbcType=DECIMAL}, -1)
+          AND pci.cdd_item_id = pp.cdd_item_id(+)
+          AND (nvl(pci.sys_flag, 'N') = 'Y' OR
+               (nvl(pci.sys_flag, 'N') = 'N' AND
+                pp.check_id IS NOT NULL))
+          AND pci.cdd_list_id =
+              nvl(#{cddListId,jdbcType=DECIMAL}, #{cddListId,jdbcType=DECIMAL})
+          AND pci.enabled_flag = 'Y'
+          AND lgt.cdd_list_id = #{cddListId,jdbcType=DECIMAL}
+        ORDER BY lgt.seq_num ASC
     </select>
-
+
     <select id="queryTabGroupId" parameterType="com.hand.hls.file.dto.PrjCddItemEntity"
             resultMap="BaseResultCddItem">
         SELECT tt.tab_group_id FROM prj_cdd_item_tab_group tt
-         WHERE tt.tab_group = #{tabGroup,jdbcType=VARCHAR}
+        WHERE tt.tab_group = #{tabGroup,jdbcType=VARCHAR}
     </select>

     <select id="queryBpCountNum" resultType="java.lang.Integer">
@@ -117,20 +132,20 @@
     -->
     <select id="queryBpVNum" resultType="java.lang.Integer">
         SELECT COUNT(1) as v_num
-            FROM prj_project_bp ppb
-             WHERE
-                1 = 1
-                <if test="prjBpId != null">
-                    AND ppb.prj_bp_id = #{prjBpId,jdbcType=DECIMAL}
-                </if>
-                AND EXISTS
-                    (SELECT 1 FROM prj_project pp
-                        WHERE
-                          1 = 1
-                            <if test="projectId != null">
-                                and pp.project_id = #{projectId,jdbcType=DECIMAL}
-                            </if>
-                          AND pp.data_class = 'NORMAL')
+        FROM prj_project_bp ppb
+        WHERE
+        1 = 1
+        <if test="prjBpId != null">
+            AND ppb.prj_bp_id = #{prjBpId,jdbcType=DECIMAL}
+        </if>
+        AND EXISTS
+        (SELECT 1 FROM prj_project pp
+        WHERE
+        1 = 1
+        <if test="projectId != null">
+            and pp.project_id = #{projectId,jdbcType=DECIMAL}
+        </if>
+        AND pp.data_class = 'NORMAL')

     </select>

@@ -138,16 +153,17 @@
             parameterType="com.hand.hls.file.dto.HnBpAttachmentRecordEntity"
             resultMap="BaseResultMuiltMap" >
         SELECT * FROM fnd_atm_attachment_multi tt
-                    WHERE
-                    1 = 1
-                        <if test="checkId != null">
-                            and tt.table_pk_value = #{checkId,jdbcType=DECIMAL}
-                        </if>
-                      AND tt.table_name = #{tableName,jdbcType=VARCHAR}
+        WHERE
+        1 = 1
+        <if test="checkId != null">
+            and tt.table_pk_value = #{checkId,jdbcType=DECIMAL}
+        </if>
+        AND tt.table_name = #{tableName,jdbcType=VARCHAR}
+        and nvl(tt.del_flag,0)=0
     </select>

     <select id="queryNextval" resultType="java.lang.Long">
-              SELECT fnd_atm_attachment_multi_s.nextval  FROM dual
+        SELECT fnd_atm_attachment_multi_s.nextval  FROM dual
     </select>


@@ -155,8 +171,8 @@

     <select id="queryAttachmentList" parameterType="com.hand.hls.file.dto.FndAtmAttachmentMultiEntity"
             resultMap="BaseResultAttachmentMap">
-              SELECT * FROM fnd_atm_attachment tt
-                      WHERE tt.attachment_id =#{attachmentId,jdbcType=DECIMAL}
+        SELECT * FROM fnd_atm_attachment tt
+        WHERE tt.attachment_id =#{attachmentId,jdbcType=DECIMAL}
     </select>

     <!--
@@ -166,54 +182,59 @@
     -->

     <select id="querySysGuid" resultType="java.lang.String">  /*   varchar类型*/
-              SELECT sys_guid()  FROM dual
+    SELECT sys_guid()  FROM dual
     </select>


     <select id="queryBeginPath" resultType="java.lang.String">
-             SELECT dd.directory_path as v_begin_path
-             FROM dba_directories dd
-             WHERE dd.directory_name = 'HLS_BP_ATTACH_DIR'
+        SELECT dd.directory_path as v_begin_path
+        FROM dba_directories dd
+        WHERE dd.directory_name = 'HLS_BP_ATTACH_DIR'
     </select>

     <select id="queryAttachmentId" resultType="java.lang.Long">
-             SELECT fnd_atm_attachment_s.nextval as v_attachment_id FROM dual
+        SELECT fnd_atm_attachment_s.nextval as v_attachment_id FROM dual
     </select>

     <select id="queryHnRecordId" resultType="java.lang.Long">
         SELECT tt.hn_record_id FROM hn_bp_attachment_record tt
-         WHERE
-         tt.check_id = #{checkId,jdbcType=DECIMAL}
-           AND tt.document_id = #{prjBpId,jdbcType=DECIMAL}
+        WHERE
+            tt.check_id = #{checkId,jdbcType=DECIMAL}
+          AND tt.document_id = #{prjBpId,jdbcType=DECIMAL}
     </select>

     <select id="queryAttachmentCount" parameterType="com.hand.hls.file.dto.PrjCddItemEntity" resultType="java.lang.Long">
         SELECT count(*) FROM fnd_atm_attachment_multi tt
-                    WHERE tt.table_pk_value = #{hnRecordId,jdbcType=DECIMAL}
-                          and tt.table_name = #{tableName,jdbcType=VARCHAR}
+        WHERE tt.table_pk_value = #{hnRecordId,jdbcType=DECIMAL}
+          and tt.table_name = #{tableName,jdbcType=VARCHAR}
+          and nvl(tt.del_flag,0)=0
     </select>

     <select id="queryAttachmentRecord" parameterType="com.hand.hls.file.dto.FndAtmAttachmentEntity"
             resultMap="BaseResultAttachmentMap">
         select * from fnd_atm_attachment t
-              left join fnd_atm_attachment_multi ft on t.attachment_id = ft.attachment_id
-              where t.source_type_code = #{sourceTypeCode,jdbcType=VARCHAR}
-               and ft.table_pk_value = #{hnRecordId,jdbcType=DECIMAL}
+                          left join fnd_atm_attachment_multi ft on t.attachment_id = ft.attachment_id
+        where t.source_type_code = #{sourceTypeCode,jdbcType=VARCHAR}
+          and ft.table_pk_value = #{hnRecordId,jdbcType=DECIMAL}
+          and nvl(ft.del_flag,0)=0
+          and nvl(t.del_flag,0)=0
     </select>


     <select id="queryAttachmentByTableNameAndPkValue" parameterType="com.hand.hls.file.dto.FndAtmAttachmentMultiEntity"
             resultMap="BaseResultMuiltMap">
         SELECT * FROM fnd_atm_attachment_multi tt
-                    WHERE tt.table_pk_value = #{tablePkValue,jdbcType=DECIMAL}
-                          and tt.table_name = #{tableName,jdbcType=VARCHAR}
+        WHERE tt.table_pk_value = #{tablePkValue,jdbcType=DECIMAL}
+          and tt.table_name = #{tableName,jdbcType=VARCHAR}
+          and nvl(tt.del_flag,0)=0
     </select>

     <select id="selectByCodeAndPkValue" parameterType="com.hand.hls.file.dto.FndAtmAttachmentMultiEntity"
             resultMap="BaseResultAttachmentMap">
         SELECT * FROM fnd_atm_attachment tt
-                    WHERE tt.source_pk_value = #{recordId,jdbcType=DECIMAL}
-                    and tt.source_type_code = #{sourceTypeCode,jdbcType=VARCHAR}
+        WHERE tt.source_pk_value = #{recordId,jdbcType=DECIMAL}
+          and tt.source_type_code = #{sourceTypeCode,jdbcType=VARCHAR}
+          and nvl(tt.del_flag,0)=0
     </select>


@@ -235,18 +256,18 @@


     <delete id="delAtachmentMultiByPkvalue" parameterType="com.hand.hls.file.dto.PrjCddItemEntity">
-      delete FROM fnd_atm_attachment_multi tt
-          WHERE tt.table_pk_value = #{hnRecordId,jdbcType=DECIMAL}
+        update fnd_atm_attachment_multi tt set tt.del_flag=1
+        WHERE tt.table_pk_value = #{hnRecordId,jdbcType=DECIMAL}
           and tt.table_name = #{tableName,jdbcType=VARCHAR}
     </delete>

     <delete id="delAtachmentByPkvalue" parameterType="com.hand.hls.file.dto.PrjCddItemEntity">
-      delete from fnd_atm_attachment faa where faa.attachment_id in(
-                 select faa.attachment_id from  fnd_atm_attachment faa
-                     left join fnd_atm_attachment_multi tt on faa.attachment_id = tt.attachment_id
-                        WHERE tt.table_pk_value = #{hnRecordId,jdbcType=DECIMAL}
-                        and tt.table_name = #{tableName,jdbcType=VARCHAR} )
-</delete>
+        update fnd_atm_attachment faa set faa.del_flag=1 where faa.attachment_id in(
+            select faa.attachment_id from  fnd_atm_attachment faa
+                                               left join fnd_atm_attachment_multi tt on faa.attachment_id = tt.attachment_id
+            WHERE tt.table_pk_value = #{hnRecordId,jdbcType=DECIMAL}
+              and tt.table_name = #{tableName,jdbcType=VARCHAR} )
+    </delete>



@@ -255,28 +276,28 @@

     <!--改变商业伙伴删除全部记录-->
     <delete id="delAtmAttachment" parameterType="com.hand.hls.file.dto.PrjCddItemEntity">
-      DELETE FROM fnd_atm_attachment faa
-         WHERE faa.attachment_id IN
-               (SELECT faam.attachment_id
-                  FROM fnd_atm_attachment_multi faam,
-                       hn_bp_attachment_record  h
-                 WHERE faam.table_pk_value = h.hn_record_id
-                   AND h.document_id = #{prjBpId,jdbcType=DECIMAL}
-                   AND faam.table_name = #{tableName,jdbcType=VARCHAR})
+        update fnd_atm_attachment faa set faa.del_flag=1
+        WHERE faa.attachment_id IN
+              (SELECT faam.attachment_id
+               FROM fnd_atm_attachment_multi faam,
+                    hn_bp_attachment_record  h
+               WHERE faam.table_pk_value = h.hn_record_id
+                 AND h.document_id = #{prjBpId,jdbcType=DECIMAL}
+                 AND faam.table_name = #{tableName,jdbcType=VARCHAR})
     </delete>

     <delete id="delAtmAttachmentMulti" parameterType="com.hand.hls.file.dto.PrjCddItemEntity">
-      DELETE FROM fnd_atm_attachment_multi tt
-         WHERE tt.table_name = #{tableName,jdbcType=VARCHAR}
-           AND tt.table_pk_value IN
-               (SELECT h.hn_record_id
-                  FROM hn_bp_attachment_record h
-                 WHERE h.document_id = #{prjBpId,jdbcType=DECIMAL})
+        update fnd_atm_attachment_multi tt set tt.del_flag=1
+        WHERE tt.table_name = #{tableName,jdbcType=VARCHAR}
+          AND tt.table_pk_value IN
+              (SELECT h.hn_record_id
+               FROM hn_bp_attachment_record h
+               WHERE h.document_id = #{prjBpId,jdbcType=DECIMAL})
     </delete>

     <delete id="delAtmAttachmentRecord" parameterType="com.hand.hls.file.dto.PrjCddItemEntity">
         DELETE FROM hn_bp_attachment_record tt
-         WHERE tt.document_id = #{prjBpId,jdbcType=DECIMAL}
+        WHERE tt.document_id = #{prjBpId,jdbcType=DECIMAL}
     </delete>


Index: src/main/resources/com/hand/hls/file/mapper/HnBpAttachmentRecordrMapper.xml
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/com/hand/hls/file/mapper/HnBpAttachmentRecordrMapper.xml b/src/main/resources/com/hand/hls/file/mapper/HnBpAttachmentRecordrMapper.xml
--- a/src/main/resources/com/hand/hls/file/mapper/HnBpAttachmentRecordrMapper.xml	(revision 33faca6317f7cfd928f5c69aff3882add32116e6)
+++ b/src/main/resources/com/hand/hls/file/mapper/HnBpAttachmentRecordrMapper.xml	(revision 40f9db19584377987c2cd103792e716e03ebefdc)
@@ -19,4 +19,15 @@
              WHERE t.hn_record_id = #{hnRecordId,jdbcType=DECIMAL}
     </select>

+    <update id="updateBpAttachmentByRecordId" parameterType="com.hand.hls.file.dto.HnBpAttachmentRecordEntity">
+        update hn_bp_attachment_record
+            set  CDD_CATEGORY = #{cddCategory},
+                INVESTIGATE_GUIDE_FLAG = #{investigateGuideFlag},
+                SHOW_SEQ = #{showSeq},
+                REASON_ALTERNATIVE = #{reasonAlternative},
+                PROJECT_REQUIRED_FLAG = #{projectRequiredFlag},
+                LENDER_TAB_GROUP = #{lenderTabGroup}
+                WHERE hn_record_id = #{hnRecordId,jdbcType=DECIMAL}
+    </update>
+
 </mapper>
\ No newline at end of file
Index: src/main/resources/leaf_static/modules/hls/HLS213N/hls_bp_master_create.lview
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/hls/HLS213N/hls_bp_master_create.lview b/src/main/resources/leaf_static/modules/hls/HLS213N/hls_bp_master_create.lview
--- a/src/main/resources/leaf_static/modules/hls/HLS213N/hls_bp_master_create.lview	(revision 33faca6317f7cfd928f5c69aff3882add32116e6)
+++ b/src/main/resources/leaf_static/modules/hls/HLS213N/hls_bp_master_create.lview	(revision 40f9db19584377987c2cd103792e716e03ebefdc)
@@ -184,6 +184,18 @@
                         }
                     }

+                }
+
+                let cdd_ds = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_cdd_item_doc_ref', 'T_CERTIFICATE');
+                if(cdd_ds === ds.id){
+                    if(name === 'investigate_guide_flag'){
+                        if(value === 'N'){
+                            record.getField('reason_alternative').setRequired(true);
+                        }
+                        else if(value === 'Y'){
+                            record.getField('reason_alternative').setRequired(false);
+                        }
+                    }
                 }
             };
             //保存前调用，生成商机编号
@@ -257,6 +269,14 @@
                         height: 400
                     });
                     win.on('close', function() {
+                        Leaf.request({
+                            url: '${/request/@context_path}/autocrud/update_file_version_by_pk/execute',
+                            para: {
+                                table_name: 'PRJ_CDD_ITEM_CHECK',
+                                table_pk_value: record.get('check_id')
+                            },
+                            scope: this
+                        });
                         record.ds.query(dsCurrentPage);
                     });
                 } else {
Index: src/main/resources/leaf_static/WEB-INF/classes/prj/PRJ501Z/hn_prj_clause_lib_manage_lv_query.lwm
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/WEB-INF/classes/prj/PRJ501Z/hn_prj_clause_lib_manage_lv_query.lwm b/src/main/resources/leaf_static/WEB-INF/classes/prj/PRJ501Z/hn_prj_clause_lib_manage_lv_query.lwm
--- a/src/main/resources/leaf_static/WEB-INF/classes/prj/PRJ501Z/hn_prj_clause_lib_manage_lv_query.lwm	(revision 40f9db19584377987c2cd103792e716e03ebefdc)
+++ b/src/main/resources/leaf_static/WEB-INF/classes/prj/PRJ501Z/hn_prj_clause_lib_manage_lv_query.lwm	(revision 43022f19947564eea387db7582c0658dc915148b)
@@ -28,6 +28,7 @@
         <bm:field name="date_type" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="DATE_TYPE"/>
         <bm:field name="date_type_n" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="DATE_TYPE_N"/>
         <bm:field name="lib_manage_type" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="LIB_MANAGE_TYPE"/>
+        <bm:field name="show_seq" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="SHOW_SEQ"/>
     </bm:fields>
     <bm:features>
         <f:standard-who />
Index: src/main/resources/leaf_static/WEB-INF/classes/prj/PRJ501Z/hn_prj_prepayment_clause.lwm
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/WEB-INF/classes/prj/PRJ501Z/hn_prj_prepayment_clause.lwm b/src/main/resources/leaf_static/WEB-INF/classes/prj/PRJ501Z/hn_prj_prepayment_clause.lwm
--- a/src/main/resources/leaf_static/WEB-INF/classes/prj/PRJ501Z/hn_prj_prepayment_clause.lwm	(revision 40f9db19584377987c2cd103792e716e03ebefdc)
+++ b/src/main/resources/leaf_static/WEB-INF/classes/prj/PRJ501Z/hn_prj_prepayment_clause.lwm	(revision 43022f19947564eea387db7582c0658dc915148b)
@@ -21,6 +21,7 @@
         <bm:field name="contract_write_flag" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="CONTRACT_WRITE_FLAG"/>
         <bm:field name="antistop_key" expression="(select hm.antistop_key from hn_prj_clause_lib_manage hm where hm.clause_lib_id = t1.clause_lib_id)" forUpdate="false" forInsert="false"/>
         <bm:field name="third_classification" expression="(select hm.third_classification from hn_prj_clause_lib_manage hm where hm.clause_lib_id = t1.clause_lib_id)" forUpdate="false" forInsert="false"/>
+        <bm:field name="show_seq"   databaseType="VARCHAR2" datatype="java.lang.String" physicalName="SHOW_SEQ"/>
     </bm:fields>
     <bm:features>
         <f:standard-who/>
@@ -49,7 +50,8 @@
                                                              p_pre_cla_content      =>${@pre_cla_content},
                                                              p_seq_number           =>${@seq_number},
                                                              p_contract_write_flag  =>${@contract_write_flag},
-                                                             p_user_id              =>${/session/@user_id});
+                                                             p_user_id              =>${/session/@user_id},
+                                                             p_show_seq             =>${@show_seq});
                 end;
                 ]]></bm:update-sql>
         </bm:operation>
Index: src/main/resources/leaf_static/WEB-INF/classes/prj/PRJ501Z/prj_clause_lib_contract_lov.lwm
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/WEB-INF/classes/prj/PRJ501Z/prj_clause_lib_contract_lov.lwm b/src/main/resources/leaf_static/WEB-INF/classes/prj/PRJ501Z/prj_clause_lib_contract_lov.lwm
--- a/src/main/resources/leaf_static/WEB-INF/classes/prj/PRJ501Z/prj_clause_lib_contract_lov.lwm	(revision 40f9db19584377987c2cd103792e716e03ebefdc)
+++ b/src/main/resources/leaf_static/WEB-INF/classes/prj/PRJ501Z/prj_clause_lib_contract_lov.lwm	(revision 43022f19947564eea387db7582c0658dc915148b)
@@ -28,6 +28,8 @@
                   physicalName="DOCUMENT_CATEGORY_N" prompt="单据类别"/>
         <bm:field name="clause_category"  databaseType="VARCHAR2" datatype="java.lang.String"  forDisplay="false"
                   physicalName="CLAUSE_CATEGORY" prompt="单据类别"/>
+        <bm:field name="show_seq" databaseType="VARCHAR2" datatype="java.lang.String"  forDisplay="false"
+                  physicalName="CLAUSE_CATEGORY" prompt="重要文件标识"/>
     </bm:fields>
     <bm:features>
         <f:standard-who/>
Index: src/main/resources/leaf_static/WEB-INF/classes/update_file_version_by_pk.lwm
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/WEB-INF/classes/update_file_version_by_pk.lwm b/src/main/resources/leaf_static/WEB-INF/classes/update_file_version_by_pk.lwm
new file mode 100644
--- /dev/null	(revision 43022f19947564eea387db7582c0658dc915148b)
+++ b/src/main/resources/leaf_static/WEB-INF/classes/update_file_version_by_pk.lwm	(revision 43022f19947564eea387db7582c0658dc915148b)
@@ -0,0 +1,16 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<bm:model xmlns:bm="http://www.leaf-framework.org/schema/bm">
+    <bm:operations>
+        <bm:operation name="execute">
+            <bm:update-sql><![CDATA[
+            begin
+                hls_bp_master_pkg.update_file_version_by_pk(p_table_name   => ${@table_name},
+                                                            p_table_pk_value => ${@table_pk_value});
+
+            end;
+
+            ]]></bm:update-sql>
+        </bm:operation>
+    </bm:operations>
+
+</bm:model>
Index: src/main/resources/leaf_static/WEB-INF/classes/acrch/ACRCH001/con_content_query_detail.lwm
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/WEB-INF/classes/acrch/ACRCH001/con_content_query_detail.lwm b/src/main/resources/leaf_static/WEB-INF/classes/acrch/ACRCH001/con_content_query_detail.lwm
new file mode 100644
--- /dev/null	(revision 600e775116243404a756244fa5f1586954125738)
+++ b/src/main/resources/leaf_static/WEB-INF/classes/acrch/ACRCH001/con_content_query_detail.lwm	(revision 600e775116243404a756244fa5f1586954125738)
@@ -0,0 +1,185 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!--
+    $Author: Feng
+    $Date: 2014-1-3 上午11:36:15
+    $Revision: 1.0
+    $Purpose:
+-->
+<bm:model xmlns:bm="http://www.leaf-framework.org/schema/bm">
+    <bm:operations>
+        <bm:operation name="query">
+            <bm:query-sql><![CDATA[
+                SELECT * from
+                    ( select (SELECT p.document_table FROM prj_cdd_item_doc_ref p WHERE p.check_id = pcc.check_id and p.document_id = t.contract_id and p.document_table in ('CON_CONTRACT_CREDIT','CON_CONTRACT') AND ROWNUM=1) document_table,
+                    t.contract_id document_id,
+                    t.document_category,
+                    pci.cdd_item_id,
+                    pci.cdd_list_id,
+                    pci.cdd_item,
+                    pci.description,
+                    pci.enabled_flag,
+                    pci.note,
+                    NVL(pci.sys_flag, 'N') sys_flag,
+                    pcc.paper_required,
+                    pcc.attachment_required,
+                    --pci.paper_content_flag,
+                    pcc.not_applicable,
+                    pcc.check_id,
+                    pci.order_seq,
+                    pci.sign_required_flag,
+                    hls_sys_upload_pkg.get_atm_file_href(p_table_pk_value => pcc.check_id,p_source_type => 'PRJ_CDD_ITEM_CHECK',p_user_id => ${/session/@user_id}) AS file_name
+                    --(SELECT
+                    --    MAX(fm.creation_date)
+                    --FROM
+                    --    fnd_atm_attachment_multi fm
+                    --WHERE
+                    --    fm.table_name     = 'PRJ_CDD_ITEM_CHECK' AND
+                    --    fm.table_pk_value = pcc.check_id
+                    --) creation_date
+                FROM
+                    prj_cdd_item pci,
+                    prj_cdd_item_check pcc,
+                    con_contract t
+                WHERE
+                    pci.cdd_item_id  = pcc.cdd_item_id(+) AND
+                    t.cdd_list_id    = pci.cdd_list_id AND
+                    pci.cdd_list_id  = t.cdd_list_id AND
+                    pci.enabled_flag = 'Y'  and
+                    t.contract_id    = ${/parameter/@contract_id}) t1
+                   order by order_seq
+            ]]></bm:query-sql>
+            <bm:parameters>
+                <bm:parameter inputPath="/parameter/@contract_id"/>
+            </bm:parameters>
+        </bm:operation>
+        <bm:operation name="update">
+            <bm:update-sql><![CDATA[
+            	BEGIN
+            	      prj_cdd_item_pkg.prj_cdd_item_doc_ref_save(p_document_table => ${@document_table},
+                                             p_document_id => ${@document_id},
+                                             p_attachment_tab_group_id => ${@attachment_tab_group_id},
+                                             p_cdd_list_id => ${@cdd_list_id},
+                                             p_cdd_item => ${@cdd_item},
+                                             p_description => ${@description},
+                                             p_line_type => 'FILE',
+                                             p_order_seq => ${@order_seq},
+                                             p_show_seq => ${@show_seq},
+                                             p_enabled_flag =>'Y',
+                                             p_chance_required_flag => ${@chance_required_flag},
+                                             p_chance_display_flag => ${@chance_display_flag},
+                                             p_project_required_flag => ${@project_required_flag},
+                                             p_project_display_flag => ${@project_display_flag},
+                                             p_contract_required_flag => ${@contract_required_flag},
+                                             p_contract_display_flag => ${@contract_display_flag},
+                                             p_sign_required_flag => ${@sign_required_flag},
+                                             p_sign_display_flag => ${@sign_display_flag},
+                                             p_incept_required_flag => ${@incept_required_flag},
+                                             p_incept_display_flag => ${@incept_display_flag},
+                                             p_lender_required_flag => ${@lender_required_flag},
+                                             p_lender_display_flag => ${@lender_display_flag},
+                                             p_chance_tab_group => ${@chance_tab_group},
+                                             p_project_tab_group => ${@project_tab_group},
+                                             p_contract_tab_group => ${@contract_tab_group},
+                                             p_sign_tab_group => ${@sign_tab_group},
+                                             p_incept_tab_group => ${@incept_tab_group},
+                                             p_lender_tab_group => ${@lender_tab_group},
+                                             p_sys_flag => ${@sys_flag},
+                                             p_note => ${@note},
+                                             p_send_flag => ${@send_flag},
+                                             p_paper_required => ${@paper_required},
+                                             p_attachment_required => ${@attachment_required},
+                                             p_not_applicable => ${@not_applicable},
+                                             p_cdd_item_id => ${@cdd_item_id},
+                                             p_check_id => ${@check_id},
+                                             p_user_id => ${/session/@user_id});
+            	END;
+        	]]></bm:update-sql>
+            <bm:parameters>
+                <bm:parameter name="cdd_item_id" input="true" inputPath="@cdd_item_id" output="true" outputPath="@cdd_item_id"/>
+                <bm:parameter name="check_id" input="true" inputPath="@check_id" output="true" outputPath="@check_id"/>
+            </bm:parameters>
+        </bm:operation>
+        <bm:operation name="insert">
+            <bm:update-sql><![CDATA[
+            	BEGIN
+            	    prj_cdd_item_pkg.prj_cdd_item_doc_ref_save(p_document_table => ${@document_table},
+                                             p_document_id => ${@document_id},
+                                             p_attachment_tab_group_id => ${@attachment_tab_group_id},
+                                             p_cdd_list_id => ${@cdd_list_id},
+                                             p_cdd_item => ${@cdd_item},
+                                             p_description => ${@description},
+                                             p_line_type => 'FILE',
+                                             p_order_seq => ${@order_seq},
+                                             p_show_seq => ${@show_seq},
+                                             p_enabled_flag =>'Y',
+                                             p_chance_required_flag => ${@chance_required_flag},
+                                             p_chance_display_flag => ${@chance_display_flag},
+                                             p_project_required_flag => ${@project_required_flag},
+                                             p_project_display_flag => ${@project_display_flag},
+                                             p_contract_required_flag => ${@contract_required_flag},
+                                             p_contract_display_flag => ${@contract_display_flag},
+                                             p_sign_required_flag => ${@sign_required_flag},
+                                             p_sign_display_flag => ${@sign_display_flag},
+                                             p_incept_required_flag => ${@incept_required_flag},
+                                             p_incept_display_flag => ${@incept_display_flag},
+                                             p_lender_required_flag => ${@lender_required_flag},
+                                             p_lender_display_flag => ${@lender_display_flag},
+                                             p_chance_tab_group => ${@chance_tab_group},
+                                             p_project_tab_group => ${@project_tab_group},
+                                             p_contract_tab_group => ${@contract_tab_group},
+                                             p_sign_tab_group => ${@sign_tab_group},
+                                             p_incept_tab_group => ${@incept_tab_group},
+                                             p_lender_tab_group => ${@lender_tab_group},
+                                             p_sys_flag => ${@sys_flag},
+                                             p_note => ${@note},
+                                             p_send_flag => ${@send_flag},
+                                             p_paper_required => ${@paper_required},
+                                             p_attachment_required => ${@attachment_required},
+                                             p_not_applicable => ${@not_applicable},
+                                             p_cdd_item_id => ${@cdd_item_id},
+                                             p_check_id => ${@check_id},
+                                             p_user_id => ${/session/@user_id});
+            	END;
+        	]]></bm:update-sql>
+            <bm:parameters>
+                <bm:parameter name="cdd_item_id" input="true" inputPath="@cdd_item_id" output="true" outputPath="@cdd_item_id"/>
+                <bm:parameter name="check_id" input="true" inputPath="@check_id" output="true" outputPath="@check_id"/>
+            </bm:parameters>
+        </bm:operation>
+        <bm:operation name="delete">
+            <bm:update-sql><![CDATA[
+            	BEGIN
+            	    prj_cdd_item_pkg.prj_cdd_item_doc_ref_delete(p_document_table =>${@document_table},
+                                        p_document_id    =>${@document_id},
+                                        p_cdd_item_id    =>${@cdd_item_id},
+                                        p_check_id       =>${@check_id},
+                                        p_user_id        =>${/session/@user_id});
+            	END;
+        	]]></bm:update-sql>
+            <bm:parameters>
+                <bm:parameter name="cdd_item_id" input="true" inputPath="@cdd_item_id" output="true" outputPath="@cdd_item_id"/>
+                <bm:parameter name="check_id" input="true" inputPath="@check_id" output="true" outputPath="@check_id"/>
+            </bm:parameters>
+        </bm:operation>
+    </bm:operations>
+    <bm:fields>
+        <bm:field name="document_id" databaseType="NUMBER" datatype="java.lang.Long" physicalName="DOCUMENT_ID"/>
+        <bm:field name="document_category" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="DOCUMENT_CATEGORY"/>
+        <bm:field name="document_table" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="DOCUMENT_TABLE"/>
+        <bm:field name="cdd_item_id" databaseType="NUMBER" datatype="java.lang.Long" physicalName="CDD_ITEM_ID"/>
+        <bm:field name="cdd_list_id" databaseType="NUMBER" datatype="java.lang.Long" physicalName="CDD_LIST_ID"/>
+        <bm:field name="cdd_item" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="CDD_ITEM"/>
+        <bm:field name="description" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="DESCRIPTION"/>
+        <bm:field name="enabled_flag" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="ENABLED_FLAG"/>
+        <bm:field name="note" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="NOTE"/>
+        <bm:field name="paper_required" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="PAPER_REQUIRED"/>
+        <bm:field name="attachment_required" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="ATTACHMENT_REQUIRED"/>
+        <bm:field name="not_applicable" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="NOT_APPLICABLE"/>
+        <bm:field name="check_id" databaseType="NUMBER" datatype="java.lang.Long" physicalName="CHECK_ID"/>
+        <bm:field name="sys_flag" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="SYS_FLAG"/>
+        <bm:field name="file_name" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="FILE_NAME"/>
+        <!--<bm:field name="creation_date" databaseType="DATE" datatype="java.util.Date" physicalName="CREATION_DATE"/>-->
+        <bm:field name="sign_required_flag" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="SIGN_REQUIRED_FLAG"/>
+        <!-- <bm:field name="paper_content_flag"/> -->
+    </bm:fields>
+</bm:model>
Index: src/main/resources/leaf_static/WEB-INF/classes/acrch/ACRCH001/con_contract_for_query.lwm
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/WEB-INF/classes/acrch/ACRCH001/con_contract_for_query.lwm b/src/main/resources/leaf_static/WEB-INF/classes/acrch/ACRCH001/con_contract_for_query.lwm
new file mode 100644
--- /dev/null	(revision 600e775116243404a756244fa5f1586954125738)
+++ b/src/main/resources/leaf_static/WEB-INF/classes/acrch/ACRCH001/con_contract_for_query.lwm	(revision 600e775116243404a756244fa5f1586954125738)
@@ -0,0 +1,43 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!--
+    $Author: gaoyang
+    $Date: 2013-6-24 下午04:30:53
+    $Revision: 1.0
+    $Purpose:
+-->
+<bm:model xmlns:s="leaf.plugin.script" xmlns:bm="http://www.leaf-framework.org/schema/bm" xmlns:f="leaf.database.features">
+    <bm:operations>
+        <bm:operation name="query">
+            <bm:query-sql><![CDATA[
+         select t.*
+                    FROM
+                        prj_project_acrch_v t
+               #WHERE_CLAUSE#
+
+            ]]></bm:query-sql>
+        </bm:operation>
+    </bm:operations>
+    <bm:query-fields>
+        <bm:query-field name="contract_number" queryExpression="contract_number like upper(&apos;%&apos;||${@contract_number}||&apos;%&apos;)"/>
+        <bm:query-field name="project_number" queryExpression="project_number like upper(&apos;%&apos;||${@project_number}||&apos;%&apos;)"/>
+        <bm:query-field name="bp_id_tenant" queryExpression="t1.bp_id_tenant=${@bp_id_tenant}"/>
+        <bm:query-field name="lease_item_amount_from" queryExpression="lease_item_amount &gt;= ${@lease_item_amount_from}"/>
+        <bm:query-field name="lease_item_amount_to" queryExpression="lease_item_amount &lt;= ${@lease_item_amount_to}"/>
+        <bm:query-field name="lease_channel" queryExpression="t1.lease_channel=${@lease_channel}"/>
+        <bm:query-field name="business_type" queryExpression="t1.business_type=${@business_type}"/>
+        <bm:query-field name="lease_organization" queryExpression="t1.lease_organization=${@lease_organization}"/>
+        <bm:query-field name="contract_status" queryExpression="t1.contract_status=${@contract_status}"/>
+        <bm:query-field name="user_status_1" queryExpression="t1.user_status_1=${@user_status_1}"/>
+        <bm:query-field name="bp_id_agent_level1" queryExpression="t1.bp_id_agent_level1=${@bp_id_agent_level1}"/>
+        <bm:query-field name="contract_file_date" queryExpression="to_char(contract_file_date,&apos;yyyy-mm-dd&apos;) = to_char(${@contract_file_date},&apos;yyyy-mm-dd&apos;)"/>
+        <bm:query-field name="finish_flag" queryExpression="${@finish_flag} =nvl2(contract_file_date,&apos;Y&apos;,&apos;N&apos;)"/>
+        <bm:query-field name="project_number" queryExpression="t1.project_number like upper(&apos;%&apos;||${@project_number}||&apos;%&apos;)"/>
+    </bm:query-fields>
+    <bm:data-filters>
+        <!-- <bm:data-filter enforceOperations="query" expression="t1.company_id = ${/session/@company_id}" field="company_id"/> -->
+        <!--<bm:data-filter enforceOperations="query" expression="t1.data_class = &apos;NORMAL&apos; and t1.contract_status=&apos;INCEPT&apos;"/>-->
+        <!-- <bm:data-filter enforceOperations="query" expression="t.mortgage_flag=&apos;Y&apos;"/> -->
+        <!-- <bm:data-filter enforceOperations="query" expression="t.contract_status = &apos;INCEPT&apos;"/> -->
+        <!--<bm:data-filter enforceOperations="query" expression="t.created_by = ${/session/@user_id}" field="created_by"/>-->
+    </bm:data-filters>
+</bm:model>
Index: src/main/resources/leaf_static/WEB-INF/classes/acrch/ARCHIVE002/arch002_archive_event.lwm
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/WEB-INF/classes/acrch/ARCHIVE002/arch002_archive_event.lwm b/src/main/resources/leaf_static/WEB-INF/classes/acrch/ARCHIVE002/arch002_archive_event.lwm
new file mode 100644
--- /dev/null	(revision 600e775116243404a756244fa5f1586954125738)
+++ b/src/main/resources/leaf_static/WEB-INF/classes/acrch/ARCHIVE002/arch002_archive_event.lwm	(revision 600e775116243404a756244fa5f1586954125738)
@@ -0,0 +1,29 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!--
+    $Author: zc
+    $Date: 2021-7-12 下午1:27:29
+    $Revision: 1.0
+    $Purpose:
+-->
+<bm:model xmlns:bm="http://www.leaf-framework.org/schema/bm" needAccessControl="false">
+    <bm:operations>
+        <bm:operation name="update">
+            <bm:update-sql><![CDATA[
+            begin
+                  update  prj_cdd_item_check pci
+                    set pci.mark_flag = 'Y'
+                  where pci.check_id=${@check_id};
+             end;
+            ]]></bm:update-sql>
+        </bm:operation>
+        <bm:operation name="execute">
+            <bm:update-sql><![CDATA[
+            begin
+                  update  prj_cdd_item_check pci
+                    set pci.mark_flag = 'N'
+                  where pci.check_id=${@check_id};
+             end;
+            ]]></bm:update-sql>
+        </bm:operation>
+    </bm:operations>
+</bm:model>
Index: src/main/resources/leaf_static/WEB-INF/classes/acrch/ARCHIVE002/arch002_project_change_req_info.lwm
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/WEB-INF/classes/acrch/ARCHIVE002/arch002_project_change_req_info.lwm b/src/main/resources/leaf_static/WEB-INF/classes/acrch/ARCHIVE002/arch002_project_change_req_info.lwm
new file mode 100644
--- /dev/null	(revision 600e775116243404a756244fa5f1586954125738)
+++ b/src/main/resources/leaf_static/WEB-INF/classes/acrch/ARCHIVE002/arch002_project_change_req_info.lwm	(revision 600e775116243404a756244fa5f1586954125738)
@@ -0,0 +1,140 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!--
+    $Author: zc
+    $Date: 2021-7-8 下午1:27:29
+    $Revision: 1.0
+    $Purpose:
+-->
+<bm:model xmlns:bm="http://www.leaf-framework.org/schema/bm" needAccessControl="false">
+    <bm:operations>
+        <bm:operation name="query">
+            <bm:query-sql><![CDATA[
+            SELECT *
+              FROM (select p.project_id,
+                           p.project_number,
+                           p.project_name,
+                           p.project_status,
+                           p.project_name project_id_n,
+                           p.virtual_con_number,
+                           p.virtual_con_number contract_number,
+                           p.virtual_con_name,
+                           p.cdd_list_id,
+                           fb.cdd_list_id arch_cdd_list_id,
+                           (select hp.plan_id
+                              from hn_prj_plan hp, hn_prj_plan_ln hl
+                             where hp.plan_id = hl.plan_id
+                               and hl.project_id = p.project_id
+                               and hp.hn_industry_classification =
+                                   p.hn_industry_classification
+                               and hp.binary_classification = p.binary_classification
+                               and hp.wfl_status = 'APPROVED') plan_id,
+                           (select hp.cdd_list_id
+                              from hn_prj_plan hp, hn_prj_plan_ln hl
+                             where hp.plan_id = hl.plan_id
+                               and hl.project_id = p.project_id
+                               and hp.hn_industry_classification =
+                                   p.hn_industry_classification
+                               and hp.binary_classification = p.binary_classification
+                               and hp.wfl_status = 'APPROVED') plan_cdd_list_id,
+                           p.data_class,
+                           p.lease_channel,
+                           p.unit_id,
+                           (select ou.description
+                              from exp_org_unit_vl ou
+                             where ou.unit_id = p.unit_id
+                               and ou.enabled_flag = 'Y') unit_id_n,
+                           (select fc.company_full_name
+                              from fnd_companies fc
+                             where fc.company_id = p.company_id) company_id_n,
+                           (select fc.company_short_name
+                              from fnd_companies fc
+                             where fc.company_id = p.company_id) company_short_name,
+                           (select dt.ref_document_type
+                              from hls_document_type dt
+                             where dt.document_type = p.document_type) con_document_type,
+                           (select dt1.description
+                              from hls_document_type dt, hls_document_type dt1
+                             where dt.document_type = p.document_type
+                               and dt.ref_document_type = dt1.document_type) con_document_type_n,
+                           p.bp_id_tenant,
+                           (select bp.bp_name
+                              from hls_bp_master bp
+                             where bp.bp_id = p.bp_id_tenant) bp_id_tenant_n,
+                           p.bp_id_tenant bp_id,
+                           p.lease_organization,
+                           (select lo.description
+                              from hls_lease_organization lo
+                             where lo.lease_organization = p.lease_organization) lease_organization_n,
+                           p.employee_id,
+                           (select ee.name
+                              from exp_employees ee
+                             where ee.employee_id = p.employee_id) employee_id_n,
+                           p.employee_id_of_manager,
+                           (select ee.name
+                              from exp_employees ee
+                             where ee.employee_id = p.employee_id_of_manager) employee_id_of_manager_n,
+                           p.division,
+                           p.financing_purpose,
+                           (select t1.description as value_name
+                              from hls_division t1
+                             where t1.enabled_flag = 'Y'
+                               and t1.division = p.division) division_n,
+                           p.business_type,
+                           (select t.description
+                              from hls_business_type t
+                             where p.business_type = t.business_type) as business_type_n,
+                           p.signing_person_id,
+                           (select cil.contact_person
+                              from hls_bp_master_contact_info_lv cil
+                             where cil.contact_info_id = p.signing_person_id) signing_person_id_n,
+                           p.signing_date,
+                           p.signing_description,
+                           p.project_type,
+                           p.content_finish_flag,
+                           p.hn_industry_classification,
+                           p.binary_classification,
+                           p.document_type,
+                           p.company_id,
+                           (select v.code_value_name
+                              from sys_code_values_v v
+                             where v.code in ('WITHIN_GROUP', 'MARKETIZATION')
+                               and v.code_value = p.binary_classification) binary_classification_n,
+                           p.ref_project_id,
+                           --合同文本审批状态
+                           nvl(p.content_wfl_status, 'NEW') content_wfl_status,
+                           (select v.code_value_name
+                              from SYS_CODE_VALUES_V V
+                             WHERE V.code = 'VIRTUAL_CON_CONTENT_STATUS'
+                               AND V.code_enabled_flag = 'Y'
+                               AND V.code_value_enabled_flag = 'Y'
+                               and v.code_value = nvl(p.content_wfl_status, 'NEW')) content_wfl_status_n,
+                           --签约状态
+                           nvl(p.sign_status, 'NEW') sign_status,
+                           (select v.code_value_name
+                              from SYS_CODE_VALUES_V V
+                             WHERE V.code = 'VIRTUAL_CON_CONTENT_STATUS'
+                               AND V.code_enabled_flag = 'Y'
+                               AND V.code_value_enabled_flag = 'Y'
+                               and v.code_value = nvl(p.sign_status, 'NEW')) sign_status_n,
+                           fb.archive_batch_id,
+                           fb.archive_number,
+                           (select zi.current_seq
+                              from zj_wfl_workflow_instance_v zi
+                             where zi.instance_id = fb.wfl_instance_id) current_seq
+                      from prj_project            p,
+                           file_archive_batch     fb,
+                           prj_project_change_req pr
+                     where p.project_id = pr.change_req_id
+                       and fb.project_id = pr.project_id
+                       and pr.req_status = 'APPROVED'
+                       and pr.change_req_id =
+                           (select max(pe.change_req_id)
+                              from prj_project_change_req pe
+                             where pe.project_id = fb.project_id
+                               and pe.req_status = 'APPROVED')
+                       ) t1
+                    #WHERE_CLAUSE#
+            ]]></bm:query-sql>
+        </bm:operation>
+    </bm:operations>
+</bm:model>
Index: src/main/resources/leaf_static/WEB-INF/classes/acrch/ARCHIVE002/arch002_project_info.lwm
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/WEB-INF/classes/acrch/ARCHIVE002/arch002_project_info.lwm b/src/main/resources/leaf_static/WEB-INF/classes/acrch/ARCHIVE002/arch002_project_info.lwm
new file mode 100644
--- /dev/null	(revision 600e775116243404a756244fa5f1586954125738)
+++ b/src/main/resources/leaf_static/WEB-INF/classes/acrch/ARCHIVE002/arch002_project_info.lwm	(revision 600e775116243404a756244fa5f1586954125738)
@@ -0,0 +1,185 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!--
+    $Author: zc
+    $Date: 2021-7-8 下午1:27:29
+    $Revision: 1.0
+    $Purpose:
+-->
+<bm:model xmlns:bm="http://www.leaf-framework.org/schema/bm" needAccessControl="false">
+    <bm:operations>
+        <bm:operation name="query">
+            <bm:query-sql><![CDATA[
+                SELECT
+                    *
+                FROM
+                    (select p.project_id,
+                     p.project_number,
+                     p.project_name,
+                     p.project_status,
+                     p.project_name project_id_n,
+                     p.virtual_con_number,
+                     p.virtual_con_number contract_number,
+                     p.virtual_con_name,
+                     p.cdd_list_id,
+                     fb.cdd_list_id arch_cdd_list_id,
+                   (select hp.plan_id
+                      from hn_prj_plan hp, hn_prj_plan_ln hl
+                     where hp.plan_id = hl.plan_id
+                       and hl.project_id = p.project_id
+                       and hp.hn_industry_classification = p.hn_industry_classification
+                       and hp.binary_classification = p.binary_classification
+                       and hp.wfl_status = 'APPROVED') plan_id,
+                   (select hp.cdd_list_id
+                      from hn_prj_plan hp, hn_prj_plan_ln hl
+                     where hp.plan_id = hl.plan_id
+                       and hl.project_id = p.project_id
+                       and hp.hn_industry_classification = p.hn_industry_classification
+                       and hp.binary_classification = p.binary_classification
+                       and hp.wfl_status = 'APPROVED') plan_cdd_list_id,
+                     p.data_class,
+                     p.lease_channel,
+                     p.unit_id,
+                     (select ou.description
+                        from exp_org_unit_vl ou
+                       where ou.unit_id = p.unit_id
+                         and ou.enabled_flag = 'Y') unit_id_n,
+                     (select fc.company_full_name
+                        from fnd_companies fc
+                       where fc.company_id = p.company_id) company_id_n,
+                     (select fc.company_short_name
+                        from fnd_companies fc
+                       where fc.company_id = p.company_id) company_short_name,
+                     (select dt.ref_document_type
+                        from hls_document_type dt
+                       where dt.document_type = p.document_type) con_document_type,
+                     (select dt1.description
+                        from hls_document_type dt, hls_document_type dt1
+                       where dt.document_type = p.document_type
+                         and dt.ref_document_type = dt1.document_type) con_document_type_n,
+                     p.bp_id_tenant,
+                     (select bp.bp_name
+                        from hls_bp_master bp
+                       where bp.bp_id = p.bp_id_tenant) bp_id_tenant_n,
+                     p.bp_id_tenant bp_id,
+                     p.lease_organization,
+                     (select fd.description_text
+                        from fnd_descriptions fd,exp_org_unit u
+                        where u.description_id = fd.description_id
+                        and language = 'ZHS'
+                        and  u.unit_id =
+                        (select ep.unit_id from exp_employee_assigns ea, exp_org_position ep
+                        where  ea.employee_id = fb.employee_id
+                        and ea.primary_position_flag = 'Y'  and ea.position_id = ep.position_id)) lease_organization_n,
+                     p.employee_id,
+                     (select ee.name
+                        from exp_employees ee
+                       where ee.employee_id = p.employee_id) employee_id_n,
+                     p.employee_id_of_manager,
+                     (select ee.name
+                        from exp_employees ee
+                       where ee.employee_id = p.employee_id_of_manager) employee_id_of_manager_n,
+                     p.division,
+                     p.financing_purpose,
+                     (select t1.description as value_name
+                        from hls_division t1
+                       where t1.enabled_flag = 'Y'
+                         and t1.division = p.division) division_n,
+                     p.business_type,
+                     (select t.description
+                        from hls_business_type t
+                       where p.business_type = t.business_type) as business_type_n,
+                     p.signing_person_id,
+                     (select cil.contact_person
+                        from hls_bp_master_contact_info_lv cil
+                       where cil.contact_info_id = p.signing_person_id) signing_person_id_n,
+                     p.signing_date,
+                     p.signing_description,
+                     p.project_type,
+                     p.content_finish_flag,
+                     p.hn_industry_classification,
+                     p.binary_classification,
+                     p.document_type,
+                     p.company_id,
+                     (select v.code_value_name from sys_code_values_v v
+                     where v.code in ('WITHIN_GROUP','MARKETIZATION','WITHIN_GROUP_BL')
+                     and v.code_value = p.binary_classification) binary_classification_n,
+                     p.ref_project_id,
+                     --合同文本审批状态
+                       nvl(p.content_wfl_status, 'NEW') content_wfl_status,
+                     (select v.code_value_name
+                        from SYS_CODE_VALUES_V V
+                       WHERE V.code = 'VIRTUAL_CON_CONTENT_STATUS'
+                         AND V.code_enabled_flag = 'Y'
+                         AND V.code_value_enabled_flag = 'Y'
+                         and v.code_value = nvl(p.content_wfl_status, 'NEW')) content_wfl_status_n,
+                      --签约状态
+                         nvl(p.sign_status, 'NEW') sign_status,
+                     (select v.code_value_name
+                        from SYS_CODE_VALUES_V V
+                       WHERE V.code = 'VIRTUAL_CON_CONTENT_STATUS'
+                         AND V.code_enabled_flag = 'Y'
+                         AND V.code_value_enabled_flag = 'Y'
+                         and v.code_value = nvl(p.sign_status, 'NEW')) sign_status_n,
+                       fb.archive_batch_id,
+                       fb.archive_number,
+                       (select zi.current_seq
+                          from zj_wfl_workflow_instance_v zi
+                         where zi.instance_id = fb.wfl_instance_id) current_seq,
+ (select t1.plan_number
+                  from hn_prj_plan t1, hn_prj_plan_ln t2
+                 where t1.plan_id = t2.plan_id
+                   and t2.project_id = p.project_id
+                   and rownum = 1) plan_number,
+               (select t1.plan_name
+                  from hn_prj_plan t1, hn_prj_plan_ln t2
+                 where t1.plan_id = t2.plan_id
+                   and t2.project_id = p.project_id
+                   and rownum = 1) plan_name,
+                   fb.submit_by
+                from prj_project p,file_archive_batch fb
+                  where
+                  --p.content_wfl_status = 'APPROVED'
+                  --and p.data_class = 'VIRTUAL_CON'
+                    fb.project_id = p.project_id(+)
+                   --and fb.wfl_status = 'APPROVING'
+                    ) t1 #WHERE_CLAUSE#
+            ]]></bm:query-sql>
+        </bm:operation>
+        <bm:operation name="update">
+            <bm:update-sql><![CDATA[
+            begin
+                  if ${@submit_from} = 'PAYMENT' then
+                    update HN_CON_PAYMENT_CONDITIONS_NEW set confirm_flag = ${@status} where condition_id = ${@condition_id};
+                  else
+                      update prj_cdd_item_check pci
+                        set pci.confirm_flag = ${@status}
+                      where pci.check_id=${@check_id};
+                  end if;
+             end;
+            ]]></bm:update-sql>
+        </bm:operation>
+        <bm:operation name="execute">
+            <bm:update-sql><![CDATA[
+            begin
+                  if ${@submit_from} = 'PAYMENT' then
+                    update hn_con_payment_conditions_new set confirm_flag = 'Y'
+                    where archive_batch_id = ${@archive_batch_id} and confirm_flag <> 'N';
+
+                  else
+                    update prj_cdd_item_check pck set pck.confirm_flag = 'Y' where pck.cdd_item_id in
+                    (select pci.cdd_item_id from prj_cdd_item pci, prj_cdd_item_list_grp_tab lgt, prj_cdd_item_tab_group tg
+                    where pci.cdd_list_id = ${@cdd_list_id} and pci.enabled_flag ='Y'
+                                        and lgt.cdd_list_id = pci.cdd_list_id
+                                        AND pci.cdd_item_id  = lgt.cdd_item_id
+                                        AND lgt.TAB_GROUP_ID =tg.TAB_GROUP_ID
+                                        AND nvl(lgt.enabled_flag,'Y') ='Y'
+                                        and nvl(tg.enabled_flag,'Y') = 'Y'
+                                        and tg.tab_group like decode(${@submit_from}, 'SIGN', '%'||${@attachment_tab_group}||'%', ${@attachment_tab_group}))
+                                        and pck.confirm_flag <> 'N';
+
+                  end if;
+             end;
+            ]]></bm:update-sql>
+        </bm:operation>
+    </bm:operations>
+</bm:model>
Index: src/main/resources/leaf_static/WEB-INF/classes/acrch/ARCHIVE002/bp_doc_cdd_item.lwm
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/WEB-INF/classes/acrch/ARCHIVE002/bp_doc_cdd_item.lwm b/src/main/resources/leaf_static/WEB-INF/classes/acrch/ARCHIVE002/bp_doc_cdd_item.lwm
new file mode 100644
--- /dev/null	(revision 600e775116243404a756244fa5f1586954125738)
+++ b/src/main/resources/leaf_static/WEB-INF/classes/acrch/ARCHIVE002/bp_doc_cdd_item.lwm	(revision 600e775116243404a756244fa5f1586954125738)
@@ -0,0 +1,59 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!--
+    $Author: zc
+    $Date: 2021-7-13 下午07:16:22
+    $Revision: 1.0
+    $Purpose:
+-->
+<bm:model xmlns:bm="http://www.leaf-framework.org/schema/bm" needAccessControl="false">
+    <bm:operations>
+        <bm:operation name="query">
+            <bm:query-sql><![CDATA[
+            select * from (select t1.document_id prj_bp_id,
+                   t1.order_seq,
+                   t1.attachment_name,
+                   (select pt.cdd_class from prj_cdd_item_templet pt where pt.cdd_item = t1.cdd_item and pt.enabled_flag = 'Y' and rownum = 1) cdd_class,
+                   t1.cdd_type,
+                   t1.note,
+                   t1.bp_id,
+                   hls_sys_upload_pkg.get_atm_file_href(p_table_pk_value => t1.hn_record_id,
+                                                        p_source_type    => 'HN_BP_ATTACHMENT_RECORD',
+                                                        p_user_id        => t1.created_by) AS attach_file_name,    --附件名
+                   t1.hn_record_id,
+                   t1.false_required_flag,
+                   pb.project_id,
+                   pb.bp_category,
+                   t1.cdd_item
+              from hn_bp_attachment_record t1,prj_project_bp pb
+             where t1.document_id = pb.prj_bp_id
+             and t1.bp_id = pb.bp_id
+                and pb.bp_category in ('GUARANTOR','TENANT')
+                and pb.project_id = ${@project_id}) t1
+              order by t1.bp_category desc,t1.attach_file_name,t1.order_seq
+            ]]></bm:query-sql>
+        </bm:operation>
+        <bm:operation name="update">
+            <bm:update-sql><![CDATA[
+                BEGIN
+                update file_archive_batch t set t.wfl_status='CANCEL' where t.archive_batch_id=${@archive_batch_id};
+                END;
+            ]]></bm:update-sql>
+        </bm:operation>
+    </bm:operations>
+    <bm:fields>
+        <bm:field name="prj_bp_id"/>
+        <bm:field name="order_seq"/>
+        <bm:field name="attachment_name"/>
+        <bm:field name="cdd_class"/>
+        <bm:field name="cdd_item"/>
+        <bm:field name="cdd_type"/>
+        <bm:field name="note"/>
+        <bm:field name="bp_id"/>
+        <bm:field name="attach_file_name"/>
+        <bm:field name="hn_record_id"/>
+        <bm:field name="false_required_flag"/>
+        <bm:field name="project_id"/>
+    </bm:fields>
+
+
+</bm:model>
Index: src/main/resources/leaf_static/WEB-INF/classes/acrch/ARCHIVE002/con_contract_file_archive.lwm
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/WEB-INF/classes/acrch/ARCHIVE002/con_contract_file_archive.lwm b/src/main/resources/leaf_static/WEB-INF/classes/acrch/ARCHIVE002/con_contract_file_archive.lwm
new file mode 100644
--- /dev/null	(revision 600e775116243404a756244fa5f1586954125738)
+++ b/src/main/resources/leaf_static/WEB-INF/classes/acrch/ARCHIVE002/con_contract_file_archive.lwm	(revision 600e775116243404a756244fa5f1586954125738)
@@ -0,0 +1,26 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!--
+    $Author: liliu
+    $Date: 2022年1月12日
+    $Revision: 1.0
+    $Purpose:
+-->
+<bm:model xmlns:s="leaf.plugin.script" xmlns:bm="http://www.leaf-framework.org/schema/bm" xmlns:f="leaf.database.features" needAccessControl="false">
+    <bm:operations>
+        <bm:operation name="delete">
+            <bm:update-sql><![CDATA[
+                BEGIN
+                    delete from con_file_archive_attachment a where a.archive_attachment_id = ${@archive_attachment_id};
+                END;
+            ]]></bm:update-sql>
+        </bm:operation>
+        <bm:operation name="execute">
+            <bm:update-sql><![CDATA[
+                BEGIN
+                   file_archive_pkg.refresh_archive_file_seq(p_archive_batch_id =>${@archive_batch_id},
+                                                             p_user_id          =>${/session/@user_id});
+                END;
+            ]]></bm:update-sql>
+        </bm:operation>
+    </bm:operations>
+</bm:model>
Index: src/main/resources/leaf_static/WEB-INF/classes/acrch/ARCHIVE002/file_archive_batch.lwm
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/WEB-INF/classes/acrch/ARCHIVE002/file_archive_batch.lwm b/src/main/resources/leaf_static/WEB-INF/classes/acrch/ARCHIVE002/file_archive_batch.lwm
new file mode 100644
--- /dev/null	(revision 600e775116243404a756244fa5f1586954125738)
+++ b/src/main/resources/leaf_static/WEB-INF/classes/acrch/ARCHIVE002/file_archive_batch.lwm	(revision 600e775116243404a756244fa5f1586954125738)
@@ -0,0 +1,42 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!--
+    $Author: gaoyang
+    $Date: 2013-6-24 下午04:30:53
+    $Revision: 1.0
+    $Purpose:
+-->
+<bm:model xmlns:s="leaf.plugin.script" xmlns:bm="http://www.leaf-framework.org/schema/bm" xmlns:f="leaf.database.features">
+    <bm:operations>
+        <bm:operation name="update">
+            <bm:update-sql><![CDATA[
+                BEGIN
+                    file_archive_pkg.file_archive_submit(p_archive_batch_id =>${@archive_batch_id}, p_company_id =>${/session/@company_id},p_user_id=>${/session/@user_id});
+                END;
+            ]]></bm:update-sql>
+        </bm:operation>
+
+        <bm:operation name="execute">
+            <bm:parameters>
+                <bm:parameter name="archive_batch_id" dataType="java.lang.Long" input="false" output="true" outputPath="/parameter/@archive_batch_id"/>
+            </bm:parameters>
+            <bm:update-sql><![CDATA[
+                BEGIN
+                   file_archive_pkg.archive_save_data
+                              (
+                              p_archive_batch_id =>${@archive_batch_id},
+                              p_project_id       =>${@project_id},
+                              p_project_type     =>${@project_type},
+                              p_class_type       =>${@class_type},
+                              p_contract_id      =>${@contract_id},
+                              p_plan_id          =>${@plan_id},
+                              p_bp_id_tenant     =>${@bp_id_tenant},
+                              p_employee_id      =>${@employee_id},
+                              p_lease_organization =>${@lease_organization},
+                              p_unit_id          =>${@unit_id},
+                              p_user_id          =>${/session/@user_id}
+                              );
+                END;
+            ]]></bm:update-sql>
+        </bm:operation>
+    </bm:operations>
+</bm:model>
Index: src/main/resources/leaf_static/WEB-INF/classes/acrch/ARCHIVE002/server_layout_doc_cdd_item.lwm
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/WEB-INF/classes/acrch/ARCHIVE002/server_layout_doc_cdd_item.lwm b/src/main/resources/leaf_static/WEB-INF/classes/acrch/ARCHIVE002/server_layout_doc_cdd_item.lwm
new file mode 100644
--- /dev/null	(revision 1beeecdc8318d1acfe253b5308ee73ea3724093c)
+++ b/src/main/resources/leaf_static/WEB-INF/classes/acrch/ARCHIVE002/server_layout_doc_cdd_item.lwm	(revision 1beeecdc8318d1acfe253b5308ee73ea3724093c)
@@ -0,0 +1,522 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!--
+    $Author: gaoyang
+    $Date: 2013-7-18 下午07:16:22
+    $Revision: 1.0
+    $Purpose:
+-->
+<bm:model xmlns:bm="http://www.leaf-framework.org/schema/bm">
+    <bm:operations>
+        <bm:operation name="query">
+            <bm:query-sql><![CDATA[
+            select t2.* from (
+            select
+            rownum as order_num,
+            t1.*
+             from(
+                SELECT
+                    pp.creation_date,
+                    to_char(pci.creation_date,'yyyy-mm-dd') creatiodate,
+                    -- 文档分类 add by wujun for huaneng 2018-6-12
+                    pci.cdd_class,
+                    pci.cdd_class_code,
+                    decode(${@fix_category}, 'MANAGER', '管理类', 'REQUIREMENT', '要件类',
+			(select cdd_category from prj_cdd_item_templet pct where pct.cdd_item = pci.cdd_item and pct.cdd_category is not null AND ROWNUM=1)) cdd_category,
+                    nvl((select 'Y' from dual where
+               exists (select 1 from hn_virtual_con_change_req tt1,prj_cdd_item_doc_ref tt2,prj_cdd_item_check tt3,prj_cdd_item tt4
+                        where tt1.change_req_id = pp.document_id
+                          and tt1.project_id = tt2.document_id
+                          and tt2.document_table = 'PRJ_PROJECT'
+                          and tt2.check_id = tt3.check_id
+                          and tt3.cdd_item_id = tt4.cdd_item_id
+                          and tt4.cdd_item = pci.cdd_item)),'N') delete_sign_flag,
+            pp.prj_version version_display,
+            nvl((select 'Y'
+                     from dual
+                    where exists (select 1
+                             from prj_cdd_item_check pcic
+                            where pcic.cdd_item_id = pci.cdd_item_id
+                              and pcic.check_id = pp.check_id)),
+                   'N') attach_only_query_flag,
+                    -- end
+                    pci.cdd_item,
+                    pci.description,
+                    pci.order_seq,
+                    pci.show_seq,
+                    pp.send_flag,
+                    pp.paper_required,
+                    pp.attachment_required,
+                    pp.not_applicable,
+                    pp.check_id,
+                    pp.audit_status,
+                    pp.audit_status_n,
+		            to_char(pp.archive_date, 'yyyy-mm-dd') archive_date,
+                      pp.note1,
+                      pp.note2,
+                      pp.note3,
+                      pp.express_number,
+                      pp.send_date,
+                      pp.receive_date,
+                      pp.print_status,
+                      pp.print_status_n,
+                      pp.dd_check_flag,
+               pp.archive_status,
+               pp.archive_status_n,
+              pp.dd_photo_flag,
+              pp.receive_flag,
+              pp.mark_flag,
+              pp.confirm_flag,
+              --add by zc 资料清单优化
+              pp.important_concerns,
+              pp.investigate_guide_flag,
+              (select v.code_value_name from sys_code_values_v v where v.code = 'PRJ_PLAN_ATTACHMENT_INVESTIGATE_GUIDE_FLAG' and v.code_value=pp.investigate_guide_flag) investigate_guide_flag_n,
+              pp.reason_alternative,
+              --end
+                    (select ct.content_print_flag from con_contract_content ct where ct.check_id = pp.check_id) content_print_flag,
+                    (select ct.content_id from con_contract_content ct where ct.check_id = pp.check_id) content_id,
+                    (SELECT
+                        COUNT(1)
+                    FROM
+                        fnd_atm_attachment_multi m
+                    WHERE
+                        m.table_name     = 'PRJ_CDD_ITEM_CHECK' AND
+                        m.table_pk_value = TO_CHAR(pp.check_id)
+                        and nvl(m.del_flag,0)=0
+                    )attach_count,
+                     (SELECT
+                       decode(count(1),0,1,0)
+                    FROM
+                        fnd_atm_attachment_multi m
+                    WHERE
+                        m.table_name     = 'PRJ_CDD_ITEM_CHECK' AND
+                        m.table_pk_value = TO_CHAR(pp.check_id)
+                        and nvl(m.del_flag,0)=0
+                    )file_count,
+                    pci.sys_flag,
+                    pci.note,
+                    pci.feedback,
+                    pci.cdd_list_id,
+                    pci.cdd_item_id,
+                    pci.line_type,
+                    pci.chance_required_flag,
+                    pci.chance_display_flag,
+                    pci.project_required_flag,
+                    pci.project_display_flag,
+                    pci.contract_required_flag,
+                    pci.contract_display_flag,
+                    pci.sign_required_flag,
+                    pci.sign_display_flag,
+                    pci.incept_required_flag,
+                    pci.incept_display_flag,
+                    pci.lender_required_flag,
+                    pci.lender_display_flag,
+                    pci.chance_tab_group,
+                    pci.project_tab_group,
+                    pci.contract_tab_group,
+                    pci.bind_bp_id,
+                    (select bp_name from hls_bp_master where bp_id = pci.bind_bp_id) bp_name,
+                    pci.false_required_flag,/* add zxt 非必传标志*/
+                    pci.sign_tab_group,
+                    pci.incept_tab_group,
+                    pci.lender_tab_group,
+                    nvl(pci.arch_required_flag, 'Y') arch_required_flag,/*add zc 归档必传标识*/
+                    nvl(pci.arch_par_has_flag,'Y') as arch_par_has_flag,
+                     (select v.code_value_name from sys_code_values_v v where v.code = 'ACRCH_TYPE' and v.code_value= nvl(pci.arch_par_has_flag,'Y')) arch_par_has_flag_desc,
+                    pci.arch_paper_required_flag,
+                    tg.tab_group_id,
+                    tg.tab_group attachment_tab_group,
+                    lgt.important_flag,
+                    lgt.seq_num,
+                    DECODE(NVL(lgt.important_flag,'N'),'Y',1,'N',0,0) order_field,
+                    NVL(pp.document_id,${@base_table_pk}) document_id,
+                    NVL(pp.document_table, ${@document_table}) document_table,
+                    NVL(
+                    (SELECT
+                        'Y'
+                    FROM
+                        dual
+                    WHERE
+                        EXISTS
+                        (SELECT
+                            1
+                        FROM
+                            con_contract_payment_terms t,
+                            con_contract_cashflow cf
+                        WHERE
+                            t.cashflow_id     =cf.cashflow_id AND
+                            cf.contract_id    =${@base_table_pk} AND
+                            t.cdd_item_id     =pci.cdd_item_id AND
+                            ${@document_table}='CON_CONTRACT'
+                        )
+                    ),'N') payment_terms_flag,
+                    (SELECT
+                        ptc.confirm_flag
+                    FROM
+                        con_contract_payment_t_check ptc
+                    WHERE
+                        ptc.cdd_item_id    = pci.cdd_item_id AND
+                        ptc.contract_id    = ${@base_table_pk} AND
+                        ${@document_table} = 'CON_CONTRACT'
+                    ) check_confirm_flag,
+                    (SELECT
+                        ptc.confirm_note
+                    FROM
+                        con_contract_payment_t_check ptc
+                    WHERE
+                        ptc.cdd_item_id    = pci.cdd_item_id AND
+                        ptc.contract_id    = ${@base_table_pk} AND
+                        ${@document_table} = 'CON_CONTRACT'
+                    ) check_confirm_note,
+                    tg.tab_group,
+                    hls_sys_upload_pkg.get_atm_file_href(p_table_pk_value => pp.check_id,p_source_type => 'PRJ_CDD_ITEM_CHECK',p_user_id => ${/session/@user_id}) AS attach_file_name,
+                    nvl(pci.sign_num,1) as sign_num
+                FROM
+                    (SELECT
+                        pcf.check_id,
+                        pcf.document_id,
+                        pcf.document_table,
+                        pck.cdd_item_id,
+                        pck.send_flag,
+                        pck.paper_required,
+                        pck.attachment_required,
+                        pck.not_applicable,
+                        pck.audit_status,
+		   pck.archive_status,
+		   (select  v.code_value_name from sys_code_values_v v where v.code = 'ARCHIVE_STATUS_ADMIN' and v.code_value=pck.archive_status) archive_status_n,
+                      (select  v.code_value_name from sys_code_values_v v where v.code = 'CON_543D_AUDIT_STATUS' and v.code_value=pck.audit_status) audit_status_n,
+                      pck.note1,
+                      pck.note2,
+                      pck.note3,
+                      pck.express_number,
+                      pck.send_date,
+                      pck.receive_date,
+                      pck.print_status,
+                      (select  v.code_value_name from sys_code_values_v v where v.code = 'OTHER_BSNT_MATRS_CODE' and v.code_value=pck.print_status) print_status_n,
+                      pck.dd_check_flag,
+              pck.dd_photo_flag,
+              pck.prj_version_id,
+              pck.prj_version,
+                        pck.instance_id,
+              pck.creation_date,
+              nvl(pck.receive_flag,'Y') receive_flag,
+              pck.mark_flag,
+              pck.confirm_flag,
+	    pck.archive_date,
+              pck.important_concerns,
+              nvl(pck.investigate_guide_flag, 'Y') as investigate_guide_flag,
+              (select  v.code_value_name from sys_code_values_v v where v.code = 'PRJ_PLAN_ATTACHMENT_INVESTIGATE_GUIDE_FLAG' and v.code_value= nvl(pck.investigate_guide_flag, 'Y')) investigate_guide_flag_n,
+              pck.reason_alternative
+                    FROM
+                        prj_cdd_item_doc_ref pcf,
+                        prj_cdd_item_check pck
+                    WHERE
+                        pcf.document_table = ${@document_table} AND
+                        pcf.document_id    = ${@base_table_pk} AND
+                        pck.check_id       = pcf.check_id
+                    ) pp,
+                    prj_cdd_item pci,
+                    prj_cdd_item_list_grp_tab lgt,
+                    prj_cdd_item_tab_group tg
+                WHERE
+                    pci.cdd_item_id  = lgt.cdd_item_id AND
+                    lgt.TAB_GROUP_ID =tg.TAB_GROUP_ID(+) AND
+
+                    nvl(lgt.enabled_flag,'Y') ='Y' AND
+                    nvl(tg.enabled_flag,'Y') = 'Y'
+                    AND
+                    /* modify by zl 20150113 手工创建的cdd，只有自己能看到 */
+                    /*((pci.sys_flag = 'Y' and pci.cdd_item_id  = pp.cdd_item_id(+)) or
+                     (nvl(pci.sys_flag,'N') = 'N' and pci.cdd_item_id  = pp.cdd_item_id)
+                    )*/
+                    /*pci.cdd_item_id  = pp.cdd_item_id(+) AND*//*modify by liliu 由于存在有的资料清单加载了两遍，外连接会导致附件重复*/
+                    pci.cdd_item_id  = pp.cdd_item_id AND
+                    (nvl(pci.sys_flag,'N')='Y' or (nvl(pci.sys_flag,'N')='N' and pp.check_id is not null)) and
+                    pci.cdd_list_id  = nvl(${/parameter/@cdd_list_id},${@cdd_list_id}) AND
+                    pci.enabled_flag ='Y'
+                    and lgt.cdd_list_id = pci.cdd_list_id
+                    and pp.archive_status != decode(${@current_seq}, 20, 'X', '' , 'X', 'ARCHIVED')
+                    and pp.archive_status != decode(${@current_seq}, '', 'X', 'FINISH_ARCHIVE')
+                    order by  decode(pci.cdd_class, '承租人资料', 2, '保证人资料', 3, '申请人基本资料', 2, '担保人基本资料', 3, '融资租赁项目方案',
+					    96, '项目方案补充资料', 97, '项目方案上会表决资料', 98, '项目方案上会表决资料', 99, '融资租赁项目方案变更', 100 , 1), pci.bind_bp_id, lgt.seq_num, pci.order_seq
+                    )t1 #WHERE_CLAUSE#) t2 order by decode(t2.cdd_class, '承租人资料', 2, '保证人资料', 3, '申请人基本资料', 2, '担保人基本资料', 3,  '融资租赁项目方案',
+					    96, '项目方案补充资料', 97, '项目方案上会表决资料', 98, '项目方案上会表决资料', 99, '融资租赁项目方案变更', 100 , 1), t2.bind_bp_id, t2.seq_num, t2.order_seq, t2.order_num
+
+            ]]></bm:query-sql>
+        </bm:operation>
+        <bm:operation name="update">
+            <bm:update-sql><![CDATA[
+            	declare
+            	  v_check_id number;
+            	BEGIN
+            		v_check_id := ${@check_id};
+            	    prj_cdd_item_pkg.prj_cdd_item_doc_ref_save(p_document_table =>${@document_table},
+                                      p_document_id           =>${@document_id},
+                                      p_attachment_tab_group_id=>${@tab_group_id},
+                                      p_cdd_list_id           =>nvl(${/parameter/@cdd_list_id},${@cdd_list_id}),
+                                      p_cdd_item              =>${@cdd_item},
+                                      p_description           =>${@description},
+                                      p_line_type             =>'FILE',
+                                      p_order_seq             =>${@order_seq},
+                                      p_show_seq              =>${@show_seq},
+                                      p_enabled_flag          =>'Y',
+                                      p_chance_required_flag=>${@chance_required_flag},
+							          p_chance_display_flag=>${@chance_display_flag},
+							          p_project_required_flag=>${@project_required_flag},
+							          p_project_display_flag=>${@project_display_flag},
+							          p_contract_required_flag=>${@contract_required_flag},
+							          p_contract_display_flag=>${@contract_display_flag},
+							          p_sign_required_flag=>${@sign_required_flag},
+							          p_sign_display_flag=>${@sign_display_flag},
+							          p_incept_required_flag=>${@incept_required_flag},
+							          p_incept_display_flag=>${@incept_display_flag},
+							          p_lender_required_flag=>${@lender_required_flag},
+							          p_lender_display_flag=>${@lender_display_flag},
+							          p_chance_tab_group=>${@chance_tab_group},
+							          p_project_tab_group=>${@project_tab_group},
+							          p_contract_tab_group=>${@contract_tab_group},
+							          p_sign_tab_group=>${@sign_tab_group},
+							          p_incept_tab_group=>${@incept_tab_group},
+							          p_lender_tab_group=>${@lender_tab_group},
+                                      p_sys_flag              =>${@sys_flag},
+                                      p_note                  =>${@note},
+                                      p_feedback              =>${@feedback},
+                                      p_send_flag             =>${@send_flag},
+                                      p_paper_required        =>${@paper_required},
+                                      p_attachment_required   =>${@attachment_required},
+                                      p_not_applicable        =>${@not_applicable},
+                                      p_cdd_item_id           =>${@cdd_item_id},
+                                      p_check_id              =>v_check_id,
+                                      p_user_id  =>${/session/@user_id},
+                                      p_false_required_flag =>${@false_required_flag},
+                                      p_arch_required_flag =>${@arch_required_flag},
+                                      p_arch_par_has_flag =>${@arch_par_has_flag},
+                                      p_arch_paper_required_flag =>${@arch_paper_required_flag},
+                                      p_sign_num =>${@sign_num}
+                                      );
+
+
+                               update  prj_cdd_item_check pci
+									  set pci.note1 = ${@note1},
+									      pci.audit_status = ${@audit_status},
+									      pci.note2	=${@note2},
+									      pci.note3 = ${@note3},
+									      pci.print_status = ${@print_status},
+									      pci.express_number = ${@express_number},
+									      pci.send_date = to_date(${@send_date},'YYYY-MM-DD'),
+									      pci.receive_date = to_date(${@receive_date},'YYYY-MM-DD'),
+									      pci.dd_check_flag = ${@dd_check_flag},
+									      pci.dd_photo_flag = ${@dd_photo_flag},
+                                          pci.receive_flag  = ${@receive_flag},
+                                          pci.mark_flag     = ${@mark_flag},
+                                          pci.archive_status  = ${@archive_status},
+                                          pci.important_concerns = ${@important_concerns},
+                                          pci.investigate_guide_flag = ${@investigate_guide_flag},
+                                          pci.reason_alternative = ${@reason_alternative},
+                                          pci.archive_date = decode(${@archive_status}, 'ARCHIVED', sysdate, '')
+								  where pci.check_id=v_check_id;
+								  select v_check_id into ${@check_id} from dual;
+            	END;
+        	]]></bm:update-sql>
+            <bm:parameters>
+                <bm:parameter name="cdd_item_id" input="true" inputPath="@cdd_item_id" output="true" outputPath="@cdd_item_id"/>
+                <bm:parameter name="check_id" input="true" inputPath="@check_id" output="true" outputPath="@check_id"/>
+            </bm:parameters>
+        </bm:operation>
+        <bm:operation name="insert">
+            <bm:update-sql><![CDATA[
+            	declare
+            	  v_check_id	number;
+            	BEGIN
+            	    prj_cdd_item_pkg.check_cdd_list_id(p_document_table =>${@document_table},
+				                                       p_document_id    =>${@document_id},
+				                                       p_user_id        =>${/session/@user_id});
+
+            	    prj_cdd_item_pkg.prj_cdd_item_doc_ref_save(p_document_table =>${@document_table},
+                                      p_document_id           =>${@document_id},
+                                      p_attachment_tab_group_id=>${@tab_group_id},
+                                      p_cdd_list_id           =>nvl(${/parameter/@cdd_list_id},${@cdd_list_id}),
+                                      p_cdd_item              =>${@cdd_item},
+                                      p_description           =>${@description},
+                                      p_line_type             =>'FILE',
+                                      p_order_seq             =>${@order_seq},
+                                      p_show_seq              =>${@show_seq},
+                                      p_enabled_flag          =>'Y',
+                                      p_chance_required_flag=>${@chance_required_flag},
+						              p_chance_display_flag=>${@chance_display_flag},
+						              p_project_required_flag=>${@project_required_flag},
+						              p_project_display_flag=>${@project_display_flag},
+						              p_contract_required_flag=>${@contract_required_flag},
+						              p_contract_display_flag=>${@contract_display_flag},
+						              p_sign_required_flag=>${@sign_required_flag},
+						              p_sign_display_flag=>${@sign_display_flag},
+						              p_incept_required_flag=>${@incept_required_flag},
+						              p_incept_display_flag=>${@incept_display_flag},
+						              p_lender_required_flag=>${@lender_required_flag},
+						              p_lender_display_flag=>${@lender_display_flag},
+						              p_chance_tab_group=>${@chance_tab_group},
+						              p_project_tab_group=>${@project_tab_group},
+						              p_contract_tab_group=>${@contract_tab_group},
+						              p_sign_tab_group=>${@sign_tab_group},
+						              p_incept_tab_group=>${@incept_tab_group},
+						              p_lender_tab_group=>${@lender_tab_group},
+                                      p_sys_flag              =>nvl(${@sys_flag},'N'),
+                                      p_note                  =>${@note},
+                                      p_send_flag             =>${@send_flag},
+                                      p_paper_required        =>${@paper_required},
+                                      p_attachment_required   =>${@attachment_required},
+                                      p_not_applicable        =>${@not_applicable},
+                                      p_cdd_item_id           =>${@cdd_item_id},
+                                      p_check_id              =>v_check_id,
+                                      p_user_id  =>${/session/@user_id},
+                                      p_false_required_flag =>${@false_required_flag},
+                                      p_arch_required_flag =>${@arch_required_flag},
+                                      p_arch_par_has_flag =>${@arch_par_has_flag},
+                                      p_arch_paper_required_flag =>${@arch_paper_required_flag},
+                                      p_sign_num =>${@sign_num}
+                                      );
+
+		                          update  prj_cdd_item_check pci
+                                    set pci.note1 = ${@note1},
+                                        pci.audit_status = ${@audit_status},
+                                        pci.note2 =${@note2},
+                                        pci.note3 = ${@note3},
+                                        pci.print_status = ${@print_status},
+                                        pci.express_number = ${@express_number},
+                                        pci.send_date = to_date(${@send_date},'YYYY-MM-DD'),
+                                        pci.receive_date = to_date(${@receive_date},'YYYY-MM-DD'),
+                                        pci.dd_check_flag = ${@dd_check_flag},
+                                        pci.dd_photo_flag = ${@dd_photo_flag},
+                                        pci.receive_flag  = ${@receive_flag},
+                                        pci.mark_flag     = ${@mark_flag},
+                                        pci.confirm_flag  = ${@confirm_flag},
+                                        pci.important_concerns = ${@important_concerns},
+                                        pci.investigate_guide_flag = ${@investigate_guide_flag},
+                                        pci.reason_alternative = ${@reason_alternative}
+                                  where pci.check_id=v_check_id;
+								select v_check_id into ${@check_id} from dual;
+            	END;
+        	]]></bm:update-sql>
+            <bm:parameters>
+                <bm:parameter name="cdd_item_id" input="true" inputPath="@cdd_item_id" output="true" outputPath="@cdd_item_id"/>
+                <bm:parameter name="check_id" input="true" inputPath="@check_id" output="true" outputPath="@check_id"/>
+            </bm:parameters>
+        </bm:operation>
+
+        <bm:operation name="delete">
+            <bm:update-sql><![CDATA[
+            	BEGIN
+            	    prj_cdd_item_pkg.prj_cdd_item_doc_ref_delete(p_document_table =>${@document_table},
+                                        p_document_id    =>${@document_id},
+                                        p_attachment_tab_group_id=>${@tab_group_id},
+                                        p_cdd_item_id    =>${@cdd_item_id},
+                                        p_check_id       =>${@check_id},
+                                        p_user_id        =>${/session/@user_id});
+            	END;
+        	]]></bm:update-sql>
+            <bm:parameters>
+                <bm:parameter name="cdd_item_id" input="true" inputPath="@cdd_item_id" output="true" outputPath="@cdd_item_id"/>
+                <bm:parameter name="check_id" input="true" inputPath="@check_id" output="true" outputPath="@check_id"/>
+            </bm:parameters>
+        </bm:operation>
+    </bm:operations>
+    <bm:fields>
+        <bm:field name="cdd_item" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="CDD_ITEM"/>
+        <bm:field name="cdd_class" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="CDD_CLASS"/>
+        <bm:field name="cdd_category" databaseType="VARCHAR2" datatype="java.lang.String"/>
+        <bm:field name="description" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="DESCRIPTION"/>
+        <bm:field name="order_seq" databaseType="NUMBER" datatype="java.lang.Long" physicalName="ORDER_SEQ"/>
+        <bm:field name="show_seq" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="SHOW_SEQ"/>
+        <bm:field name="send_flag" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="SEND_FLAG"/>
+        <bm:field name="paper_required" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="PAPER_REQUIRED"/>
+        <bm:field name="attachment_required" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="ATTACHMENT_REQUIRED"/>
+        <bm:field name="not_applicable" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="NOT_APPLICABLE"/>
+        <bm:field name="check_id" databaseType="NUMBER" datatype="java.lang.Long" physicalName="CHECK_ID"/>
+        <bm:field name="attach_count" databaseType="NUMBER" datatype="java.lang.Long" physicalName="ATTACH_COUNT"/>
+        <bm:field name="cdd_list_id" databaseType="NUMBER" datatype="java.lang.Long" physicalName="cdd_list_id"/>
+        <bm:field name="sys_flag" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="SYS_FLAG" prompt="PRJ_CDD_ITEM.SYS_FLAG"/>
+        <bm:field name="note" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="NOTE" prompt="PRJ_CDD_ITEM.NOTE"/>
+        <bm:field name="document_table" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="DOCUMENT_TABLE"/>
+        <bm:field name="document_id" databaseType="NUMBER" datatype="java.lang.Long" physicalName="DOCUMENT_ID"/>
+        <bm:field name="cdd_item_id" databaseType="NUMBER" datatype="java.lang.Long" physicalName="CDD_ITEM_ID"/>
+        <bm:field name="chance_required_flag" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="CHANCE_REQUIRED_FLAG" prompt="PRJ_CDD_ITEM.CHANCE_REQUIRED_FLAG"/>
+        <bm:field name="chance_display_flag" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="CHANCE_DISPLAY_FLAG" prompt="PRJ_CDD_ITEM.CHANCE_DISPLAY_FLAG"/>
+        <bm:field name="project_required_flag" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="PROJECT_REQUIRED_FLAG" prompt="PRJ_CDD_ITEM.PROJECT_REQUIRED_FLAG"/>
+        <bm:field name="project_display_flag" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="PROJECT_DISPLAY_FLAG" prompt="PRJ_CDD_ITEM.PROJECT_DISPLAY_FLAG"/>
+        <bm:field name="contract_required_flag" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="CONTRACT_REQUIRED_FLAG" prompt="PRJ_CDD_ITEM.CONTRACT_REQUIRED_FLAG"/>
+        <bm:field name="contract_display_flag" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="CONTRACT_DISPLAY_FLAG" prompt="PRJ_CDD_ITEM.CONTRACT_DISPLAY_FLAG"/>
+        <bm:field name="sign_required_flag" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="SIGN_REQUIRED_FLAG" prompt="PRJ_CDD_ITEM.SIGN_REQUIRED_FLAG"/>
+        <bm:field name="sign_display_flag" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="SIGN_DISPLAY_FLAG" prompt="PRJ_CDD_ITEM.SIGN_DISPLAY_FLAG"/>
+        <bm:field name="incept_required_flag" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="INCEPT_REQUIRED_FLAG" prompt="PRJ_CDD_ITEM.INCEPT_REQUIRED_FLAG"/>
+        <bm:field name="incept_display_flag" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="INCEPT_DISPLAY_FLAG" prompt="PRJ_CDD_ITEM.INCEPT_DISPLAY_FLAG"/>
+        <bm:field name="lender_required_flag" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="LENDER_REQUIRED_FLAG" prompt="PRJ_CDD_ITEM.LENDER_REQUIRED_FLAG"/>
+        <bm:field name="lender_display_flag" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="LENDER_DISPLAY_FLAG" prompt="PRJ_CDD_ITEM.LENDER_DISPLAY_FLAG"/>
+        <bm:field name="chance_tab_group" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="CHANCE_TAB_GROUP" prompt="PRJ_CDD_ITEM.CHANCE_TAB_GROUP"/>
+        <bm:field name="project_tab_group" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="PROJECT_TAB_GROUP" prompt="PRJ_CDD_ITEM.PROJECT_TAB_GROUP"/>
+        <bm:field name="contract_tab_group" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="CONTRACT_TAB_GROUP" prompt="PRJ_CDD_ITEM.CONTRACT_TAB_GROUP"/>
+        <bm:field name="sign_tab_group" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="SIGN_TAB_GROUP" prompt="PRJ_CDD_ITEM.SIGN_TAB_GROUP"/>
+        <bm:field name="incept_tab_group" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="INCEPT_TAB_GROUP" prompt="PRJ_CDD_ITEM.INCEPT_TAB_GROUP"/>
+        <bm:field name="lender_tab_group" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="LENDER_TAB_GROUP" prompt="PRJ_CDD_ITEM.LENDER_TAB_GROUP"/>
+        <bm:field name="payment_terms_flag" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="PAYMENT_TERMS_FLAG" prompt="PAYMENT_TERMS_FLAG"/>
+        <bm:field name="check_confirm_flag" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="CHECK_CONFIRM_FLAG" prompt="CHECK_CONFIRM_FLAG"/>
+        <bm:field name="check_confirm_note" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="CHECK_CONFIRM_NOTE" prompt="CHECK_CONFIRM_NOTE"/>
+        <bm:field name="attachment_tab_group" databaseType="VARCHAR2" datatype="java.lang.String"/>
+        <bm:field name="tab_group_id" databaseType="NUMBER" datatype="java.lang.Long"/>
+        <bm:field name="important_flag" databaseType="VARCHAR2" datatype="java.lang.String"/>
+        <bm:field name="attach_file_name" databaseType="VARCHAR2" datatype="java.lang.String"/>
+        <bm:field name="content_id"/>
+        <bm:field name="content_print_flag"/>
+        <bm:field name="audit_status"/>
+        <bm:field name="note1"/>
+        <bm:field name="note2"/>
+        <bm:field name="note3"/>
+        <bm:field name="express_number"/>
+        <bm:field name="send_date" databaseType="DATE" datatype="java.util.Date"/>
+        <bm:field name="receive_date" databaseType="DATE" datatype="java.util.Date"/>
+        <bm:field name="print_status"/>
+        <bm:field name="print_status_n"/>
+        <bm:field name="audit_status_n"/>
+        <bm:field name="dd_check_flag"/>
+        <bm:field name="dd_photo_flag"/>
+        <bm:field name="cdd_class_code"/>
+        <bm:field name="delete_sign_flag"/>
+        <bm:field name="creation_date" databaseType="DATE" datatype="java.util.Date"/>
+        <bm:field name="version_display"/>
+        <bm:field name="creatiodate"/>
+        <bm:field name="attach_only_query_flag"/>
+        <bm:field name="false_required_flag"/>
+        <bm:field name="sign_num"/>
+        <bm:field name="arch_required_flag"/>
+        <bm:field name="arch_par_has_flag"/>
+        <bm:field name="arch_par_has_flag_desc"/>
+        <bm:field name="arch_paper_required_flag"/>
+        <bm:field name="receive_flag"/>
+        <bm:field name="mark_flag"/>
+        <bm:field name="confirm_flag"/>
+        <bm:field name="feedback"/>
+        <bm:field name="bind_bp_id"/>
+        <bm:field name="bp_name"/>
+        <bm:field name="archive_status"/>
+        <bm:field name="archive_status_n"/>
+        <bm:field name="archive_date"/>
+
+        <bm:field name="seq_num"/>
+        <bm:field name="important_concerns"/>
+        <bm:field name="investigate_guide_flag"/>
+        <bm:field name="investigate_guide_flag_n"/>
+        <bm:field name="reason_alternative"/>
+        <bm:field name="order_num"/>
+    </bm:fields>
+    <bm:query-fields>
+        <!--提前留购发起隐藏同意提前留购确认书-->
+        <bm:query-field name="query_flag" queryExpression="(${@query_flag}='Y' and  t1.cdd_item != 'HN_CON_ET_ATTACH_CONFIRM')"/>
+        <!--项目审查和项目变更单独查询资料清单-->
+        <bm:query-field name="cdd_class" queryExpression="(${@cdd_class} is not null and t1.cdd_class = ${@cdd_class} and t1.version_display is null)"/>
+        <!--仅用于查询不关联右关联 项目变更附件版本-->
+        <bm:query-field name="attach_only_query_flag" queryExpression="(nvl(${@attach_only_query_flag},'N') = t1.attach_only_query_flag )"/>
+        <!--用于项目变更仅查询本次新增的变更附件资料-->
+        <bm:query-field name="prj_change_query_flag" queryExpression="(${@prj_change_query_flag} is not null and t1.version_display is null)"/>
+        <bm:query-field name="attachment_tab_group" queryExpression="t1.attachment_tab_group like '%'||${@attachment_tab_group}||'%' "/>
+        <bm:query-field name="confirm_flag" queryExpression="t1.confirm_flag = ${@confirm_flag}"/>
+
+    </bm:query-fields>
+</bm:model>
Index: src/main/resources/leaf_static/WEB-INF/classes/acrch/ARCHIVE003/con_file_archive_attachment.lwm
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/WEB-INF/classes/acrch/ARCHIVE003/con_file_archive_attachment.lwm b/src/main/resources/leaf_static/WEB-INF/classes/acrch/ARCHIVE003/con_file_archive_attachment.lwm
new file mode 100644
--- /dev/null	(revision 600e775116243404a756244fa5f1586954125738)
+++ b/src/main/resources/leaf_static/WEB-INF/classes/acrch/ARCHIVE003/con_file_archive_attachment.lwm	(revision 600e775116243404a756244fa5f1586954125738)
@@ -0,0 +1,57 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!--
+    $Author: liliu
+    $Date: 2022年1月13日
+    $Revision: 1.0
+    $Purpose:
+-->
+
+
+<bm:model xmlns:s="leaf.plugin.script" xmlns:bm="http://www.leaf-framework.org/schema/bm">
+    <bm:operations>
+        <bm:operation name="query">
+            <bm:query-sql><![CDATA[
+                 select ca.archive_attachment_id,
+                       row_number() over(partition by project_id order by ca.archive_attachment_id) row_number,
+                       ca.project_id,
+                       ca.cdd_item_name,
+                       ca.archive_batch_id,
+                       hls_sys_upload_pkg.get_atm_file_href(p_table_pk_value => ca.archive_attachment_id,
+                                                            p_source_type    => 'CON_FILE_ARCHIVE_ATTACHMENT',
+                                                            p_user_id        => '1') AS attach_file_name,
+                       ca.important_paper_file_flag,
+                       (select v.code_value_name
+                          from SYS_CODE_VALUES_V V
+                         WHERE V.code = 'YES_NO'
+                           AND V.code_enabled_flag = 'Y'
+                           AND V.code_value_enabled_flag = 'Y'
+                           AND V.code_value = ca.important_paper_file_flag) important_paper_file_flag_n,
+                       ca.archive_date,
+                       ca.ramark,
+                       ca.archive_status,
+                       ca.receive_flag,
+                       (select v.code_value_name
+                          from SYS_CODE_VALUES_V V
+                         WHERE V.code = 'HN1410_WFL_STATUS'
+                           AND V.code_enabled_flag = 'Y'
+                           AND V.code_value_enabled_flag = 'Y'
+                           AND V.code_value = ca.archive_status) archive_status_n,
+                       ca.file_seq,
+                       ca.file_type,
+                       (select v.code_value_name
+                          from SYS_CODE_VALUES_V V
+                         WHERE V.code = 'ARCHIVE002_FILE_TYPE'
+                           AND V.code_enabled_flag = 'Y'
+                           AND V.code_value_enabled_flag = 'Y'
+                           AND V.code_value = ca.file_type) file_type_n, --文件类型
+                       ca.important_flag,
+                       ca.file_classification,
+                       ca.document_number,
+                       ca.copies_number,
+                       ca.archive_form
+                  from con_file_archive_attachment ca
+                 where ca.archive_batch_id = ${@archive_batch_id}
+            ]]></bm:query-sql>
+        </bm:operation>
+    </bm:operations>
+</bm:model>
Index: src/main/resources/leaf_static/modules/prj/PRJ501Z/hn_prj_clause_lib_manage_lov.lview
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/prj/PRJ501Z/hn_prj_clause_lib_manage_lov.lview b/src/main/resources/leaf_static/modules/prj/PRJ501Z/hn_prj_clause_lib_manage_lov.lview
--- a/src/main/resources/leaf_static/modules/prj/PRJ501Z/hn_prj_clause_lib_manage_lov.lview	(revision 43022f19947564eea387db7582c0658dc915148b)
+++ b/src/main/resources/leaf_static/modules/prj/PRJ501Z/hn_prj_clause_lib_manage_lov.lview	(revision 600e775116243404a756244fa5f1586954125738)
@@ -68,6 +68,7 @@
                     <a:column name="antistop_key"  width="120" prompt="二级分类" />
                     <a:column name="third_classification"  width="120" prompt="三级分类" />
                     <a:column name="content_overview" width="240" prompt="内容概述"  renderer="details_red_renderer"/>
+                    <a:column name="show_seq" width="100" prompt="重要文件标识"/>
                 </a:columns>
             </a:table>
         </a:screenBody>
Index: src/main/resources/leaf_static/modules/prj/PRJ501Z/hn_prj_prepayment_clause.lview
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/prj/PRJ501Z/hn_prj_prepayment_clause.lview b/src/main/resources/leaf_static/modules/prj/PRJ501Z/hn_prj_prepayment_clause.lview
--- a/src/main/resources/leaf_static/modules/prj/PRJ501Z/hn_prj_prepayment_clause.lview	(revision 43022f19947564eea387db7582c0658dc915148b)
+++ b/src/main/resources/leaf_static/modules/prj/PRJ501Z/hn_prj_prepayment_clause.lview	(revision 600e775116243404a756244fa5f1586954125738)
@@ -25,7 +25,9 @@
             Leaf.Masker.unmask(Ext.getBody());
         }
         function prj_prepayment_clause_save() {
+
             var ds = $('prj_prepayment_clause_ds');
+
             if (ds.validate()) {
                 var records = ds.getAll();
                 var saveData = [];
@@ -42,8 +44,10 @@
                     array['pre_cla_type'] = record.get('pre_cla_type');
                     array['pre_cla_content'] = record.get('pre_cla_content');
                     array['contract_write_flag'] = record.get('contract_write_flag');
+                    array['show_seq'] = record.get('show_seq')
                     saveData.push(array);
                 }
+                console.log(saveData)
                 Leaf.showConfirm('提示', '确认进行保存么?', function () {
                     lock_current_window();
                     Leaf.request({
@@ -55,7 +59,7 @@
                         },
                         failure: function () {
                             unlock_current_window();
-                            // ds.query();
+                           // ds.query();
                         },
                         error: function () {
                             unlock_current_window();
@@ -72,6 +76,7 @@
             $('${/parameter/@requirement_winId}').close();
         }

+
         function prj_prepayment_clause_add(ds, record) {
             if (ds.id) {
                 //设置增信措施序号
@@ -87,6 +92,11 @@
             }
         }

+        function pre_cla_content_renderer(value, record, name) {
+            if (name == 'pre_cla_content') {
+                return red_char(value);
+            }
+        }
         function prj_prepayment_clause_update(ds, record, name, value, oldvalue) {
             if (name ='pre_cla_type'){
                 if (record.get('pre_cla_type') =='其他'){
@@ -112,11 +122,6 @@
             }
         }

-        function pre_cla_content_renderer(value, record, name) {
-            if (name == 'pre_cla_content') {
-                return red_char(value);
-            }
-        }

         function prj_prepayment_clause_list() {
             var win = new Leaf.Window({
@@ -140,6 +145,10 @@
                 $('prj_prepayment_clause_ds').query();
             });
         }
+
+        function test(){
+            console.log($("prj_prepayment_clause_ds"))
+        }
         ]]></script>
         <a:dataSets>
             <a:dataSet id="violate_claim_ds" lookupCode="PRJ501Z_VIOLATE_CLAIM_TYPE"/>
@@ -160,21 +169,22 @@
                             <a:map from="content_overview" to="pre_cla_content"/>
                             <a:map from="antistop_key" to="antistop_key"/>
                             <a:map from="third_classification" to="third_classification"/>
+                            <a:map from="show_seq" to="show_seq"/>
                         </a:mapping>
                     </a:field>
                     <a:field name="antistop_key"/>
                     <a:field name="third_classification"/>
+                    <a:field name="show_seq"/>
                     <a:field name="clause_lib_id"/>
                     <a:field name="pre_cla_type" />
                     <a:field name="pre_cla_content" readOnly="true"/>
                     <a:field name="contract_write_flag" checkedValue="Y" uncheckedValue="N" defaultValue="N"/>
                 </a:fields>
                 <a:events>
-                    <a:event name="load" handler="prj_prepayment_clause_load"/>
-                    <a:event name="update" handler="prj_prepayment_clause_update"/>
                     <a:event name="add" handler="prj_prepayment_clause_add"/>
                     <a:event name="remove" handler="prj_prepayment_clause_remove"/>
-
+                    <a:event name="update" handler="prj_prepayment_clause_update"/>
+                    <a:event name="load" handler="prj_prepayment_clause_load"/>
                 </a:events>
             </a:dataSet>
         </a:dataSets>
@@ -188,6 +198,7 @@
                             <a:button click="prj_prepayment_clause_save" text="保存" icon="${/request/@context_path}/images/save.png"/>
                             <a:button click="prj_prepayment_clause_list" text="多选" icon="${/request/@context_path}/images/save.png"/>
                             <a:button type="delete"/>
+                            <a:button click="test" text="test"/>
                         </a:toolBar>
                         <a:columns>
                             <a:column name="seq_number" width="80" align="center" prompt="序号"/>
@@ -196,6 +207,7 @@
                             <a:column name="third_classification" width="120" align="left" prompt="三级分类"/>
                             <a:column name="pre_cla_content" width="520" align="left" prompt="落实条件" renderer="pre_cla_content_renderer" editor="prepayment_clause_ta"/>
                             <a:column name="contract_write_flag" editor="prj_manage_cbx" prompt="不写入合同" width="100"/>
+                            <a:column name="show_seq" width="100" prompt="重要文件标识"/>
                         </a:columns>
                         <a:editors>
                             <a:lov id="prepayment_clause_lov"/>
@@ -211,4 +223,4 @@
             </a:hBox>
         </a:screenBody>
     </a:view>
-</a:screen>
+</a:screen>
\ No newline at end of file
Index: src/main/resources/leaf_static/modules/prj/PRJ501Z/prj_project_modify_info.lview
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/prj/PRJ501Z/prj_project_modify_info.lview b/src/main/resources/leaf_static/modules/prj/PRJ501Z/prj_project_modify_info.lview
--- a/src/main/resources/leaf_static/modules/prj/PRJ501Z/prj_project_modify_info.lview	(revision 43022f19947564eea387db7582c0658dc915148b)
+++ b/src/main/resources/leaf_static/modules/prj/PRJ501Z/prj_project_modify_info.lview	(revision 600e775116243404a756244fa5f1586954125738)
@@ -30,6 +30,7 @@
         <a:link id="hn_plan_prj_bp_add" url="${/request/@context_path}/modules/prj/PRJ501Z/hls_plan_prj_bp_create.lview"/>
         <script><![CDATA[

+
         //保存前调用
         window['${/parameter/@bp_seq}${/parameter/@layout_code}_on_layout_dynamic_before_submit'] = function (ds, record) {
             window['${/parameter/@layout_code}_lock_layout_dynamic_window']();
@@ -70,6 +71,7 @@
             }
             if('${/parameter/@document_type}'!='PRJF'){
                 if($(structure_deal_ds_id).getAt(0).get('bank_principal')>0&&Ext.isEmpty($(structure_deal_ds_id).getAt(0).get('bank_description'))){
+
                     Leaf.showMessage('${l:HLS.PROMPT}', '银承金额（大于0），请填写银承投放要求。');
                     window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
                     check_flag = false;
@@ -99,6 +101,8 @@
             var ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'prj_project');
             var structure_deal_ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'hn_project_structure_deal');
             var structure_factor_ds_id = get_dsid_by_basetable(window['${/parameter/@layout_code}_layoutDataSetList'], 'hn_prj_factor_structure');
+
+
             if (ds_id == ds.id) {
                 record.set('plan_times', '${/parameter/@plan_times}');
                 record.set('plan_times_n', '${/parameter/@plan_times_n}');
@@ -131,10 +135,10 @@
                 }

                if(record.get('lease_pay_way_type')=='OTHERS'){
-                   record.getField('lease_pay_way').setReadOnly(false);
+                   record.getField('float_pay_way').setReadOnly(false);
                 }
                 else{
-                   record.getField('lease_pay_way').setReadOnly(true);
+                   record.getField('float_pay_way').setReadOnly(true);
                }


@@ -161,7 +165,6 @@
                     }
                     if(record.get('factor_pay_way_type_n')=='其他'){
                         record.getField('factor_pay_way').setReadOnly(false);
-                        record.set('factor_pay_way','');
                     }else{
                         record.getField('factor_pay_way').setReadOnly(true);
                     }
@@ -372,6 +375,7 @@
                 $(ds_id).getField('equipment_seller_n').setRequired(true);
             }*/
             window['${/parameter/@layout_code}_unlock_layout_dynamic_window']();
+            //

         };

Index: src/main/resources/leaf_static/modules/prj/PRJ501ZW/hn_prj_project_plan_wfl.lview
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/prj/PRJ501ZW/hn_prj_project_plan_wfl.lview b/src/main/resources/leaf_static/modules/prj/PRJ501ZW/hn_prj_project_plan_wfl.lview
--- a/src/main/resources/leaf_static/modules/prj/PRJ501ZW/hn_prj_project_plan_wfl.lview	(revision 43022f19947564eea387db7582c0658dc915148b)
+++ b/src/main/resources/leaf_static/modules/prj/PRJ501ZW/hn_prj_project_plan_wfl.lview	(revision 600e775116243404a756244fa5f1586954125738)
@@ -338,13 +338,26 @@
             var ds_id = ds.id;
             var plan_id = '${/parameter/@plan_id}';
             var cdd_list_id = records[0].data.cdd_list_id;
+            var current_seq = '${/model/plan_basic_info/record/@current_seq}';
             var param = {};
-            var function_code = 'PRJ501ZW_AMTQ';
+            //modify by zc for archive
+            var important_file_flag = '${/parameter/@important_file_flag}';
+            if(important_file_flag == 'Y' || important_file_flag == 'E'){
+                var function_code = 'PRJ501ZW_AMTU';
+                param['function_usage'] = 'MODIFY';
+                param['maintain_type'] = 'UPDATE';
+                param['current_seq'] = current_seq;
+                param['important_file_flag'] = important_file_flag;
+            }
+            else{
+                var function_code = 'PRJ501ZW_AMTQ';
+                param['function_usage'] = 'QUERY';
+                param['maintain_type'] = 'READONLY';
+            }
+            console.log(function_code)
             param['function_code'] = function_code;
             param['plan_id'] = plan_id;
             param['cdd_list_id'] = cdd_list_id;
-            param['function_usage'] = 'QUERY';
-            param['maintain_type'] = 'READONLY';
             param['url_title'] = '项目方案附件';
             param['winid'] = 'prj_project_plan_attachment_win_id';
             hls_doc_get_layout_code('prj_plan_get_layout_code_link_id', param, 'prj_project_plan_attachment_link', ds_id);
@@ -579,16 +592,16 @@
             <a:switch test="/parameter/@download_flag">
                 <a:case value="Y">
                     <a:screenTopToolbar>
-                        <a:gridButton text="项目方案下载" click="prj501Z_project_plan_excel"/>
-                        <a:gridButton id="plan_download_btn" click="hn_batch_download" text="项目资料下载（按提交次数）"/>
-                        <a:gridButton text="项目资料下载（按文件位置）" id="batch_download_btn" click="go_to_zip_page"/>
+                        <a:gridButton text="查看项目方案" click="prj501Z_project_plan_excel"/>
+                        <a:gridButton id="plan_download_btn" click="hn_batch_download" text="项目方案附件下载"/>
+                        <a:gridButton text="打包下载" id="batch_download_btn" click="go_to_zip_page"/>
                     </a:screenTopToolbar>
                 </a:case>
                 <a:case value="*">
                     <a:screenTopToolbar>
-                        <a:gridButton text="项目方案下载" click="prj501Z_project_plan_excel"/>
-                        <a:gridButton id="plan_download_btn" click="hn_batch_download" text="项目资料下载（按提交次数）"/>
-                        <a:gridButton text="项目资料下载（按文件位置）" id="batch_download_btn" click="go_to_zip_page"/>
+                        <a:gridButton text="查看项目方案" click="prj501Z_project_plan_excel"/>
+                        <a:gridButton id="plan_download_btn" click="hn_batch_download" text="项目方案附件下载"/>
+                        <a:gridButton text="打包下载" id="batch_download_btn" click="go_to_zip_page"/>
                     </a:screenTopToolbar>
                 </a:case>
             </a:switch>
Index: src/main/resources/leaf_static/WEB-INF/server-script/layoutconfig/archive_file_his_entrance_g_project_result_queryfields.js
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/WEB-INF/server-script/layoutconfig/archive_file_his_entrance_g_project_result_queryfields.js b/src/main/resources/leaf_static/WEB-INF/server-script/layoutconfig/archive_file_his_entrance_g_project_result_queryfields.js
new file mode 100644
--- /dev/null	(revision 8e37abc57cea997d3cadf83218a4e9d2801a0c87)
+++ b/src/main/resources/leaf_static/WEB-INF/server-script/layoutconfig/archive_file_his_entrance_g_project_result_queryfields.js	(revision 8e37abc57cea997d3cadf83218a4e9d2801a0c87)
@@ -0,0 +1,20 @@
+
+var add_datafilters = [{
+	name: 'employee_id',
+	expression: " (t1.employee_id = (select su.employee_id from sys_user su where su.user_id = ${/session/@user_id}) or ( ${/session/@user_id} = 1) or exists (SELECT 1 FROM sys_user su,exp_employee_assigns eea,exp_employees ex,exp_org_position_vl eo WHERE su.employee_id = eea.employee_id AND eea.position_id = eo.position_id and ex.employee_id =su.employee_id and nvl (su.frozen_flag ,'N' )<>'Y' and eea.enabled_flag ='Y' and ex.enabled_flag ='Y' and eo.ENABLED_FLAG='Y' and sysdate between su.start_date and nvl(su.end_date ,to_date ('3000-01-01' ,'yyyy-mm-dd' )) and su.user_id = ${/session/@user_id} and eo.POSITION_CODE = '1200')or((select count(1)\n" +
+		"  from sys_user_role_groups_vl v\n" +
+		" where v.user_id =  ${/session/@user_id}\n" +
+		"   and v.enabled_flag = 'Y'\n" +
+		"   and v.role_code = 'ARCHIVIST')>0))"
+}];
+
+var override_queryfields = [
+	{
+		name:'months',
+		queryexpression:"t1.months=${@months}"
+	}
+];
+
+add_datafilter();
+override();
+
Index: src/main/resources/leaf_static/WEB-INF/classes/fnd/fnd_attachment_upload_query.lwm
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/WEB-INF/classes/fnd/fnd_attachment_upload_query.lwm b/src/main/resources/leaf_static/WEB-INF/classes/fnd/fnd_attachment_upload_query.lwm
--- a/src/main/resources/leaf_static/WEB-INF/classes/fnd/fnd_attachment_upload_query.lwm	(revision 8e37abc57cea997d3cadf83218a4e9d2801a0c87)
+++ b/src/main/resources/leaf_static/WEB-INF/classes/fnd/fnd_attachment_upload_query.lwm	(revision 3eea5444a4ed63440f09ba81ac120bf418c8d6e0)
@@ -8,6 +8,7 @@
   union
 select t1.upload_type,
        t1.upload_version value_code,
+       decode(t1.delete_button_flag, 'N', 'false', 'Y', 'true') delete_button_flag,
        case
          when nvl(upload_version, 0) > 0 then
           decode(t1.upload_type,
@@ -17,7 +18,7 @@
          else
           null
        end value_name
-  from (SELECT fam.upload_type, fam.upload_version
+  from (SELECT fam.upload_type, fam.upload_version, nvl(fam.delete_button_flag, 'N')
           from fnd_atm_attachment_multi fam,
                prj_cdd_item             pi,
                prj_cdd_item_check       pc
Index: src/main/resources/leaf_static/WEB-INF/classes/execute_sql.lwm
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/WEB-INF/classes/execute_sql.lwm b/src/main/resources/leaf_static/WEB-INF/classes/execute_sql.lwm
new file mode 100644
--- /dev/null	(revision 3b91a98aeb86b0598dc3905b460956ce39825391)
+++ b/src/main/resources/leaf_static/WEB-INF/classes/execute_sql.lwm	(revision 3b91a98aeb86b0598dc3905b460956ce39825391)
@@ -0,0 +1,13 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<bm:model xmlns:bm="http://www.leaf-framework.org/schema/bm">
+    <bm:operations>
+        <bm:operation name="execute">
+            <bm:update-sql><![CDATA[
+            begin
+                execute immediate ${@execute_sql};
+            end;
+            ]]></bm:update-sql>
+        </bm:operation>
+    </bm:operations>
+
+</bm:model>
Index: src/main/resources/leaf_static/WEB-INF/classes/prj/PRJ507/prj_plan_change_req_atm_download.lwm
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/WEB-INF/classes/prj/PRJ507/prj_plan_change_req_atm_download.lwm b/src/main/resources/leaf_static/WEB-INF/classes/prj/PRJ507/prj_plan_change_req_atm_download.lwm
--- a/src/main/resources/leaf_static/WEB-INF/classes/prj/PRJ507/prj_plan_change_req_atm_download.lwm	(revision a74a6e0d6996a54310e2085f7af0cfce8613d8a5)
+++ b/src/main/resources/leaf_static/WEB-INF/classes/prj/PRJ507/prj_plan_change_req_atm_download.lwm	(revision 3b91a98aeb86b0598dc3905b460956ce39825391)
@@ -17,7 +17,8 @@
                                   FROM hn_att_general_record gr
                                  WHERE gr.document_table = 'HN_PRJ_PLAN'
                                    AND gr.document_id = ${@plan_id}
-                                   AND nvl(gr.ref_v01,'N') <> 'Y'
+                                   AND (nvl(gr.ref_v01,'N') <> 'Y'
+                                   or exists(select 1 from hn_prj_plan where plan_id = ${@plan_id} and wfl_status = 'APPROVED'))
                                    and gr.record_id = fam.table_pk_value)) t1
                 ]]></bm:query-sql>
         </bm:operation>
Index: src/main/resources/leaf_static/WEB-INF/classes/simple/SIM_WFL/simple_instance_info.lwm
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/WEB-INF/classes/simple/SIM_WFL/simple_instance_info.lwm b/src/main/resources/leaf_static/WEB-INF/classes/simple/SIM_WFL/simple_instance_info.lwm
new file mode 100644
--- /dev/null	(revision 3b91a98aeb86b0598dc3905b460956ce39825391)
+++ b/src/main/resources/leaf_static/WEB-INF/classes/simple/SIM_WFL/simple_instance_info.lwm	(revision 3b91a98aeb86b0598dc3905b460956ce39825391)
@@ -0,0 +1,45 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!--
+    $Author: Sora
+    $Date: 2022-4-2
+    $Revision: 1.0
+    $Purpose:
+-->
+<bm:model xmlns:bm="http://www.leaf-framework.org/schema/bm">
+    <bm:operations>
+        <bm:operation name="query">
+            <bm:query-sql>
+                <![CDATA[
+                    select * from (
+                        select t1.instance_id,
+                               t1.workflow_code,
+                               t1.workflow_desc,
+                               t1.current_seq,
+                               t1.created_by,
+                               t1.submitted_by,
+                               t2.node_display_service_desc,
+                               t2.node_display_service_name,
+                               t2.node_display_my_app_svc_desc,
+                               t2.node_display_my_app_svc_name
+                               from zj_wfl_workflow_instance_v t1, zj_wfl_workflow_node_v t2
+                               where t1.workflow_id = t2.workflow_id and t1.current_seq = t2.sequence_num
+                        ) t
+                           #WHERE_CLAUSE#
+            ]]></bm:query-sql>
+        </bm:operation>
+    </bm:operations>
+    <bm:fields>
+        <bm:field name="workflow_code" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="WORKFLOW_CODE"/>
+        <bm:field name="node_display_service_desc" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="NODE_DISPLAY_SERVICE_DESC"/>
+        <bm:field name="node_display_service_name" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="NODE_DISPLAY_SERVICE_NAME"/>
+        <bm:field name="node_display_my_app_svc_desc" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="NODE_DISPLAY_MY_APP_SVC_DESC"/>
+        <bm:field name="node_display_my_app_svc_name" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="NODE_DISPLAY_MY_APP_SVC_NAME"/>
+        <bm:field name="workflow_desc" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="WORKFLOW_DESC"/>
+        <bm:field name="submitted_by" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="SUBMITTED_BY"/>
+        <bm:field name="current_seq" databaseType="NUMBER" datatype="java.lang.String" physicalName="CURRENT_SEQ"/>
+        <bm:field name="instance_id" databaseType="NUMBER" datatype="java.lang.String" physicalName="INSTANCE_ID"/>
+    </bm:fields>
+    <bm:query-fields>
+        <bm:query-field field="instance_id" queryOperator="="/>
+    </bm:query-fields>
+</bm:model>
Index: src/main/resources/leaf_static/WEB-INF/classes/simple/SIM_WFL/simple_workflow_view_para.lwm
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/WEB-INF/classes/simple/SIM_WFL/simple_workflow_view_para.lwm b/src/main/resources/leaf_static/WEB-INF/classes/simple/SIM_WFL/simple_workflow_view_para.lwm
new file mode 100644
--- /dev/null	(revision 3b91a98aeb86b0598dc3905b460956ce39825391)
+++ b/src/main/resources/leaf_static/WEB-INF/classes/simple/SIM_WFL/simple_workflow_view_para.lwm	(revision 3b91a98aeb86b0598dc3905b460956ce39825391)
@@ -0,0 +1,30 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!--
+    $Author: Sora
+    $Date: 2022-4-2
+    $Revision: 1.0
+    $Purpose:
+-->
+<bm:model xmlns:bm="http://www.leaf-framework.org/schema/bm">
+    <bm:operations>
+        <bm:operation name="query">
+            <bm:query-sql>
+                <![CDATA[
+                    select * from (
+                        select sa.parameter_code, sa.parameter_desc, s.service_name
+                            from zj_wfl_workflow_service_para sa, zj_wfl_workflow_service s
+                            where s.service_id = sa.service_id order by sa.sequence_num desc
+                        ) t
+                           #WHERE_CLAUSE#
+            ]]></bm:query-sql>
+        </bm:operation>
+    </bm:operations>
+    <bm:fields>
+        <bm:field name="parameter_code" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="PARAMETER_CODE"/>
+        <bm:field name="parameter_desc" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="PARAMETER_DESC"/>
+        <bm:field name="service_name" databaseType="VARCHAR2" datatype="java.lang.String" physicalName="SERVICE_NAME"/>
+    </bm:fields>
+    <bm:query-fields>
+        <bm:query-field field="service_name" queryOperator="="/>
+    </bm:query-fields>
+</bm:model>
Index: src/main/resources/leaf_static/modules/simple/active_view_model.lview
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/simple/active_view_model.lview b/src/main/resources/leaf_static/modules/simple/active_view_model.lview
new file mode 100644
--- /dev/null	(revision 3b91a98aeb86b0598dc3905b460956ce39825391)
+++ b/src/main/resources/leaf_static/modules/simple/active_view_model.lview	(revision 3b91a98aeb86b0598dc3905b460956ce39825391)
@@ -0,0 +1,19 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<!--
+    $Author: Sora
+    $Date: 2022-3-24
+    $Revision: 1.0
+    $Purpose: 动态页面模板
+-->
+<a:screen xmlns:a="http://www.leaf-framework.org/application" customizationEnabled="true" dynamiccreateenabled="true" trace="true">
+    <a:view>
+        <script><![CDATA[
+
+
+
+        ]]></script>
+
+        <a:screen-include screen="modules/cont/CON500/con_contract_get_layout_code.lview"/>
+        <a:screen-include screen="modules/simple/simple_util.lview"/>
+    </a:view>
+</a:screen>
Index: src/main/resources/leaf_static/modules/simple/js/simple_util_log.js
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/simple/js/simple_util_log.js b/src/main/resources/leaf_static/modules/simple/js/simple_util_log.js
new file mode 100644
--- /dev/null	(revision da8428c2e99909756cfaae5c7f7ee13604ee5c11)
+++ b/src/main/resources/leaf_static/modules/simple/js/simple_util_log.js	(revision da8428c2e99909756cfaae5c7f7ee13604ee5c11)
@@ -0,0 +1,85 @@
+const sp_const_colorful = ['LightBlue', 'LightCoral', 'LightGreen',  'LightSalmon',
+    'LightSeaGreen',  'LightSlateGray',  'MediumPurple', 'MediumSlateBlue', 'MediumVioletRed', 'Orange', 'Plum']
+
+const sp_const_fruit_emoji = ['🍇', '🍈', '🍉', '🍊', '🍋', '🍌', '🍍', '🥭', '🍎', '🍏', '🍐', '🍑',
+    '🍒', '🍓', '🫐', '🥝', '🍅', '🫒', '🥥', '🥑', '🍆', '🥔', '🥕', '🌽', '🌶️']
+
+const sp_const_plant_emoji = ['💐', '🌸', '💮', '🏵️', '🌹', '🥀', '🌺', '🌻', '🌼', '🌷', '🌱', '🪴', '🌲', '🌳',
+    '🌴', '🌵', '🌾', '🌿', '☘️', '🍀', '🍁', '🍂', '🍃', '🍄']
+
+const sp_log_version = 'Simple Log V0.1'
+
+let sp_log_banner_flag = true
+
+console.clear()
+
+/**
+ * 华丽的输出object类型数据
+ * @param obj 输出数据
+ * @param group_name 数据组名称
+ * @param compare_func 比较方法(默认英文比较)
+ * @param fold 是否折叠 默认是(不折叠就输出的就太多啦 自行斟酌)
+ */
+function sp_obj_colorful_log(obj, group_name, compare_func=compare_english, fold=true){
+    const plant_emoji = sp_choice(sp_const_plant_emoji)
+    group_name = plant_emoji + " " + group_name + " " + plant_emoji
+    if(fold){
+        console.groupCollapsed(group_name)
+    } else{
+        console.group(group_name)
+    }
+    let arr = sp_obj_to_list(obj)
+    arr.sort(compare_func("key"))
+    arr.forEach(para =>{
+        let emoji = sp_choice(sp_const_fruit_emoji)
+        console.log(sp_format(`%c{0} {1}:{2} {3}`, emoji, para["key"], para["value"], emoji),
+            sp_format(`color: {0}; font-weight: bold;`, sp_choice(sp_const_colorful)))
+    })
+    console.groupEnd()
+}
+
+/**
+ * 特别的输出 随机颜色 随机水果符号
+ * @param log_str 要输出的字符串
+ * @param colorful_flag 是否要颜色 (不要就是默认黑)
+ * @param emoji_flag 是否要符号
+ */
+function sp_log(log_str, colorful_flag=true, emoji_flag=true){
+    let emoji, color
+    if(emoji_flag){
+        emoji = sp_choice(sp_const_fruit_emoji)
+    }
+    if(colorful_flag){
+        color = sp_choice(sp_const_colorful)
+    } else{
+        color = "black"
+    }
+    console.log(sp_format(`%c{0} {1}`, emoji, log_str),
+        sp_format(`color: {0}; font-weight: bold; font-size: 18px;`, color))
+}
+
+/**
+ * 控制台输出页面信息
+ * @param banner_data example:{author: 'Sora', view_name: 'test view'}
+ */
+function sp_banner(banner_data){
+    const author_str = sp_format(`view-author: {0} `, banner_data['author'])
+    const detail_str = sp_format(`view-function: {0} `, banner_data['view_name'])
+    console.log("\n %c "+ author_str +" %c "+ detail_str + " %c " + sp_log_version
+        +" \n","color: #fadfa3; background: #030307; padding:5px 0;font-weight: bold;",
+        "background: #fadfa3; padding:5px 0;font-weight: bold;",
+        "color: #fadfa3; background: #030307; padding:5px 0;font-weight: bold;")
+}
+
+function sp_log_banner(){
+    console.log("\n %c "+ 'Thanks for using Simple Log!' + " %c " + sp_log_version,
+        "background: #fadfa3; padding:5px;font-weight: bold;",
+        "color: #fadfa3; background: #030307; padding:5px;font-weight: bold;")
+}
+
+if(sp_log_banner_flag){
+    sp_log_banner()
+}
+
+
+
Index: src/main/resources/leaf_static/modules/simple/js/simple_util_mess.js
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/simple/js/simple_util_mess.js b/src/main/resources/leaf_static/modules/simple/js/simple_util_mess.js
new file mode 100644
--- /dev/null	(revision e860552033dc60e9229fb8dacefe84337b7f6d2d)
+++ b/src/main/resources/leaf_static/modules/simple/js/simple_util_mess.js	(revision e860552033dc60e9229fb8dacefe84337b7f6d2d)
@@ -0,0 +1,72 @@
+//list-obj比较(英文)
+function compare_english(property_name) {
+    return function(a,b){
+        let x1 = a[property_name].toUpperCase();
+        let x2 = b[property_name].toUpperCase();
+        if (x1 < x2) {
+            return -1;
+        }
+        if (x1 > x2) {
+            return 1;
+        }
+        return 0;
+    }
+
+}
+
+//list-obj比较(数字)
+function compare_number(property_name){
+    return function(a,b){
+        const value1 = a[property_name];
+        const value2 = b[property_name];
+        return value1 - value2;
+    }
+}
+
+//list-obj比较(中文首字母)
+function compare_chinese_head(property_name){
+    return function(a,b){
+        const value1 = a[property_name][0];
+        const value2 = b[property_name][0];
+        if(value1 > value2){
+            return 1
+        } else if(value1 < value2){
+            return -1
+        }
+    }
+}
+
+/**
+ * 动态字符串插入 例子 sp_format(`{0}, {1}`, 'hello', 'world') output:'hello, world'
+ * @param val
+ * @returns {*}
+ */
+function sp_format(val) {
+    let args = Array.prototype.slice.call(arguments, 1)
+    return val.replace(/{(\d+)}/g, function(match, number) {
+        return typeof args[number] !== 'undefined' ? args[number] : match
+    })
+}
+
+
+/**
+ * 在列表中随机选取一条数据
+ * @param list 列表
+ * @returns {*} 数据
+ */
+function sp_choice(list){
+    return list[Math.floor((Math.random() * list.length))];
+}
+
+function sp_range(start, end){
+    return Array(end-start).fill(start).map((el,i)=>start+i)
+}
+
+/**
+ * 获取一个长度为num 数据为从1到num的列表
+ * @param num
+ * @returns {number[]}
+ */
+function range(num){
+    return [...Array(num).keys()]
+}
\ No newline at end of file
Index: src/main/resources/leaf_static/modules/simple/js/simple_util_workflow.js
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/simple/js/simple_util_workflow.js b/src/main/resources/leaf_static/modules/simple/js/simple_util_workflow.js
new file mode 100644
--- /dev/null	(revision 3b91a98aeb86b0598dc3905b460956ce39825391)
+++ b/src/main/resources/leaf_static/modules/simple/js/simple_util_workflow.js	(revision 3b91a98aeb86b0598dc3905b460956ce39825391)
@@ -0,0 +1,57 @@
+const sp_workflow_info = {
+    instance_info:{},
+    workflow_para_info: []
+}
+
+//设置属性参数
+function set_property(layout_code, current_seq){
+    let filter_info = window['simple_wfl_property'].filter(seq =>{
+        return seq["current_seq"] = current_seq
+    })
+
+    try {
+        filter_info[0]["revise_data"].forEach(revise_obj =>{
+            let revise_ds = $(get_dsid_by_basetable(window[layout_code+'_layoutDataSetList'], revise_obj["ds_name"], revise_obj["tab_group"]))
+            revise_obj["columns"].forEach(column =>{
+                revise_ds.getAll().forEach(rec =>{
+                    if(column["column_value"]){
+                        rec.set(column["column_name"], column["column_value"])
+                    }
+                    if(column["property"]["readonly"]){
+                        rec.getField(column["column_name"]).setReadOnly(column["property"]["readonly"])
+                    }
+                    if(column["property"]["required"]){
+                        rec.getField(column["column_name"]).setRequired(column["property"]["required"])
+                    }
+                })
+            })
+
+        })
+    } catch (e){
+        console.error(e)
+    }
+}
+
+function get_instance_info(local_url, instance_id, complete_function=()=>{}){
+    Leaf.request({
+        url:`${local_url}/autocrud/simple.SIM_WFL.simple_instance_info/query`,
+        para:{instance_id},
+        success: (res)=>{
+            const record = res.result.record
+            sp_workflow_info.instance_info = record
+            get_view_para_info(local_url, record['node_display_service_name'], complete_function)
+        }
+    })
+}
+
+function get_view_para_info(local_url, service_name, complete_function){
+    Leaf.request({
+        url:`${local_url}/autocrud/simple.SIM_WFL.simple_workflow_view_para/query`,
+        para:{service_name},
+        success: (res)=>{
+            sp_workflow_info.workflow_para_info = res.result.record
+            complete_function(sp_workflow_info)
+        }
+    })
+}
+
Index: src/main/resources/leaf_static/WEB-INF/classes/csh/CSH900/hn_con_payment_conditions_detail_new.lwm
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/WEB-INF/classes/csh/CSH900/hn_con_payment_conditions_detail_new.lwm b/src/main/resources/leaf_static/WEB-INF/classes/csh/CSH900/hn_con_payment_conditions_detail_new.lwm
--- a/src/main/resources/leaf_static/WEB-INF/classes/csh/CSH900/hn_con_payment_conditions_detail_new.lwm	(revision 8d19853c38a202128ca6e278489bca351f4738b9)
+++ b/src/main/resources/leaf_static/WEB-INF/classes/csh/CSH900/hn_con_payment_conditions_detail_new.lwm	(revision 866c39a59cab07939cfac359f3b12b7fe34e5510)
@@ -44,7 +44,7 @@
         <bm:field name="arch_par_has_flag_desc"   expression="(select v.code_value_name from sys_code_values_v v where v.code = &apos;ACRCH_TYPE&apos; and v.code_value = nvl(t1.arch_par_has_flag,'Y'))" forInsert="false" forUpdate="false" prompt="是否有纸质资料"/>

         <bm:field name="archive_batch_id" databaseType="NUMBER" datatype="java.lang.Long" physicalName="ARCHIVE_BATCH_ID"
-                         prompt="HN_CON_PAYMENT_CONDITIONS_NEW.ARCHIVE_BATCH_ID"/>
+                  prompt="HN_CON_PAYMENT_CONDITIONS_NEW.ARCHIVE_BATCH_ID"/>
         <bm:field name="arch_paper_required_flag" databaseType="VARCHAR2" expression="nvl(t1.arch_paper_required_flag,'N')" datatype="java.lang.String" lookupCode="YES_NO"
                   lookupField="arch_paper_required_flag_desc" />
         <bm:field name="arch_paper_required_flag_desc" forInsert="false" forUpdate="false" />
@@ -54,12 +54,14 @@

         <bm:field name="receive_flag" databaseType="VARCHAR2"  datatype="java.lang.String"/>
         <bm:field name="receive_flag_desc"   expression="(select v.code_value_name from sys_code_values_v v where v.code = &apos;YES_NO&apos; and v.code_value = t1.receive_flag)" forInsert="false" forUpdate="false" prompt="是否有纸质资料"/>
-
+        <bm:field name="archive_date" databaseType="VARCHAR2"   datatype="java.util.Date" />
         <bm:field name="creation_date_s" databaseType="VARCHAR2" expression="to_char(t1.creation_date,'YYYY-MM-DD')" datatype="java.lang.String" forInsert="false" forUpdate="false"/>
         <bm:field name="cdd_category"/>
         <bm:field name="cdd_class"/>
         <bm:field name="mark_flag"/>
         <bm:field name="show_seq"/>
+        <bm:field name="archive_status"/>
+        <bm:field name="archive_status_n" forInsert="false" forUpdate="false"/>
         <bm:field name="important_concerns"/>
         <bm:field name="sign_num"/>
         <bm:field name="order_num" databaseType="NUMBER" datatype="java.lang.Long" expression="rownum" physicalName="ROW_NUM" forUpdate="false" forInsert="false"/>
@@ -74,7 +76,12 @@
     <bm:query-fields>
         <bm:query-field  name="archive_batch_id" queryExpression="t1.archive_batch_id=${@archive_batch_id}" />
         <bm:query-field  name="confirm_flag" queryExpression="t1.confirm_flag=${@confirm_flag}" />
+        <bm:query-field  name="archive_status" queryExpression="t1.archive_status=${@archive_status}" />
     </bm:query-fields>
+    <bm:data-filters>
+        <bm:data-filter enforceOperations="query" expression="t1.archive_status != decode(${@current_seq}, 20, 'X', '' , 'X', 'ARCHIVED')"/>
+        <bm:data-filter enforceOperations="query" expression="t1.archive_status != decode(${@current_seq}, '', 'X', 'FINISH_ARCHIVE')"/>
+    </bm:data-filters>
     <bm:operations>
         <bm:operation name="query">
             <bm:query-sql><![CDATA[
@@ -84,6 +91,10 @@
                            t1.DESCRIPTION,
                            t1.ATTACHMENT_NUMBER,
                            t1.CONFIRM_FLAG,
+                           t1.archive_status,
+                           (select  v.code_value_name from sys_code_values_v v
+                           where v.code = 'ARCHIVE_STATUS_ADMIN'
+                           and v.code_value=t1.archive_status) archive_status_n,
                            t1.CONFIRM_USER_ID,
                            t1.CONFIRM_DATE,
                            t1.NOTE,
@@ -129,6 +140,7 @@
                            t1.show_seq,
                            t1.important_concerns,
                            t1.sign_num,
+                           to_char(t1.archive_date, 'yyyy-mm-dd') archive_date,
                            rownum AS order_num
                       FROM HN_CON_PAYMENT_CONDITIONS_NEW t1
                      ORDER BY confirm_flag desc, condition_id, condition_code) t1#WHERE_CLAUSE#
@@ -145,15 +157,7 @@
             ]]></bm:update-sql>
         </bm:operation>

-        <bm:operation name="execute">
-            <bm:update-sql><![CDATA[
-            begin
-                  update HN_CON_PAYMENT_CONDITIONS_NEW pci
-                    set pci.mark_flag = ${@status}
-                  where pci.condition_id=${@condition_id};
-             end;
-            ]]></bm:update-sql>
-        </bm:operation>
+
     </bm:operations>

 </bm:model>
Index: src/main/resources/leaf_static/modules/simple/simple_util.lview
IDEA additional info:
Subsystem: com.intellij.openapi.diff.impl.patch.CharsetEP
<+>UTF-8
===================================================================
diff --git a/src/main/resources/leaf_static/modules/simple/simple_util.lview b/src/main/resources/leaf_static/modules/simple/simple_util.lview
--- a/src/main/resources/leaf_static/modules/simple/simple_util.lview	(revision 8d19853c38a202128ca6e278489bca351f4738b9)
+++ b/src/main/resources/leaf_static/modules/simple/simple_util.lview	(revision b64dcb4f41d7eef23a79cb9d23bb89a5257d94ce)
@@ -8,6 +8,9 @@

 <a:screen xmlns:a="http://www.leaf-framework.org/application" customizationEnabled="true" trace="true">
     <a:view>
+        <script src="${/request/@context_path}/modules/simple/js/simple_util_log.js"></script>
+        <script src="${/request/@context_path}/modules/simple/js/simple_util_mess.js"></script>
+        <script src="${/request/@context_path}/modules/simple/js/simple_util_workflow.js"></script>
         <script><![CDATA[

             //获取属性信息
@@ -23,47 +26,125 @@
                 })
             }

-            //设置属性参数
-            function set_property(layout_code, current_seq){
-                let filter_info = window['simple_wfl_property'].filter(seq =>{
-                    return seq["current_seq"] = current_seq
-                })
-
-                // try {
-                    filter_info[0]["revise_data"].forEach(revise_obj =>{
-                        let revise_ds = $(get_dsid_by_basetable(window[layout_code+'_layoutDataSetList'], revise_obj["ds_name"], revise_obj["tab_group"]))
-                        revise_obj["columns"].forEach(column =>{
-                            revise_ds.getAll().forEach(rec =>{
-                                if(column["column_value"]){
-                                    rec.set(column["column_name"], column["column_value"])
-                                }
-                                if(column["property"]["readonly"]){
-                                    rec.getField(column["column_name"]).setReadOnly(column["property"]["readonly"])
-                                }
-                                if(column["property"]["required"]){
-                                    rec.getField(column["column_name"]).setRequired(column["property"]["required"])
-                                }
-                            })
-                        })
-
-                    })
-                // } catch (e){
-                //     console.error(e)
-                // }
-
+            //对象转列表 估计很少用
+            function sp_obj_to_list(obj){
+                let arr = []
+                for(let key in obj){
+                    if(obj.hasOwnProperty(key)){
+                        arr.push({key, value:obj[key]})
+                    }
+                }
+                return arr
+            }
+
+
+
+            //多records 变为列表 说实话这个我也不知道应该用到哪里 先写着
+            function sp_rec_dict(records){
+                let arr = []
+                records.forEach(rec =>{
+                    arr.push(rec.data)
+                })
+                return arr
+            }
+
+            /**
+             * 将单个record全转化为只读/必填
+             * @param rec record
+             * @param sp_switch 只读必填开关 只读=>true 必填=>false
+             * @returns {undefined}
+             */
+            function sp_rec_readonly(rec, sp_switch=true){
+                for(let field in rec.data){
+                    if(rec.data.hasOwnProperty(field)){
+                        rec.getField(field).setReadOnly(sp_switch)
+                        rec.getField(field).setRequired(!sp_switch)
+                    }
+                }
+
+            }
+
+            //执行SQL语句
+            function sp_execute_sql(execute_sql){
+                Leaf.request({
+                    url:"${/request/@context_path}/autocrud/execute_sql",
+                    para: {execute_sql},
+                    success: (res) =>{return res}
+                })
+            }
+
+            //获取JSON数据
+            function sp_req_json(json_url){
+                Ext.Ajax.request({
+                    json_url,
+                    method: "GET",
+                    success: function(response){
+                        return  Ext.decode(response.responseText)
+                    },
+                    scope: this
+                })
+            }
+
+            /**
+             * ds验证是否有脏数据 有就提示 返回false验证不通过 没有就返回true验证通过
+             * @param ds
+             * @returns {boolean}
+             */
+            function sp_ds_dirty_valid(ds){
+                return ds.getAll().every(rec =>{
+                    if(rec.dirty === true){
+                        Leaf.showMessage("提示", "请先保存")
+                        return false
+                    }
+                    return true
+                })
             }

-            //字符串插入 参考python 中 str.format()
-            function sp_format(val) {
-                let args = Array.prototype.slice.call(arguments, 1)
-                return val.replace(/{(\d+)}/g, function(match, number) {
-                    return typeof args[number] !== 'undefined' ? args[number] : match
+            /**
+             * 将类似${/parameter} 或者是 ${/model/dataset/record/}转化为object类型
+             * @param parameter_str
+             * @returns {{}}
+             */
+            function sp_get_parameter_obj(parameter_str) {
+                let parameter_obj = {}
+                parameter_str.replace("{", "").replace("}", "").split(",").forEach(para_str => {
+                    const [key, value] = para_str.replace(/\ +/g, "").split("=")
+                    parameter_obj[key] = value
                 })
+                return parameter_obj
             }


+            /**
+             * 输出obj集
+             * @param parameter_str 页面参数 一般为${/parameter/}
+             * @param group_name obj集名
+             * @returns {{}}
+             */
+            function sp_output_view_parameter(parameter_str, group_name='页面参数'){
+                const para_obj = sp_get_parameter_obj(parameter_str)
+                sp_obj_colorful_log(para_obj, group_name)
+                return para_obj
+            }

+            /**
+             *
+             * @param parameter_str 页面参数 一般为${/parameter/}
+             * @param complete_func 回调函数 返回参数为工作流信息 本来是想把查询数据返回回去的 但是现有的技术好像做不到这一点
+             * @param instance_id 流程ID 默认从页面参数里面取
+             */
+            function sp_get_workflow_info(parameter_str, complete_func, instance_id=sp_get_parameter_obj(parameter_str)['instance_id']){
+                get_instance_info('${/request/@context_path}', instance_id, (workflow_info)=>{
+                    const para_obj = sp_get_parameter_obj(parameter_str)
+                    let para_desc_obj = {}
+                    workflow_info.workflow_para_info.forEach(para =>{
+                        para_desc_obj[para['parameter_desc']] = para_obj[para['parameter_code']]
+                    })
+                    sp_obj_colorful_log(workflow_info['instance_info'], '工作流参数')
+                    sp_obj_colorful_log(para_desc_obj, "工作流页面参数", compare_chinese_head)
+                    complete_func(workflow_info)
+                })
+            }
         ]]></script>
-        <a:screen-include screen="modules/cont/CON500/con_contract_get_layout_code.lview"/>
     </a:view>
 </a:screen>
Index: src/main/resources/leaf_static/modules/prj/PRJ506/prj_project_print_detail.lview
===================================================================
diff --git a/src/main/resources/leaf_static/modules/prj/PRJ506/prj_project_print_detail.lview b/src/main/resources/leaf_static/modules/prj/PRJ506/prj_project_print_detail.lview
deleted file mode 100644
--- a/src/main/resources/leaf_static/modules/prj/PRJ506/prj_project_print_detail.lview	(revision 600e775116243404a756244fa5f1586954125738)
+++ /dev/null	(revision 600e775116243404a756244fa5f1586954125738)
@@ -1,398 +0,0 @@
-<?xml version="1.0" encoding="UTF-8"?>
-<!--
-    $Author: wangwei
-    $Date: 2015-11-4 下午5:28:45
-    $Revision: 1.0
-    $Purpose: 虚拟合同生成文本明细
--->
-<a:screen xmlns:s="leaf.plugin.script" xmlns:a="http://www.leaf-framework.org/application" customizationEnabled="true" trace="true">
-    <a:init-procedure>
-        <a:model-query fetchAll="true" model="cont.CON500N.bgfl_get_contract_print_file_path" rootPath="contract_file_path"/>
-    </a:init-procedure>
-    <a:view>
-        <a:link id="prj_project_link" url="${/request/@context_path}/modules/prj/PRJ506/prj_project_print_detail_create.lview"/>
-        <a:link id="con_contract_get_layout_code_link_id" model="cont.CON500.con_contract_get_layout_code" modelaction="update"/>
-        <a:link id="con_contract_content_asset_detail_link_id" url="${/request/@context_path}/modules/cont/CON505/con_contract_content_asset_detail.lview"/>
-        <a:link id="con_contract_update_print_fin_link_id" url="${/request/@context_path}/modules/cont/CON500/con_contract_update_print_word.lview"/>
-        <a:link id="prj_project_create_content_link_id" model="prj.PRJ506.prj_project_create_content" modelaction="insert"/>
-        <a:link id="prj_project_print_dir_link_id" model="prj.PRJ506.prj_project_create_content" modelaction="update"/>
-        <a:link id="con_contract_save_print_information_link_id" model="cont.CON505.con_contract_save_print_information" modelaction="update"/>
-        <a:link id="get_mapping_xml_svc_link_id" model="cont.CON505.con_contract_save_print_information" modelaction="execute"/>
-        <a:link id="con_contract_uploadfile" url="${/request/@context_path}/uploadFile.lview"/>
-        <a:link id="con_contract_content_bp_link" model="cont.CON505.con_contract_content_bp_for_lov" modelaction="query"/>
-        <a:link id="con543_con_batch_dl_link_id" url="${/request/@context_path}/modules/prj/PRJ506/prj_atm_batch_dl.lsc"/>
-        <a:link id="con_contract_dowload_uploadfile_id" url="${/request/@context_path}/modules/cont/CON500/con_atm_batch_dl.lsc"/>
-        <a:link id="con_doc_batch_create_link_id" url="${/request/@context_path}/modules/prj/PRJ506/con_doc_batch_create.lsc"/>
-        <script><![CDATA[
-            function con_print_detail_print() {
-                if ($('con_contract_update_print_detail_line_ds').validate(true)) {
-                    var records = $('con_contract_update_print_detail_line_ds').getSelected();
-                    if (records.length == 0) {
-                        Leaf.showMessage('${l:PROMPT}', '${l:HLS.SELECT_RECORD}');
-                        return;
-                    }
-
-                    // if(Ext.isEmpty(record.get('templet_name')) || Ext.isEmpty(record.get('content_number'))){
-                    // Leaf.showMessage('${l:PROMPT}', '合同条款模板和合同文本编号不能为空！');
-                    // unlock_current_window();
-                    // return;
-                    // }
-
-                    // if (record.dirty) {
-                    // Leaf.showMessage('${l:PROMPT}', '${l:HLS.EXECUTE_AFTER_SAVE}');
-                    // unlock_current_window();
-                    // return;
-                    // }
-
-                    lock_current_window();
-                    $('con500_print_btn').disable();
-                    for (i = 0;i < records.length;i++) {
-                        var record = records[i];
-                        var templt_name, clause_usage = record.get('clause_usage'),
-                            business_type = '${/parameter/@business_type}',
-                            templet_id = record.get('templet_id'),
-                            bp_id = record.get('bp_id'),
-                            bp_class = record.get('bp_class'),
-                            mortgage_id = record.get('mortgage_id') || '',
-                            couple_guarantee_flag = record.get('couple_guarantee_flag'),
-                            content_number = record.get('content_number'),
-                            content_id = record.get('content_id'),
-                            bp_name = record.get('bp_name'),
-                            prj_bp_id = record.get('prj_bp_id');
-                        if (!bp_id) {
-                            bp_id = '';
-                        }
-                        debugger;
-                        //var file_path = '${/parameter/@file_path}'; /* file_path = file_path+search_term_1; */
-                        var file_path = $('contract_file_path_ds').getAt(0).get('contract_file_path');
-                        Leaf.request({
-                            url: $('prj_project_print_dir_link_id').getUrl(),
-                            para: {
-                                project_id: '${/parameter/@project_id}',
-                                content_id: record.get('content_id'),
-                                file_path: file_path,
-                                type: 'doc',
-                                file_name: content_number + bp_name
-                            },
-                            success: function() {
-
-                                Leaf.request({
-                                    url: $('get_mapping_xml_svc_link_id').getUrl(),
-                                    para: {
-                                        templet_code: record.get('templet_code')
-
-                                    },
-                                    success: function(res) {
-                                        debugger;
-                                        var xml = res.result.mapping_xml;
-                                        var svc = res.result.mapping_svc;
-
-                                        templt_name = xml;
-                                        if (clause_usage == 'FIN') {
-                                            //templt_name = 'fin_contract.xml';
-                                            con_name = '融资租赁合同';
-                                        } else if (clause_usage == 'GUT' && bp_class == 'ORG') {
-                                            //templt_name = 'fin_contract.xml';
-                                            con_name = '保证合同（法人）';
-                                        } else if (clause_usage == 'GUT' && bp_class == 'NP') {
-                                            //templt_name = 'fin_contract.xml';
-                                            con_name = '保证合同（自然人）';
-                                        } else if (clause_usage == 'OWN') {
-                                            //templt_name = 'fin_contract.xml';
-                                            con_name = '资产转让合同';
-                                        } else if (clause_usage == 'PUR') {
-                                            //templt_name = 'fin_contract.xml';
-                                            con_name = '购买合同';
-                                        } else if (clause_usage == 'MOR') {
-                                            //templt_name = 'fin_contract.xml';
-                                            con_name = '抵押合同';
-                                        } else if (clause_usage == 'DEPOSIT') {
-                                            //templt_name = 'fin_contract.xml';
-                                            con_name = '保证金合同';
-                                        } else if (clause_usage == 'COA') {
-                                            //templt_name = 'fin_contract.xml';
-                                            con_name = '';
-                                        } else {
-                                            //templt_name = 'fin_contract.xml';
-                                            con_name = '';
-                                        }
-                                        //存入数据库的名称
-                                        var timestamp = Date.parse(new Date());
-                                        var url = '${/request/@context_path}/' + svc + '?templt_name=' + templt_name + '&file_name=' + timestamp + '&file_path=' + file_path + '&project_id=${/parameter/@project_id}&clause_usage=' + clause_usage + '&templet_id=' + templet_id + '&content_id=' + content_id + '&bp_id=' + bp_id + '&prj_bp_id=' + prj_bp_id;
-                                        window.open(url, '', '_self', 'false');
-                                        unlock_current_window();
-
-                                    },
-                                    scope: this,
-                                    sync: true
-
-                                });
-                                /*
-                                 var url = $('con_contract_update_print_fin_link_id').getUrl() + '?templt_name=' + templt_name + '&file_name=' + search_term_1 + content_number + bp_name + '&file_path=' + file_path + '&contract_id=${/parameter/@contract_id}&clause_usage=' + clause_usage + '&templet_id=' + templet_id + '&content_id=' + content_id + '&bp_id=' + bp_id + '&con_contract_bp_id=' + con_contract_bp_id + '&_csrf=' + '${/session/@_csrf.token}';
-                                 window.open(url);
-                                 unlock_current_window();
-                                 var form = document.createElement("form");
-                                 form.target = "word_export_window";
-                                 form.method = "post";
-                                 form.action = url;
-                                 var iframe = Ext.get('word_export_window') || new Ext.Template('<iframe id ="word_export_window" name="word_export_window" style="position:absolute;left:-10000px;top:-10000px;width:1px;height:1px;display:none"></iframe>').insertFirst(document.body, {}, true);
-                                 document.body.appendChild(form);
-                                 form.submit();
-                                 Ext.fly(form).remove(); */
-
-                            },
-                            failure: function() {
-                                unlock_current_window();
-                            },
-                            error: function() {
-                                unlock_current_window();
-                            },
-                            scope: this,
-                            sync: true
-                        });
-                    }
-                    $('con_contract_update_print_detail_line_ds').query();
-                    $('con500_print_btn').enable();
-                }
-            }
-
-            //确认打印
-            function con_print_detail_print_new() {
-
-                lock_current_window();
-                var result_ds = $('con_contract_update_print_detail_line_ds');
-                var records = result_ds.getAll();
-                lock_current_window();
-                var file_path = $('contract_file_path_ds').getAt(0).get('contract_file_path');
-                Leaf.request({
-                    url: $('con_doc_batch_create_link_id').getUrl(),
-                    para: {
-                        project_id: '${/parameter/@project_id}',
-                        file_path: file_path,  // kyy暂时测试
-                        batch_flag: 'Y'
-                    },
-                    success: function(res) {
-                        Leaf.SideBar.enable = true;
-                        Leaf.SideBar.show({
-                            msg: '生成完毕',
-                            duration: 2000
-                        });
-                        result_ds.query(result_ds.currentPage);
-                        unlock_current_window();
-                    },
-                    error: function() {
-                        unlock_current_window();
-                    },
-                    failure: function() {
-                        unlock_current_window();
-                    },
-                    scope: this
-                });
-            }
-
-            function lock_current_window() {
-                Leaf.Masker.mask($('${/parameter/@winid}').wrap, '${l:HLS.EXECUTING}');
-            }
-
-            function unlock_current_window() {
-                Leaf.Masker.unmask($('${/parameter/@winid}').wrap);
-            }
-        //生成合同文本
-            function con_print_detail_create() {
-                /*lock_current_window();
-                Leaf.request({
-                    url: $('prj_project_create_content_link_id').getUrl(),
-                    para: {
-                        project_id: '${/parameter/@project_id}'
-                    },
-                    success: function(res) {
-                        var result_ds = $('con_contract_update_print_detail_line_ds');
-                        result_ds.query(result_ds.currentPage);
-                        unlock_current_window();
-                    },
-                    error: function() {
-                        unlock_current_window();
-                    },
-                    failure: function() {
-                        unlock_current_window();
-                    },
-                    scope: this
-                });*/
-
-                var param = {};
-
-                param['function_code'] = 'PRJ506T';
-                param['project_id'] = '${/parameter/@project_id}';
-                param['function_usage'] = 'query';
-                param['url_title'] = '合同类型';
-                param['screen_width'] = 700;
-                param['screen_height'] = 500;
-                param['pre_layout_code'] = '${/parameter/@layout_code}';
-                var url_link_id='prj_project_link';
-                hls_doc_get_layout_code('con_contract_get_layout_code_link_id',param,url_link_id,'con_contract_update_print_detail_line_ds');
-            }
-
-            function on_result_load(ds) {
-                var records = ds.getAll();
-                for (var i = 0;i < records.length;i++) {
-                    var record = records[i];
-                }
-            }
-//下载
-            function update_attachment_renderer(value, record, name) {
-
-                var content_id = record.get('content_id');
-                var record_id = record.id;
-                   return '<a href="javascript:downloadfile_link(' + content_id + ',\''+record_id+'\')">下载</a>';
-            }
-
-            function downloadfile_link(content_id,record_id) {
-                var res = $('con_contract_update_print_detail_line_ds').findById(record_id);
-                var content_print_flag = res.get('content_print_flag');
-                if(content_print_flag =='Y' ){
-                   var url = $('con543_con_batch_dl_link_id').getUrl() + '?content_id=' + content_id + '&contract_id=' + '${/parameter/@contract_id}' + '&content_type=' + '${/parameter/@content_type}';
-                window.open(url, '_self');
-                }else{
-                    Leaf.showMessage('${l:PROMPT}', '合同文本未生成！');
-                    return;
-                }
-            }
-//打包下载
-            /*function con_download_zip() {
-                var url = $('con543_con_batch_dl_link_id').getUrl() + '?contract_id=' + '${/parameter/@contract_id}';
-                window.open(url, '_self');
-            }*/
-
-            function con500_delete_print() {
-                $('con_contract_update_print_detail_grid_1').remove();
-            }
-//附件上传
-            function detail_upload_window(record_id) {
-                var record = $('con_contract_update_print_detail_line_ds').findById(record_id);
-                var dsCurrentPage = record.ds.currentPage;
-                var url = $('con_contract_uploadfile').getUrl() + '?table_name=CON_CONTRACT_CONTENT_V&header_id=' + record_id;
-                var win = new Leaf.Window({
-                    url: url,
-                    title: '${l:HLS.SUPPORTING_DOCUMENT}',
-                    id: 'insurance_records_uploadFile_id',
-                    width: 850,
-                    height: 400
-                });
-                win.on('close', function() {
-                    $('con_contract_update_print_detail_line_ds').query(dsCurrentPage);
-                });
-            }
-
-            function attachment_upload(val, rec, name) {
-                return '<a href=javascript:detail_upload_window(' + rec.get('content_id') + ')>附件上传</a>';
-            }
-
-            window['con500_link_render'] = function(value, record, name) {
-                if (value != null) {
-                    var link = '${/request/@context_path}/atm_download.lsc?attachment_id=';
-                    var str = value.split(';;');
-                    var url = '';
-                    for (var i = 0;i < str.length;i++) {
-                        var temp = str[i].split('--');
-                        if (!Leaf.isEmpty(temp[0])) {
-                            url = url + '<a href=' + link + temp[1] + ' ref="img">' + temp[0] + '</a>' + ',';
-                        }
-                    }
-                    return url;
-                }
-            };
-
-           /* function con_download_zip() {
-
-                var project_id = $('con_contract_update_print_detail_line_ds').getAt(0).get('project_id');
-                var doc_code = '合同文本附件';
-                var url_l = $('con543_con_batch_dl_link_id').getUrl() + '?project_id=' + project_id + '&doc_code=' + encodeURI(doc_code) + '&type=ZIP';
-
-                window.open(href = url_l, target = "_self");
-            }*/
-        ]]></script>
-        <a:dataSets>
-            <a:dataSet id="basic_clause_tmplet_usage_ds" lookupCode="CON_TMPLET_USAGE"/>
-            <a:dataSet id="contract_file_path_ds">
-                <a:datas dataSource="/model/contract_file_path"/>
-            </a:dataSet>
-            <a:dataSet id="con_contract_update_print_detail_header_ds" autoQuery="true" model="prj.PRJ506.prj_project_create_content" queryUrl="${/request/@context_path}/autocrud/prj.PRJ506.prj_project_create_content/query?project_id=${/parameter/@project_id}">
-                <a:fields>
-                    <a:field name="virtual_con_number" readOnly="true"/>
-                    <a:field name="contract_name" readOnly="true"/>
-                    <a:field name="project_name" readOnly="true"/>
-                </a:fields>
-            </a:dataSet>
-<!--
- leaf_static\WEB-INF\classes/cont/CON911/hn_con_content_template_list.lwm
--->
-            <a:dataSet id="con_contract_update_print_detail_line_ds" autoQuery="true" queryUrl="${/request/@context_path}/autocrud/prj.PRJ506.prj_project_content_v/query?project_id=${/parameter/@project_id}"  selectable="true" submitUrl="${/request/@context_path}/modules/prj/PRJ506/con_contract_content_save.lsc">
-                <a:fields>
-                    <a:field name="bp_name" lovGridHeight="350" lovHeight="500" lovLabelWidth="100" lovService="cont.CON505.con_contract_content_bp_for_lov?contract_id=${/parameter/@contract_id}" lovWidth="550" required="true" title="HLS.BP_TITLE">
-                        <a:mapping>
-                            <a:map from="record_id" to="con_contract_bp_id"/>
-                            <a:map from="bp_name" to="bp_name"/>
-                            <a:map from="bp_category" to="bp_category"/>
-                            <a:map from="bp_category_desc" to="bp_category_desc"/>
-                            <a:map from="bp_class" to="bp_class"/>
-                            <a:map from="bp_class_desc" to="bp_class_desc"/>
-                        </a:mapping>
-                    </a:field>
-                    <a:field name="clause_usage_name" displayField="code_value_name" options="basic_clause_tmplet_usage_ds" required="true" returnField="clause_usage" valueField="code_value"/>
-                    <a:field name="clause_usage"/>
-                    <a:field name="templet_name" lovGridHeight="350" lovHeight="500" lovService="basic.con_clause_templet_for_lov" lovWidth="500" title="CON505.CON_CONTENT_TEMPLET_NAME">
-                        <a:mapping>
-                            <a:map from="templet_id" to="templet_id"/>
-                            <a:map from="description" to="templet_name"/>
-                        </a:mapping>
-                    </a:field>
-                    <a:field name="content_number"/>
-                    <a:field name="available_flag" checkedValue="Y" defaultValue="Y" uncheckedValue="N"/>
-                    <a:field name="print_date" datatype="java.util.DATE"/>
-                </a:fields>
-                <a:events>
-                    <a:event name="load" handler="on_result_load"/>
-                </a:events>
-            </a:dataSet>
-        </a:dataSets>
-        <a:screenBody>
-            <a:screenTopToolbar style="width:848px">
-                <a:gridButton click="con_print_detail_create" text="CON505.CON_CONTENT_CREATE"/>
-                <!-- <a:gridButton id="con500_print_btn" click="con_print_detail_print" text="PRJ702.GENERATE_THE_FILE"/> -->
-               <!--确认打印按钮-->
-                <a:gridButton id="con_print_detail_print_id" click="con_print_detail_print_new" text="HLS.PRINT_CONFIRM"/>
-                <!-- <a:gridButton click="con_download_zip" text="打包下载"/> -->
-                <a:gridButton click="con500_delete_print" text="HLS.REMOVE"/>
-            </a:screenTopToolbar>
-            <a:form column="2" title="CON505.CON_CONTENT_PRINT" width="900">
-                <a:textField name="virtual_con_number" bindTarget="con_contract_update_print_detail_header_ds" prompt="HLS.CONTRACT_NUMBER"/>
-                <a:textField name="project_name" bindTarget="con_contract_update_print_detail_header_ds" prompt="HLS.CONTRACT_NAME" width="330"/>
-            </a:form>
-            <a:grid id="con_contract_update_print_detail_grid_1" bindTarget="con_contract_update_print_detail_line_ds" height="300" navBar="true" width="930">
-                <a:columns>
-<!-- <a:column name="description" prompt="模板类型" width="150"/>-->
-                    <a:column name="templet_type" prompt="模板类别" width="150"/>
-                    <a:column name="templet_name" editor="print_detail_grid_lov_id" prompt="CON505.CON_CONTENT_TEMPLET_NAME"/>
-
-<!--
-                    <a:column name="content_number" prompt="CON505.CON_CONTENT_NUMBER" width="300"/>
--->
-                    <!-- <a:column name="clause_usage_name" prompt="HLS.CONTRACT_USAGE"/> -->
-                    <!--  <a:column name="ref_n05" align="right" prompt="PRJ702.NUMBER_OF_COPIES" width="70"/> -->
-                    <a:column name="print_date" prompt="PRJ702.FILE_GENERATED_DATE" renderer="Leaf.formatDate" width="80"/>
-                    <!-- <a:column name="bp_class_desc" prompt="HLS.BP_CLASS"/> -->
-                    <!-- <a:column name="asset_detail" align="center" prompt="CON505.CON_CONTENT_ASSET_DETAIL" renderer="see_asset_detail_renderer"/> -->
-                    <a:column name="bp_name" prompt="HLS.BP_NAME"/>
-<!-- <a:column name="bp_category_desc" prompt="HLS.BP_CATEGORY"/>-->
-                    <a:column name="content_print_flag_name" prompt="CON505.CON_CONTENT_STATUS" width="80"/>
-                    <a:column name="create_online" prompt="在线编辑" width="150"/>
-                    <a:column name="file" prompt="附件" width="150"/>
-                    <a:column name="number" prompt="签约份数" width="150"/>
-                    <a:column name="attachment" align="center" prompt="HLS.ATTACHMENT" renderer="update_attachment_renderer" width="50"/>
-                    <!-- <a:column align="center" prompt="附件上传" renderer="attachment_upload" width="80"/>
-                    <a:column name="file_name" align="left" prompt="附件名" renderer="con500_link_render" width="220"/> -->
-                </a:columns>
-            </a:grid>
-        </a:screenBody>
-    </a:view>
-</a:screen>
